{
 "cells": [
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "# AER - Access Entitlement Review Reporter (Final Optimized v3.5)\n",
    "\n",
    "**Updates (v3.5):**\n",
    "- **Smart File Matching**: Handles varying filename formats (e.g., 'Alloy agent user listing' inside 'Alloy' folder).\n",
    "- **Alias Support**: Automatically handles specific naming quirks (e.g., 'DIB Services' folder -> 'D1B...' files).\n",
    "\n",
    "**Previous Features:**\n",
    "- **Full Audit History**: Tracks Creator, Modifier, and timestamps.\n",
    "- **Smart Caching**: Toggleable cache to speed up processing.\n",
    "- **Strict Filtering**: Ignores system folders.\n",
    "- **Advanced Reporting**: Individual app reports, Status Summary, 'Details' column preservation.\n",
    "- **Dashboard Highlighting**: Visual alerts for Denied/Changed items.\n",
    "- **Email Automation**: Merge capability & Apple Bank template."
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "metadata": {},
   "outputs": [],
   "source": [
    "# === Cell 1: Setup & Authentication ===\n",
    "import os\n",
    "import sys\n",
    "import io\n",
    "import logging\n",
    "from datetime import datetime\n",
    "from dotenv import load_dotenv\n",
    "from msal import PublicClientApplication\n",
    "import requests\n",
    "\n",
    "load_dotenv()\n",
    "\n",
    "# === Logging ===\n",
    "os.makedirs(\"output\", exist_ok=True)\n",
    "log_file = f\"output/aer_{datetime.now().strftime('%Y%m%d_%H%M%S')}.log\"\n",
    "\n",
    "logger = logging.getLogger(\"aer\")\n",
    "logger.handlers.clear()\n",
    "logger.setLevel(logging.INFO)\n",
    "\n",
    "def _get_console_stream():\n",
    "    s = getattr(sys, \"stdout\", None)\n",
    "    try:\n",
    "        if s and hasattr(s, \"reconfigure\"):\n",
    "            s.reconfigure(encoding=\"utf-8\")\n",
    "            if hasattr(sys.stderr, \"reconfigure\"):\n",
    "                sys.stderr.reconfigure(encoding=\"utf-8\")\n",
    "            return s\n",
    "    except Exception: pass\n",
    "    return sys.stdout\n",
    "\n",
    "formatter = logging.Formatter('%(asctime)s | %(levelname)s | %(message)s')\n",
    "ch = logging.StreamHandler(_get_console_stream())\n",
    "ch.setFormatter(formatter)\n",
    "logger.addHandler(ch)\n",
    "fh = logging.FileHandler(log_file, encoding=\"utf-8\")\n",
    "fh.setFormatter(formatter)\n",
    "logger.addHandler(fh)\n",
    "\n",
    "# === Azure AD Config ===\n",
    "TENANT_ID = os.getenv(\"AZURE_TENANT_ID\")\n",
    "CLIENT_ID = os.getenv(\"AZURE_CLIENT_ID\")\n",
    "SHAREPOINT_HOST = os.getenv(\"SHAREPOINT_HOST\", \"davidshih.sharepoint.com\")\n",
    "SITE_NAME = os.getenv(\"SITE_NAME\", \"aer\")\n",
    "APP_NAME = \"2025 Entitlement Review\"\n",
    "BASE_PATH = APP_NAME\n",
    "SENDER_EMAIL = os.getenv(\"SENDER_EMAIL\")\n",
    "\n",
    "SCOPES = [\n",
    "    \"User.Read.All\", \"Mail.Send\", \"Mail.Read\", \n",
    "    \"Files.Read.All\", \"Sites.Read.All\"\n",
    "]\n",
    "\n",
    "app = PublicClientApplication(CLIENT_ID, authority=f\"https://login.microsoftonline.com/{TENANT_ID}\")\n",
    "print(\"üöÄ Opening browser for authentication...\")\n",
    "interactive_result = app.acquire_token_interactive(scopes=SCOPES, prompt=\"select_account\")\n",
    "\n",
    "if \"access_token\" not in interactive_result:\n",
    "    raise RuntimeError(f\"Login Failed: {interactive_result.get('error_description')}\")\n",
    "\n",
    "headers = {\"Authorization\": f\"Bearer {interactive_result['access_token']}\"}\n",
    "logger.info(\"‚úÖ Login Successful\")\n",
    "logger.info(f\"Log File: {log_file}\")"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "metadata": {},
   "outputs": [],
   "source": [
    "# === Cell 2: SharePoint API, App Selector & Cache Toggle ===\n",
    "import ipywidgets as widgets\n",
    "from IPython.display import display, clear_output\n",
    "import requests\n",
    "\n",
    "# --- 1. SharePoint API Functions ---\n",
    "def get_site_id(site_name: str) -> str:\n",
    "    url = f\"https://graph.microsoft.com/v1.0/sites/{SHAREPOINT_HOST}:/sites/{site_name}\"\n",
    "    resp = requests.get(url, headers=headers)\n",
    "    resp.raise_for_status()\n",
    "    return resp.json()[\"id\"]\n",
    "\n",
    "def list_folders(site_id: str, path: str) -> list[dict]:\n",
    "    if not path or path.strip() == \"\":\n",
    "        url = f\"https://graph.microsoft.com/v1.0/sites/{site_id}/drive/root/children\"\n",
    "    else:\n",
    "        clean_path = path.strip(\"/\")\n",
    "        url = f\"https://graph.microsoft.com/v1.0/sites/{site_id}/drive/root:/{clean_path}:/children\"\n",
    "    resp = requests.get(url, headers=headers)\n",
    "    return [\n",
    "        {\"name\": item[\"name\"], \"webUrl\": item.get(\"webUrl\", \"\")}\n",
    "        for item in resp.json().get(\"value\", []) if item.get(\"folder\")\n",
    "    ]\n",
    "\n",
    "def list_excel_files(site_id: str, folder_path: str) -> list[dict]:\n",
    "    clean_path = folder_path.strip(\"/\")\n",
    "    url = f\"https://graph.microsoft.com/v1.0/sites/{site_id}/drive/root:/{clean_path}:/children\"\n",
    "    resp = requests.get(url, headers=headers)\n",
    "    files = []\n",
    "    for item in resp.json().get(\"value\", []):\n",
    "        if item[\"name\"].endswith(\".xlsx\"):\n",
    "            files.append({\n",
    "                \"id\": item[\"id\"], \"name\": item[\"name\"],\n",
    "                \"lastModifiedDateTime\": item.get(\"lastModifiedDateTime\"),\n",
    "                \"createdDateTime\": item.get(\"createdDateTime\"),\n",
    "                \"webUrl\": item.get(\"webUrl\")\n",
    "            })\n",
    "    return sorted(files, key=lambda f: f.get(\"lastModifiedDateTime\", \"\"), reverse=True)\n",
    "\n",
    "def download_file(site_id: str, file_path: str) -> bytes:\n",
    "    clean_path = file_path.strip(\"/\")\n",
    "    url = f\"https://graph.microsoft.com/v1.0/sites/{site_id}/drive/root:/{clean_path}:/content\"\n",
    "    resp = requests.get(url, headers=headers)\n",
    "    resp.raise_for_status()\n",
    "    return resp.content\n",
    "\n",
    "def get_file_audit_info(site_id: str, file_id: str) -> dict:\n",
    "    url = f\"https://graph.microsoft.com/v1.0/sites/{site_id}/drive/items/{file_id}/versions\"\n",
    "    resp = requests.get(url, headers=headers)\n",
    "    default_res = {\"log\": \"N/A\", \"creator\": \"Unknown\", \"modifier\": \"Unknown\", \"created_ts\": None}\n",
    "    \n",
    "    if resp.status_code != 200: return default_res\n",
    "    \n",
    "    versions = resp.json().get(\"value\", [])\n",
    "    if not versions: return default_res\n",
    "\n",
    "    logs = []\n",
    "    for v in versions:\n",
    "        mod_time = v.get(\"lastModifiedDateTime\", \"\")[:19].replace(\"T\", \" \")\n",
    "        actor = v.get(\"lastModifiedBy\", {}).get(\"user\", {}).get(\"displayName\") or \"System\"\n",
    "        logs.append(f\"{mod_time} - {actor}\")\n",
    "    \n",
    "    # Last = Newest, First = Oldest (Creation)\n",
    "    last_v = versions[0]\n",
    "    first_v = versions[-1]\n",
    "\n",
    "    return {\n",
    "        \"log\": \"\\n\".join(logs),\n",
    "        \"creator\": first_v.get(\"lastModifiedBy\", {}).get(\"user\", {}).get(\"displayName\") or \"System\",\n",
    "        \"modifier\": last_v.get(\"lastModifiedBy\", {}).get(\"user\", {}).get(\"displayName\") or \"System\",\n",
    "        \"created_ts\": first_v.get(\"lastModifiedDateTime\")\n",
    "    }\n",
    "\n",
    "# --- 2. Initialize Connection ---\n",
    "try:\n",
    "    site_id = get_site_id(SITE_NAME)\n",
    "    logger.info(f\"‚úÖ SharePoint Connected (Site ID: {site_id[:10]}...)\")\n",
    "except Exception as e:\n",
    "    logger.error(f\"‚ùå Connection Failed: {e}\")\n",
    "\n",
    "# --- 3. Tree Selector UI ---\n",
    "TARGET_APPS = [] \n",
    "USE_CACHE = True \n",
    "\n",
    "def create_app_selector():\n",
    "    print(f\"üìÇ Reading Root: {BASE_PATH} ...\")\n",
    "    try:\n",
    "        categories = list_folders(site_id, BASE_PATH)\n",
    "    except Exception as e:\n",
    "        print(f\"‚ùå Read Failed: {e}\")\n",
    "        return\n",
    "\n",
    "    ui_container = widgets.VBox()\n",
    "    app_checkboxes = []\n",
    "    \n",
    "    chk_cache = widgets.Checkbox(value=True, description=\"‚ö° Use Cache (Faster)\", indent=False)\n",
    "    ui_container.children += (widgets.HTML(\"<h3>üìÇ App Selector</h3>\"), chk_cache, widgets.HTML(\"<hr>\"))\n",
    "\n",
    "    for cat in categories:\n",
    "        if cat['name'] in [\"Forms\", \"_private\"] or \"audit\" in cat['name'].lower(): continue\n",
    "            \n",
    "        cat_label = widgets.HTML(f\"<b>üìÅ {cat['name']}</b>\", layout=widgets.Layout(width='100px'))\n",
    "        btn_expand = widgets.Button(description=\"‚ûï Expand\", button_style='info', layout=widgets.Layout(width='80px'))\n",
    "        app_list_box = widgets.VBox(layout=widgets.Layout(margin='0 0 0 30px', display='none'))\n",
    "        \n",
    "        def on_expand(b, cat_name=cat['name'], container=app_list_box, btn=btn_expand):\n",
    "            if btn.description == \"‚ûï Expand\":\n",
    "                btn.description = \"‚è≥\"\n",
    "                sub_path = f\"{BASE_PATH}/{cat_name}\"\n",
    "                try:\n",
    "                    apps = list_folders(site_id, sub_path)\n",
    "                    checks = []\n",
    "                    if not apps: checks.append(widgets.Label(\"(Empty)\"))\n",
    "                    \n",
    "                    for app in apps:\n",
    "                        if app['name'] in [\"Forms\", \"_private\"]: continue\n",
    "                        cb = widgets.Checkbox(value=False, description=app['name'], indent=False)\n",
    "                        cb.app_data = (cat_name, app['name'], f\"{sub_path}/{app['name']}\")\n",
    "                        checks.append(cb)\n",
    "                        app_checkboxes.append(cb)\n",
    "                    \n",
    "                    container.children = tuple(checks)\n",
    "                    container.layout.display = 'block'\n",
    "                    btn.description = \"‚ûñ Collapse\"\n",
    "                except Exception as e:\n",
    "                    container.children = (widgets.Label(f\"Error: {e}\"),)\n",
    "                    btn.description = \"‚ùå\"\n",
    "            else:\n",
    "                if container.layout.display == 'none':\n",
    "                    container.layout.display = 'block'; btn.description = \"‚ûñ Collapse\"\n",
    "                else:\n",
    "                    container.layout.display = 'none'; btn.description = \"‚ûï Expand\"\n",
    "\n",
    "        btn_expand.on_click(on_expand)\n",
    "        ui_container.children += (widgets.HBox([btn_expand, cat_label]), app_list_box)\n",
    "\n",
    "    btn_confirm = widgets.Button(description=\"‚úÖ Confirm Selection\", button_style='success', layout=widgets.Layout(margin='20px 0'))\n",
    "    output_area = widgets.Output()\n",
    "\n",
    "    def on_confirm(b):\n",
    "        global TARGET_APPS, USE_CACHE\n",
    "        TARGET_APPS = [cb.app_data for cb in app_checkboxes if cb.value]\n",
    "        USE_CACHE = chk_cache.value\n",
    "        \n",
    "        with output_area:\n",
    "            clear_output()\n",
    "            if not TARGET_APPS: print(\"‚ö†Ô∏è No apps selected!\")\n",
    "            else:\n",
    "                print(f\"üéØ Selected {len(TARGET_APPS)} Apps | Cache: {USE_CACHE}\")\n",
    "                print(\"‚è≥ Proceed to Cell 4.\")\n",
    "\n",
    "    btn_confirm.on_click(on_confirm)\n",
    "    display(ui_container, btn_confirm, output_area)\n",
    "\n",
    "create_app_selector()"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "metadata": {},
   "outputs": [],
   "source": [
    "# === Cell 3: Excel Parsing Logic ===\n",
    "from openpyxl import load_workbook\n",
    "from io import BytesIO\n",
    "\n",
    "COL_REVIEWER = \"Reviewer\"\n",
    "COL_RESPONSE = \"Reviewer's Response\"\n",
    "COL_DETAILS = \"Details of Access change\"\n",
    "\n",
    "def read_visible_rows(excel_bytes: bytes, reviewer_name: str, file_name: str, folder_url: str) -> list[dict]:\n",
    "    wb = load_workbook(BytesIO(excel_bytes))\n",
    "    ws = wb.active\n",
    "    \n",
    "    header_row = [cell.value for cell in ws[1]]\n",
    "    col_map = {str(name).strip(): idx for idx, name in enumerate(header_row) if name}\n",
    "    \n",
    "    reviewer_col = col_map.get(COL_REVIEWER)\n",
    "    response_col = col_map.get(COL_RESPONSE)\n",
    "    details_col = col_map.get(COL_DETAILS)\n",
    "    \n",
    "    if reviewer_col is None or response_col is None:\n",
    "        raise ValueError(f\"Missing columns. Found: {list(col_map.keys())}\")\n",
    "    \n",
    "    has_filter = any(ws.row_dimensions[i].hidden for i in range(2, ws.max_row + 1) if i in ws.row_dimensions)\n",
    "    results = []\n",
    "    \n",
    "    for row_idx in range(2, ws.max_row + 1):\n",
    "        if has_filter and ws.row_dimensions.get(row_idx) and ws.row_dimensions[row_idx].hidden:\n",
    "            continue\n",
    "        row = [cell.value for cell in ws[row_idx]]\n",
    "        \n",
    "        reviewer = row[reviewer_col] if reviewer_col < len(row) else None\n",
    "        response = row[response_col] if response_col < len(row) else None\n",
    "        details = row[details_col] if details_col is not None and details_col < len(row) else None\n",
    "        \n",
    "        if not has_filter and (reviewer is None or str(reviewer).strip().lower() != reviewer_name.lower()):\n",
    "            continue\n",
    "        \n",
    "        results.append({\n",
    "            \"reviewer\": reviewer_name, \"response\": response, \"details\": details,\n",
    "            \"is_missing\": (response is None or str(response).strip() == \"\"),\n",
    "            \"row_number\": row_idx, \"file_name\": file_name, \"folder_url\": folder_url\n",
    "        })\n",
    "    return results"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "metadata": {},
   "outputs": [],
   "source": [
    "# === Cell 4: Raw Data Enrichment (Auto-fill Manager & Status) ===\n",
    "import pandas as pd\n",
    "import io\n",
    "import requests\n",
    "import time\n",
    "from IPython.display import display, clear_output, FileLink\n",
    "\n",
    "# --- 1. Graph API Helper Functions ---\n",
    "# Cache to avoid hitting API repeatedly for the same manager/user\n",
    "user_cache = {}\n",
    "\n",
    "def get_ad_details(user_identity):\n",
    "    \"\"\"\n",
    "    Input: Email or UPN\n",
    "    Output: Dict with {displayName, department, accountEnabled, manager_name, manager_email}\n",
    "    \"\"\"\n",
    "    user_identity = str(user_identity).strip()\n",
    "    if not user_identity or user_identity.lower() == 'nan':\n",
    "        return None\n",
    "\n",
    "    if user_identity in user_cache:\n",
    "        return user_cache[user_identity]\n",
    "\n",
    "    # 1. Get User Info (Status, Dept, Id)\n",
    "    # Using Select to minimize payload\n",
    "    url_user = f\"https://graph.microsoft.com/v1.0/users/{user_identity}?$select=id,displayName,department,accountEnabled,mail,userPrincipalName\"\n",
    "    \n",
    "    try:\n",
    "        resp = requests.get(url_user, headers=headers)\n",
    "        if resp.status_code != 200:\n",
    "            # Fallback: Try searching by Display Name if email failed\n",
    "            url_filter = f\"https://graph.microsoft.com/v1.0/users?$filter=displayName eq '{user_identity}'&$select=id,displayName,department,accountEnabled,mail,userPrincipalName\"\n",
    "            resp = requests.get(url_filter, headers=headers)\n",
    "            data = resp.json().get('value', [])\n",
    "            if not data:\n",
    "                return {\"status\": \"Not Found\", \"dept\": \"Unknown\", \"manager\": \"Unknown\", \"manager_email\": \"\"}\n",
    "            user_data = data[0]\n",
    "        else:\n",
    "            user_data = resp.json()\n",
    "            \n",
    "        user_id = user_data.get('id')\n",
    "        is_active = user_data.get('accountEnabled', False)\n",
    "        status = \"Active\" if is_active else \"Inactive/Disabled\"\n",
    "        dept = user_data.get('department') or \"N/A\"\n",
    "        \n",
    "        # 2. Get Manager Info\n",
    "        url_manager = f\"https://graph.microsoft.com/v1.0/users/{user_id}/manager?$select=displayName,mail,userPrincipalName\"\n",
    "        resp_mgr = requests.get(url_manager, headers=headers)\n",
    "        \n",
    "        mgr_name = \"Unknown\"\n",
    "        mgr_email = \"\"\n",
    "        \n",
    "        if resp_mgr.status_code == 200:\n",
    "            mgr_data = resp_mgr.json()\n",
    "            mgr_name = mgr_data.get('displayName', \"Unknown\")\n",
    "            mgr_email = mgr_data.get('mail') or mgr_data.get('userPrincipalName')\n",
    "        elif resp_mgr.status_code == 404:\n",
    "             mgr_name = \"No Manager Assigned\"\n",
    "        \n",
    "        result = {\n",
    "            \"status\": status,\n",
    "            \"dept\": dept,\n",
    "            \"manager\": mgr_name,\n",
    "            \"manager_email\": mgr_email,\n",
    "            \"email\": user_data.get('mail') or user_data.get('userPrincipalName')\n",
    "        }\n",
    "        \n",
    "        user_cache[user_identity] = result\n",
    "        return result\n",
    "\n",
    "    except Exception as e:\n",
    "        logger.error(f\"Graph API Error for {user_identity}: {e}\")\n",
    "        return {\"status\": \"Error\", \"dept\": \"Error\", \"manager\": \"Check Manually\", \"manager_email\": \"\"}\n",
    "\n",
    "# --- 2. UI & Processing Logic ---\n",
    "\n",
    "uploader = widgets.FileUpload(accept='.xlsx, .csv', multiple=False, description=\"üìÇ Upload Raw List\")\n",
    "btn_process = widgets.Button(description=\"üöÄ Auto-Fill AD Info\", button_style='primary')\n",
    "output_enrich = widgets.Output()\n",
    "\n",
    "def on_process_click(b):\n",
    "    output_enrich.clear_output()\n",
    "    if not uploader.value:\n",
    "        with output_enrich: print(\"‚ö†Ô∏è Please upload a file first!\")\n",
    "        return\n",
    "\n",
    "    b.disabled = True\n",
    "    b.description = \"Processing...\"\n",
    "    \n",
    "    # Get file content\n",
    "    file_info = uploader.value[0]\n",
    "    content = file_info['content']\n",
    "    fname = file_info['name']\n",
    "    \n",
    "    with output_enrich:\n",
    "        print(f\"üìñ Reading {fname}...\")\n",
    "        try:\n",
    "            if fname.endswith('.csv'):\n",
    "                df_input = pd.read_csv(io.BytesIO(content))\n",
    "            else:\n",
    "                df_input = pd.read_excel(io.BytesIO(content))\n",
    "        except Exception as e:\n",
    "            print(f\"‚ùå Read Error: {e}\")\n",
    "            b.disabled = False; b.description = \"üöÄ Auto-Fill AD Info\"\n",
    "            return\n",
    "\n",
    "        # Attempt to find the \"User Identity\" column\n",
    "        cols = [c.lower() for c in df_input.columns]\n",
    "        id_col = None\n",
    "        \n",
    "        # Priority: Email > UPN > User Name > Name\n",
    "        candidates = ['email', 'mail', 'user email', 'upn', 'user principal name', 'user name', 'username', 'name', 'user']\n",
    "        \n",
    "        for cand in candidates:\n",
    "            for col in df_input.columns:\n",
    "                if cand == col.lower().strip():\n",
    "                    id_col = col\n",
    "                    break\n",
    "            if id_col: break\n",
    "        \n",
    "        if not id_col:\n",
    "            # Fallback: take the first column\n",
    "            id_col = df_input.columns[0]\n",
    "            print(f\"‚ö†Ô∏è Could not auto-detect Email column. Using first column: '{id_col}'\")\n",
    "        else:\n",
    "            print(f\"üéØ Detected User Column: '{id_col}'\")\n",
    "\n",
    "        print(f\"‚è≥ Querying Azure AD for {len(df_input)} users... (This may take a moment)\")\n",
    "        \n",
    "        # --- Processing Loop ---\n",
    "        new_rows = []\n",
    "        \n",
    "        # Prepare Progress Bar\n",
    "        prog = widgets.IntProgress(value=0, min=0, max=len(df_input), description='Querying:')\n",
    "        display(prog)\n",
    "        \n",
    "        for idx, row in df_input.iterrows():\n",
    "            user_val = row[id_col]\n",
    "            \n",
    "            # Fetch AD Info\n",
    "            ad_info = get_ad_details(user_val)\n",
    "            \n",
    "            # Build New Row Structure\n",
    "            # Keep original data? The prompt asks for specific columns. \n",
    "            # I will prioritize the Prompt's requested columns but merge original data if needed.\n",
    "            # Here we strictly follow the requested structure.\n",
    "            \n",
    "            base_data = {\n",
    "                \"User\": row.get('User', row.get('Name', user_val)), # Try to find a Name, else use value\n",
    "                \"User Email\": ad_info['email'] if ad_info and ad_info.get('email') else user_val,\n",
    "                \"User Department\": ad_info['dept'] if ad_info else \"N/A\",\n",
    "                \"User Status\": ad_info['status'] if ad_info else \"Unknown\",\n",
    "                \"Reviewer\": ad_info['manager'] if ad_info else \"Manual Check\",\n",
    "                \"Reviewer Email\": ad_info['manager_email'] if ad_info else \"\", # Helper col\n",
    "                \"Reviewer's Response\": \"\", # Blank for review\n",
    "                \"Details of Access change\": \"\" # Blank for review\n",
    "            }\n",
    "            new_rows.append(base_data)\n",
    "            prog.value += 1\n",
    "            \n",
    "        # Create Final DataFrame\n",
    "        df_final = pd.DataFrame(new_rows)\n",
    "        \n",
    "        # Reorder columns as requested\n",
    "        target_cols = [\"User\", \"User Email\", \"User Department\", \"User Status\", \"Reviewer\", \"Reviewer's Response\", \"Details of Access change\"]\n",
    "        # Add any extra columns from input if you want, but for now let's stick to the request + Reviewer Email for reference\n",
    "        final_cols = target_cols \n",
    "        \n",
    "        df_export = df_final[final_cols]\n",
    "        \n",
    "        # Generate Output File\n",
    "        out_filename = f\"Prepared_Review_List_{int(time.time())}.xlsx\"\n",
    "        df_export.to_excel(f\"output/{out_filename}\", index=False)\n",
    "        \n",
    "        print(\"\\n‚úÖ Processing Complete!\")\n",
    "        print(f\"üìä Processed {len(df_export)} records.\")\n",
    "        print(f\"üìÇ Saved to: output/{out_filename}\")\n",
    "        \n",
    "        # Display Preview\n",
    "        display(df_export.head())\n",
    "        \n",
    "        b.disabled = False\n",
    "        b.description = \"üöÄ Auto-Fill AD Info\"\n",
    "\n",
    "btn_process.on_click(on_process_click)\n",
    "display(widgets.VBox([\n",
    "    widgets.HTML(\"<h3>üõ†Ô∏è Step 0: Prepare Review List (AD Enrichment)</h3>\"),\n",
    "    widgets.HTML(\"<p>Upload a raw list (must have Email or Name column). This tool will fetch <b>Manager</b> and <b>User Status</b> from Azure AD.</p>\"),\n",
    "    widgets.HBox([uploader, btn_process]),\n",
    "    output_enrich\n",
    "]))"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "metadata": {},
   "outputs": [],
   "source": [
    "# === Cell 6: Email Notification (Merge & Apple Bank Template) ===\n",
    "import ipywidgets as widgets\n",
    "from urllib.parse import quote\n",
    "from datetime import datetime, timedelta\n",
    "import requests\n",
    "import pandas as pd\n",
    "from IPython.display import display, clear_output, HTML\n",
    "\n",
    "# --- 1. Helper Functions ---\n",
    "def get_email(name): \n",
    "    if not name: return \"\"\n",
    "    try:\n",
    "        clean = quote(name.split(\"(\")[0].strip())\n",
    "        url = f\"https://graph.microsoft.com/v1.0/users?$filter=startswith(displayName,'{clean}')&$select=mail,userPrincipalName\"\n",
    "        res = requests.get(url, headers=headers).json().get('value')\n",
    "        if res: return res[0].get('mail') or res[0].get('userPrincipalName')\n",
    "    except: pass\n",
    "    return \"\"\n",
    "\n",
    "def fmt_date_long(iso_date_str):\n",
    "    if not iso_date_str or pd.isna(iso_date_str): return \"Unknown Date\"\n",
    "    try:\n",
    "        dt_str = str(iso_date_str).replace('Z', '').split('.')[0]\n",
    "        dt = datetime.fromisoformat(dt_str)\n",
    "        return dt.strftime(\"%B %d, %Y\")\n",
    "    except: return str(iso_date_str)\n",
    "\n",
    "def calc_due_date_long(iso_date_str):\n",
    "    if not iso_date_str or pd.isna(iso_date_str): return \"ASAP\"\n",
    "    try:\n",
    "        dt_str = str(iso_date_str).replace('Z', '').split('.')[0]\n",
    "        dt = datetime.fromisoformat(dt_str)\n",
    "        due = dt + timedelta(days=14)\n",
    "        return due.strftime(\"%B %d, %Y\")\n",
    "    except: return \"ASAP\"\n",
    "\n",
    "# --- 2. Data Preparation ---\n",
    "if 'df' not in globals() or df.empty:\n",
    "    display(widgets.HTML(\"<h4 style='color:red'>‚ö†Ô∏è No data found. Run Cell 4 first.</h4>\"))\n",
    "else:\n",
    "    pending_df = df[df['is_missing'] == True].copy()\n",
    "    targets = pending_df.groupby([\"Category\", \"App_Name\", \"reviewer\", \"folder_url\"]).agg(\n",
    "        missing_count=(\"is_missing\", \"count\"),\n",
    "        file_date_raw=(\"File_Created_Date\", \"min\") \n",
    "    ).reset_index()\n",
    "\n",
    "    notes_db = manual_data_store if 'manual_data_store' in globals() else {}\n",
    "    print(\"üîç Looking up emails for pending reviewers...\")\n",
    "    email_cache = {} \n",
    "    raw_data_list = []\n",
    "    \n",
    "    for _, r in targets.iterrows():\n",
    "        app_key = f\"{r['Category']} > {r['App_Name']}\"\n",
    "        rev_key = r['reviewer']\n",
    "        app_node = notes_db.get(app_key, {})\n",
    "        if app_node.get(\"app_status\") in [\"Force Completed\", \"N/A\"]: continue\n",
    "        rev_override = app_node.get(\"reviewers\", {}).get(rev_key, {}).get(\"override\", \"-\")\n",
    "        if rev_override in [\"Mark Done\", \"Waived\", \"Escalated\"]: continue\n",
    "        \n",
    "        if rev_key not in email_cache: email_cache[rev_key] = get_email(rev_key)\n",
    "        raw_data_list.append({\n",
    "            \"App_Name\": r['App_Name'], \"reviewer\": r['reviewer'], \"missing\": r['missing_count'], \n",
    "            \"folder_url\": r['folder_url'], \"sent_date\": fmt_date_long(r['file_date_raw']),\n",
    "            \"due_date\": calc_due_date_long(r['file_date_raw']), \"email\": email_cache[rev_key]\n",
    "        })\n",
    "    clear_output()\n",
    "\n",
    "    # --- 3. UI Construction ---\n",
    "    current_year = datetime.now().year\n",
    "    default_subj_single = f\"REMINDER - {current_year} {{app_name}} Entitlement Review\"\n",
    "    default_subj_merge = f\"REMINDER - {current_year} Entitlement Reviews Action Required\"\n",
    "    default_body = (\n",
    "        \"The Information Security team is sending you a reminder to complete the <b>{app_name}</b> entitlement review that was sent to you on <b>{sent_date}</b>.<br><br>\"\n",
    "        \"The review was due on <b>{due_date}</b>. Please complete this review as soon as possible as it is now overdue. Your prompt assistance to this matter is appreciated.<br><br>\"\n",
    "        \"<b>Review Details:</b>\"\n",
    "        \"<ul><li>Pending Items: <b>{missing}</b></li>\"\n",
    "        \"<li>Link: <a href='{link}'>Open Access Review Folder</a></li></ul><br>\"\n",
    "        \"Sincerely,<br>Apple Bank's Information Security Team\"\n",
    "    )\n",
    "\n",
    "    w_merge = widgets.Checkbox(value=True, description=\"<b>üîó Merge Apps by Reviewer</b>\", indent=False)\n",
    "    w_subject_tpl = widgets.Text(value=default_subj_merge, description=\"<b>Subject:</b>\", layout=widgets.Layout(width='98%'))\n",
    "    w_cc_global = widgets.Text(value=\"\", description=\"<b>Global CC:</b>\", placeholder=\"manager@applebank.com\", layout=widgets.Layout(width='50%'))\n",
    "    w_body_tpl = widgets.Textarea(value=default_body.replace(\"<br>\", \"\\n\"), layout=widgets.Layout(width='100%', height='150px'))\n",
    "    btn_refresh = widgets.Button(description=\"üîÑ Refresh List\", button_style='info', layout=widgets.Layout(width='200px'))\n",
    "    container_rows = widgets.VBox()\n",
    "\n",
    "    def render_rows(b=None):\n",
    "        container_rows.children = (widgets.Label(\"Loading...\"),)\n",
    "        is_merged = w_merge.value\n",
    "        if is_merged and \"{app_name}\" in w_subject_tpl.value: w_subject_tpl.value = default_subj_merge\n",
    "        elif not is_merged and \"{app_name}\" not in w_subject_tpl.value: w_subject_tpl.value = default_subj_single\n",
    "\n",
    "        df_raw = pd.DataFrame(raw_data_list)\n",
    "        if df_raw.empty: container_rows.children = (widgets.HTML(\"<h3>‚úÖ No pending emails to send!</h3>\"),); return\n",
    "\n",
    "        final_rows = []\n",
    "        if is_merged:\n",
    "            grouped = df_raw.groupby(['reviewer', 'email'])\n",
    "            for (rev, mail), group in grouped:\n",
    "                apps_html = \"<table border='1' style='border-collapse:collapse; width:100%; font-size:12px; border:1px solid #ddd'>\"\n",
    "                apps_html += \"<tr style='background:#f3f3f3'><th>App Name</th><th>Sent Date</th><th>Due Date</th><th>Missing</th><th>Link</th></tr>\"\n",
    "                for _, row in group.iterrows():\n",
    "                    apps_html += f\"<tr><td style='padding:5px'>{row['App_Name']}</td><td style='padding:5px'>{row['sent_date']}</td><td style='padding:5px'>{row['due_date']}</td><td style='padding:5px; text-align:center'>{row['missing']}</td><td style='padding:5px'><a href='{row['folder_url']}'>Open</a></td></tr>\"\n",
    "                apps_html += \"</table>\"\n",
    "                final_rows.append({\"key\": rev, \"reviewer\": rev, \"email\": mail, \"is_merged\": True, \"merged_html\": apps_html,\n",
    "                                   \"ctx\": {\"app_name\": \"following applications\", \"sent_date\": \"previous dates\", \"due_date\": \"recently\", \"missing\": int(group['missing'].sum()), \"link\": \"#\"}})\n",
    "        else:\n",
    "            for idx, r in df_raw.iterrows():\n",
    "                final_rows.append({\"key\": f\"{r['reviewer']}_{r['App_Name']}\", \"reviewer\": r['reviewer'], \"email\": r['email'], \"is_merged\": False,\n",
    "                                   \"ctx\": {\"app_name\": r['App_Name'], \"sent_date\": r['sent_date'], \"due_date\": r['due_date'], \"missing\": r['missing'], \"link\": r['folder_url']}})\n",
    "\n",
    "        ui_items = []; row_logic_store = {}\n",
    "        for item in final_rows:\n",
    "            key = item['key']\n",
    "            email_color = \"#0078d4\" if item['email'] else \"red\"\n",
    "            info_html = (f\"<b>üë§ {item['reviewer']}</b><br><span style='color:{email_color}'>{item['email'] or '(No Email)'}</span><br>\"\n",
    "                         f\"<span style='color:darkorange'>Combine {item['ctx']['missing']} items</span>\") if item['is_merged'] else \\\n",
    "                        (f\"<b>üë§ {item['reviewer']}</b><br>üìÇ {item['ctx']['app_name']}<br><span style='color:{email_color}'>{item['email'] or '(No Email)'}</span>\")\n",
    "\n",
    "            w_chk = widgets.Checkbox(value=True, layout=widgets.Layout(width='30px'))\n",
    "            w_info = widgets.HTML(info_html, layout=widgets.Layout(width='200px'))\n",
    "            tpl_body = w_body_tpl.value.replace(\"\\n\", \"<br>\")\n",
    "            final_preview_html = (\"The Information Security team is sending you a reminder to complete the entitlement reviews for the following applications:<br><br>\" + item['merged_html'] + \"<br><br>Please complete these reviews as soon as possible. Your prompt assistance to this matter is appreciated.<br><br>Sincerely,<br>Apple Bank's Information Security Team\") if item['is_merged'] else tpl_body.format(**item['ctx'])\n",
    "            \n",
    "            w_preview = widgets.HTML(value=f\"<div style='font-family:sans-serif; font-size:12px; padding:5px; color:#333'>{final_preview_html}</div>\", layout=widgets.Layout(width='100%', height='140px', border='1px solid #eee', overflow_y='auto'))\n",
    "            w_email = widgets.Text(value=item['email'], placeholder=\"Email\", layout=widgets.Layout(width='98%'))\n",
    "            w_btn = widgets.Button(description=\"üöÄ Send\", button_style='warning', layout=widgets.Layout(width='80px'))\n",
    "\n",
    "            def create_sender(k, preview_html, subj_tpl):\n",
    "                def on_send(b):\n",
    "                    if not row_logic_store[k]['w_email'].value: b.description = \"No Email\"; return\n",
    "                    b.disabled = True; b.description = \"...\"\n",
    "                    try:\n",
    "                        final_subj = subj_tpl if item['is_merged'] else subj_tpl.format(**item['ctx'])\n",
    "                        url = f\"https://graph.microsoft.com/v1.0/users/{SENDER_EMAIL}/sendMail\"\n",
    "                        to_list = [{\"emailAddress\": {\"address\": row_logic_store[k]['w_email'].value}}]\n",
    "                        cc_list = [{\"emailAddress\": {\"address\": w_cc_global.value.strip()}}] if w_cc_global.value.strip() else []\n",
    "                        payload = {\"message\": {\"subject\": final_subj, \"body\": {\"contentType\": \"HTML\", \"content\": preview_html}, \"toRecipients\": to_list, \"ccRecipients\": cc_list}}\n",
    "                        r = requests.post(url, headers={**headers, \"Content-Type\": \"application/json\"}, json=payload)\n",
    "                        if r.status_code == 202: b.button_style = 'success'; b.description = \"Sent\"; row_logic_store[k]['w_chk'].value = False\n",
    "                        else: b.button_style = 'danger'; b.description = \"Fail\"; print(r.text)\n",
    "                    except Exception as e: print(e); b.button_style = 'danger'\n",
    "                    finally: \n",
    "                        if b.description != \"Sent\": b.disabled = False\n",
    "                return on_send\n",
    "            w_btn.on_click(create_sender(key, final_preview_html, w_subject_tpl.value))\n",
    "            row_logic_store[key] = {'w_chk': w_chk, 'w_email': w_email}\n",
    "            ui_items.append(widgets.HBox([w_chk, w_info, widgets.VBox([widgets.Label(\"Preview:\"), w_preview], layout=widgets.Layout(flex='1', padding='0 10px')), widgets.VBox([widgets.Label(\"Action:\"), w_email, w_btn], layout=widgets.Layout(width='150px'))], layout=widgets.Layout(border='1px solid #ccc', margin='5px 0', padding='5px', align_items='center')))\n",
    "        container_rows.children = tuple(ui_items)\n",
    "\n",
    "    w_merge.observe(render_rows, names='value')\n",
    "    btn_refresh.on_click(render_rows)\n",
    "    render_rows()\n",
    "    display(widgets.VBox([widgets.HTML(\"<h3>üìß Email Notification Center</h3>\"), widgets.HBox([w_merge, btn_refresh]), widgets.HTML(\"<hr>\"), w_subject_tpl, w_cc_global, widgets.Label(\"Body Template (Single App Only):\"), w_body_tpl], layout=widgets.Layout(background_color='#f0f4f8', padding='10px', border='1px solid #ccc', margin='0 0 10px 0')), container_rows)"
   ]
  }
 ],
 "metadata": {
  "kernelspec": {
   "display_name": "Python 3",
   "language": "python",
   "name": "python3"
  },
  "language_info": {
   "codemirror_mode": {
    "name": "ipython",
    "version": 3
   },
   "file_extension": ".py",
   "mimetype": "text/x-python",
   "name": "python",
   "nbconvert_exporter": "python",
   "pygments_lexer": "ipython3",
   "version": "3.8.5"
  }
 },
 "nbformat": 4,
 "nbformat_minor": 4
}
