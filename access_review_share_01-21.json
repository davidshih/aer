{
 "cells": [
  {
   "cell_type": "code",
   "execution_count": null,
   "metadata": {},
   "outputs": [],
   "source": [
    "# === Step 1: Install packages and Import ===\n",
    "import sys\n",
    "import subprocess\n",
    "import platform\n",
    "import os\n",
    "import shutil\n",
    "import time\n",
    "import glob\n",
    "import pandas as pd\n",
    "import ipywidgets as widgets\n",
    "from IPython.display import display, HTML, clear_output\n",
    "from typing import Dict, List, Optional, Tuple\n",
    "\n",
    "# æª¢æŸ¥å¿…è¦å¥—ä»¶\n",
    "required_packages = ['pandas', 'openpyxl', 'ipywidgets', 'pywin32']\n",
    "print(\"ğŸ” æª¢æŸ¥å¥—ä»¶å®‰è£ç‹€æ…‹...\")\n",
    "for package in required_packages:\n",
    "    try:\n",
    "        if package == 'pywin32':\n",
    "            import win32com.client\n",
    "        else:\n",
    "            __import__(package)\n",
    "        print(f\"  âœ… {package} å·²å®‰è£\")\n",
    "    except ImportError:\n",
    "        print(f\"  âš ï¸ æœªå®‰è£ {package}ï¼Œæ­£åœ¨å®‰è£...\")\n",
    "        subprocess.check_call([sys.executable, \"-m\", \"pip\", \"install\", package])\n",
    "        print(f\"  âœ… {package} å®‰è£å®Œæˆ\")\n",
    "\n",
    "# æª¢æŸ¥ Windows COM\n",
    "WIN32COM_AVAILABLE = False\n",
    "if platform.system() == 'Windows':\n",
    "    try:\n",
    "        import win32com.client\n",
    "        WIN32COM_AVAILABLE = True\n",
    "        print(\"  âœ… Windows Excel COM è‡ªå‹•åŒ–: å¯ç”¨\")\n",
    "    except ImportError:\n",
    "        print(\"  âŒ Windows Excel COM è‡ªå‹•åŒ–: ä¸å¯ç”¨ (è«‹å®‰è£ pywin32)\")\n",
    "else:\n",
    "    print(\"  â„¹ï¸ é Windows ç³»çµ±ï¼Œåƒ…èƒ½ä½¿ç”¨ OpenPyXL æ¨¡å¼\")"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "metadata": {},
   "outputs": [],
   "source": [
    "# === Step 2: Global Variables and Helper Functions ===\n",
    "\n",
    "excel_com_instance = None\n",
    "\n",
    "def sanitize_folder_name(name: str) -> str:\n",
    "    \"\"\"æ¸…ç†è³‡æ–™å¤¾åç¨±ï¼Œç§»é™¤ä¸åˆæ³•å­—å…ƒ\"\"\"\n",
    "    invalid_chars = ['/', '\\\\', ':', '*', '?', '\"', '<', '>', '|', '#', '%']\n",
    "    sanitized = str(name).strip()\n",
    "    for char in invalid_chars:\n",
    "        sanitized = sanitized.replace(char, '_')\n",
    "    return sanitized[:255].rstrip() # é™åˆ¶é•·åº¦\n",
    "\n",
    "def find_column(worksheet, column_name):\n",
    "    \"\"\"åœ¨å·¥ä½œè¡¨ä¸­å°‹æ‰¾æ¬„ä½\"\"\"\n",
    "    for col_idx, cell in enumerate(worksheet[1], start=1):\n",
    "        if cell.value == column_name:\n",
    "            return col_idx\n",
    "    raise ValueError(f\"æ‰¾ä¸åˆ° '{column_name}' æ¬„ä½ï¼\")\n",
    "\n",
    "def copy_selected_documents(source_dir, dest_dir, copy_word=True, copy_pdf=True):\n",
    "    \"\"\"è¤‡è£½é¸å®šçš„æ–‡ä»¶é¡å‹\"\"\"\n",
    "    copied_files = []\n",
    "    \n",
    "    if copy_word:\n",
    "        word_patterns = [\n",
    "            os.path.join(source_dir, \"*.docx\"),\n",
    "            os.path.join(source_dir, \"*.doc\")\n",
    "        ]\n",
    "        for pattern in word_patterns:\n",
    "            for file in glob.glob(pattern):\n",
    "                if os.path.isfile(file):\n",
    "                    dest_path = os.path.join(dest_dir, os.path.basename(file))\n",
    "                    shutil.copy2(file, dest_path)\n",
    "                    copied_files.append(os.path.basename(file))\n",
    "\n",
    "    if copy_pdf:\n",
    "        pdf_pattern = os.path.join(source_dir, \"*.pdf\")\n",
    "        for file in glob.glob(pdf_pattern):\n",
    "            if os.path.isfile(file):\n",
    "                dest_path = os.path.join(dest_dir, os.path.basename(file))\n",
    "                shutil.copy2(file, dest_path)\n",
    "                copied_files.append(os.path.basename(file))\n",
    "                \n",
    "    return copied_files"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "metadata": {},
   "outputs": [],
   "source": [
    "# === Step 3: Excel COM Management ===\n",
    "\n",
    "def initialize_excel_com():\n",
    "    \"\"\"åˆå§‹åŒ–å…¨åŸŸ Excel COM å¯¦ä¾‹\"\"\"\n",
    "    global excel_com_instance\n",
    "    if WIN32COM_AVAILABLE and excel_com_instance is None:\n",
    "        try:\n",
    "            import pythoncom\n",
    "            pythoncom.CoInitialize()\n",
    "            excel_com_instance = win32com.client.Dispatch(\"Excel.Application\")\n",
    "            excel_com_instance.Visible = False\n",
    "            excel_com_instance.DisplayAlerts = False\n",
    "            excel_com_instance.ScreenUpdating = False\n",
    "            print(\"  âœ… Excel COM å¯¦ä¾‹å·²åˆå§‹åŒ–\")\n",
    "            return True\n",
    "        except Exception as e:\n",
    "            print(f\"  âŒ ç„¡æ³•åˆå§‹åŒ– Excel COM: {str(e)}\")\n",
    "            excel_com_instance = None\n",
    "            return False\n",
    "    return excel_com_instance is not None\n",
    "\n",
    "def cleanup_excel_com():\n",
    "    \"\"\"æ¸…ç†å…¨åŸŸ Excel COM å¯¦ä¾‹\"\"\"\n",
    "    global excel_com_instance\n",
    "    if excel_com_instance is not None:\n",
    "        try:\n",
    "            excel_com_instance.Quit()\n",
    "            import pythoncom\n",
    "            pythoncom.CoUninitialize()\n",
    "        except Exception as e:\n",
    "            print(f\"  âš ï¸ æ¸…ç† COM æ™‚ç™¼ç”ŸéŒ¯èª¤: {str(e)}\")\n",
    "        finally:\n",
    "            excel_com_instance = None\n",
    "            import gc\n",
    "            gc.collect()\n",
    "\n",
    "def restart_excel_com():\n",
    "    \"\"\"é‡å•Ÿ Excel COM\"\"\"\n",
    "    cleanup_excel_com()\n",
    "    time.sleep(1)\n",
    "    return initialize_excel_com()"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "metadata": {},
   "outputs": [],
   "source": [
    "# === Step 4: Logic Implementation (OpenPyXL Hide Rows) ===\n",
    "# é€™æ˜¯ä½ åœ¨æˆªåœ– 6 ä¸­çœ‹åˆ°çš„ç‰ˆæœ¬\n",
    "\n",
    "from openpyxl import load_workbook\n",
    "\n",
    "def process_reviewer_excel_hide_rows(file_path, reviewer, column_name, output_folder):\n",
    "    \"\"\"ä½¿ç”¨ openpyxl éš±è—åˆ—çš„æ–¹å¼è™•ç†ï¼ˆä¿ç•™æª”æ¡ˆå®Œæ•´æ€§ï¼‰\"\"\"\n",
    "    try:\n",
    "        reviewer_name = sanitize_folder_name(str(reviewer).strip())\n",
    "        reviewer_folder = os.path.join(output_folder, reviewer_name)\n",
    "        os.makedirs(reviewer_folder, exist_ok=True)\n",
    "\n",
    "        base_name = os.path.basename(file_path)\n",
    "        name_without_ext = os.path.splitext(base_name)[0]\n",
    "        ext = os.path.splitext(base_name)[1]\n",
    "        new_filename = f\"{name_without_ext} - {reviewer_name}{ext}\"\n",
    "        dst_path = os.path.join(reviewer_folder, new_filename)\n",
    "\n",
    "        # å…ˆè¤‡è£½æª”æ¡ˆ\n",
    "        shutil.copy2(file_path, dst_path)\n",
    "        \n",
    "        # é–‹å•Ÿæ–°æª”é€²è¡Œè™•ç†\n",
    "        wb = load_workbook(dst_path, keep_vba=True)\n",
    "        main_ws = wb.active\n",
    "        \n",
    "        # å°‹æ‰¾æ¬„ä½\n",
    "        col_idx = find_column(main_ws, column_name)\n",
    "        \n",
    "        # æ‰¾å‡ºè¦éš±è—çš„åˆ—\n",
    "        rows_to_hide = []\n",
    "        for row in range(2, main_ws.max_row + 1):\n",
    "            cell_value = main_ws.cell(row=row, column=col_idx).value\n",
    "            if str(cell_value).strip() != str(reviewer).strip():\n",
    "                rows_to_hide.append(row)\n",
    "                \n",
    "        # éš±è—åˆ—\n",
    "        for row_idx in rows_to_hide:\n",
    "            main_ws.row_dimensions[row_idx].hidden = True\n",
    "            \n",
    "        wb.save(dst_path)\n",
    "        wb.close()\n",
    "        print(f\"  âœ… å·²è™•ç† (éš±è—åˆ—): {new_filename}\")\n",
    "        return True, reviewer_folder, new_filename\n",
    "        \n",
    "    except Exception as e:\n",
    "        print(f\"  âŒ è™•ç† {reviewer} å¤±æ•—: {str(e)}\")\n",
    "        return False, None, None"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "metadata": {},
   "outputs": [],
   "source": [
    "# === Step 5: Logic Implementation (Windows Excel COM) ===\n",
    "# é€™æ˜¯ä½ åœ¨æˆªåœ– 9 ä¸­çœ‹åˆ°çš„ç‰ˆæœ¬ (æœ€å®Œæ•´)\n",
    "\n",
    "def process_reviewer_excel_windows_excel(file_path, reviewer, column_name, output_folder):\n",
    "    \"\"\"ä½¿ç”¨ Windows Excel COM è‡ªå‹•åŒ– (ä¿®æ­£ç‰ˆ - ä¿ç•™æ ¼å¼)\"\"\"\n",
    "    if not WIN32COM_AVAILABLE:\n",
    "        return False, None, None\n",
    "        \n",
    "    global excel_com_instance\n",
    "    if excel_com_instance is None:\n",
    "        if not initialize_excel_com():\n",
    "            return False, None, None\n",
    "            \n",
    "    reviewer_name = sanitize_folder_name(str(reviewer).strip())\n",
    "    reviewer_folder = os.path.join(output_folder, reviewer_name)\n",
    "    os.makedirs(reviewer_folder, exist_ok=True)\n",
    "    \n",
    "    base_name = os.path.basename(file_path)\n",
    "    name_without_ext = os.path.splitext(base_name)[0]\n",
    "    ext = os.path.splitext(base_name)[1]\n",
    "    new_filename = f\"{name_without_ext} - {reviewer_name}.xlsx\"\n",
    "    dst_path = os.path.join(reviewer_folder, new_filename)\n",
    "    \n",
    "    try:\n",
    "        # ä½¿ç”¨ SaveCopyAs ç¢ºä¿å®Œæ•´è¤‡è£½\n",
    "        wb_source = excel_com_instance.Workbooks.Open(os.path.abspath(file_path), ReadOnly=True)\n",
    "        wb_source.SaveCopyAs(os.path.abspath(dst_path))\n",
    "        wb_source.Close(False)\n",
    "        \n",
    "        # é–‹å•Ÿè¤‡è£½çš„æª”æ¡ˆé€²è¡Œè™•ç†\n",
    "        wb_dest = excel_com_instance.Workbooks.Open(os.path.abspath(dst_path))\n",
    "        \n",
    "        # æ‰¾å·¥ä½œè¡¨\n",
    "        main_ws = None\n",
    "        try:\n",
    "             main_ws = wb_dest.Worksheets(1)\n",
    "        except:\n",
    "             pass\n",
    "             \n",
    "        if main_ws:\n",
    "            # å°‹æ‰¾æ¬„ä½\n",
    "            col_idx = None\n",
    "            used_range = main_ws.UsedRange\n",
    "            for col in range(1, used_range.Columns.Count + 1):\n",
    "                if main_ws.Cells(1, col).Value == column_name:\n",
    "                    col_idx = col\n",
    "                    break\n",
    "            \n",
    "            if col_idx:\n",
    "                 # ä½¿ç”¨ AutoFilter ç¯©é¸ä¸¦åˆªé™¤å¯è¦‹åˆ— (Headeré™¤å¤–)\n",
    "                 if main_ws.AutoFilterMode:\n",
    "                     main_ws.AutoFilterMode = False\n",
    "                 \n",
    "                 # é€™è£¡å‡è¨­æˆ‘å€‘è¦ä¿ç•™è©² Reviewerï¼Œæ‰€ä»¥ç¯©é¸ã€Œä¸ç­‰æ–¼ã€Reviewer çš„\n",
    "                 main_ws.UsedRange.AutoFilter(Field=col_idx, Criteria1=f\"<>{reviewer}\")\n",
    "                 \n",
    "                 # åˆªé™¤å¯è¦‹åˆ— (é™¤äº†æ¨™é¡Œ)\n",
    "                 # æˆªåœ–ä¸­çš„é‚è¼¯è¼ƒè¤‡é›œï¼Œé€™è£¡ä½¿ç”¨æ¨™æº– COM åˆªé™¤æ³•\n",
    "                 try:\n",
    "                     main_ws.UsedRange.Offset(1, 0).SpecialCells(12).EntireRow.Delete()\n",
    "                 except:\n",
    "                     pass # å¯èƒ½æ²’æœ‰è³‡æ–™è¢«ç¯©é¸å‡ºä¾†\n",
    "                 \n",
    "                 main_ws.AutoFilterMode = False\n",
    "                 print(f\"  âœ… COM è™•ç†å®Œæˆ: {new_filename}\")\n",
    "            else:\n",
    "                 print(f\"  âš ï¸ æ‰¾ä¸åˆ°æ¬„ä½ {column_name}\")\n",
    "                 \n",
    "        wb_dest.Save()\n",
    "        wb_dest.Close()\n",
    "        return True, reviewer_folder, new_filename\n",
    "\n",
    "    except Exception as e:\n",
    "        print(f\"  âŒ COM è™•ç†å¤±æ•—: {str(e)}\")\n",
    "        # å˜—è©¦æ¸…ç†\n",
    "        try: wb_source.Close(False); except: pass\n",
    "        try: wb_dest.Close(False); except: pass\n",
    "        return False, None, None"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "metadata": {},
   "outputs": [],
   "source": [
    "# === Step 6: UI Setup (Widgets) ===\n",
    "\n",
    "excel_file_input = widgets.Text(\n",
    "    value='',\n",
    "    placeholder='è«‹è²¼ä¸Š Excel æª”æ¡ˆè·¯å¾‘...',\n",
    "    description='Excel æª”æ¡ˆ:',\n",
    "    layout=widgets.Layout(width='450px')\n",
    ")\n",
    "\n",
    "reviewer_column_input = widgets.Text(\n",
    "    value='Reviewer',\n",
    "    description='å¯©æŸ¥è€…æ¬„ä½:',\n",
    "    layout=widgets.Layout(width='300px')\n",
    ")\n",
    "\n",
    "output_folder_input = widgets.Text(\n",
    "    value='output',\n",
    "    placeholder='è¼¸å‡ºè³‡æ–™å¤¾',\n",
    "    description='è¼¸å‡ºä½ç½®:',\n",
    "    layout=widgets.Layout(width='450px')\n",
    ")\n",
    "\n",
    "copy_word_check = widgets.Checkbox(\n",
    "    value=True,\n",
    "    description='è¤‡è£½ Word æ–‡ä»¶ (.doc, .docx)'\n",
    ")\n",
    "\n",
    "copy_pdf_check = widgets.Checkbox(\n",
    "    value=True,\n",
    "    description='è¤‡è£½ PDF æ–‡ä»¶ (.pdf)'\n",
    ")\n",
    "\n",
    "use_com_check = widgets.Checkbox(\n",
    "    value=True,\n",
    "    description='ä½¿ç”¨ Windows Excel COM (ä¿ç•™æ ¼å¼)',\n",
    "    disabled=not WIN32COM_AVAILABLE\n",
    ")\n",
    "\n",
    "process_button = widgets.Button(\n",
    "    description='è™•ç† Excel æª”æ¡ˆ',\n",
    "    button_style='success',\n",
    "    layout=widgets.Layout(width='200px', height='40px'),\n",
    "    icon='check'\n",
    ")\n",
    "\n",
    "output = widgets.Output()\n",
    "\n",
    "display(widgets.HTML(\"<h3>ğŸ“‚ æ­¥é©Ÿ 1: æª”æ¡ˆé¸æ“‡</h3>\"))\n",
    "display(excel_file_input)\n",
    "display(reviewer_column_input)\n",
    "display(output_folder_input)\n",
    "\n",
    "display(widgets.HTML(\"<h3>âš™ï¸ æ­¥é©Ÿ 2: é¸é …è¨­å®š</h3>\"))\n",
    "display(copy_word_check)\n",
    "display(copy_pdf_check)\n",
    "display(use_com_check)\n",
    "\n",
    "display(widgets.HTML(\"<br>\"))\n",
    "display(process_button)\n",
    "display(output)"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "metadata": {},
   "outputs": [],
   "source": [
    "# === Step 7: Main Execution Logic ===\n",
    "\n",
    "def on_button_click(b):\n",
    "    output.clear_output()\n",
    "    with output:\n",
    "        file_path = excel_file_input.value.strip('\"')\n",
    "        column_name = reviewer_column_input.value\n",
    "        output_folder = output_folder_input.value\n",
    "        \n",
    "        if not os.path.exists(file_path):\n",
    "            print(\"âŒ æ‰¾ä¸åˆ°æª”æ¡ˆï¼Œè«‹æª¢æŸ¥è·¯å¾‘ã€‚\")\n",
    "            return\n",
    "            \n",
    "        print(f\"ğŸš€ é–‹å§‹è™•ç†: {os.path.basename(file_path)}\")\n",
    "        \n",
    "        # è®€å– Reviewers\n",
    "        try:\n",
    "            df = pd.read_excel(file_path, engine='openpyxl')\n",
    "            if column_name not in df.columns:\n",
    "                print(f\"âŒ æ‰¾ä¸åˆ°æ¬„ä½ '{column_name}'\")\n",
    "                print(f\"   å¯ç”¨æ¬„ä½: {', '.join(df.columns)}\")\n",
    "                return\n",
    "                \n",
    "            reviewers = df[column_name].dropna().unique().tolist()\n",
    "            print(f\"ğŸ” æ‰¾åˆ° {len(reviewers)} ä½å¯©æŸ¥è€…\")\n",
    "            \n",
    "            # é€²åº¦æ¢\n",
    "            progress = widgets.IntProgress(min=0, max=len(reviewers), description='é€²åº¦:')\n",
    "            display(progress)\n",
    "            \n",
    "            for i, reviewer in enumerate(reviewers):\n",
    "                print(f\"[{i+1}/{len(reviewers)}] è™•ç†ä¸­: {reviewer}\")\n",
    "                \n",
    "                success = False\n",
    "                r_folder = None\n",
    "                \n",
    "                # é¸æ“‡è™•ç†æ¨¡å¼\n",
    "                if use_com_check.value and WIN32COM_AVAILABLE:\n",
    "                     # å˜—è©¦ COM æ¨¡å¼\n",
    "                     success, r_folder, _ = process_reviewer_excel_windows_excel(file_path, reviewer, column_name, output_folder)\n",
    "                else:\n",
    "                     # é€€å› OpenPyXL Hide Rows æ¨¡å¼\n",
    "                     success, r_folder, _ = process_reviewer_excel_hide_rows(file_path, reviewer, column_name, output_folder)\n",
    "                \n",
    "                if success and r_folder:\n",
    "                    # è¤‡è£½é™„ä»¶\n",
    "                    base_dir = os.path.dirname(file_path)\n",
    "                    copy_selected_documents(\n",
    "                        base_dir, \n",
    "                        r_folder, \n",
    "                        copy_word=copy_word_check.value, \n",
    "                        copy_pdf=copy_pdf_check.value\n",
    "                    )\n",
    "                \n",
    "                progress.value += 1\n",
    "                \n",
    "            print(\"\\nğŸ‰ æ‰€æœ‰ä½œæ¥­å®Œæˆï¼\")\n",
    "            \n",
    "        except Exception as e:\n",
    "            print(f\"âŒ ç™¼ç”ŸéŒ¯èª¤: {str(e)}\")\n",
    "        finally:\n",
    "            if WIN32COM_AVAILABLE:\n",
    "                cleanup_excel_com()\n",
    "\n",
    "process_button.on_click(on_button_click)"
   ]
  }
 ],
 "metadata": {
  "kernelspec": {
   "display_name": "Python 3",
   "language": "python",
   "name": "python3"
  },
  "language_info": {
   "codemirror_mode": {
    "name": "ipython",
    "version": 3
   },
   "file_extension": ".py",
   "mimetype": "text/x-python",
   "name": "python",
   "nbconvert_exporter": "python",
   "pygments_lexer": "ipython3",
   "version": "3.8.5"
  }
 },
 "nbformat": 4,
 "nbformat_minor": 4
}