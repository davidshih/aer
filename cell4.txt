# === Cell 4: Smart Data Preparation (AD Enrichment + Dept Head Mapping) ===
import pandas as pd
import io
import requests
import time
import ipywidgets as widgets
from IPython.display import display, clear_output

# --- 1. Global Cache & Config ---
user_cache = {}  # Cache to reduce API calls
dept_map_cache = {} # Stores Department -> Reviewer mapping

# --- 2. AD Helper Function ---
def fetch_ad_info(email):
    """
    Returns: { 'status': 'Active'/'Inactive', 'dept': '...', 'manager': '...' }
    """
    email = str(email).strip()
    if not email or email.lower() == 'nan': 
        return {'status': 'Unknown', 'dept': 'N/A', 'manager': 'Manual Check'}
    
    if email in user_cache: return user_cache[email]

    # Get User Data
    try:
        url = f"https://graph.microsoft.com/v1.0/users/{email}?$select=id,accountEnabled,department,displayName"
        resp = requests.get(url, headers=headers)
        if resp.status_code == 404:
            # Try searching by mail if UPN fails
            url = f"https://graph.microsoft.com/v1.0/users?$filter=mail eq '{email}'&$select=id,accountEnabled,department,displayName"
            resp = requests.get(url, headers=headers)
            data = resp.json().get('value', [])
            if not data:
                return {'status': 'Not Found', 'dept': 'N/A', 'manager': 'Manual Check'}
            user_data = data[0]
        elif resp.status_code != 200:
            return {'status': 'Error', 'dept': 'Error', 'manager': 'Manual Check'}
        else:
            user_data = resp.json()

        # Parse User Info
        status = "Active" if user_data.get('accountEnabled') else "Inactive"
        dept = user_data.get('department') or "N/A"
        user_id = user_data.get('id')

        # Get Manager
        mgr_name = "Manual Check"
        if status != "Not Found":
            url_mgr = f"https://graph.microsoft.com/v1.0/users/{user_id}/manager?$select=displayName,mail"
            r_mgr = requests.get(url_mgr, headers=headers)
            if r_mgr.status_code == 200:
                mgr_name = r_mgr.json().get('displayName')
            elif r_mgr.status_code == 404:
                mgr_name = "No Manager"

        res = {'status': status, 'dept': dept, 'manager': mgr_name}
        user_cache[email] = res
        return res

    except Exception as e:
        logger.error(f"AD Error ({email}): {e}")
        return {'status': 'Error', 'dept': 'Error', 'manager': 'Manual Check'}

# --- 3. UI Components ---
style = {'description_width': 'initial'}
up_main = widgets.FileUpload(accept='.xlsx, .csv', description='üìÇ 1. Select Main List', layout=widgets.Layout(width='300px'))
up_dept = widgets.FileUpload(accept='.csv, .xlsx', description='üìÇ 2. Dept Head Map (Opt)', layout=widgets.Layout(width='300px'))
out_log = widgets.Output(layout=widgets.Layout(border='1px solid #eee', padding='10px', height='300px', overflow_y='scroll'))
btn_run = widgets.Button(description='üöÄ Start Processing', button_style='primary', disabled=True)
lbl_file_info = widgets.HTML("<i>Waiting for file...</i>")

processed_df = None # Store result

def check_file(change):
    # Validate Main File on Upload
    if not up_main.value: 
        lbl_file_info.value = "<i>Waiting for file...</i>"
        btn_run.disabled = True
        return

    f = up_main.value[0]
    fname = f['name']
    content = f['content']
    
    try:
        if fname.endswith('.csv'): df = pd.read_csv(io.BytesIO(content))
        else: df = pd.read_excel(io.BytesIO(content))
        
        rows = len(df)
        cols = df.columns.tolist()
        
        # Check First Two Columns (Soft Check)
        col1_ok = "name" in cols[0].lower() or "user" in cols[0].lower()
        col2_ok = "email" in cols[1].lower() or "mail" in cols[1].lower()
        
        status_icon = "‚úÖ" if (col1_ok and col2_ok) else "‚ö†Ô∏è"
        status_text = "Format Looks Good" if (col1_ok and col2_ok) else "Check Columns 1 & 2"
        
        info = f"""
        <b>Selected File:</b> {fname}<br>
        <b>Records:</b> {rows}<br>
        <b>Columns:</b> {cols[:2]}...<br>
        <b>Status:</b> {status_icon} {status_text}
        """
        lbl_file_info.value = info
        btn_run.disabled = False
        
    except Exception as e:
        lbl_file_info.value = f"‚ùå Error reading file: {e}"
        btn_run.disabled = True

up_main.observe(check_file, names='value')

def process_data(b):
    out_log.clear_output()
    btn_run.disabled = True
    btn_run.description = "Processing..."
    
    global processed_df, dept_map_cache
    
    with out_log:
        # 1. Load Dept Map if exists
        if up_dept.value:
            print("üì• Loading Department Head Mapping...")
            f_d = up_dept.value[0]
            try:
                if f_d['name'].endswith('.csv'): df_map = pd.read_csv(io.BytesIO(f_d['content']))
                else: df_map = pd.read_excel(io.BytesIO(f_d['content']))
                # Assume Col 1 = Dept, Col 2 = Reviewer
                for _, row in df_map.iterrows():
                    d_key = str(row[0]).strip().lower()
                    d_val = str(row[1]).strip()
                    dept_map_cache[d_key] = d_val
                print(f"   ‚úÖ Loaded {len(dept_map_cache)} department rules.")
            except Exception as e:
                print(f"   ‚ùå Failed to load Dept Map: {e}")

        # 2. Load Main File
        f_m = up_main.value[0]
        if f_m['name'].endswith('.csv'): df = pd.read_csv(io.BytesIO(f_m['content']))
        else: df = pd.read_excel(io.BytesIO(f_m['content']))
        
        # Identify Columns (Strict based on prompt: 1=Name, 2=Email)
        col_name = df.columns[0]
        col_email = df.columns[1]
        
        print(f"üöÄ Processing {len(df)} records...")
        
        new_data = []
        
        # 3. Iterate & Enrich
        prog = widgets.IntProgress(min=0, max=len(df), description='Enriching:')
        display(prog)
        
        for idx, row in df.iterrows():
            u_name = row[col_name]
            u_email = row[col_email]
            
            # AD Lookup
            ad = fetch_ad_info(u_email)
            
            # Logic: Determine Reviewer
            # Priority: Dept Map > AD Manager > "Manual Check"
            dept_key = str(ad['dept']).strip().lower()
            
            final_reviewer = ad['manager']
            source = "AD"
            
            if dept_key in dept_map_cache:
                final_reviewer = dept_map_cache[dept_key]
                source = "Map"
            
            new_data.append({
                "User": u_name,
                "User Email": u_email,
                "User Department": ad['dept'],
                "User Status": ad['status'],
                "Reviewer": final_reviewer,
                "Reviewer's Response": "", # Blank
                "Details of Access change": "" # Blank
            })
            
            if idx % 10 == 0: prog.value = idx
            
        prog.value = len(df)
        
        # 4. Finalize
        processed_df = pd.DataFrame(new_data)
        out_name = f"output/Enriched_Review_List_{int(time.time())}.xlsx"
        processed_df.to_excel(out_name, index=False)
        
        print("\n‚úÖ Done!")
        print(f"üíæ Saved to: {out_name}")
        display(processed_df.head(5))
        
        btn_run.description = "‚úÖ Start Processing"
        btn_run.disabled = False

btn_run.on_click(process_data)

# Layout
ui = widgets.VBox([
    widgets.HTML("<h3>üõ†Ô∏è Step 1: Input Data & Enrichment</h3>"),
    widgets.HBox([
        widgets.VBox([widgets.Label("1. Main User List (User, Email)"), up_main]),
        widgets.VBox([widgets.Label("2. Dept Mapping (Dept, Head) [Optional]"), up_dept])
    ]),
    widgets.HTML("<hr>"),
    lbl_file_info,
    btn_run,
    widgets.HTML("<hr>"),
    out_log
])
display(ui)