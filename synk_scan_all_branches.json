{
 "cells": [
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "# ğŸ›¡ï¸ Snyk Multi-Branch Scanner for Azure DevOps (Windows Edition)\n",
    "\n",
    "é€™å€‹ Notebook å°ˆé–€ç”¨ä¾†è™•ç†ç”± **Azure DevOps** ä»£ç®¡çš„ Python å°ˆæ¡ˆã€‚å®ƒæœƒè‡ªå‹•æŠ“å–æ‰€æœ‰é ç«¯ Branchï¼Œä¸¦é€ä¸€åŸ·è¡Œ `pip install` èˆ‡ `snyk monitor`ã€‚\n",
    "\n",
    "### ğŸ“‹ å‰ç½®éœ€æ±‚\n",
    "1. ç¢ºä¿å·²å®‰è£ `git` èˆ‡ `snyk` CLIã€‚\n",
    "2. ç¢ºä¿ç›®éŒ„ä¸‹æœ‰ `.env` æª”æ¡ˆï¼Œå…§å®¹å¦‚ä¸‹ï¼š\n",
    "   ```ini\n",
    "   ADO_REPO_URL=https://<PAT>@[dev.azure.com/Org/Proj/_git/Repo](https://dev.azure.com/Org/Proj/_git/Repo)\n",
    "   LOCAL_REPO_PATH=C:\\Temp\\Snyk_Repo\n",
    "   SNYK_TOKEN=ä½ çš„_API_Token\n",
    "   SNYK_ORG_ID=ä½ çš„_Org_ID (å¯é¸)\n",
    "   PROJECT_PREFIX=MyApp\n",
    "   ```"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "metadata": {},
   "outputs": [],
   "source": [
    "# Cell 1: å®‰è£å¿…è¦å¥—ä»¶èˆ‡è¼‰å…¥ç’°å¢ƒè®Šæ•¸\n",
    "import sys\n",
    "import os\n",
    "import subprocess\n",
    "import time\n",
    "\n",
    "# è‡ªå‹•å®‰è£ python-dotenv (å¦‚æœä½ é‚„æ²’è£çš„è©±)\n",
    "try:\n",
    "    import dotenv\n",
    "except ImportError:\n",
    "    print(\"ğŸ“¦ Installing python-dotenv...\")\n",
    "    subprocess.check_call([sys.executable, \"-m\", \"pip\", \"install\", \"python-dotenv\"])\n",
    "    import dotenv\n",
    "\n",
    "from dotenv import load_dotenv\n",
    "\n",
    "# è¼‰å…¥ .env\n",
    "load_dotenv()\n",
    "\n",
    "# è®€å–è®Šæ•¸\n",
    "REPO_URL = os.getenv(\"ADO_REPO_URL\")\n",
    "LOCAL_PATH = os.getenv(\"LOCAL_REPO_PATH\")\n",
    "SNYK_TOKEN = os.getenv(\"SNYK_TOKEN\")\n",
    "SNYK_ORG_ID = os.getenv(\"SNYK_ORG_ID\")\n",
    "PROJECT_PREFIX = os.getenv(\"PROJECT_PREFIX\", \"SnykScan\")\n",
    "\n",
    "# é©—è­‰\n",
    "if not REPO_URL or not LOCAL_PATH:\n",
    "    raise ValueError(\"âŒ ç¼ºå°‘å¿…è¦è®Šæ•¸ï¼è«‹æª¢æŸ¥ .env æª”æ¡ˆä¸­çš„ ADO_REPO_URL å’Œ LOCAL_REPO_PATHã€‚\")\n",
    "\n",
    "print(f\"âœ… è¨­å®šè¼‰å…¥å®Œæˆï¼\")\n",
    "print(f\"ğŸ“ Target Repo: {REPO_URL}\")\n",
    "print(f\"ğŸ“‚ Local Path: {LOCAL_PATH}\")"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "metadata": {},
   "outputs": [],
   "source": [
    "# Cell 2: å®šç¾© Windows å°ˆç”¨æŒ‡ä»¤åŸ·è¡Œå‡½å¼ (è™•ç†ç·¨ç¢¼å•é¡Œ)\n",
    "def run_command(command, cwd=None, env_vars=None):\n",
    "    \"\"\"\n",
    "    åŸ·è¡Œ Shell æŒ‡ä»¤ä¸¦å›å‚³çµæœï¼ŒåŒ…å«éŒ¯èª¤è™•ç†èˆ‡ç·¨ç¢¼ç›¸å®¹æ€§ã€‚\n",
    "    \"\"\"\n",
    "    my_env = os.environ.copy()\n",
    "    if env_vars:\n",
    "        my_env.update(env_vars)\n",
    "\n",
    "    try:\n",
    "        # Windows ä¸Š shell=True æ˜¯å¿…é ˆçš„ï¼Œä¸ç„¶å¾ˆå¤šæŒ‡ä»¤æœƒæ‰¾ä¸åˆ°\n",
    "        result = subprocess.run(\n",
    "            command,\n",
    "            cwd=cwd,\n",
    "            shell=True,\n",
    "            check=True,\n",
    "            stdout=subprocess.PIPE,\n",
    "            stderr=subprocess.PIPE,\n",
    "            text=True,\n",
    "            encoding='utf-8', # å˜—è©¦ UTF-8\n",
    "            errors='replace', # å¦‚æœ Windows è·³ cp950 äº‚ç¢¼ï¼Œç”¨ replace å¿½ç•¥éŒ¯èª¤\n",
    "            env=my_env\n",
    "        )\n",
    "        return result.stdout.strip()\n",
    "    except subprocess.CalledProcessError as e:\n",
    "        print(f\"âŒ Command Failed: {command}\")\n",
    "        print(f\"ğŸ”» Stderr: {e.stderr}\")\n",
    "        return None\n",
    "\n",
    "print(\"âœ… Helper function ready.\")"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "metadata": {},
   "outputs": [],
   "source": [
    "# Cell 3: æª¢æŸ¥å·¥å…·èˆ‡ Snyk ç™»å…¥\n",
    "print(\"ğŸ” Checking Environment...\")\n",
    "\n",
    "# Check Git\n",
    "git_ver = run_command(\"git --version\")\n",
    "if git_ver:\n",
    "    print(f\"ğŸ”¹ {git_ver}\")\n",
    "else:\n",
    "    raise RuntimeError(\"âŒ Git not found! Please install Git for Windows.\")\n",
    "\n",
    "# Check Snyk\n",
    "snyk_ver = run_command(\"snyk --version\")\n",
    "if snyk_ver:\n",
    "    print(f\"ğŸ”¹ Snyk CLI: {snyk_ver}\")\n",
    "else:\n",
    "    raise RuntimeError(\"âŒ Snyk CLI not found! Run 'npm install -g snyk' or download the binary.\")\n",
    "\n",
    "# Authenticate\n",
    "if SNYK_TOKEN:\n",
    "    print(\"ğŸ” Authenticating Snyk with Token...\")\n",
    "    # ä½¿ç”¨ snyk auth <token> é€²è¡Œæˆæ¬Š\n",
    "    run_command(f\"snyk auth {SNYK_TOKEN}\")\n",
    "else:\n",
    "    print(\"âš ï¸ No SNYK_TOKEN in .env. Assuming you are already logged in.\")"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "metadata": {},
   "outputs": [],
   "source": [
    "# Cell 4: ä¸‹è¼‰æˆ–æ›´æ–° Repo\n",
    "if os.path.exists(LOCAL_PATH):\n",
    "    print(f\"ğŸ“‚ Folder exists at {LOCAL_PATH}. Fetching updates...\")\n",
    "    # å¼·åˆ¶ fetch ç¢ºä¿æ‹¿åˆ°æœ€æ–°çš„ branch åˆ—è¡¨\n",
    "    run_command(\"git fetch --all\", cwd=LOCAL_PATH)\n",
    "else:\n",
    "    print(f\"ğŸš€ Cloning repo to {LOCAL_PATH}...\")\n",
    "    # å¦‚æœ REPO_URL åŒ…å« PATï¼Œé€™è£¡å°±æœƒç›´æ¥ Clone æˆåŠŸ\n",
    "    run_command(f\"git clone {REPO_URL} {LOCAL_PATH}\")\n",
    "\n",
    "print(\"âœ… Git Repo ready for scanning.\")"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "metadata": {},
   "outputs": [],
   "source": [
    "# Cell 5: è§£æé ç«¯ Branch æ¸…å–®\n",
    "print(\"ğŸ” Parsing remote branches...\")\n",
    "\n",
    "# å–å¾—æ‰€æœ‰é ç«¯åˆ†æ”¯\n",
    "raw_branches = run_command(\"git branch -r\", cwd=LOCAL_PATH)\n",
    "branches = []\n",
    "\n",
    "if raw_branches:\n",
    "    for line in raw_branches.splitlines():\n",
    "        b = line.strip()\n",
    "        # éæ¿¾æ‰ '->' æŒ‡æ¨™å’Œ origin å‰ç¶´\n",
    "        if \"->\" not in b and \"origin/\" in b:\n",
    "            clean_name = b.replace(\"origin/\", \"\")\n",
    "            branches.append(clean_name)\n",
    "\n",
    "print(f\"ğŸ“Š Found {len(branches)} branches: {branches}\")"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "metadata": {},
   "outputs": [],
   "source": [
    "# Cell 6: æ‰¹æ¬¡æƒæè¿´åœˆ (The Main Loop)\n",
    "\n",
    "print(\"ğŸš€ Starting Snyk Monitor Batch Job...\")\n",
    "\n",
    "for i, branch in enumerate(branches):\n",
    "    print(f\"\\n------------------------------------------------------\")\n",
    "    print(f\"[{i+1}/{len(branches)}] ğŸ‘‰ Processing Branch: {branch}\")\n",
    "    \n",
    "    # 1. Checkout (å¼·åˆ¶ Clean ä»¥å…è¡çª)\n",
    "    run_command(\"git reset --hard\", cwd=LOCAL_PATH)\n",
    "    # æ³¨æ„: å¦‚æœæœ‰ untracked files å°è‡´ checkout å¤±æ•—ï¼Œå¯åŠ  git clean -fdx (å°å¿ƒä½¿ç”¨)\n",
    "    \n",
    "    # Windows Path è™•ç†ï¼šç¢ºä¿ branch åç¨±æ²’æœ‰å¥‡æ€ªå­—å…ƒ\n",
    "    checkout_res = run_command(f\"git checkout {branch}\", cwd=LOCAL_PATH)\n",
    "    run_command(f\"git pull origin {branch}\", cwd=LOCAL_PATH)\n",
    "    \n",
    "    if checkout_res is None:\n",
    "        print(f\"âŒ Failed to checkout {branch}, skipping.\")\n",
    "        continue\n",
    "\n",
    "    # 2. å®‰è£ä¾è³´ (ä½¿ç”¨ç›®å‰çš„ Jupyter Python Kernel)\n",
    "    req_path = os.path.join(LOCAL_PATH, \"requirements.txt\")\n",
    "    if os.path.exists(req_path):\n",
    "        print(\"ğŸ“¦ Installing requirements.txt...\")\n",
    "        # -q å®‰éœæ¨¡å¼ï¼Œé¿å… log çˆ†ç‚¸\n",
    "        run_command(f\"\\\"{sys.executable}\\\" -m pip install -r requirements.txt -q\", cwd=LOCAL_PATH)\n",
    "    else:\n",
    "        print(\"âš ï¸ No requirements.txt found. Snyk might report inaccurate results.\")\n",
    "\n",
    "    # 3. åŸ·è¡Œ Snyk Monitor\n",
    "    # å»ºæ§‹ Project Name: e.g. \"MyApp-feature-login\"\n",
    "    proj_name = f\"{PROJECT_PREFIX}-{branch}\"\n",
    "    \n",
    "    # Snyk æŒ‡ä»¤\n",
    "    cmd = f\"snyk monitor --target-reference=\\\"{branch}\\\" --project-name=\\\"{proj_name}\\\"\"\n",
    "    if SNYK_ORG_ID:\n",
    "        cmd += f\" --org={SNYK_ORG_ID}\"\n",
    "\n",
    "    print(f\"ğŸ›¡ï¸ Sending snapshot to Snyk (Project: {proj_name})...\")\n",
    "    snyk_out = run_command(cmd, cwd=LOCAL_PATH)\n",
    "\n",
    "    if snyk_out and \"Explore this snapshot\" in snyk_out:\n",
    "        print(f\"âœ… Success! Snapshot uploaded for {branch}\")\n",
    "    else:\n",
    "        print(f\"âŒ Snyk Monitor failed for {branch}\")\n",
    "        if snyk_out:\n",
    "            # å°å‡ºæœ€å¾Œ 300 å­—å…ƒé™¤éŒ¯\n",
    "            print(f\"Debug Log: ...{snyk_out[-300:]}\")\n",
    "            \n",
    "    # ä¼‘æ¯ 2 ç§’é¿å… API Rate Limit\n",
    "    time.sleep(2)\n",
    "\n",
    "print(\"\\nğŸ‰ All branches processed! (è¨˜å¾—å»æ¸…ç©º Temp è³‡æ–™å¤¾å–”)\")"
   ]
  }
 ],
 "metadata": {
  "kernelspec": {
   "display_name": "Python 3",
   "language": "python",
   "name": "python3"
  },
  "language_info": {
   "codemirror_mode": {
    "name": "ipython",
    "version": 3
   },
   "file_extension": ".py",
   "mimetype": "text/x-python",
   "name": "python",
   "nbconvert_exporter": "python",
   "pygments_lexer": "ipython3",
   "version": "3.8.5"
  }
 },
 "nbformat": 4,
 "nbformat_minor": 5
}
