{
 "cells": [
  {
   "cell_type": "code",
   "execution_count": null,
   "metadata": {},
   "outputs": [],
   "source": [
    "# === Cell 1: è¨­å®šèˆ‡èªè­‰ (äº’å‹•å¼è¦–çª—ç™»å…¥ & UTF-8 Logging) ===\n",
    "import os\n",
    "import sys\n",
    "import io\n",
    "import logging\n",
    "from datetime import datetime\n",
    "from dotenv import load_dotenv\n",
    "from msal import PublicClientApplication\n",
    "import requests\n",
    "\n",
    "# è®€å– .env\n",
    "load_dotenv()\n",
    "\n",
    "# === Logging è¨­å®š ===\n",
    "os.makedirs(\"output\", exist_ok=True)\n",
    "log_file = f\"output/aer_{datetime.now().strftime('%Y%m%d_%H%M%S')}.log\"\n",
    "\n",
    "logger = logging.getLogger(\"aer\")\n",
    "logger.handlers.clear()\n",
    "logger.setLevel(logging.INFO)\n",
    "\n",
    "def _get_console_stream():\n",
    "    s = getattr(sys, \"stdout\", None)\n",
    "    try:\n",
    "        if s and hasattr(s, \"reconfigure\"):\n",
    "            s.reconfigure(encoding=\"utf-8\")\n",
    "            if hasattr(sys.stderr, \"reconfigure\"):\n",
    "                sys.stderr.reconfigure(encoding=\"utf-8\")\n",
    "            return s\n",
    "    except Exception: pass\n",
    "    try:\n",
    "        buf = getattr(s, \"buffer\", None)\n",
    "        if buf: return io.TextIOWrapper(buf, encoding=\"utf-8\", errors=\"replace\")\n",
    "    except Exception: pass\n",
    "    return None\n",
    "\n",
    "formatter = logging.Formatter('%(asctime)s | %(levelname)s | %(message)s')\n",
    "ch = logging.StreamHandler(_get_console_stream())\n",
    "ch.setFormatter(formatter)\n",
    "logger.addHandler(ch)\n",
    "fh = logging.FileHandler(log_file, encoding=\"utf-8\")\n",
    "fh.setFormatter(formatter)\n",
    "logger.addHandler(fh)\n",
    "\n",
    "# === Azure AD ===\n",
    "TENANT_ID = os.getenv(\"AZURE_TENANT_ID\")\n",
    "CLIENT_ID = os.getenv(\"AZURE_CLIENT_ID\")\n",
    "SHAREPOINT_HOST = os.getenv(\"SHAREPOINT_HOST\", \"davidshih.sharepoint.com\")\n",
    "SITE_NAME = os.getenv(\"SITE_NAME\", \"aer\")\n",
    "APP_NAME = \"2025 Entitlement Review\"\n",
    "BASE_PATH = APP_NAME\n",
    "SENDER_EMAIL = os.getenv(\"SENDER_EMAIL\")\n",
    "\n",
    "SCOPES = [\n",
    "    \"User.Read.All\",         # è®€å–ä½ çš„å€‹äººæª”æ¡ˆ\n",
    "    \"Mail.Send\",\n",
    "    \"Mail.Read\",         # è®€å–ä½ çš„ Email (Copilot æ ¸å¿ƒåŠŸèƒ½)\n",
    "    \"Files.Read.All\",    # è®€å– OneDrive/SharePoint æª”æ¡ˆ\n",
    "    \"Sites.Read.All\",    # æœå°‹ SharePoint ç¶²ç«™\n",
    "    \"People.Read.All\", # å‚™ç”¨\n",
    "    \"OnlineMeetingTranscript.Read.All\",\n",
    "    \"Chat.Read\",\n",
    "    \"ChannelMessage.Read.All\",\n",
    "    \"ExternalItem.Read.All\"\n",
    "]\n",
    "\n",
    "app = PublicClientApplication(CLIENT_ID, authority=f\"https://login.microsoftonline.com/{TENANT_ID}\")\n",
    "\n",
    "print(\"ğŸš€ æ­£åœ¨é–‹å•Ÿç€è¦½å™¨é€²è¡Œç™»å…¥...\")\n",
    "interactive_result = app.acquire_token_interactive(scopes=SCOPES, prompt=\"select_account\")\n",
    "\n",
    "if \"access_token\" not in interactive_result:\n",
    "    raise RuntimeError(f\"ç™»å…¥å¤±æ•—: {interactive_result.get('error_description')}\")\n",
    "\n",
    "headers = {\"Authorization\": f\"Bearer {interactive_result['access_token']}\"}\n",
    "logger.info(\"âœ… ç™»å…¥æˆåŠŸ\")\n",
    "logger.info(f\"Log æª”æ¡ˆ: {log_file}\")"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "metadata": {},
   "outputs": [],
   "source": [
    "# === Cell 4 (V12b): M365 Copilot åŒæ­¥ç‰ˆ + 500 é‡è©¦ & è©³ç´°éŒ¯èª¤ ===\n",
    "import ipywidgets as widgets\n",
    "from IPython.display import display\n",
    "import requests, json, time, re, uuid\n",
    "\n",
    "GRAPH_ROOT = \"https://graph.microsoft.com/beta\"\n",
    "# ä½ å…ˆå‰å®šç¾©çš„ headers è‡³å°‘è¦å« Authorizationï¼›é€™è£¡è£œ Content-Type\n",
    "headers[\"Content-Type\"] = \"application/json\"\n",
    "\n",
    "debug_log = []\n",
    "def log(msg):\n",
    "    timestamp = time.strftime(\"%H:%M:%S\")\n",
    "    debug_log.append(f\"[{timestamp}] {msg}\")\n",
    "\n",
    "def clean_bot_text(text):\n",
    "    if not text: return \"\"\n",
    "    text = text.replace(\"\\n\", \"<br>\")\n",
    "    text = re.sub(r'\\[(.*?)\\]\\((.*?)\\)',\n",
    "                  r'<a href=\"\\\\2\" target=\"_blank\" style=\"color:#0078d4\">\\\\1</a>', text)\n",
    "    return text\n",
    "\n",
    "conv_id = None\n",
    "def ensure_conversation():\n",
    "    global conv_id\n",
    "    if conv_id: return conv_id\n",
    "    log(\"â• å»ºç«‹æ–°å°è©±\")\n",
    "    r = requests.post(f\"{GRAPH_ROOT}/copilot/conversations\", headers=headers, json={}, timeout=15)\n",
    "    r.raise_for_status()\n",
    "    conv_id = r.json()[\"id\"]\n",
    "    log(f\"âœ… conv_id: {conv_id}\")\n",
    "    return conv_id\n",
    "\n",
    "def post_chat(cid, body):\n",
    "    # é‡å° 500 åšæœ€å¤š 3 æ¬¡é‡è©¦ï¼ˆæŒ‡æ•¸é€€é¿ï¼‰\n",
    "    for attempt in range(3):\n",
    "        try:\n",
    "            r = requests.post(f\"{GRAPH_ROOT}/copilot/conversations/{cid}/chat\",\n",
    "                              headers=headers, json=body, timeout=30)\n",
    "            log(f\"ğŸ“¥ Status: {r.status_code}\")\n",
    "            if r.status_code < 500:\n",
    "                return r  # æˆåŠŸæˆ– 4xx ç›´æ¥å›å‚³\n",
    "        except Exception as e:\n",
    "            log(f\"âš ï¸ Exception: {e}\")\n",
    "        sleep = 2 ** attempt\n",
    "        log(f\"ğŸ” 500/Exceptionï¼Œ{sleep}s å¾Œé‡è©¦ ({attempt+1}/3)\")\n",
    "        time.sleep(sleep)\n",
    "    return r  # å›å‚³æœ€å¾Œä¸€æ¬¡çµæœ\n",
    "\n",
    "def chat_once(user_text, tz=\"America/Los_Angeles\"):\n",
    "    cid = ensure_conversation()\n",
    "    body = {\n",
    "        \"message\": { \"text\": user_text },\n",
    "        \"locationHint\": { \"timeZone\": tz }  # å¿…å¡«\n",
    "        # è‹¥è¦é—œæ‰ Web æœå°‹å¯åŠ ï¼š\n",
    "        # \"contextualResources\": { \"webContext\": { \"isWebEnabled\": False } }\n",
    "    }\n",
    "    log(\"âœ‰ï¸ POST /chat\")\n",
    "    r = post_chat(cid, body)\n",
    "\n",
    "    try:\n",
    "        r.raise_for_status()\n",
    "    except Exception:\n",
    "        # æŠŠæ›´å¤šç´°ç¯€å¡å› UI\n",
    "        err_json = \"\"\n",
    "        try:\n",
    "            err_json = json.dumps(r.json(), ensure_ascii=False)\n",
    "        except:\n",
    "            err_json = r.text\n",
    "        req_id = r.headers.get(\"request-id\", \"n/a\")\n",
    "        cli_id = r.headers.get(\"client-request-id\", \"n/a\")\n",
    "        return f\"âŒ HTTP {r.status_code}<br>request-id: {req_id}<br>client-request-id: {cli_id}<br>body: {err_json}\"\n",
    "\n",
    "    msgs = r.json().get(\"messages\", [])\n",
    "    if not msgs: return \"(empty response)\"\n",
    "    return msgs[-1].get(\"text\", \"(no text)\")\n",
    "\n",
    "# ========= UI =========\n",
    "chat_history_list = []\n",
    "ui_style = \"\"\"<style> .chat-app { font-family:'Segoe UI',sans-serif;max-width:800px;margin:0 auto; }\n",
    ".chat-window { background:#fff;border:1px solid #e0e0e0;border-radius:8px;height:400px;overflow-y:auto;padding:20px; }\n",
    ".msg-row { margin-bottom:15px;display:flex;flex-direction:column; }\n",
    ".msg-user { align-items:flex-end; } .msg-bot { align-items:flex-start; }\n",
    ".bubble { padding:10px 16px;max-width:80%;line-height:1.5;font-size:15px;position:relative;word-wrap:break-word; }\n",
    ".bubble-user { background:#0078D4;color:white;border-radius:18px 18px 4px 18px; }\n",
    ".bubble-bot { background:#f3f2f1;color:#201f1e;border-radius:18px 18px 18px 4px;border:1px solid #e1dfdd; }\n",
    ".debug-box { font-family:monospace;font-size:11px;color:#666;background:#f0f0f0;border:1px dashed #ccc;\n",
    "             padding:8px;margin-top:10px;height:120px;overflow-y:auto; } code { background:#e1dfdd;padding:2px 6px;\n",
    "             border-radius:3px;font-size:12px; } </style>\"\"\"\n",
    "\n",
    "header_w = widgets.HTML(\"<h2>ğŸ¤– M365 Copilot (V12b - åŒæ­¥ API)</h2>\")\n",
    "history_w = widgets.HTML(value=ui_style + \"<div class='chat-app'><div class='chat-window'></div></div>\")\n",
    "debug_w = widgets.HTML(value=\"<div class='debug-box'>Ready.</div>\")\n",
    "input_w = widgets.Text(placeholder=\"è©¦è©¦è¼¸å…¥: Hello\", layout=widgets.Layout(width='80%'))\n",
    "send_btn_w = widgets.Button(description=\"Send\", button_style='primary', layout=widgets.Layout(width='18%'))\n",
    "loading_w = widgets.HTML(value=\"\", layout=widgets.Layout(height='30px'))\n",
    "\n",
    "def render_chat():\n",
    "    history_w.value = f\"{ui_style}<div class='chat-app'><div class='chat-window'>{''.join(chat_history_list)}</div></div>\"\n",
    "\n",
    "def update_debug():\n",
    "    debug_w.value = \"<div class='debug-box'>\" + \"<br>\".join(debug_log[-12:]) + \"</div>\"\n",
    "\n",
    "def on_chat_submit(b):\n",
    "    user_text = input_w.value.strip()\n",
    "    if not user_text: return\n",
    "    debug_log.clear(); log(\"ğŸ User send\")\n",
    "    chat_history_list.append(f\"<div class='msg-row msg-user'><div class='bubble bubble-user'>{user_text}</div></div>\")\n",
    "    render_chat(); update_debug()\n",
    "    input_w.value = \"\"; input_w.disabled = True; send_btn_w.disabled = True\n",
    "    loading_w.value = \"<span style='color:#0078D4; margin-left:10px;'>â³ Copilot æ­£åœ¨å›è¦†...</span>\"\n",
    "    try:\n",
    "        reply = chat_once(user_text)\n",
    "    except Exception as e:\n",
    "        reply = f\"âŒ Error: {e}\"\n",
    "        log(str(e))\n",
    "    update_debug()\n",
    "    chat_history_list.append(f\"<div class='msg-row msg-bot'><div class='bubble bubble-bot'>{clean_bot_text(reply)}</div></div>\")\n",
    "    render_chat()\n",
    "    loading_w.value = \"\"; input_w.disabled = False; send_btn_w.disabled = False\n",
    "\n",
    "send_btn_w.on_click(on_chat_submit)\n",
    "input_w.on_submit(on_chat_submit)\n",
    "\n",
    "display(widgets.VBox([header_w, history_w, loading_w, input_w, send_btn_w, debug_w]))"
   ]
  }
 ],
 "metadata": {
  "kernelspec": {
   "display_name": "Python 3",
   "language": "python",
   "name": "python3"
  },
  "language_info": {
   "codemirror_mode": {
    "name": "ipython",
    "version": 3
   },
   "file_extension": ".py",
   "mimetype": "text/x-python",
   "name": "python",
   "nbconvert_exporter": "python",
   "pygments_lexer": "ipython3",
   "version": "3.8.5"
  }
 },
 "nbformat": 4,
 "nbformat_minor": 4
}