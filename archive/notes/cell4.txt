# === AER - Advanced Enrichment & Reviewer Assignment Logic ===
import pandas as pd
import numpy as np
import requests
import re
import io
import ipywidgets as widgets
from IPython.display import display, clear_output
from openpyxl import load_workbook
from openpyxl.worksheet.datavalidation import DataValidation
from openpyxl.utils import get_column_letter

# --- 1. Helper Functions (å·¥å…·äººå‡½å¼) ---

def is_valid_email(s):
    """ç°¡å–®çš„æ­£å‰‡è¡¨é”å¼åˆ¤æ–·æ˜¯å¦ç‚º Email"""
    if not isinstance(s, str): return False
    regex = r'^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$'
    return re.match(regex, s.strip()) is not None

def detect_columns(df):
    """
    ä¸çœ‹æ¨™é¡Œï¼Œç›²æ¸¬å‰å…©æ¬„ï¼Œåˆ¤æ–·å“ªä¸€æ¬„æ˜¯ Emailï¼Œå“ªä¸€æ¬„æ˜¯ Nameã€‚
    å›å‚³: (email_col_name, name_col_name)
    """
    # å–å‰ 10 ç­†è³‡æ–™ä¾†æ¸¬è©¦
    sample = df.head(10)
    col0 = df.columns[0]
    col1 = df.columns[1]
    
    # è¨ˆç®—ç¬¦åˆ Email æ ¼å¼çš„æ•¸é‡
    col0_score = sum(1 for x in sample[col0] if is_valid_email(str(x)))
    col1_score = sum(1 for x in sample[col1] if is_valid_email(str(x)))
    
    if col0_score > col1_score:
        return col0, col1  # ç¬¬ä¸€æ¬„æ˜¯ Emailï¼Œç¬¬äºŒæ¬„æ˜¯ Name
    else:
        return col1, col0  # ç¬¬äºŒæ¬„æ˜¯ Emailï¼Œç¬¬ä¸€æ¬„æ˜¯ Name

def normalize_name(name):
    """å°‡åå­—è½‰å°å¯«ä¸¦ç§»é™¤æ¨™é»ç¬¦è™Ÿï¼Œç”¨æ–¼æ¨¡ç³Šæ¯”å°"""
    if not isinstance(name, str): return ""
    return re.sub(r'[^a-zA-Z0-9]', '', name.lower())

def check_name_match(input_name, ad_name):
    """æ¯”å°è¼¸å…¥åå­—èˆ‡ AD åå­—æ˜¯å¦å¤§æ¦‚ç›¸ç¬¦ (é˜²å‘†æª¢æŸ¥)"""
    n1 = normalize_name(str(input_name))
    n2 = normalize_name(str(ad_name))
    # å¦‚æœå…¶ä¸­ä¸€æ–¹åŒ…å«å¦ä¸€æ–¹ï¼Œè¦–ç‚º Match (ä¾‹å¦‚ John Doe vs Doe, John)
    return (n1 in n2) or (n2 in n1)

# å¿«å– AD æŸ¥è©¢çµæœï¼Œé¿å…é‡è¤‡æ‰“ API
ad_cache = {}

def fetch_ad_profile(email):
    """å» Azure AD æŸ¥è©³ç´°è³‡æ–™"""
    email = str(email).strip()
    if not email or not is_valid_email(email): 
        return {"status": "Invalid Email", "name": "N/A", "dept": "N/A", "active": False}
    
    if email in ad_cache: return ad_cache[email]
    
    # å‘¼å« Graph API (å‡è¨­ headers å·²åœ¨å‰é¢çš„ Cell è¨­å®šå¥½)
    url = f"https://graph.microsoft.com/v1.0/users/{email}?$select=id,displayName,department,accountEnabled,mail"
    try:
        resp = requests.get(url, headers=headers) # headers ä¾†è‡ªå…¨åŸŸè®Šæ•¸
        if resp.status_code == 200:
            data = resp.json()
            res = {
                "status": "Found",
                "name": data.get("displayName", "Unknown"),
                "dept": data.get("department") or "N/A",
                "active": data.get("accountEnabled", False)
            }
        else:
            res = {"status": "Not Found", "name": "N/A", "dept": "N/A", "active": False}
    except Exception as e:
        res = {"status": "Error", "name": "Error", "dept": "Error", "active": False}
    
    ad_cache[email] = res
    return res

# --- 2. Main Logic UI (ä¸»ç¨‹å¼) ---

w_upload_list = widgets.FileUpload(accept='.xlsx, .csv', description="1. User List")
w_upload_map = widgets.FileUpload(accept='.csv', description="2. Reviewer Map")
btn_run = widgets.Button(description="ğŸš€ Process & Generate", button_style='danger')
out_log = widgets.Output()

def process_data(b):
    out_log.clear_output()
    if not w_upload_list.value or not w_upload_map.value:
        with out_log: print("âŒ è«‹å…ˆä¸Šå‚³å…©å€‹æª”æ¡ˆ (User List å’Œ Reviewer Mapping CSV)ï¼")
        return

    b.disabled = True
    b.description = "Processing..."
    
    try:
        # --- A. è®€å– Reviewer Mapping File ---
        map_file = w_upload_map.value[0]
        df_map = pd.read_csv(io.BytesIO(map_file['content']))
        
        # å»ºç«‹å¿«é€ŸæŸ¥æ‰¾å­—å…¸ (è½‰å°å¯«ä»¥é˜²å¤§å°å¯«å·®ç•°)
        # å‡è¨­ CSV æ¨™é¡Œå›ºå®šç‚º: "email address", "department", "reviewer"
        # æ¸…ç†æ¬„ä½åç¨± (ç§»é™¤å¤šé¤˜ç©ºç™½)
        df_map.columns = [c.strip().lower() for c in df_map.columns]
        
        # å»ºç«‹å…©å€‹ Lookup Table
        # 1. Email ç›´æ¥å°æ‡‰
        email_map = dict(zip(df_map['email address'].str.lower().str.strip(), df_map['reviewer']))
        # 2. éƒ¨é–€å°æ‡‰
        dept_map = dict(zip(df_map['department'].str.lower().str.strip(), df_map['reviewer']))
        
        with out_log: print(f"âœ… Mapping Loaded: {len(email_map)} User Rules, {len(dept_map)} Dept Rules.")

        # --- B. è®€å– User List & åˆ¤æ–·æ¬„ä½ ---
        list_file = w_upload_list.value[0]
        fname = list_file['name']
        if fname.endswith('.csv'): df_user = pd.read_csv(io.BytesIO(list_file['content']))
        else: df_user = pd.read_excel(io.BytesIO(list_file['content']))
        
        # æ™ºæ…§åˆ¤æ–·æ¬„ä½ (ä¸çœ‹æ¨™é¡Œï¼Œçœ‹å…§å®¹)
        col_email, col_name = detect_columns(df_user)
        with out_log: print(f"ğŸ” Detected Columns - Email: '{col_email}', Name: '{col_name}'")

        # --- C. è³‡æ–™è™•ç†è¿´åœˆ ---
        processed_rows = []
        prog = widgets.IntProgress(min=0, max=len(df_user), description='Enriching:')
        display(prog)
        
        for idx, row in df_user.iterrows():
            raw_email = str(row[col_email]).strip()
            raw_name = str(row[col_name]).strip()
            
            # 1. æŸ¥è©¢ AD
            ad_info = fetch_ad_profile(raw_email)
            
            # 2. åˆ¤æ–· Active
            is_active_str = "Active" if ad_info['active'] else "Inactive"
            if ad_info['status'] == "Not Found": is_active_str = "User Not Found"
            
            # 3. åˆ¤æ–· Name Match
            is_match = check_name_match(raw_name, ad_info['name'])
            match_str = "Yes" if is_match else "Typo/Mismatch"
            if ad_info['status'] != "Found": match_str = "N/A"
            
            # 4. æŒ‡æ´¾ Reviewer (æ ¸å¿ƒé‚è¼¯)
            assigned_reviewer = ""
            # å„ªå…ˆæ¬Š 1: æª¢æŸ¥ Email Mapping
            if raw_email.lower() in email_map:
                assigned_reviewer = email_map[raw_email.lower()]
            # å„ªå…ˆæ¬Š 2: æª¢æŸ¥ éƒ¨é–€ Mapping (ä½¿ç”¨ AD æŠ“å›ä¾†çš„éƒ¨é–€)
            elif ad_info['dept'].lower().strip() in dept_map:
                assigned_reviewer = dept_map[ad_info['dept'].lower().strip()]
            # å„ªå…ˆæ¬Š 3: ç©ºå€¼
            else:
                assigned_reviewer = "" # No Match Found

            # 5. çµ„åˆæ–°è³‡æ–™
            # è¤‡è£½åŸå§‹è³‡æ–™
            new_row = row.to_dict()
            # åŠ ä¸Šæ–°æ¬„ä½
            new_row.update({
                "user_name": ad_info['name'],
                "user_email": raw_email, # ç¢ºä¿æœ‰ä¸€æ¬„æ¨™æº–çš„ key
                "is_match": match_str,
                "is_active": is_active_str,
                "department": ad_info['dept'],
                "Reviewer": assigned_reviewer,
                "Reviewer's Response": "",      # ç•™ç™½çµ¦ä¸‹æ‹‰é¸å–®
                "Details of Access Change": ""  # ç•™ç™½
            })
            processed_rows.append(new_row)
            prog.value += 1
            
        # --- D. ç”¢å‡º Excel & å¢åŠ ä¸‹æ‹‰é¸å–® ---
        df_final = pd.DataFrame(processed_rows)
        
        # å®šç¾©æœ€å¾Œè¼¸å‡ºçš„æ¬„ä½é †åº (åŸå§‹æ¬„ä½ + æ–°å¢æ¬„ä½)
        # æ’é™¤ user_email é‡è¤‡é¡¯ç¤º (å¦‚æœåŸå§‹æ¬„ä½å·²ç¶“æœ‰äº†)ï¼Œé€™è£¡å¼·åˆ¶æ”¾åœ¨å¾Œé¢æ–¹ä¾¿çœ‹
        final_cols = list(df_user.columns) + [
            "user_name", "is_match", "is_active", "department", 
            "Reviewer", "Reviewer's Response", "Details of Access Change"
        ]
        # å»é™¤é‡è¤‡æ¬„ä½ (å¦‚æœ user_email åå­—è¡çª)
        final_cols = list(dict.fromkeys(final_cols))
        
        df_export = df_final[final_cols]
        output_path = "output/Enhanced_Review_List.xlsx"
        df_export.to_excel(output_path, index=False)
        
        # ä½¿ç”¨ OpenPyXL åŠ ä¸Šä¸‹æ‹‰é¸å–®
        wb = load_workbook(output_path)
        ws = wb.active
        
        # æ‰¾åˆ° "Reviewer's Response" æ˜¯ç¬¬å¹¾æ¬„ (1-based index)
        target_col_idx = None
        for col_idx, cell in enumerate(ws[1], 1):
            if cell.value == "Reviewer's Response":
                target_col_idx = col_idx
                break
        
        if target_col_idx:
            # å»ºç«‹è³‡æ–™é©—è­‰ç‰©ä»¶ (Dropdown)
            dv = DataValidation(type="list", formula1='"Approved,Denied,Change Required"', allow_blank=True)
            dv.error = 'Your entry is not in the list'
            dv.errorTitle = 'Invalid Entry'
            dv.prompt = 'Please select your responses from the drop-down menu'
            dv.promptTitle = 'Action Required'
            
            # å¥—ç”¨åˆ°è©²æ¬„ä½çš„æ‰€æœ‰è³‡æ–™åˆ— (å¾ç¬¬2åˆ—åˆ°æœ€å¾Œ)
            col_letter = get_column_letter(target_col_idx)
            dv.add(f'{col_letter}2:{col_letter}{len(df_export)+1}')
            ws.add_data_validation(dv)
            
            wb.save(output_path)
        
        with out_log:
            print("\nğŸ‰ Success! Process Completed.")
            print(f"ğŸ“‚ Output File: {output_path}")
            display(df_export.head())

    except Exception as e:
        with out_log: print(f"âŒ Error: {e}")
        import traceback
        traceback.print_exc()
    
    b.disabled = False
    b.description = "ğŸš€ Process & Generate"

btn_run.on_click(process_data)
display(widgets.VBox([
    widgets.HTML("<h3>ğŸ•µï¸â€â™‚ï¸ AER - Smart Review List Generator</h3>"),
    widgets.HTML("<p>é‚è¼¯ï¼šè‡ªå‹•åµæ¸¬ Email/Name -> æŸ¥ AD ç‹€æ…‹ -> æ¯”å°åå­— -> ä¾ç…§ <b>User > Dept</b> é †åºæŒ‡æ´¾ Reviewerã€‚</p>"),
    w_upload_list, w_upload_map, btn_run, out_log
]))