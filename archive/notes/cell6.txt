# === Cell 6: Email Notification (Merge Capability & Custom Template) ===
import ipywidgets as widgets
from urllib.parse import quote
from datetime import datetime, timedelta
import requests
import pandas as pd
from IPython.display import display, clear_output, HTML

# --- 1. Helper Functions ---
def get_email(name): 
    if not name: return ""
    try:
        clean = quote(name.split("(")[0].strip())
        url = f"https://graph.microsoft.com/v1.0/users?$filter=startswith(displayName,'{clean}')&$select=mail,userPrincipalName"
        res = requests.get(url, headers=headers).json().get('value')
        if res: return res[0].get('mail') or res[0].get('userPrincipalName')
    except: pass
    return ""

def fmt_date_long(iso_date_str):
    """Converts ISO date to 'December 10, 2025' format"""
    if not iso_date_str or pd.isna(iso_date_str): return "Unknown Date"
    try:
        dt_str = str(iso_date_str).replace('Z', '').split('.')[0]
        dt = datetime.fromisoformat(dt_str)
        return dt.strftime("%B %d, %Y")
    except: return str(iso_date_str)

def calc_due_date_long(iso_date_str):
    """Calculates Due Date (Created + 14 days) in 'December 24, 2025' format"""
    if not iso_date_str or pd.isna(iso_date_str): return "ASAP"
    try:
        dt_str = str(iso_date_str).replace('Z', '').split('.')[0]
        dt = datetime.fromisoformat(dt_str)
        due = dt + timedelta(days=14)
        return due.strftime("%B %d, %Y")
    except: return "ASAP"

# --- 2. Data Preparation ---
if 'df' not in globals() or df.empty:
    display(widgets.HTML("<h4 style='color:red'>‚ö†Ô∏è No data found. Run Cell 4 first.</h4>"))
else:
    # Filter Pending Items
    pending_df = df[df['is_missing'] == True].copy()
    
    # Group by App & Reviewer to get counts
    targets = pending_df.groupby(["Category", "App_Name", "reviewer", "folder_url"]).agg(
        missing_count=("is_missing", "count"),
        file_date_raw=("File_Created_Date", "min") 
    ).reset_index()

    # Apply Manual Overrides Filtering
    final_targets = []
    notes_db = manual_data_store if 'manual_data_store' in globals() else {}
    
    print("üîç Looking up emails for pending reviewers...")
    
    # Cache emails to avoid repeated API calls during re-renders
    email_cache = {} 
    
    raw_data_list = []
    for _, r in targets.iterrows():
        app_key = f"{r['Category']} > {r['App_Name']}"
        rev_key = r['reviewer']
        
        # Check Overrides
        app_node = notes_db.get(app_key, {})
        if app_node.get("app_status") in ["Force Completed", "N/A"]: continue
        rev_override = app_node.get("reviewers", {}).get(rev_key, {}).get("override", "-")
        if rev_override in ["Mark Done", "Waived", "Escalated"]: continue
        
        # Get Email
        if rev_key not in email_cache:
            email_cache[rev_key] = get_email(rev_key)
            
        raw_data_list.append({
            "App_Name": r['App_Name'], 
            "reviewer": r['reviewer'],
            "missing": r['missing_count'], 
            "folder_url": r['folder_url'],
            "sent_date": fmt_date_long(r['file_date_raw']),
            "due_date": calc_due_date_long(r['file_date_raw']),
            "email": email_cache[rev_key]
        })
    
    clear_output()

    # --- 3. UI Construction ---
    
    # Global Settings
    current_year = datetime.now().year
    
    # Templates (Apple Bank Style)
    default_subj_single = f"REMINDER - {current_year} {{app_name}} Entitlement Review"
    default_subj_merge = f"REMINDER - {current_year} Entitlement Reviews Action Required"
    
    default_body = (
        "The Information Security team is sending you a reminder to complete the <b>{app_name}</b> entitlement review that was sent to you on <b>{sent_date}</b>.<br><br>"
        "The review was due on <b>{due_date}</b>. Please complete this review as soon as possible as it is now overdue. Your prompt assistance to this matter is appreciated.<br><br>"
        "<b>Review Details:</b>"
        "<ul><li>Pending Items: <b>{missing}</b></li>"
        "<li>Link: <a href='{link}'>Open Access Review Folder</a></li></ul><br>"
        "Sincerely,<br>"
        "Apple Bank's Information Security Team"
    )

    # UI Widgets
    w_merge = widgets.Checkbox(value=True, description="<b>üîó Merge Apps by Reviewer</b> (Combine multiple apps into one email)", indent=False)
    w_subject_tpl = widgets.Text(value=default_subj_merge, description="<b>Subject:</b>", layout=widgets.Layout(width='98%'))
    w_cc_global = widgets.Text(value="", description="<b>Global CC:</b>", placeholder="manager@applebank.com", layout=widgets.Layout(width='50%'))
    w_body_tpl = widgets.Textarea(value=default_body.replace("<br>", "\n"), layout=widgets.Layout(width='100%', height='150px'))
    btn_refresh = widgets.Button(description="üîÑ Refresh List", button_style='info', layout=widgets.Layout(width='200px'))
    
    container_rows = widgets.VBox()

    def render_rows(b=None):
        container_rows.children = (widgets.Label("Loading..."),)
        is_merged = w_merge.value
        
        # Adjust Subject Template based on mode
        if is_merged and "{app_name}" in w_subject_tpl.value:
            w_subject_tpl.value = default_subj_merge
        elif not is_merged and "{app_name}" not in w_subject_tpl.value:
            w_subject_tpl.value = default_subj_single

        # Prepare Data Grouping
        df_raw = pd.DataFrame(raw_data_list)
        if df_raw.empty:
            container_rows.children = (widgets.HTML("<h3>‚úÖ No pending emails to send!</h3>"),)
            return

        final_rows = []
        
        if is_merged:
            # Group by Reviewer
            grouped = df_raw.groupby(['reviewer', 'email'])
            for (rev, mail), group in grouped:
                # Create Merged Context
                apps_html = "<table border='1' style='border-collapse:collapse; width:100%; font-size:12px; border:1px solid #ddd'>"
                apps_html += "<tr style='background:#f3f3f3'><th>App Name</th><th>Sent Date</th><th>Due Date</th><th>Missing</th><th>Link</th></tr>"
                
                for _, row in group.iterrows():
                    apps_html += f"<tr><td style='padding:5px'>{row['App_Name']}</td><td style='padding:5px'>{row['sent_date']}</td><td style='padding:5px'>{row['due_date']}</td><td style='padding:5px; text-align:center'>{row['missing']}</td><td style='padding:5px'><a href='{row['folder_url']}'>Open</a></td></tr>"
                apps_html += "</table>"

                final_rows.append({
                    "key": rev,
                    "reviewer": rev,
                    "email": mail,
                    "ctx": {
                        "app_name": "following applications", # Fallback for template
                        "sent_date": "previous dates",
                        "due_date": "recently",
                        "missing": int(group['missing'].sum()),
                        "link": "#"
                    },
                    "is_merged": True,
                    "merged_html": apps_html
                })
        else:
            # Single Rows
            for idx, r in df_raw.iterrows():
                final_rows.append({
                    "key": f"{r['reviewer']}_{r['App_Name']}",
                    "reviewer": r['reviewer'],
                    "email": r['email'],
                    "ctx": {
                        "app_name": r['App_Name'],
                        "sent_date": r['sent_date'],
                        "due_date": r['due_date'],
                        "missing": r['missing'],
                        "link": r['folder_url']
                    },
                    "is_merged": False
                })

        # Generate UI Rows
        ui_items = []
        row_logic_store = {}

        for item in final_rows:
            key = item['key']
            
            # Info Block
            email_color = "#0078d4" if item['email'] else "red"
            email_txt = item['email'] if item['email'] else "(No Email Found)"
            
            if item['is_merged']:
                info_html = (f"<b>üë§ {item['reviewer']}</b><br>"
                             f"<span style='color:{email_color}'>{email_txt}</span><br>"
                             f"<span style='color:darkorange'>Combine {item['ctx']['missing']} items</span>")
            else:
                info_html = (f"<b>üë§ {item['reviewer']}</b><br>"
                             f"üìÇ {item['ctx']['app_name']}<br>"
                             f"<span style='color:{email_color}'>{email_txt}</span>")

            w_chk = widgets.Checkbox(value=True, layout=widgets.Layout(width='30px'))
            w_info = widgets.HTML(info_html, layout=widgets.Layout(width='200px'))
            
            # Preview Generation
            tpl_body = w_body_tpl.value.replace("\n", "<br>")
            
            if item['is_merged']:
                # Custom injection for Merged
                # We replace the list part of the standard template with the table
                base_text = "The Information Security team is sending you a reminder to complete the entitlement reviews for the following applications:<br><br>"
                base_text += item['merged_html'] + "<br><br>"
                base_text += "Please complete these reviews as soon as possible. Your prompt assistance to this matter is appreciated.<br><br>Sincerely,<br>Apple Bank's Information Security Team"
                final_preview_html = base_text
            else:
                final_preview_html = tpl_body.format(**item['ctx'])

            w_preview = widgets.HTML(value=f"<div style='font-family:sans-serif; font-size:12px; padding:5px; color:#333'>{final_preview_html}</div>", 
                                     layout=widgets.Layout(width='100%', height='140px', border='1px solid #eee', overflow_y='auto'))
            
            w_email = widgets.Text(value=item['email'], placeholder="Email", layout=widgets.Layout(width='98%'))
            w_btn = widgets.Button(description="üöÄ Send", button_style='warning', layout=widgets.Layout(width='80px'))

            # Action
            def create_sender(k, preview_html, subj_tpl):
                def on_send(b):
                    if not row_logic_store[k]['w_email'].value:
                        b.description = "No Email"; return
                    
                    b.disabled = True; b.description = "..."
                    
                    # Subject Logic
                    try:
                        if item['is_merged']: final_subj = subj_tpl
                        else: final_subj = subj_tpl.format(**item['ctx'])
                    except: final_subj = subj_tpl
                    
                    # API Call
                    try:
                        url = f"https://graph.microsoft.com/v1.0/users/{SENDER_EMAIL}/sendMail"
                        to_list = [{"emailAddress": {"address": row_logic_store[k]['w_email'].value}}]
                        cc_list = [{"emailAddress": {"address": w_cc_global.value.strip()}}] if w_cc_global.value.strip() else []
                        
                        payload = {
                            "message": {
                                "subject": final_subj,
                                "body": {"contentType": "HTML", "content": preview_html},
                                "toRecipients": to_list,
                                "ccRecipients": cc_list
                            }
                        }
                        r = requests.post(url, headers={**headers, "Content-Type": "application/json"}, json=payload)
                        if r.status_code == 202:
                            b.button_style = 'success'; b.description = "Sent"
                            row_logic_store[k]['w_chk'].value = False
                        else:
                            b.button_style = 'danger'; b.description = "Fail"
                            print(r.text)
                    except Exception as e:
                        print(e); b.button_style = 'danger'
                    finally:
                         if b.description != "Sent": b.disabled = False
                return on_send

            w_btn.on_click(create_sender(key, final_preview_html, w_subject_tpl.value))
            
            row_logic_store[key] = {'w_chk': w_chk, 'w_email': w_email}
            
            row_ui = widgets.HBox([
                w_chk, 
                w_info, 
                widgets.VBox([widgets.Label("Preview:"), w_preview], layout=widgets.Layout(flex='1', padding='0 10px')),
                widgets.VBox([widgets.Label("Action:"), w_email, w_btn], layout=widgets.Layout(width='150px'))
            ], layout=widgets.Layout(border='1px solid #ccc', margin='5px 0', padding='5px', align_items='center'))
            
            ui_items.append(row_ui)

        container_rows.children = tuple(ui_items)

    w_merge.observe(render_rows, names='value')
    btn_refresh.on_click(render_rows)
    
    # Render Initial
    render_rows()

    # Layout
    header = widgets.VBox([
        widgets.HTML("<h3>üìß Email Notification Center (Apple Bank Style)</h3>"),
        widgets.HBox([w_merge, btn_refresh]),
        widgets.HTML("<hr>"),
        w_subject_tpl,
        w_cc_global,
        widgets.Label("Body Template (Single App Only - Merged uses automatic table):"),
        w_body_tpl
    ], layout=widgets.Layout(background_color='#f0f4f8', padding='10px', border='1px solid #ccc', margin='0 0 10px 0'))

    display(header, container_rows)