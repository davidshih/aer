{
 "cells": [
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "#### üõ°Ô∏è AER - Smart Access Review Generator (v5.8 Audit-Ready)\n",
    "\n",
    "**Core Features:**\n",
    "1. **Step 1 (Analyze)**: Connects to Azure AD to verify accounts and last login dates.\n",
    "2. **Interactive Review**: \n",
    "   - **Branches vs Depts**: Use the 'Branch' checkbox to filter mapping options.\n",
    "   - **AD Status Intelligence**: Accounts not found or inactive are marked for removal by default.\n",
    "3. **Step 2 (Save)**: Finalizes the Excel report with Data Validation dropdowns."
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "metadata": {},
   "outputs": [],
   "source": [
    "# === Cell 1: Environment & Authentication ===\n",
    "import os, sys, logging, glob, io, re, requests\n",
    "import pandas as pd\n",
    "import ipywidgets as widgets\n",
    "from datetime import datetime\n",
    "from dotenv import load_dotenv\n",
    "from msal import PublicClientApplication\n",
    "from collections import Counter\n",
    "from IPython.display import display, HTML\n",
    "from concurrent.futures import ThreadPoolExecutor\n",
    "from openpyxl import load_workbook\n",
    "from openpyxl.worksheet.datavalidation import DataValidation\n",
    "from openpyxl.utils import get_column_letter\n",
    "\n",
    "# 1. Setup Logging & Paths\n",
    "today = datetime.now().strftime('%Y-%m-%d')\n",
    "BASE_DIR = os.path.join(\"output\", today, \"create\")\n",
    "LOG_DIR = os.path.join(BASE_DIR, \"logs\")\n",
    "MAPPING_DIR = os.path.join(\"input\", \"mapping\")\n",
    "os.makedirs(LOG_DIR, exist_ok=True)\n",
    "\n",
    "log_file = os.path.join(LOG_DIR, f\"aer_create_{today}_{datetime.now().strftime('%H%M')}.log\")\n",
    "logger = logging.getLogger(\"aer\")\n",
    "logger.handlers.clear()\n",
    "logger.setLevel(logging.INFO)\n",
    "fh = logging.FileHandler(log_file, encoding=\"utf-8\")\n",
    "fh.setFormatter(logging.Formatter('%(asctime)s | %(levelname)s | %(message)s'))\n",
    "logger.addHandler(fh)\n",
    "logger.addHandler(logging.StreamHandler(sys.stdout))\n",
    "\n",
    "# 2. Azure AD Engine\n",
    "load_dotenv()\n",
    "headers = {}\n",
    "try:\n",
    "    tid, cid = os.getenv(\"AZURE_TENANT_ID\"), os.getenv(\"AZURE_CLIENT_ID\")\n",
    "    if tid and cid:\n",
    "        app = PublicClientApplication(cid, authority=f\"https://login.microsoftonline.com/{tid}\")\n",
    "        res = app.acquire_token_interactive(scopes=[\"User.Read.All\"], prompt=\"select_account\")\n",
    "        if \"access_token\" in res:\n",
    "            headers = {\"Authorization\": f\"Bearer {res['access_token']}\"}\n",
    "            logger.info(\"Azure AD Auth Successful\")\n",
    "except Exception as e:\n",
    "    logger.error(f\"Authentication failed: {str(e)}\")\n",
    "\n",
    "ad_cache = {}\n",
    "session = requests.Session()\n",
    "\n",
    "def fetch_ad_profile(email):\n",
    "    email = str(email).strip().lower()\n",
    "    if not re.match(r'^[a-z0-9._%+-]+@[a-z0-9.-]+\\.[a-z]{2,}$', email):\n",
    "        return {\"email\": email, \"status\": \"Invalid\", \"name\": \"N/A\", \"dept\": \"N/A\", \"active\": \"N/A\", \"last_seen\": \"\"}\n",
    "    if email in ad_cache: return ad_cache[email]\n",
    "    if not headers: return {\"email\": email, \"status\": \"Found\", \"name\": \"User\", \"dept\": \"Dept\", \"active\": True, \"last_seen\": \"\"}\n",
    "    \n",
    "    try:\n",
    "        # Requesting user profile and sign-in activity (requires specific permissions)\n",
    "        url = f\"https://graph.microsoft.com/v1.0/users/{email}?$select=displayName,department,accountEnabled,signInActivity\"\n",
    "        r = session.get(url, headers=headers, timeout=8)\n",
    "        if r.status_code == 200:\n",
    "            d = r.json()\n",
    "            active = d.get(\"accountEnabled\", \"N/A\")\n",
    "            # Extract last sign in date\n",
    "            last_seen = \"\"\n",
    "            if d.get(\"signInActivity\"):\n",
    "                raw_date = d[\"signInActivity\"].get(\"lastSignInDateTime\", \"\")\n",
    "                if raw_date: last_seen = raw_date[:10]\n",
    "            \n",
    "            res = {\"email\": email, \"status\": \"Found\", \"name\": d.get(\"displayName\", \"N/A\"), \n",
    "                   \"dept\": d.get(\"department\") or \"N/A\", \"active\": active, \"last_seen\": last_seen}\n",
    "        else:\n",
    "            res = {\"email\": email, \"status\": \"Not Found\", \"name\": \"N/A\", \"dept\": \"N/A\", \"active\": \"N/A\", \"last_seen\": \"no AD record\"}\n",
    "    except Exception as e:\n",
    "        logger.error(f\"Error fetching {email}: {e}\")\n",
    "        res = {\"email\": email, \"status\": \"Error\", \"name\": \"N/A\", \"dept\": \"N/A\", \"active\": \"N/A\", \"last_seen\": \"error\"}\n",
    "    \n",
    "    ad_cache[email] = res\n",
    "    return res"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "metadata": {},
   "outputs": [],
   "source": [
    "# === Cell 2: UI Components & Logic ===\n",
    "up_list = widgets.FileUpload(accept='.xlsx, .csv', description=\"1. User List\", button_style='info')\n",
    "txt_list = widgets.HTML(value=\"<i>No file selected</i>\", layout=widgets.Layout(margin='0 10px'))\n",
    "up_map = widgets.FileUpload(accept='.csv', description=\"2. Reviewer Map\", button_style='info')\n",
    "\n",
    "def get_latest_map():\n",
    "    files = glob.glob(os.path.join(MAPPING_DIR, \"*.csv\"))\n",
    "    return max(files, key=os.path.getmtime) if files else None\n",
    "\n",
    "def on_list_file_change(c):\n",
    "    fname = up_list.value[0]['name']\n",
    "    if \"User Listing\" not in fname:\n",
    "        txt_list.value = \"<b style='color:red;'>‚ùå Filename must contain 'User Listing'</b>\"\n",
    "    else:\n",
    "        txt_list.value = f\"<b style='color:green;'>‚úÖ Selected: {fname}</b>\"\n",
    "\n",
    "up_list.observe(on_list_file_change, 'value')\n",
    "map_path = get_latest_map()\n",
    "txt_map = widgets.HTML(value=f\"<b style='color:green;'>‚úÖ Default: {os.path.basename(map_path)}</b>\" if map_path else \"<i>No map found</i>\", layout=widgets.Layout(margin='0 10px'))\n",
    "\n",
    "btn_process = widgets.Button(description=\"üöÄ Step 1: Analyze\", button_style='warning', layout=widgets.Layout(width='180px'))\n",
    "btn_save = widgets.Button(description=\"üíæ Step 2: Save\", button_style='success', layout=widgets.Layout(width='180px'), disabled=True)\n",
    "out_area = widgets.Output()\n",
    "\n",
    "review_registry = []\n",
    "processed_df = None\n",
    "current_fname = \"\"\n",
    "mapping_data = {\"emails\": {}, \"depts\": {}, \"branches\": {}}\n",
    "\n",
    "def do_process(b):\n",
    "    global processed_df, current_fname, review_registry, mapping_data\n",
    "    out_area.clear_output()\n",
    "    review_registry = []\n",
    "    \n",
    "    if not up_list.value or \"User Listing\" not in up_list.value[0]['name']:\n",
    "        with out_area: print(\"Error: Valid 'User Listing' file required.\")\n",
    "        return\n",
    "    \n",
    "    b.disabled = True\n",
    "    try:\n",
    "        # 1. Load Map\n",
    "        m_src = io.BytesIO(up_map.value[0]['content']) if up_map.value else map_path\n",
    "        df_m = pd.read_csv(m_src)\n",
    "        df_m.columns = [str(c).strip().lower() for c in df_m.columns]\n",
    "        \n",
    "        # Separate Branches from Departments (Heuristic: check for word 'branch')\n",
    "        mapping_data['emails'] = {str(k).strip().lower(): v for k, v in zip(df_m['email address'], df_m['reviewer'])}\n",
    "        mapping_data['depts'] = {str(k).strip().lower(): v for k, v in zip(df_m['department'], df_m['reviewer'])}\n",
    "        \n",
    "        all_options = sorted([(str(d), str(d).lower().strip()) for d in df_m['department'].unique()])\n",
    "        branch_opts = [o for o in all_options if \"branch\" in o[0].lower()]\n",
    "        dept_opts = [o for o in all_options if \"branch\" not in o[0].lower()]\n",
    "\n",
    "        # 2. Load User List\n",
    "        f_item = up_list.value[0]\n",
    "        current_fname = f_item['name']\n",
    "        df_u = pd.read_csv(io.BytesIO(f_item['content'])) if current_fname.endswith('.csv') else pd.read_excel(io.BytesIO(f_item['content']))\n",
    "        \n",
    "        # Column Detection\n",
    "        col_email = df_u.columns[0]\n",
    "        for i in range(min(2, len(df_u.columns))):\n",
    "            if \"@\" in str(df_u.iloc[0, i]): col_email = df_u.columns[i]; break\n",
    "\n",
    "        # 3. Parallel Fetch\n",
    "        emails = df_u[col_email].dropna().unique().tolist()\n",
    "        with out_area: print(f\"Connecting to AD for {len(emails)} users...\")\n",
    "        with ThreadPoolExecutor(max_workers=10) as ex:\n",
    "            ad_results = {r['email']: r for r in list(ex.map(fetch_ad_profile, emails))}\n",
    "\n",
    "        # 4. Row Processing\n",
    "        final_rows = []\n",
    "        widget_rows = []\n",
    "        for idx, row in df_u.iterrows():\n",
    "            raw_email = str(row[col_email]).strip().lower()\n",
    "            ad = ad_results.get(raw_email, {\"dept\": \"N/A\", \"active\": \"N/A\", \"last_seen\": \"no record\"})\n",
    "            clean_dept = str(ad['dept']).split(\" - \")[-1].strip().lower()\n",
    "            \n",
    "            reviewer = mapping_data['emails'].get(raw_email) or mapping_data['depts'].get(clean_dept)\n",
    "            \n",
    "            is_problem = not reviewer or str(reviewer).strip().lower() in [\"nan\", \"none\", \"\", \"()\"]\n",
    "            if is_problem:\n",
    "                reviewer = \"(please manual review)\"\n",
    "                \n",
    "                # Logic for status string & color\n",
    "                status_html = \"\"\n",
    "                should_remove = False\n",
    "                if ad['active'] == True:\n",
    "                    status_html = \"<span style='color: orange; font-weight: bold;'>act: True (Attention)</span>\"\n",
    "                elif ad['active'] == False:\n",
    "                    status_html = f\"<span>act: False (last seen: {ad['last_seen']})</span>\"\n",
    "                    should_remove = True\n",
    "                elif ad['last_seen'] == \"no AD record\":\n",
    "                    status_html = \"<span style='color: red; font-weight: bold;'>act: N/A (no AD record)</span>\"\n",
    "                    should_remove = True\n",
    "                else:\n",
    "                    status_html = f\"<span>act: N/A (last seen: {ad['last_seen']})</span>\"\n",
    "                    should_remove = True\n",
    "\n",
    "                chk_rem = widgets.Checkbox(value=should_remove, layout=widgets.Layout(width='60px'))\n",
    "                chk_br = widgets.Checkbox(value=\"branch\" in clean_dept, layout=widgets.Layout(width='70px'))\n",
    "                drp = widgets.Dropdown(options=branch_opts if chk_br.value else dept_opts, layout=widgets.Layout(width='200px'))\n",
    "                lbl_rev = widgets.Label(value=\"Unassigned\", layout=widgets.Layout(width='140px'))\n",
    "                \n",
    "                # Dropdown & Branch Toggle Linkage\n",
    "                def update_drp(change, d=drp):\n",
    "                    d.options = branch_opts if change['new'] else dept_opts\n",
    "                chk_br.observe(update_drp, names='value')\n",
    "                \n",
    "                def update_lbl(change, l=lbl_rev): \n",
    "                    l.value = str(mapping_data['depts'].get(change['new'], \"Manual\"))\n",
    "                drp.observe(update_lbl, names='value')\n",
    "                \n",
    "                review_registry.append({'index': idx, 'chk': chk_rem, 'drp': drp, 'lbl': lbl_rev})\n",
    "                widget_rows.append(widgets.HBox([\n",
    "                    chk_rem, \n",
    "                    widgets.Label(value=raw_email, layout=widgets.Layout(width='220px')),\n",
    "                    widgets.HTML(value=status_html, layout=widgets.Layout(width='250px')),\n",
    "                    chk_br, drp, lbl_rev\n",
    "                ], layout=widgets.Layout(border='bottom 1px solid #ddd')))\n",
    "\n",
    "            new_row = row.to_dict()\n",
    "            new_row.update({\"Reviewer\": reviewer, \"Reviewer's Response\": \"\", \"Details of Access Changes\": \"\"})\n",
    "            final_rows.append(new_row)\n",
    "\n",
    "        processed_df = pd.DataFrame(final_rows)\n",
    "        btn_save.disabled = False\n",
    "        with out_area:\n",
    "            print(f\"Analysis finished. Total records: {len(processed_df)}\")\n",
    "            if widget_rows:\n",
    "                display(widgets.HTML(\"<b>Review problematic records below:</b>\"))\n",
    "                header = widgets.HBox([\n",
    "                    widgets.Label(\"REMOVE\", layout=widgets.Layout(width='60px')), \n",
    "                    widgets.Label(\"EMAIL\", layout=widgets.Layout(width='220px')), \n",
    "                    widgets.Label(\"AD STATUS / LAST LOGIN\", layout=widgets.Layout(width='250px')), \n",
    "                    widgets.Label(\"BRANCH?\", layout=widgets.Layout(width='70px')),\n",
    "                    widgets.Label(\"ASSIGN DEPT/BRANCH\", layout=widgets.Layout(width='200px')),\n",
    "                    widgets.Label(\"REVIEWER\", layout=widgets.Layout(width='140px'))\n",
    "                ])\n",
    "                display(widgets.VBox([header] + widget_rows))\n",
    "            else: print(\"All records matched successfully.\")\n",
    "    except Exception as e:\n",
    "        with out_area: print(f\"Error: {str(e)}\")\n",
    "        logger.error(\"Analysis error\", exc_info=True)\n",
    "    finally: b.disabled = False\n",
    "\n",
    "def do_save(b):\n",
    "    global processed_df\n",
    "    b.disabled = True\n",
    "    try:\n",
    "        df_final = processed_df.copy()\n",
    "        to_drop = []\n",
    "        for item in review_registry:\n",
    "            if item['chk'].value: to_drop.append(item['index'])\n",
    "            elif item['drp'].value != \"\": df_final.at[item['index'], 'Reviewer'] = item['lbl'].value\n",
    "        \n",
    "        df_final = df_final.drop(to_drop)\n",
    "        fpath = os.path.join(BASE_DIR, current_fname.split('.')[0] + \".xlsx\")\n",
    "        df_final.to_excel(fpath, index=False)\n",
    "        \n",
    "        # Excel Data Validation\n",
    "        wb = load_workbook(fpath)\n",
    "        ws = wb.active\n",
    "        col_resp = next((i for i, c in enumerate(ws[1], 1) if c.value == \"Reviewer's Response\"), None)\n",
    "        if col_resp:\n",
    "            dv = DataValidation(type=\"list\", formula1='\"Approved,Denied,Changes Required\"', allow_blank=True)\n",
    "            dv.promptTitle, dv.prompt = \"Selection\", \"Please select your responses from the drop-down menu\"\n",
    "            dv.errorTitle, dv.error = \"Error\", \"Please select a valid option form the drop-down menu\"\n",
    "            letter = get_column_letter(col_resp)\n",
    "            dv.add(f\"{letter}2:{letter}{len(df_final)+1}\")\n",
    "            ws.add_data_validation(dv)\n",
    "        wb.save(fpath)\n",
    "        with out_area: display(HTML(f\"<b style='color:blue;'>Process Complete. Saved to: {fpath}</b>\"))\n",
    "        logger.info(f\"Saved {fpath}. Cleaned {len(to_drop)} rows.\")\n",
    "    except Exception as e:\n",
    "        with out_area: print(f\"Save Error: {str(e)}\")\n",
    "        logger.error(\"Save Error\", exc_info=True)\n",
    "    finally: b.disabled = False\n",
    "\n",
    "btn_process.on_click(do_process); btn_save.on_click(do_save)\n",
    "display(widgets.VBox([widgets.HTML(\"<h4>üõ°Ô∏è AER Generator v5.8</h4>\"), \n",
    "                      widgets.HBox([up_list, txt_list]), widgets.HBox([up_map, txt_map]), \n",
    "                      widgets.HBox([btn_process, btn_save], layout=widgets.Layout(margin='15px 0')), out_area]))\n"
   ]
  }
 ],
 "metadata": {
  "kernelspec": { "display_name": "Python 3", "language": "python", "name": "python3" },
  "language_info": { "name": "python", "version": "3.8.5" }
 },
 "nbformat": 4,
 "nbformat_minor": 4
}