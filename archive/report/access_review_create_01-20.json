{
 "cells": [
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "# üõ°Ô∏è AER - Smart Access Review Generator (v4.3 Manual Review Flag)\n",
    "\n",
    "**Updates (v4.3):**\n",
    "1. **Manual Review Flag**:\n",
    "   - If the mapped reviewer is `()`, `Empty`, or not found, the `Reviewer` column is now filled with **`(please manual review)`** instead of being left blank.\n",
    "   - This makes it easier to filter and address missing assignments in Excel.\n",
    "\n",
    "**Previous Fixes:**\n",
    "- **Co-op City Fix**: Handles `Branch - Dept` parsing using `\" - \"` delimiter.\n",
    "- **N/A Name Handling**: Relies strictly on Email for AD lookups even if Name is missing.\n",
    "\n",
    "**Required Files:**\n",
    "- `.env` (Azure Credentials)\n",
    "- `Reviewer_Map.csv` (Columns: `email address`, `department`, `reviewer`)"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "metadata": {},
   "outputs": [],
   "source": [
    "# === Cell 1: Environment, Logging & Path Setup ===\n",
    "import os\n",
    "import sys\n",
    "import logging\n",
    "from datetime import datetime\n",
    "from dotenv import load_dotenv\n",
    "from msal import PublicClientApplication\n",
    "\n",
    "# 1. Setup Date & Paths\n",
    "today_str = datetime.now().strftime('%Y-%m-%d')\n",
    "\n",
    "# Define Paths: output/<yyyy-mm-dd>/create/\n",
    "BASE_OUTPUT_DIR = os.path.join(\"output\", today_str, \"create\")\n",
    "LOG_DIR = os.path.join(BASE_OUTPUT_DIR, \"log\")\n",
    "\n",
    "# Create Directories\n",
    "os.makedirs(LOG_DIR, exist_ok=True)\n",
    "\n",
    "# 2. Configure Logging\n",
    "log_file = os.path.join(LOG_DIR, f\"aer_{datetime.now().strftime('%H%M%S')}.log\")\n",
    "\n",
    "logger = logging.getLogger(\"aer\")\n",
    "logger.handlers.clear()\n",
    "logger.setLevel(logging.INFO)\n",
    "\n",
    "formatter = logging.Formatter('%(asctime)s | %(levelname)s | %(message)s')\n",
    "\n",
    "# Console Handler\n",
    "ch = logging.StreamHandler(sys.stdout)\n",
    "ch.setFormatter(formatter)\n",
    "logger.addHandler(ch)\n",
    "\n",
    "# File Handler\n",
    "fh = logging.FileHandler(log_file, encoding=\"utf-8\")\n",
    "fh.setFormatter(formatter)\n",
    "logger.addHandler(fh)\n",
    "\n",
    "logger.info(f\"üìÇ Log Path Set: {log_file}\")\n",
    "logger.info(f\"üìÇ Output Path Set: {BASE_OUTPUT_DIR}\")\n",
    "\n",
    "# 3. Azure AD Auth\n",
    "load_dotenv()\n",
    "TENANT_ID = os.getenv(\"AZURE_TENANT_ID\")\n",
    "CLIENT_ID = os.getenv(\"AZURE_CLIENT_ID\")\n",
    "SCOPES = [\"User.Read.All\"]\n",
    "\n",
    "headers = {}\n",
    "try:\n",
    "    if not TENANT_ID or not CLIENT_ID:\n",
    "        logger.warning(\"‚ö†Ô∏è No Azure Env Vars found. Running in Offline/Mock mode.\")\n",
    "    else:\n",
    "        app = PublicClientApplication(CLIENT_ID, authority=f\"https://login.microsoftonline.com/{TENANT_ID}\")\n",
    "        print(\"üöÄ Authentication required...\")\n",
    "        result = app.acquire_token_interactive(scopes=SCOPES, prompt=\"select_account\")\n",
    "        if \"access_token\" in result:\n",
    "            headers = {\"Authorization\": f\"Bearer {result['access_token']}\"}\n",
    "            logger.info(\"‚úÖ Azure AD Login Successful.\")\n",
    "        else:\n",
    "            logger.error(f\"‚ùå Login Failed: {result.get('error_description')}\")\n",
    "except Exception as e:\n",
    "    logger.error(f\"‚ùå Auth Exception: {e}\")"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "metadata": {},
   "outputs": [],
   "source": [
    "# === Cell 2: Helper Functions (Parsing & AD) ===\n",
    "import re\n",
    "import requests\n",
    "\n",
    "ad_cache = {}\n",
    "\n",
    "def is_valid_email(s):\n",
    "    if not isinstance(s, str): return False\n",
    "    return re.match(r'^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\\.[a-zA-Z]{2,}$', s.strip()) is not None\n",
    "\n",
    "def detect_columns(df):\n",
    "    \"\"\"Blindly detect Email and Name columns\"\"\"\n",
    "    if len(df.columns) < 2: return df.columns[0], df.columns[0]\n",
    "    sample = df.head(15)\n",
    "    col0, col1 = df.columns[0], df.columns[1]\n",
    "    score0 = sum(1 for x in sample[col0] if is_valid_email(str(x)))\n",
    "    score1 = sum(1 for x in sample[col1] if is_valid_email(str(x)))\n",
    "    return (col0, col1) if score0 > score1 else (col1, col0)\n",
    "\n",
    "def normalize_name(name):\n",
    "    if not isinstance(name, str): return \"\"\n",
    "    return re.sub(r'[^a-zA-Z0-9]', '', name.lower())\n",
    "\n",
    "def check_name_match(input_name, ad_name):\n",
    "    n1, n2 = normalize_name(str(input_name)), normalize_name(str(ad_name))\n",
    "    if not n1 or n1 in ['na', 'nan']: return False\n",
    "    if not n2: return False\n",
    "    return (n1 in n2) or (n2 in n1)\n",
    "\n",
    "def parse_m365_department(dept_str):\n",
    "    \"\"\"\n",
    "    Parses 'Corporate/Branch xxx - DepartmentName'.\n",
    "    Uses ' - ' (space-hyphen-space) to correctly handle names like 'Co-op City'.\n",
    "    \"\"\"\n",
    "    if not isinstance(dept_str, str) or not dept_str:\n",
    "        return \"\"\n",
    "    if \" - \" in dept_str:\n",
    "        return dept_str.split(\" - \")[-1].strip()\n",
    "    return dept_str.strip()\n",
    "\n",
    "def fetch_ad_profile(email):\n",
    "    email = str(email).strip()\n",
    "    if not is_valid_email(email):\n",
    "        return {\"status\": \"Invalid Email\", \"name\": \"N/A\", \"dept\": \"N/A\", \"active\": False}\n",
    "    \n",
    "    if email in ad_cache: return ad_cache[email]\n",
    "    \n",
    "    # Mock Data if Offline\n",
    "    if not headers:\n",
    "        return {\"status\": \"Mock\", \"name\": \"Mock User\", \"dept\": \"Branch 156 - Co-op City\", \"active\": True}\n",
    "\n",
    "    url = f\"https://graph.microsoft.com/v1.0/users/{email}?$select=id,displayName,department,accountEnabled,mail\"\n",
    "    try:\n",
    "        resp = requests.get(url, headers=headers)\n",
    "        if resp.status_code == 200:\n",
    "            data = resp.json()\n",
    "            res = {\n",
    "                \"status\": \"Found\",\n",
    "                \"name\": data.get(\"displayName\", \"Unknown\"),\n",
    "                \"dept\": data.get(\"department\") or \"N/A\",\n",
    "                \"active\": data.get(\"accountEnabled\", False)\n",
    "            }\n",
    "        else:\n",
    "            res = {\"status\": \"Not Found\", \"name\": \"N/A\", \"dept\": \"N/A\", \"active\": False}\n",
    "    except Exception:\n",
    "        res = {\"status\": \"Error\", \"name\": \"Error\", \"dept\": \"Error\", \"active\": False}\n",
    "    \n",
    "    ad_cache[email] = res\n",
    "    return res"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "metadata": {},
   "outputs": [],
   "source": [
    "# === Cell 3: Main Processing Logic ===\n",
    "import io\n",
    "import pandas as pd\n",
    "import numpy as np\n",
    "import ipywidgets as widgets\n",
    "from IPython.display import display, clear_output\n",
    "from openpyxl import load_workbook\n",
    "from openpyxl.worksheet.datavalidation import DataValidation\n",
    "from openpyxl.utils import get_column_letter\n",
    "\n",
    "# --- UI Elements ---\n",
    "w_upload_list = widgets.FileUpload(accept='.xlsx, .csv', multiple=False, description=\"1. User List\")\n",
    "w_upload_map = widgets.FileUpload(accept='.csv', multiple=False, description=\"2. Reviewer Map\")\n",
    "w_input_path = widgets.Text(description=\"Source Path:\", placeholder=\"(Optional) Paste folder path to save copy\", layout=widgets.Layout(width='400px'))\n",
    "btn_run = widgets.Button(description=\"üöÄ Process & Generate\", button_style='primary', layout=widgets.Layout(width='200px'))\n",
    "out_log = widgets.Output()\n",
    "\n",
    "def process_data(b):\n",
    "    out_log.clear_output()\n",
    "    if not w_upload_list.value or not w_upload_map.value:\n",
    "        with out_log: print(\"‚ùå Please upload both User List and Reviewer Map.\")\n",
    "        return\n",
    "\n",
    "    b.disabled = True\n",
    "    b.description = \"Processing...\"\n",
    "\n",
    "    try:\n",
    "        # --- 1. Read Reviewer Map ---\n",
    "        map_file = w_upload_map.value[0]\n",
    "        df_map = pd.read_csv(io.BytesIO(map_file['content']))\n",
    "        df_map.columns = [str(c).strip().lower() for c in df_map.columns]\n",
    "        \n",
    "        # Create Lookup Dictionaries\n",
    "        email_map = dict(zip(df_map['email address'].astype(str).str.lower().str.strip(), df_map['reviewer']))\n",
    "        dept_map = dict(zip(df_map['department'].astype(str).str.lower().str.strip(), df_map['reviewer']))\n",
    "        \n",
    "        logger.info(f\"Mapping Loaded. Emails: {len(email_map)}, Depts: {len(dept_map)}\")\n",
    "\n",
    "        # --- 2. Read User List ---\n",
    "        list_file = w_upload_list.value[0]\n",
    "        input_filename = list_file['name']\n",
    "        if input_filename.endswith('.csv'):\n",
    "            df_user = pd.read_csv(io.BytesIO(list_file['content']))\n",
    "        else:\n",
    "            df_user = pd.read_excel(io.BytesIO(list_file['content']))\n",
    "            \n",
    "        col_email, col_name = detect_columns(df_user)\n",
    "        logger.info(f\"Columns Detected: Email='{col_email}', Name='{col_name}'\")\n",
    "\n",
    "        # --- 3. Processing Loop ---\n",
    "        processed_rows = []\n",
    "        prog = widgets.IntProgress(min=0, max=len(df_user), description='Running:')\n",
    "        display(prog)\n",
    "        \n",
    "        for idx, row in df_user.iterrows():\n",
    "            raw_email = str(row[col_email]).strip()\n",
    "            raw_name = str(row[col_name]).strip()\n",
    "            if raw_name.lower() in ['nan', 'none', 'n/a', '']:\n",
    "                raw_name = \"N/A\"\n",
    "            \n",
    "            # A. Fetch AD Info\n",
    "            ad_info = fetch_ad_profile(raw_email)\n",
    "            \n",
    "            # B. Parse Department\n",
    "            full_dept = ad_info['dept']\n",
    "            clean_dept = parse_m365_department(full_dept)\n",
    "            \n",
    "            # C. Reviewer Assignment Logic\n",
    "            reviewer = \"\"\n",
    "            # Priority 1: Email Match\n",
    "            if raw_email.lower() in email_map:\n",
    "                reviewer = email_map[raw_email.lower()]\n",
    "            # Priority 2: Department Match (using Cleaned Dept Name)\n",
    "            elif clean_dept.lower() in dept_map:\n",
    "                reviewer = dept_map[clean_dept.lower()]\n",
    "            \n",
    "            # D. Reviewer Validation / Fallback\n",
    "            # If reviewer is Empty, \"()\", or NaN -> Fill with Manual Flag\n",
    "            if pd.isna(reviewer) or str(reviewer).strip() in [\"\", \"()\", \"nan\", \"None\"]:\n",
    "                reviewer = \"(please manual review)\"\n",
    "\n",
    "            # E. Status Checks\n",
    "            is_active_str = \"Active\" if ad_info['active'] else \"Inactive\"\n",
    "            if ad_info['status'] == \"Not Found\": is_active_str = \"User Not Found\"\n",
    "            \n",
    "            is_match = \"Typo/Mismatch\"\n",
    "            if ad_info['status'] != \"Found\": is_match = \"N/A\"\n",
    "            elif raw_name == \"N/A\": is_match = \"N/A (Input Missing)\"\n",
    "            elif check_name_match(raw_name, ad_info['name']): is_match = \"Yes\"\n",
    "\n",
    "            # F. Construct Row\n",
    "            new_row = row.to_dict()\n",
    "            new_row.update({\n",
    "                \"user_name\": ad_info['name'],\n",
    "                \"user_email\": raw_email,\n",
    "                \"is_match\": is_match,\n",
    "                \"is_active\": is_active_str,\n",
    "                \"department\": full_dept, \n",
    "                \"Reviewer\": reviewer,\n",
    "                \"Reviewer's Response\": \"\",\n",
    "                \"Details of Access Change\": \"\"\n",
    "            })\n",
    "            processed_rows.append(new_row)\n",
    "            prog.value += 1\n",
    "\n",
    "        # --- 4. Export & Save ---\n",
    "        df_final = pd.DataFrame(processed_rows)\n",
    "        \n",
    "        target_cols = [\"user_name\", \"user_email\", \"is_match\", \"is_active\", \"department\", \n",
    "                       \"Reviewer\", \"Reviewer's Response\", \"Details of Access Change\"]\n",
    "        final_cols = list(df_user.columns) + [c for c in target_cols if c not in df_user.columns]\n",
    "        df_export = df_final[final_cols]\n",
    "        \n",
    "        output_filename = f\"Enhanced_{os.path.splitext(input_filename)[0]}.xlsx\"\n",
    "        path_local_copy = os.path.join(BASE_OUTPUT_DIR, output_filename)\n",
    "        df_export.to_excel(path_local_copy, index=False)\n",
    "        \n",
    "        path_source_copy = None\n",
    "        if w_input_path.value.strip():\n",
    "            try:\n",
    "                source_dir = w_input_path.value.strip().strip('\"')\n",
    "                if os.path.exists(source_dir):\n",
    "                    path_source_copy = os.path.join(source_dir, output_filename)\n",
    "                    df_export.to_excel(path_source_copy, index=False)\n",
    "            except Exception as e:\n",
    "                logger.error(f\"Failed to save to source path: {e}\")\n",
    "\n",
    "        # --- 5. Add Dropdowns ---\n",
    "        def add_validation(fpath):\n",
    "            wb = load_workbook(fpath)\n",
    "            ws = wb.active\n",
    "            target_idx = None\n",
    "            for i, cell in enumerate(ws[1], 1):\n",
    "                if cell.value == \"Reviewer's Response\":\n",
    "                    target_idx = i\n",
    "                    break\n",
    "            if target_idx:\n",
    "                dv = DataValidation(type=\"list\", formula1='\"Approved,Denied,Change Required\"', allow_blank=True)\n",
    "                dv.prompt = 'Please select your responses from the drop-down menu'\n",
    "                col_char = get_column_letter(target_idx)\n",
    "                dv.add(f'{col_char}2:{col_char}{len(df_export)+1}')\n",
    "                ws.add_data_validation(dv)\n",
    "                wb.save(fpath)\n",
    "\n",
    "        add_validation(path_local_copy)\n",
    "        if path_source_copy: add_validation(path_source_copy)\n",
    "\n",
    "        # --- 6. Feedback ---\n",
    "        with out_log:\n",
    "            print(f\"‚úÖ Process Complete!\")\n",
    "            print(f\"üìÇ Saved to: {path_local_copy}\")\n",
    "            if path_source_copy: print(f\"üìÇ Saved copy to: {path_source_copy}\")\n",
    "            display(widgets.HTML(f\"<b style='color:blue'>Note: Reviewers marked as '(please manual review)' need attention.</b>\"))\n",
    "            display(df_export.head())\n",
    "\n",
    "    except Exception as e:\n",
    "        with out_log: \n",
    "            print(f\"‚ùå Error: {e}\")\n",
    "            logger.error(f\"Process Failed: {e}\", exc_info=True)\n",
    "    finally:\n",
    "        b.disabled = False\n",
    "        b.description = \"üöÄ Process & Generate\"\n",
    "\n",
    "btn_run.on_click(process_data)\n",
    "display(widgets.VBox([\n",
    "    widgets.HTML(\"<h3>üõ†Ô∏è AER - Enhanced Processor (v4.3 Manual Flag)</h3>\"),\n",
    "    widgets.HBox([w_upload_list, w_upload_map]),\n",
    "    w_input_path,\n",
    "    btn_run,\n",
    "    out_log\n",
    "]))"
   ]
  }
 ],
 "metadata": {
  "kernelspec": {
   "display_name": "Python 3",
   "language": "python",
   "name": "python3"
  },
  "language_info": {
   "codemirror_mode": {
    "name": "ipython",
    "version": 3
   },
   "file_extension": ".py",
   "mimetype": "text/x-python",
   "name": "python",
   "nbconvert_exporter": "python",
   "pygments_lexer": "ipython3",
   "version": "3.8.5"
  }
 },
 "nbformat": 4,
 "nbformat_minor": 4
}