{
  "cells": [
    {
      "cell_type": "markdown",
      "metadata": {},
      "source": [
        "# AER - Access Entitlement Review Reporter v4.2\n",
        "\n",
        "**Updates (v4.2):**\n",
        "- **Bug Fix**: Cache hit stats no longer inflate (per-row calculation instead of total).\n",
        "- **Global Report**: New `üìä Global Report` button exports summary across all apps.\n",
        "- **User Info**: Per-App reports now include User Name & User Email columns.\n",
        "- **File Paths**: All reports saved under `output/{date}/report/`, logs under `report/logs/`.\n",
        "- **Safe Write**: Auto-appends `_1`, `_2`... if target file is locked/open.\n",
        "\n",
        "**Previous Features:**\n",
        "- **Smart Tab Handling**: Prioritizes \"User Listing\" tab.\n",
        "- **Full Data Caching**: Reports populated from cache are identical to live reads.\n",
        "- **Merged Logic**: Parsing logic integrated into Engine.\n",
        "- **Full Audit History & Advanced Reporting**."
      ]
    },
    {
      "cell_type": "code",
      "execution_count": null,
      "metadata": {},
      "outputs": [],
      "source": [
        "# === Cell 1: Setup & Authentication ===\n",
        "import os\n",
        "import sys\n",
        "import io\n",
        "import logging\n",
        "from datetime import datetime\n",
        "from dotenv import load_dotenv\n",
        "from msal import PublicClientApplication\n",
        "import requests\n",
        "\n",
        "load_dotenv()\n",
        "\n",
        "# === Logging ===\n",
        "today_str = datetime.now().strftime('%Y-%m-%d')\n",
        "hour_str = datetime.now().strftime('%H')\n",
        "log_dir = f\"output/{today_str}/report/logs\"\n",
        "os.makedirs(log_dir, exist_ok=True)\n",
        "\n",
        "log_file = f\"{log_dir}/aer_{today_str}_{hour_str}00.log\"\n",
        "\n",
        "logger = logging.getLogger(\"aer\")\n",
        "logger.handlers.clear()\n",
        "logger.setLevel(logging.INFO)\n",
        "\n",
        "def _get_console_stream():\n",
        "    s = getattr(sys, \"stdout\", None)\n",
        "    try:\n",
        "        if s and hasattr(s, \"reconfigure\"):\n",
        "            s.reconfigure(encoding=\"utf-8\")\n",
        "            if hasattr(sys.stderr, \"reconfigure\"):\n",
        "                sys.stderr.reconfigure(encoding=\"utf-8\")\n",
        "            return s\n",
        "    except Exception: pass\n",
        "    return sys.stdout\n",
        "\n",
        "formatter = logging.Formatter('%(asctime)s | %(levelname)s | %(message)s')\n",
        "ch = logging.StreamHandler(_get_console_stream())\n",
        "ch.setFormatter(formatter)\n",
        "logger.addHandler(ch)\n",
        "\n",
        "fh = logging.FileHandler(log_file, encoding=\"utf-8\", mode='a')\n",
        "fh.setFormatter(formatter)\n",
        "logger.addHandler(fh)\n",
        "\n",
        "# === Azure AD Config ===\n",
        "TENANT_ID = os.getenv(\"AZURE_TENANT_ID\")\n",
        "CLIENT_ID = os.getenv(\"AZURE_CLIENT_ID\")\n",
        "SHAREPOINT_HOST = os.getenv(\"SHAREPOINT_HOST\", \"davidshih.sharepoint.com\")\n",
        "SITE_NAME = os.getenv(\"SITE_NAME\", \"aer\")\n",
        "APP_NAME = \"2025 Entitlement Review\"\n",
        "BASE_PATH = APP_NAME\n",
        "SENDER_EMAIL = os.getenv(\"SENDER_EMAIL\")\n",
        "\n",
        "SCOPES = [\n",
        "    \"User.Read.All\", \"Mail.Send\", \"Mail.Read\", \n",
        "    \"Files.Read.All\", \"Sites.Read.All\"\n",
        "]\n",
        "\n",
        "app = PublicClientApplication(CLIENT_ID, authority=f\"https://login.microsoftonline.com/{TENANT_ID}\")\n",
        "print(\"üöÄ Opening browser for authentication...\")\n",
        "interactive_result = app.acquire_token_interactive(scopes=SCOPES, prompt=\"select_account\")\n",
        "\n",
        "if \"access_token\" not in interactive_result:\n",
        "    raise RuntimeError(f\"Login Failed: {interactive_result.get('error_description')}\")\n",
        "\n",
        "headers = {\"Authorization\": f\"Bearer {interactive_result['access_token']}\"}\n",
        "logger.info(\"‚úÖ Login Successful\")\n",
        "logger.info(f\"Log File: {log_file}\")"
      ]
    },
    {
      "cell_type": "code",
      "execution_count": null,
      "metadata": {},
      "outputs": [],
      "source": [
        "# === Cell 2: SharePoint API & App Selector (v3.6 with Counts & Filtering) ===\n",
        "import ipywidgets as widgets\n",
        "from IPython.display import display, clear_output\n",
        "import requests\n",
        "\n",
        "# --- 1. SharePoint API Functions ---\n",
        "def get_site_id(site_name: str) -> str:\n",
        "    url = f\"https://graph.microsoft.com/v1.0/sites/{SHAREPOINT_HOST}:/sites/{site_name}\"\n",
        "    resp = requests.get(url, headers=headers)\n",
        "    resp.raise_for_status()\n",
        "    return resp.json()[\"id\"]\n",
        "\n",
        "def list_folders_with_count(site_id: str, path: str) -> list[dict]:\n",
        "    if not path or path.strip() == \"\":\n",
        "        url = f\"https://graph.microsoft.com/v1.0/sites/{site_id}/drive/root/children\"\n",
        "    else:\n",
        "        clean_path = path.strip(\"/\")\n",
        "        url = f\"https://graph.microsoft.com/v1.0/sites/{site_id}/drive/root:/{clean_path}:/children\"\n",
        "    \n",
        "    resp = requests.get(url, headers=headers)\n",
        "    results = []\n",
        "    EXCLUDED_NAMES = [\"forms\", \"_private\", \"audit logs\", \"audit\", \"user listings\", \"shared documents\"]\n",
        "\n",
        "    for item in resp.json().get(\"value\", []):\n",
        "        if item.get(\"folder\"):\n",
        "            name_lower = item[\"name\"].lower()\n",
        "            if any(ex in name_lower for ex in EXCLUDED_NAMES):\n",
        "                continue\n",
        "\n",
        "            count = item.get(\"folder\", {}).get(\"childCount\", 0)\n",
        "            results.append({\n",
        "                \"name\": item[\"name\"], \n",
        "                \"webUrl\": item.get(\"webUrl\", \"\"),\n",
        "                \"count\": count\n",
        "            })\n",
        "    return results\n",
        "\n",
        "def list_excel_files(site_id: str, folder_path: str) -> list[dict]:\n",
        "    clean_path = folder_path.strip(\"/\")\n",
        "    url = f\"https://graph.microsoft.com/v1.0/sites/{site_id}/drive/root:/{clean_path}:/children\"\n",
        "    resp = requests.get(url, headers=headers)\n",
        "    files = []\n",
        "    for item in resp.json().get(\"value\", []):\n",
        "        if item[\"name\"].endswith(\".xlsx\"):\n",
        "            files.append({\n",
        "                \"id\": item[\"id\"], \"name\": item[\"name\"],\n",
        "                \"lastModifiedDateTime\": item.get(\"lastModifiedDateTime\"),\n",
        "                \"createdDateTime\": item.get(\"createdDateTime\"),\n",
        "                \"webUrl\": item.get(\"webUrl\")\n",
        "            })\n",
        "    return sorted(files, key=lambda f: f.get(\"lastModifiedDateTime\", \"\"), reverse=True)\n",
        "\n",
        "def download_file(site_id: str, file_path: str) -> bytes:\n",
        "    clean_path = file_path.strip(\"/\")\n",
        "    url = f\"https://graph.microsoft.com/v1.0/sites/{site_id}/drive/root:/{clean_path}:/content\"\n",
        "    resp = requests.get(url, headers=headers)\n",
        "    resp.raise_for_status()\n",
        "    return resp.content\n",
        "\n",
        "def get_file_audit_info(site_id: str, file_id: str) -> dict:\n",
        "    url = f\"https://graph.microsoft.com/v1.0/sites/{site_id}/drive/items/{file_id}/versions\"\n",
        "    resp = requests.get(url, headers=headers)\n",
        "    default_res = {\"log\": \"N/A\", \"creator\": \"Unknown\", \"modifier\": \"Unknown\", \"created_ts\": None}\n",
        "    if resp.status_code != 200: return default_res\n",
        "    \n",
        "    versions = resp.json().get(\"value\", [])\n",
        "    if not versions: return default_res\n",
        "\n",
        "    logs = []\n",
        "    for v in versions:\n",
        "        mod_time = v.get(\"lastModifiedDateTime\", \"\")[:19].replace(\"T\", \" \")\n",
        "        actor = v.get(\"lastModifiedBy\", {}).get(\"user\", {}).get(\"displayName\") or \"System\"\n",
        "        logs.append(f\"{mod_time} - {actor}\")\n",
        "    \n",
        "    last_v = versions[0]\n",
        "    first_v = versions[-1]\n",
        "\n",
        "    return {\n",
        "        \"log\": \"\\n\".join(logs),\n",
        "        \"creator\": first_v.get(\"lastModifiedBy\", {}).get(\"user\", {}).get(\"displayName\") or \"System\",\n",
        "        \"modifier\": last_v.get(\"lastModifiedBy\", {}).get(\"user\", {}).get(\"displayName\") or \"System\",\n",
        "        \"created_ts\": first_v.get(\"lastModifiedDateTime\")\n",
        "    }\n",
        "\n",
        "# --- 2. Initialize Connection ---\n",
        "try:\n",
        "    site_id = get_site_id(SITE_NAME)\n",
        "    logger.info(f\"‚úÖ SharePoint Connected (Site ID: {site_id[:10]}...)\")\n",
        "except Exception as e:\n",
        "    logger.error(f\"‚ùå Connection Failed: {e}\")\n",
        "\n",
        "# --- 3. Tree Selector UI (with Counts) ---\n",
        "TARGET_APPS = [] \n",
        "USE_CACHE = True \n",
        "\n",
        "def create_app_selector():\n",
        "    print(f\"üìÇ Reading Root: {BASE_PATH} ...\")\n",
        "    try:\n",
        "        categories = list_folders_with_count(site_id, BASE_PATH)\n",
        "    except Exception as e:\n",
        "        print(f\"‚ùå Read Failed: {e}\")\n",
        "        return\n",
        "\n",
        "    ui_container = widgets.VBox()\n",
        "    app_checkboxes = []\n",
        "    \n",
        "    chk_cache = widgets.Checkbox(value=True, description=\"‚ö° Use Cache (Faster)\", indent=False)\n",
        "    ui_container.children += (widgets.HTML(\"<h3>üìÇ App Selector (v3.6)</h3>\"), chk_cache, widgets.HTML(\"<hr>\"))\n",
        "\n",
        "    for cat in categories:\n",
        "        if cat['name'] in [\"Forms\", \"_private\"] or \"audit\" in cat['name'].lower(): continue\n",
        "            \n",
        "        cat_label = widgets.HTML(f\"<b>üìÅ {cat['name']}</b>\", layout=widgets.Layout(width='150px'))\n",
        "        btn_expand = widgets.Button(description=\"‚ûï Expand\", button_style='info', layout=widgets.Layout(width='80px'))\n",
        "        app_list_box = widgets.VBox(layout=widgets.Layout(margin='0 0 0 30px', display='none'))\n",
        "        \n",
        "        def on_expand(b, cat_name=cat['name'], container=app_list_box, btn=btn_expand):\n",
        "            if btn.description == \"‚ûï Expand\":\n",
        "                btn.description = \"‚è≥\"\n",
        "                sub_path = f\"{BASE_PATH}/{cat_name}\"\n",
        "                try:\n",
        "                    apps = list_folders_with_count(site_id, sub_path)\n",
        "                    checks = []\n",
        "                    if not apps: checks.append(widgets.Label(\"(Empty)\"))\n",
        "                    \n",
        "                    for app in apps:\n",
        "                        if app['name'] in [\"Forms\", \"_private\"]: continue\n",
        "                        \n",
        "                        count_display = f\" <span style='color:#888; font-size:11px'>({app['count']} users)</span>\"\n",
        "                        cb = widgets.Checkbox(value=False, description=app['name'], indent=False, layout=widgets.Layout(width='400px'))\n",
        "                        lbl_count = widgets.HTML(count_display)\n",
        "                        \n",
        "                        cb.app_data = (cat_name, app['name'], f\"{sub_path}/{app['name']}\")\n",
        "                        app_checkboxes.append(cb)\n",
        "                        checks.append(widgets.HBox([cb, lbl_count]))\n",
        "                    \n",
        "                    container.children = tuple(checks)\n",
        "                    container.layout.display = 'block'\n",
        "                    btn.description = \"‚ûñ Collapse\"\n",
        "                except Exception as e:\n",
        "                    container.children = (widgets.Label(f\"Error: {e}\"),)\n",
        "                    btn.description = \"‚ùå\"\n",
        "            else:\n",
        "                if container.layout.display == 'none':\n",
        "                    container.layout.display = 'block'; btn.description = \"‚ûñ Collapse\"\n",
        "                else:\n",
        "                    container.layout.display = 'none'; btn.description = \"‚ûï Expand\"\n",
        "\n",
        "        btn_expand.on_click(on_expand)\n",
        "        ui_container.children += (widgets.HBox([btn_expand, cat_label]), app_list_box)\n",
        "\n",
        "    btn_confirm = widgets.Button(description=\"‚úÖ Confirm Selection\", button_style='success', layout=widgets.Layout(margin='20px 0'))\n",
        "    output_area = widgets.Output()\n",
        "\n",
        "    def on_confirm(b):\n",
        "        global TARGET_APPS, USE_CACHE\n",
        "        TARGET_APPS = [cb.app_data for cb in app_checkboxes if cb.value]\n",
        "        USE_CACHE = chk_cache.value\n",
        "        \n",
        "        with output_area:\n",
        "            clear_output()\n",
        "            if not TARGET_APPS: print(\"‚ö†Ô∏è No apps selected!\")\n",
        "            else:\n",
        "                print(f\"üéØ Selected {len(TARGET_APPS)} Apps | Cache: {USE_CACHE}\")\n",
        "                print(\"‚è≥ Proceed to Cell 4 (Enrichment) or Cell 5 (Scan).\")\n",
        "\n",
        "    btn_confirm.on_click(on_confirm)\n",
        "    display(ui_container, btn_confirm, output_area)\n",
        "\n",
        "create_app_selector()"
      ]
    },
    {
      "cell_type": "code",
      "execution_count": null,
      "metadata": {},
      "outputs": [],
      "source": [
        "# === Cell 5: AER Engine v4.2 (Cache Fix, User Info, Global Report, Safe Write) ===\n",
        "\n",
        "import pandas as pd\n",
        "\n",
        "import re, time, json, os, requests\n",
        "\n",
        "import ipywidgets as widgets\n",
        "\n",
        "from datetime import datetime\n",
        "\n",
        "from openpyxl import load_workbook\n",
        "from openpyxl.styles import Alignment\n",
        "from openpyxl.utils import get_column_letter\n",
        "\n",
        "from io import BytesIO\n",
        "\n",
        "from IPython.display import display, HTML, clear_output\n",
        "\n",
        "\n",
        "\n",
        "# ==========================================\n",
        "\n",
        "# PART 1: CONFIG & LOADER\n",
        "\n",
        "# ==========================================\n",
        "\n",
        "CACHE_FILE = \"aer_cache.json\"\n",
        "\n",
        "NOTES_FILE = \"aer_manual_notes.json\"\n",
        "\n",
        "CACHE_VERSION = 4.2\n",
        "\n",
        "cache_updated = False\n",
        "\n",
        "EXCLUDED_FOLDERS = [\"forms\", \"_private\", \"user listings\", \"audit logs\", \"audit\"]\n",
        "\n",
        "\n",
        "\n",
        "def load_json(file_path):\n",
        "\n",
        "    if os.path.exists(file_path):\n",
        "\n",
        "        try:\n",
        "\n",
        "            with open(file_path, 'r', encoding='utf-8') as f: return json.load(f)\n",
        "\n",
        "        except: return {}\n",
        "\n",
        "    return {}\n",
        "\n",
        "\n",
        "\n",
        "def save_json(file_path, data):\n",
        "\n",
        "    with open(file_path, 'w', encoding='utf-8') as f: json.dump(data, f, indent=2, ensure_ascii=False)\n",
        "\n",
        "\n",
        "\n",
        "def safe_excel_path(base_path):\n",
        "\n",
        "    \"\"\"If base_path is locked/open, append _1, _2, ... until writable.\"\"\"\n",
        "\n",
        "    if not os.path.exists(base_path):\n",
        "\n",
        "        return base_path\n",
        "\n",
        "    try:\n",
        "\n",
        "        with open(base_path, 'a'):\n",
        "\n",
        "            pass\n",
        "\n",
        "        return base_path\n",
        "\n",
        "    except OSError:\n",
        "\n",
        "        pass\n",
        "\n",
        "    stem, ext = os.path.splitext(base_path)\n",
        "\n",
        "    for i in range(1, 100):\n",
        "\n",
        "        candidate = f\"{stem}_{i}{ext}\"\n",
        "\n",
        "        if not os.path.exists(candidate):\n",
        "\n",
        "            return candidate\n",
        "\n",
        "    return f\"{stem}_{int(time.time())}{ext}\"\n",
        "\n",
        "\n",
        "\n",
        "def format_export_excel(file_path, audit_col_name=\"Audit Log\"):\n",
        "\n",
        "    wb = load_workbook(file_path)\n",
        "\n",
        "    ws = wb.active\n",
        "\n",
        "    header_to_col = {}\n",
        "\n",
        "    for col_idx in range(1, ws.max_column + 1):\n",
        "\n",
        "        hdr = ws.cell(row=1, column=col_idx).value\n",
        "\n",
        "        hdr_txt = str(hdr).strip() if hdr is not None else \"\"\n",
        "\n",
        "        if hdr_txt:\n",
        "\n",
        "            header_to_col[hdr_txt] = col_idx\n",
        "\n",
        "        max_len = len(hdr_txt)\n",
        "\n",
        "        for row_idx in range(2, ws.max_row + 1):\n",
        "\n",
        "            cell_val = ws.cell(row=row_idx, column=col_idx).value\n",
        "\n",
        "            if cell_val is None:\n",
        "\n",
        "                continue\n",
        "\n",
        "            lines = str(cell_val).splitlines() or [str(cell_val)]\n",
        "\n",
        "            max_len = max(max_len, max(len(line) for line in lines))\n",
        "\n",
        "        ws.column_dimensions[get_column_letter(col_idx)].width = min(max(10, max_len + 2), 80)\n",
        "\n",
        "    audit_col = header_to_col.get(audit_col_name)\n",
        "\n",
        "    if audit_col:\n",
        "\n",
        "        for row_idx in range(2, ws.max_row + 1):\n",
        "\n",
        "            cell = ws.cell(row=row_idx, column=audit_col)\n",
        "\n",
        "            txt = \"\" if cell.value is None else str(cell.value)\n",
        "\n",
        "            line_count = max(1, txt.count(\"\\n\") + 1)\n",
        "\n",
        "            cell.alignment = Alignment(wrap_text=True, vertical=\"top\")\n",
        "\n",
        "            current_height = ws.row_dimensions[row_idx].height or 15\n",
        "\n",
        "            ws.row_dimensions[row_idx].height = max(current_height, min(15 * line_count, 300))\n",
        "\n",
        "    wb.save(file_path)\n",
        "\n",
        "\n",
        "\n",
        "local_cache = load_json(CACHE_FILE)\n",
        "\n",
        "manual_data_store = load_json(NOTES_FILE)\n",
        "\n",
        "\n",
        "\n",
        "# ==========================================\n",
        "\n",
        "# PART 2: ROBUST EXCEL PARSER\n",
        "\n",
        "# ==========================================\n",
        "\n",
        "def find_col_index(headers, keywords):\n",
        "\n",
        "    \"\"\"Case-insensitive search for column index.\"\"\"\n",
        "\n",
        "    for idx, h in enumerate(headers):\n",
        "\n",
        "        if not h: continue\n",
        "\n",
        "        h_str = str(h).strip().lower()\n",
        "\n",
        "        if all(k in h_str for k in keywords):\n",
        "\n",
        "            return idx\n",
        "\n",
        "    return None\n",
        "\n",
        "\n",
        "\n",
        "def is_name_like_header(header_text: str) -> bool:\n",
        "\n",
        "    txt = (header_text or \"\").strip().lower()\n",
        "\n",
        "    if not txt:\n",
        "\n",
        "        return False\n",
        "\n",
        "    if \"reviewer\" in txt or \"manager\" in txt:\n",
        "\n",
        "        return False\n",
        "\n",
        "    return (\"name\" in txt) or (\"display\" in txt and \"user\" in txt) or (\"full\" in txt and \"name\" in txt)\n",
        "\n",
        "\n",
        "\n",
        "def is_email_like_header(header_text: str) -> bool:\n",
        "\n",
        "    txt = (header_text or \"\").strip().lower()\n",
        "\n",
        "    if not txt:\n",
        "\n",
        "        return False\n",
        "\n",
        "    return (\"email\" in txt) or (\"mail\" == txt) or txt.endswith(\" mail\")\n",
        "\n",
        "\n",
        "\n",
        "def resolve_column_map(header, app_col_map=None):\n",
        "\n",
        "    if app_col_map:\n",
        "\n",
        "        return app_col_map, \"app-locked\"\n",
        "\n",
        "    idx_rev = find_col_index(header, [\"reviewer\"])\n",
        "\n",
        "    idx_res = find_col_index(header, [\"response\"])\n",
        "\n",
        "    idx_det = find_col_index(header, [\"details\", \"change\"])\n",
        "\n",
        "    idx_user = None\n",
        "\n",
        "    idx_email = None\n",
        "\n",
        "    if idx_rev is not None:\n",
        "\n",
        "        rev_hdr = str(header[idx_rev]).strip().lower() if header[idx_rev] else \"\"\n",
        "\n",
        "        if \"response\" in rev_hdr:\n",
        "\n",
        "            idx_rev = None\n",
        "\n",
        "            for i, h in enumerate(header):\n",
        "\n",
        "                h_str = str(h).strip().lower() if h else \"\"\n",
        "\n",
        "                if (\"reviewer\" in h_str) and (\"response\" not in h_str):\n",
        "\n",
        "                    idx_rev = i\n",
        "\n",
        "                    break\n",
        "\n",
        "    for i in range(min(2, len(header))):\n",
        "\n",
        "        h = str(header[i]).strip().lower() if header[i] else \"\"\n",
        "\n",
        "        if idx_user is None and is_name_like_header(h):\n",
        "\n",
        "            idx_user = i\n",
        "\n",
        "        if idx_email is None and is_email_like_header(h):\n",
        "\n",
        "            idx_email = i\n",
        "\n",
        "    if idx_user is None: idx_user = find_col_index(header, [\"user\", \"name\"])\n",
        "\n",
        "    if idx_user is None: idx_user = find_col_index(header, [\"display\", \"name\"])\n",
        "\n",
        "    if idx_user is None: idx_user = find_col_index(header, [\"full\", \"name\"])\n",
        "\n",
        "    if idx_user is None: idx_user = find_col_index(header, [\"name\"])\n",
        "\n",
        "    if idx_email is None: idx_email = find_col_index(header, [\"email\"])\n",
        "\n",
        "    if idx_email is None: idx_email = find_col_index(header, [\"mail\"])\n",
        "\n",
        "    if idx_rev is None: idx_rev = find_col_index(header, [\"manager\"])\n",
        "\n",
        "    if idx_rev is None or idx_res is None:\n",
        "\n",
        "        return None, \"invalid\"\n",
        "\n",
        "    return {\n",
        "\n",
        "        \"idx_rev\": idx_rev, \"idx_res\": idx_res, \"idx_det\": idx_det,\n",
        "\n",
        "        \"idx_user\": idx_user, \"idx_email\": idx_email\n",
        "\n",
        "    }, \"detected\"\n",
        "\n",
        "\n",
        "\n",
        "def read_excel_rows(excel_bytes: bytes, reviewer_name: str, file_name: str, folder_url: str, app_col_map=None):\n",
        "\n",
        "    wb = load_workbook(BytesIO(excel_bytes), read_only=True)\n",
        "\n",
        "\n",
        "\n",
        "    # 1. Smart Tab Selection\n",
        "\n",
        "    sheet_name = wb.sheetnames[0]\n",
        "\n",
        "    for sn in wb.sheetnames:\n",
        "\n",
        "        if \"user listing\" in sn.lower(): sheet_name = sn; break\n",
        "\n",
        "    ws = wb[sheet_name]\n",
        "\n",
        "\n",
        "\n",
        "    # 2. Read Headers\n",
        "\n",
        "    rows_iter = ws.iter_rows(values_only=True)\n",
        "\n",
        "    try:\n",
        "\n",
        "        header = next(rows_iter)\n",
        "\n",
        "    except StopIteration:\n",
        "\n",
        "        return [], None, \"empty-sheet\"\n",
        "\n",
        "\n",
        "\n",
        "    # 3. Column Mapping\n",
        "\n",
        "    col_map, map_source = resolve_column_map(header, app_col_map=app_col_map)\n",
        "\n",
        "    if not col_map:\n",
        "\n",
        "        return [], None, map_source\n",
        "\n",
        "    idx_rev = col_map[\"idx_rev\"]\n",
        "\n",
        "    idx_res = col_map[\"idx_res\"]\n",
        "\n",
        "    idx_det = col_map[\"idx_det\"]\n",
        "\n",
        "    idx_user = col_map[\"idx_user\"]\n",
        "\n",
        "    idx_email = col_map[\"idx_email\"]\n",
        "\n",
        "\n",
        "\n",
        "    results = []\n",
        "\n",
        "\n",
        "\n",
        "    # 4. Iterate Rows\n",
        "\n",
        "    for i, row in enumerate(rows_iter, start=2):\n",
        "\n",
        "        r_rev = row[idx_rev] if idx_rev < len(row) else None\n",
        "\n",
        "        r_res = row[idx_res] if idx_res < len(row) else None\n",
        "\n",
        "        r_det = row[idx_det] if idx_det is not None and idx_det < len(row) else None\n",
        "\n",
        "        r_user = row[idx_user] if idx_user is not None and idx_user < len(row) else None\n",
        "\n",
        "        r_email = row[idx_email] if idx_email is not None and idx_email < len(row) else None\n",
        "\n",
        "\n",
        "\n",
        "        if str(r_rev).strip().lower() != reviewer_name.lower(): continue\n",
        "\n",
        "\n",
        "\n",
        "        val_res = str(r_res).strip() if r_res else \"\"\n",
        "\n",
        "        val_det = str(r_det).strip() if r_det else \"\"\n",
        "\n",
        "\n",
        "\n",
        "        results.append({\n",
        "\n",
        "            \"reviewer\": reviewer_name,\n",
        "\n",
        "            \"user_name\": str(r_user).strip() if r_user else \"\",\n",
        "\n",
        "            \"user_email\": str(r_email).strip() if r_email else \"\",\n",
        "\n",
        "            \"response\": val_res,\n",
        "\n",
        "            \"details\": val_det,\n",
        "\n",
        "            \"is_missing\": (val_res == \"\"),\n",
        "\n",
        "            \"row_number\": i,\n",
        "\n",
        "            \"file_name\": file_name,\n",
        "\n",
        "            \"folder_url\": folder_url\n",
        "\n",
        "        })\n",
        "\n",
        "    return results, col_map, map_source\n",
        "\n",
        "\n",
        "\n",
        "def get_row_stats(txt):\n",
        "\n",
        "    txt = str(txt).lower().strip()\n",
        "\n",
        "    kw_appr = ['approv', 'retain', 'keep', 'confirm', 'yes', 'ok', 'active']\n",
        "\n",
        "    kw_deny = ['denied', 'deny', 'remove', 'delete', 'revok', 'reject', 'no']\n",
        "\n",
        "    kw_chg  = ['change', 'modif', 'updat', 'correct', 'edit', 'adjust']\n",
        "\n",
        "    return {\n",
        "\n",
        "        \"is_appr\": 1 if any(k in txt for k in kw_appr) else 0,\n",
        "\n",
        "        \"is_deny\": 1 if any(k in txt for k in kw_deny) else 0,\n",
        "\n",
        "        \"is_chg\":  1 if any(k in txt for k in kw_chg) else 0\n",
        "\n",
        "    }\n",
        "\n",
        "\n",
        "\n",
        "# ==========================================\n",
        "\n",
        "# PART 3: SCANNING ENGINE\n",
        "\n",
        "# ==========================================\n",
        "\n",
        "if 'TARGET_APPS' not in globals() or not TARGET_APPS:\n",
        "\n",
        "    print(\"‚ö†Ô∏è Please select Apps in Cell 2 first!\")\n",
        "\n",
        "    TARGET_APPS = []\n",
        "\n",
        "\n",
        "\n",
        "all_responses = []\n",
        "\n",
        "errors = []\n",
        "\n",
        "app_column_map_store = {}\n",
        "\n",
        "\n",
        "\n",
        "print(f\"üöÄ Starting Scan Engine v{CACHE_VERSION} (Fuzzy Column Match)...\")\n",
        "\n",
        "\n",
        "\n",
        "for category, current_app_name, current_path in TARGET_APPS:\n",
        "\n",
        "    try:\n",
        "\n",
        "        raw_folders = list_folders_with_count(site_id, current_path) if 'list_folders_with_count' in globals() else []\n",
        "\n",
        "        if not raw_folders: raw_folders = [{\"name\": \"Error\", \"webUrl\": \"#\"}]\n",
        "\n",
        "\n",
        "\n",
        "        reviewers = [r for r in raw_folders if r['name'].lower() not in EXCLUDED_FOLDERS]\n",
        "\n",
        "        total_revs = len(reviewers)\n",
        "\n",
        "        logger.info(f\"üìÇ App: {current_app_name} | Reviewers: {total_revs}\")\n",
        "\n",
        "        app_schema_key = f\"{category}|{current_app_name}\"\n",
        "\n",
        "        app_col_map = app_column_map_store.get(app_schema_key)\n",
        "\n",
        "\n",
        "\n",
        "        for idx, folder in enumerate(reviewers, 1):\n",
        "\n",
        "            reviewer_name = folder[\"name\"]\n",
        "\n",
        "            folder_url = folder[\"webUrl\"]\n",
        "\n",
        "            folder_path = f\"{current_path}/{reviewer_name}\"\n",
        "\n",
        "            cache_key = f\"{category}|{current_app_name}|{reviewer_name}\"\n",
        "\n",
        "\n",
        "\n",
        "            try:\n",
        "\n",
        "                files = list_excel_files(site_id, folder_path)\n",
        "\n",
        "                match_candidates = [f for f in files if reviewer_name.lower() in f[\"name\"].lower()]\n",
        "\n",
        "                target_file = match_candidates[0] if match_candidates else (files[0] if files else None)\n",
        "\n",
        "\n",
        "\n",
        "                if not target_file:\n",
        "\n",
        "                    logger.info(f\"  ‚ö†Ô∏è Skip: [{idx}/{total_revs}] {reviewer_name} (no xlsx found)\")\n",
        "\n",
        "                    continue\n",
        "\n",
        "\n",
        "\n",
        "                remote_mod = target_file.get(\"lastModifiedDateTime\")\n",
        "\n",
        "                logger.info(f\"  üîé File: [{idx}/{total_revs}] {reviewer_name} | Target:{target_file['name']} | Modified:{remote_mod}\")\n",
        "\n",
        "\n",
        "\n",
        "                cached = local_cache.get(cache_key)\n",
        "\n",
        "                is_hit = False\n",
        "                force_live_recheck = False\n",
        "                cache_pending = False\n",
        "\n",
        "\n",
        "\n",
        "                if USE_CACHE and cached and cached.get('v') == CACHE_VERSION and cached.get('last_mod') == remote_mod and 'rows' in cached and len(cached['rows']) > 0:\n",
        "\n",
        "                    cache_pending = any(r.get('is_missing') for r in cached.get('rows', []))\n",
        "\n",
        "                    if cache_pending:\n",
        "\n",
        "                        force_live_recheck = True\n",
        "\n",
        "                        logger.info(f\"  ‚ôªÔ∏è Cache Recheck: [{idx}/{total_revs}] {reviewer_name} has pending rows; reading live and overwriting cache.\")\n",
        "\n",
        "                    else:\n",
        "\n",
        "                        is_hit = True\n",
        "\n",
        "                        logger.info(f\"  üßä Cache Hit (Completed): [{idx}/{total_revs}] {reviewer_name} | rows:{len(cached['rows'])}\")\n",
        "\n",
        "                else:\n",
        "\n",
        "                    if not USE_CACHE:\n",
        "\n",
        "                        logger.info(f\"  ‚ÑπÔ∏è Cache Bypass: [{idx}/{total_revs}] {reviewer_name} (USE_CACHE=False)\")\n",
        "\n",
        "                    elif not cached:\n",
        "\n",
        "                        logger.info(f\"  ‚ÑπÔ∏è Cache Miss: [{idx}/{total_revs}] {reviewer_name} (no cache key)\")\n",
        "\n",
        "                    elif cached.get('v') != CACHE_VERSION:\n",
        "\n",
        "                        logger.info(f\"  ‚ÑπÔ∏è Cache Miss: [{idx}/{total_revs}] {reviewer_name} (version {cached.get('v')} != {CACHE_VERSION})\")\n",
        "\n",
        "                    elif cached.get('last_mod') != remote_mod:\n",
        "\n",
        "                        logger.info(f\"  ‚ÑπÔ∏è Cache Miss: [{idx}/{total_revs}] {reviewer_name} (modified changed)\")\n",
        "\n",
        "                    else:\n",
        "\n",
        "                        logger.info(f\"  ‚ÑπÔ∏è Cache Miss: [{idx}/{total_revs}] {reviewer_name} (no cached rows)\")\n",
        "\n",
        "\n",
        "\n",
        "                if is_hit:\n",
        "\n",
        "                    audit_snap = cached.get('audit', {})\n",
        "\n",
        "                    c_appr = cached['stats']['Appr']\n",
        "\n",
        "                    c_deny = cached['stats']['Deny']\n",
        "\n",
        "                    c_chg = cached['stats']['Chg']\n",
        "\n",
        "                    c_miss = sum(1 for r in cached['rows'] if r['is_missing'])\n",
        "\n",
        "\n",
        "\n",
        "                    logger.info(f\"  ‚úÖ Read (Cache): [{idx}/{total_revs}] {reviewer_name} (Missing:{c_miss})(A:{c_appr}, D:{c_deny}, C:{c_chg})\")\n",
        "\n",
        "\n",
        "\n",
        "                    for r in cached['rows']:\n",
        "\n",
        "                        r_copy = r.copy()\n",
        "\n",
        "                        st = get_row_stats(r['response'])\n",
        "\n",
        "                        r_copy.update({\n",
        "\n",
        "                            \"Category\": category, \"App_Name\": current_app_name,\n",
        "\n",
        "                            \"Last_Modified\": remote_mod, \"File_Created_Date\": audit_snap.get('created_ts'),\n",
        "\n",
        "                            \"Audit_Log\": audit_snap.get('log'), \"File_Creator\": audit_snap.get('creator'), \"File_Modifier\": audit_snap.get('modifier'),\n",
        "\n",
        "                            \"stats_appr\": st['is_appr'], \"stats_deny\": st['is_deny'], \"stats_chg\": st['is_chg'],\n",
        "\n",
        "                            \"source_is_cache\": True\n",
        "\n",
        "                        })\n",
        "\n",
        "                        all_responses.append(r_copy)\n",
        "\n",
        "                    continue\n",
        "\n",
        "\n",
        "\n",
        "                content = download_file(site_id, f\"{folder_path}/{target_file['name']}\")\n",
        "\n",
        "                audit_info = get_file_audit_info(site_id, target_file[\"id\"])\n",
        "\n",
        "\n",
        "\n",
        "                rows, detected_col_map, map_source = read_excel_rows(\n",
        "                    content, reviewer_name, target_file['name'], folder_url, app_col_map=app_col_map\n",
        "                )\n",
        "\n",
        "                if detected_col_map and not app_col_map:\n",
        "\n",
        "                    app_col_map = detected_col_map\n",
        "\n",
        "                    app_column_map_store[app_schema_key] = detected_col_map\n",
        "\n",
        "                    logger.info(\n",
        "                        f\"  üß≠ App Column Map Locked: NameIdx={detected_col_map.get('idx_user')} \"\n",
        "                        f\"EmailIdx={detected_col_map.get('idx_email')} Source={map_source}\"\n",
        "                    )\n",
        "                elif detected_col_map and map_source == \"app-locked\":\n",
        "\n",
        "                    logger.info(\n",
        "                        f\"  üß≠ App Column Map Reused: NameIdx={detected_col_map.get('idx_user')} \"\n",
        "                        f\"EmailIdx={detected_col_map.get('idx_email')}\"\n",
        "                    )\n",
        "                else:\n",
        "\n",
        "                    logger.warning(f\"  ‚ö†Ô∏è Column Mapping Failed: [{idx}/{total_revs}] {reviewer_name}\")\n",
        "\n",
        "\n",
        "\n",
        "                s_appr, s_deny, s_chg, miss_cnt = 0, 0, 0, 0\n",
        "\n",
        "                clean_rows_cache = []\n",
        "\n",
        "                final_created = audit_info.get('created_ts') or target_file.get(\"createdDateTime\")\n",
        "\n",
        "\n",
        "\n",
        "                for r in rows:\n",
        "\n",
        "                    st = get_row_stats(r['response'])\n",
        "\n",
        "                    s_appr += st['is_appr']; s_deny += st['is_deny']; s_chg += st['is_chg']\n",
        "\n",
        "                    if r['is_missing']: miss_cnt += 1\n",
        "\n",
        "\n",
        "\n",
        "                    clean_rows_cache.append({\n",
        "\n",
        "                        \"reviewer\": r['reviewer'], \"user_name\": r.get('user_name', ''), \"user_email\": r.get('user_email', ''),\n",
        "\n",
        "                        \"response\": r['response'], \"details\": r['details'],\n",
        "\n",
        "                        \"is_missing\": r['is_missing'], \"row_number\": r['row_number'],\n",
        "\n",
        "                        \"file_name\": r['file_name'], \"folder_url\": r['folder_url']\n",
        "\n",
        "                    })\n",
        "\n",
        "\n",
        "\n",
        "                    r.update({\n",
        "\n",
        "                        \"Category\": category, \"App_Name\": current_app_name,\n",
        "\n",
        "                        \"Last_Modified\": remote_mod, \"File_Created_Date\": final_created,\n",
        "\n",
        "                        \"Audit_Log\": audit_info['log'], \"File_Creator\": audit_info['creator'], \"File_Modifier\": audit_info['modifier'],\n",
        "\n",
        "                        \"stats_appr\": st['is_appr'], \"stats_deny\": st['is_deny'], \"stats_chg\": st['is_chg'],\n",
        "\n",
        "                        \"source_is_cache\": False\n",
        "\n",
        "                    })\n",
        "\n",
        "\n",
        "\n",
        "                all_responses.extend(rows)\n",
        "\n",
        "\n",
        "\n",
        "                logger.info(\n",
        "                    f\"  ‚úÖ Read (Live): [{idx}/{total_revs}] {reviewer_name} \"\n",
        "                    f\"(Rows:{len(rows)} Missing:{miss_cnt})(A:{s_appr}, D:{s_deny}, C:{s_chg})\"\n",
        "                )\n",
        "\n",
        "\n",
        "\n",
        "                if rows or force_live_recheck:\n",
        "\n",
        "                    local_cache[cache_key] = {\n",
        "\n",
        "                        \"v\": CACHE_VERSION, \"last_mod\": remote_mod,\n",
        "\n",
        "                        \"stats\": {\"Appr\": s_appr, \"Deny\": s_deny, \"Chg\": s_chg},\n",
        "\n",
        "                        \"audit\": audit_info, \"rows\": clean_rows_cache\n",
        "\n",
        "                    }\n",
        "\n",
        "                    cache_updated = True\n",
        "\n",
        "                    logger.info(\n",
        "                        f\"  üíæ Cache Write: [{idx}/{total_revs}] {reviewer_name} \"\n",
        "                        f\"(Rows:{len(clean_rows_cache)} Missing:{miss_cnt} PendingRecheck:{force_live_recheck})\"\n",
        "                    )\n",
        "\n",
        "\n",
        "\n",
        "            except Exception as e:\n",
        "\n",
        "                logger.error(f\"  ‚ùå Error {reviewer_name}: {e}\")\n",
        "\n",
        "                errors.append({\"Category\": category, \"App_Name\": current_app_name, \"reviewer\": reviewer_name, \"error\": str(e), \"folder_url\": folder_url})\n",
        "\n",
        "\n",
        "\n",
        "    except Exception as e: logger.error(f\"‚ùå App Error: {e}\")\n",
        "\n",
        "\n",
        "\n",
        "if cache_updated:\n",
        "\n",
        "    save_json(CACHE_FILE, local_cache)\n",
        "\n",
        "    logger.info(\"üíæ Cache Updated (v4.2)\")\n",
        "\n",
        "\n",
        "\n",
        "# ==========================================\n",
        "\n",
        "# PART 4: DASHBOARD\n",
        "\n",
        "# ==========================================\n",
        "\n",
        "df = pd.DataFrame(all_responses)\n",
        "\n",
        "widget_store = {}\n",
        "\n",
        "unified_data = {}\n",
        "\n",
        "today_str = datetime.now().strftime(\"%Y-%m-%d\")\n",
        "\n",
        "report_dir = f\"output/{today_str}/report\"\n",
        "\n",
        "os.makedirs(report_dir, exist_ok=True)\n",
        "\n",
        "\n",
        "\n",
        "if not df.empty:\n",
        "\n",
        "    stats = df.groupby([\"Category\", \"App_Name\", \"reviewer\"]).agg(\n",
        "\n",
        "        missing=(\"is_missing\", \"sum\"),\n",
        "\n",
        "        approved=(\"stats_appr\", \"sum\"), denied=(\"stats_deny\", \"sum\"), changed=(\"stats_chg\", \"sum\"),\n",
        "\n",
        "        f_creator=(\"File_Creator\", \"first\"), f_modifier=(\"File_Modifier\", \"first\"), audit=(\"Audit_Log\", \"first\"),\n",
        "\n",
        "        is_cached=(\"source_is_cache\", \"all\")\n",
        "\n",
        "    ).reset_index()\n",
        "\n",
        "\n",
        "\n",
        "    for _, row in stats.iterrows():\n",
        "\n",
        "        key = f\"{row['Category']} > {row['App_Name']}\"\n",
        "\n",
        "        if key not in unified_data:\n",
        "\n",
        "            saved_app = manual_data_store.get(key, {})\n",
        "\n",
        "            unified_data[key] = {\n",
        "\n",
        "                \"Category\": row['Category'], \"App_Name\": row['App_Name'],\n",
        "\n",
        "                \"status_manual\": saved_app.get(\"app_status\", \"Calculated\"), \"note_manual\": saved_app.get(\"app_note\", \"\"),\n",
        "\n",
        "                \"reviewers\": {}, \"stats\": {\"total_users\": 0, \"completed_users\": 0}\n",
        "\n",
        "            }\n",
        "\n",
        "\n",
        "\n",
        "        node = unified_data[key]\n",
        "\n",
        "        node['stats']['total_users'] += 1\n",
        "\n",
        "        is_done = (row['missing'] == 0)\n",
        "\n",
        "        if is_done: node['stats']['completed_users'] += 1\n",
        "\n",
        "        status_calc = f\"‚ùå Pending: {row['missing']}\"\n",
        "\n",
        "        if is_done: status_calc = \"‚úÖ Cached - Completed\" if row['is_cached'] else \"‚úÖ Completed\"\n",
        "\n",
        "\n",
        "\n",
        "        d_style = \"color:red;font-weight:bold\" if row['denied'] > 0 else \"color:#555\"\n",
        "\n",
        "        node['reviewers'][row['reviewer']] = {\n",
        "\n",
        "            \"status_calc\": status_calc,\n",
        "\n",
        "            \"detail_html\": f\"Appr:{int(row['approved'])} | <span style='{d_style}'>Deny:{int(row['denied'])}</span> | Chg:{int(row['changed'])}\",\n",
        "\n",
        "            \"folder_url\": df[(df['App_Name'] == row['App_Name']) & (df['reviewer'] == row['reviewer'])].iloc[0].get('folder_url', '#')\n",
        "\n",
        "        }\n",
        "\n",
        "\n",
        "\n",
        "def build_dashboard():\n",
        "\n",
        "    container = widgets.VBox()\n",
        "\n",
        "    btn_export = widgets.Button(description=\"üíæ Save Reports\", button_style='success', icon='file-excel')\n",
        "\n",
        "    btn_global = widgets.Button(description=\"üìä Global Report\", button_style='primary')\n",
        "\n",
        "    lbl_out = widgets.Label()\n",
        "\n",
        "\n",
        "\n",
        "    app_widgets = []\n",
        "\n",
        "    for app_key in sorted(unified_data.keys()):\n",
        "\n",
        "        app_data = unified_data[app_key]\n",
        "\n",
        "        pct = int((app_data['stats']['completed_users'] / app_data['stats']['total_users'] * 100)) if app_data['stats']['total_users'] > 0 else 0\n",
        "\n",
        "        w_lbl = widgets.HTML(f\"<b>üìÇ {app_key}</b> &nbsp; <span style='background:#eee; padding:2px 5px; border-radius:4px'>{pct}% Done</span>\", layout=widgets.Layout(width='400px'))\n",
        "\n",
        "        w_stat = widgets.Dropdown(options=[\"Calculated\", \"Force Completed\", \"Action Required\"], value=app_data['status_manual'], layout=widgets.Layout(width='150px'))\n",
        "\n",
        "        widget_store[app_key] = {\"data\": app_data, \"w_stat\": w_stat}\n",
        "\n",
        "\n",
        "\n",
        "        rev_list = widgets.VBox([\n",
        "\n",
        "            widgets.HBox([\n",
        "\n",
        "                widgets.HTML(f\"<a href='{rd['folder_url']}' target='_blank'>{rn}</a>\", layout=widgets.Layout(width='250px')),\n",
        "\n",
        "                widgets.HTML(rd['status_calc'], layout=widgets.Layout(width='200px')),\n",
        "\n",
        "                widgets.HTML(rd['detail_html'])\n",
        "\n",
        "            ]) for rn, rd in app_data['reviewers'].items()\n",
        "\n",
        "        ], layout=widgets.Layout(margin='5px 0 5px 20px', display='none'))\n",
        "\n",
        "\n",
        "\n",
        "        btn_tog = widgets.Button(description=\"‚ûï Show Users\", layout=widgets.Layout(width='100px'))\n",
        "\n",
        "        def create_tog(w):\n",
        "\n",
        "            def on_tog(b):\n",
        "\n",
        "                if w.layout.display == 'none': w.layout.display = 'block'; b.description = \"‚ûñ Hide\"\n",
        "\n",
        "                else: w.layout.display = 'none'; b.description = \"‚ûï Show Users\"\n",
        "\n",
        "            return on_tog\n",
        "\n",
        "        btn_tog.on_click(create_tog(rev_list))\n",
        "\n",
        "        app_widgets.append(widgets.VBox([widgets.HBox([btn_tog, w_lbl, w_stat]), rev_list]))\n",
        "\n",
        "\n",
        "\n",
        "    def export(b):\n",
        "\n",
        "        b.disabled=True; b.description=\"Saving...\"\n",
        "\n",
        "        saved_files = []\n",
        "\n",
        "        for app_key, widget_data in widget_store.items():\n",
        "\n",
        "            app_name = widget_data['data']['App_Name']\n",
        "\n",
        "            category = widget_data['data']['Category']\n",
        "\n",
        "            app_rows = df[(df['Category'] == category) & (df['App_Name'] == app_name)].to_dict('records')\n",
        "\n",
        "\n",
        "\n",
        "            final_data = []\n",
        "\n",
        "            for row in app_rows:\n",
        "\n",
        "                fin_st = widget_data['w_stat'].value\n",
        "\n",
        "                if fin_st == \"Calculated\": fin_st = \"Cached - Completed\" if row.get('source_is_cache') else \"Completed\"\n",
        "\n",
        "\n",
        "\n",
        "                final_data.append({\n",
        "\n",
        "                    \"User Name\": row.get('user_name', ''),\n",
        "\n",
        "                    \"User Email\": row.get('user_email', ''),\n",
        "\n",
        "                    \"Reviewer\": row['reviewer'],\n",
        "\n",
        "                    \"File Name\": row.get('file_name'),\n",
        "\n",
        "                    \"Reviewer Response\": row.get('response'),\n",
        "\n",
        "                    \"Details of Access Change\": row.get('details'),\n",
        "\n",
        "                    \"Final Status\": fin_st,\n",
        "\n",
        "                    \"Row Num\": row.get('row_number'),\n",
        "\n",
        "                    \"Audit Log\": row.get('Audit_Log')\n",
        "\n",
        "                })\n",
        "\n",
        "\n",
        "\n",
        "            if final_data:\n",
        "\n",
        "                safe_name = re.sub(r'[\\\\/*?:\"<>|]', \"\", app_name)\n",
        "\n",
        "                f_path = safe_excel_path(f\"{report_dir}/{safe_name}_{today_str}.xlsx\")\n",
        "\n",
        "                pd.DataFrame(final_data).to_excel(f_path, index=False)\n",
        "                format_export_excel(f_path)\n",
        "\n",
        "                saved_files.append(safe_name)\n",
        "\n",
        "\n",
        "\n",
        "        lbl_out.value = f\"Saved {len(saved_files)} files.\"\n",
        "\n",
        "        b.disabled=False; b.description=\"üíæ Save Reports\"\n",
        "\n",
        "\n",
        "\n",
        "    def export_global(b):\n",
        "\n",
        "        b.disabled = True; b.description = \"Saving...\"\n",
        "\n",
        "        rows = []\n",
        "\n",
        "        for _, r in stats.sort_values(\"App_Name\").iterrows():\n",
        "\n",
        "            rows.append({\n",
        "\n",
        "                \"Category\": r['Category'],\n",
        "\n",
        "                \"App Name\": r['App_Name'],\n",
        "\n",
        "                \"Reviewer\": r['reviewer'],\n",
        "\n",
        "                \"Final Status\": \"Completed\" if r['missing'] == 0 else \"Pending\",\n",
        "\n",
        "                \"Total Approved\": int(r['approved']),\n",
        "\n",
        "                \"Total Denied\": int(r['denied']),\n",
        "\n",
        "                \"Total Changed\": int(r['changed'])\n",
        "\n",
        "            })\n",
        "\n",
        "        f_path = safe_excel_path(f\"{report_dir}/Summary_Report_{today_str}.xlsx\")\n",
        "\n",
        "        pd.DataFrame(rows).to_excel(f_path, index=False)\n",
        "        format_export_excel(f_path)\n",
        "\n",
        "        lbl_out.value = f\"Global report saved.\"\n",
        "\n",
        "        b.disabled = False; b.description = \"üìä Global Report\"\n",
        "\n",
        "\n",
        "\n",
        "    btn_export.on_click(export)\n",
        "\n",
        "    btn_global.on_click(export_global)\n",
        "\n",
        "    container.children = tuple([widgets.HBox([btn_export, btn_global, lbl_out])] + app_widgets)\n",
        "\n",
        "    display(container)\n",
        "\n",
        "\n",
        "\n",
        "if unified_data:\n",
        "\n",
        "    build_dashboard()\n",
        "\n",
        "else:\n",
        "\n",
        "    print(\"‚ö†Ô∏è No data found.\")\n"
      ]
    },
    {
      "cell_type": "code",
      "execution_count": null,
      "metadata": {},
      "outputs": [],
      "source": [
        "# === Cell 6: Email Notification (Merge & Apple Bank Template with SEND ALL) ===\n",
        "import ipywidgets as widgets\n",
        "from urllib.parse import quote\n",
        "from datetime import datetime, timedelta\n",
        "import requests\n",
        "import pandas as pd\n",
        "import re\n",
        "from IPython.display import display, clear_output, HTML\n",
        "\n",
        "# --- 1. Helper Functions ---\n",
        "def get_email(name): \n",
        "    if not name: return \"\"\n",
        "    try:\n",
        "        clean = quote(name.split(\"(\")[0].strip())\n",
        "        url = f\"https://graph.microsoft.com/v1.0/users?$filter=startswith(displayName,'{clean}')&$select=mail,userPrincipalName\"\n",
        "        res = requests.get(url, headers=headers).json().get('value')\n",
        "        if res: return res[0].get('mail') or res[0].get('userPrincipalName')\n",
        "    except: pass\n",
        "    return \"\"\n",
        "\n",
        "def fmt_date_long(iso_date_str):\n",
        "    if not iso_date_str or pd.isna(iso_date_str): return \"Unknown Date\"\n",
        "    try:\n",
        "        dt_str = str(iso_date_str).replace('Z', '').split('.')[0]\n",
        "        dt = datetime.fromisoformat(dt_str)\n",
        "        return dt.strftime(\"%B %d, %Y\")\n",
        "    except: return str(iso_date_str)\n",
        "\n",
        "def calc_due_date_long(iso_date_str):\n",
        "    if not iso_date_str or pd.isna(iso_date_str): return \"ASAP\"\n",
        "    try:\n",
        "        dt_str = str(iso_date_str).replace('Z', '').split('.')[0]\n",
        "        dt = datetime.fromisoformat(dt_str)\n",
        "        due = dt + timedelta(days=14)\n",
        "        return due.strftime(\"%B %d, %Y\")\n",
        "    except: return \"ASAP\"\n",
        "\n",
        "def parse_email_list(raw_text):\n",
        "    if not raw_text:\n",
        "        return []\n",
        "    parts = re.split(r\"[,\\n;]+\", str(raw_text))\n",
        "    return [p.strip() for p in parts if p and p.strip()]\n",
        "\n",
        "# --- 2. Data Preparation ---\n",
        "if 'df' not in globals() or df.empty:\n",
        "    display(widgets.HTML(\"<h4 style='color:red'>‚ö†Ô∏è No data found. Run Cell 5 first.</h4>\"))\n",
        "else:\n",
        "    pending_df = df[df['is_missing'] == True].copy()\n",
        "    targets = pending_df.groupby([\"Category\", \"App_Name\", \"reviewer\", \"folder_url\"]).agg(\n",
        "        missing_count=(\"is_missing\", \"count\"),\n",
        "        file_date_raw=(\"File_Created_Date\", \"min\") \n",
        "    ).reset_index()\n",
        "\n",
        "    notes_db = manual_data_store if 'manual_data_store' in globals() else {}\n",
        "    print(\"üîç Looking up emails for pending reviewers...\")\n",
        "    email_cache = {} \n",
        "    raw_data_list = []\n",
        "    \n",
        "    for _, r in targets.iterrows():\n",
        "        app_key = f\"{r['Category']} > {r['App_Name']}\"\n",
        "        rev_key = r['reviewer']\n",
        "        app_node = notes_db.get(app_key, {})\n",
        "        if app_node.get(\"app_status\") in [\"Force Completed\", \"N/A\"]: continue\n",
        "        rev_override = app_node.get(\"reviewers\", {}).get(rev_key, {}).get(\"override\", \"-\")\n",
        "        if rev_override in [\"Mark Done\", \"Waived\", \"Escalated\"]: continue\n",
        "        \n",
        "        if rev_key not in email_cache: email_cache[rev_key] = get_email(rev_key)\n",
        "        raw_data_list.append({\n",
        "            \"App_Name\": r['App_Name'], \"reviewer\": r['reviewer'], \"missing\": r['missing_count'], \n",
        "            \"folder_url\": r['folder_url'], \"sent_date\": fmt_date_long(r['file_date_raw']),\n",
        "            \"due_date\": calc_due_date_long(r['file_date_raw']), \"email\": email_cache[rev_key]\n",
        "        })\n",
        "    clear_output()\n",
        "\n",
        "    # --- 3. UI Construction ---\n",
        "    current_year = datetime.now().year\n",
        "    default_subj_single = f\"REMINDER - {current_year} {{app_name}} Entitlement Review\"\n",
        "    default_subj_merge = f\"REMINDER - {current_year} Entitlement Reviews Action Required\"\n",
        "    \n",
        "    default_body = (\n",
        "        \"Hi {reviewer_name},<br><br>\"\n",
        "        \"The Information Security team is sending you a reminder to complete the <b>{app_name}</b> entitlement review that was sent to you on <b>{sent_date}</b>.<br><br>\"\n",
        "        \"The review was due on <b>{due_date}</b>. Please complete this review as soon as possible as it is now overdue. Your prompt assistance to this matter is appreciated.<br><br>\"\n",
        "        \"<b>Review Details:</b>\"\n",
        "        \"<ul><li>Pending Items: <b>{missing}</b></li>\"\n",
        "        \"<li>Link: <a href='{link}'>Open Access Review Folder</a></li></ul><br>\"\n",
        "        \"Sincerely,<br>Apple Bank's Information Security Team\"\n",
        "    )\n",
        "\n",
        "    w_merge = widgets.Checkbox(value=True, description=\"<b>üîó Merge Apps by Reviewer</b>\", indent=False)\n",
        "    w_subject_tpl = widgets.Text(value=default_subj_merge, description=\"<b>Subject:</b>\", layout=widgets.Layout(width='98%'))\n",
        "    w_cc_global = widgets.Textarea(\n",
        "        value=\"\",\n",
        "        description=\"<b>Global CC:</b>\",\n",
        "        placeholder=\"manager@applebank.com, team@applebank.com\",\n",
        "        layout=widgets.Layout(width='98%', height='60px')\n",
        "    )\n",
        "    w_reply_to = widgets.Text(\n",
        "        value=\"\",\n",
        "        description=\"<b>Reply-To:</b>\",\n",
        "        placeholder=\"security-team@applebank.com\",\n",
        "        layout=widgets.Layout(width='98%')\n",
        "    )\n",
        "    w_body_tpl = widgets.Textarea(value=default_body.replace(\"<br>\", \"\\n\"), layout=widgets.Layout(width='100%', height='150px'))\n",
        "    btn_refresh = widgets.Button(description=\"üîÑ Refresh List\", button_style='info', layout=widgets.Layout(width='200px'))\n",
        "    \n",
        "    btn_send_all = widgets.Button(description=\"üî• Send All (Batch)\", button_style='danger', layout=widgets.Layout(width='200px'))\n",
        "    \n",
        "    container_rows = widgets.VBox()\n",
        "    row_logic_store = {}\n",
        "\n",
        "    def render_rows(b=None):\n",
        "        global row_logic_store\n",
        "        row_logic_store = {}\n",
        "        container_rows.children = (widgets.Label(\"Loading...\"),)\n",
        "        is_merged = w_merge.value\n",
        "        if is_merged and \"{app_name}\" in w_subject_tpl.value: w_subject_tpl.value = default_subj_merge\n",
        "        elif not is_merged and \"{app_name}\" not in w_subject_tpl.value: w_subject_tpl.value = default_subj_single\n",
        "\n",
        "        df_raw = pd.DataFrame(raw_data_list)\n",
        "        if df_raw.empty: container_rows.children = (widgets.HTML(\"<h3>‚úÖ No pending emails to send!</h3>\"),); return\n",
        "\n",
        "        final_rows = []\n",
        "        if is_merged:\n",
        "            grouped = df_raw.groupby(['reviewer', 'email'])\n",
        "            for (rev, mail), group in grouped:\n",
        "                apps_html = \"<table border='1' style='border-collapse:collapse; width:100%; font-size:12px; border:1px solid #ddd'>\"\n",
        "                apps_html += \"<tr style='background:#f3f3f3'><th>App Name</th><th>Sent Date</th><th>Due Date</th><th>Missing</th><th>Link</th></tr>\"\n",
        "                for _, row in group.iterrows():\n",
        "                    apps_html += f\"<tr><td style='padding:5px'>{row['App_Name']}</td><td style='padding:5px'>{row['sent_date']}</td><td style='padding:5px'>{row['due_date']}</td><td style='padding:5px; text-align:center'>{row['missing']}</td><td style='padding:5px'><a href='{row['folder_url']}'>Open</a></td></tr>\"\n",
        "                apps_html += \"</table>\"\n",
        "                final_rows.append({\"key\": rev, \"reviewer\": rev, \"email\": mail, \"is_merged\": True, \"merged_html\": apps_html,\n",
        "                                   \"ctx\": {\"reviewer_name\": rev, \"app_name\": \"following applications\", \"sent_date\": \"previous dates\", \"due_date\": \"recently\", \"missing\": int(group['missing'].sum()), \"link\": \"#\"}})\n",
        "        else:\n",
        "            for idx, r in df_raw.iterrows():\n",
        "                final_rows.append({\"key\": f\"{r['reviewer']}_{r['App_Name']}\", \"reviewer\": r['reviewer'], \"email\": r['email'], \"is_merged\": False,\n",
        "                                   \"ctx\": {\"reviewer_name\": r['reviewer'], \"app_name\": r['App_Name'], \"sent_date\": r['sent_date'], \"due_date\": r['due_date'], \"missing\": r['missing'], \"link\": r['folder_url']}})\n",
        "\n",
        "        ui_items = []\n",
        "        for item in final_rows:\n",
        "            key = item['key']\n",
        "            email_color = \"#0078d4\" if item['email'] else \"red\"\n",
        "            info_html = (f\"<b>üë§ {item['reviewer']}</b><br><span style='color:{email_color}'>{item['email'] or '(No Email)'}</span><br>\"\n",
        "                         f\"<span style='color:darkorange'>Combine {item['ctx']['missing']} items</span>\") if item['is_merged'] else \\\n",
        "                        (f\"<b>üë§ {item['reviewer']}</b><br>üìÇ {item['ctx']['app_name']}<br><span style='color:{email_color}'>{item['email'] or '(No Email)'}</span>\")\n",
        "\n",
        "            w_chk = widgets.Checkbox(value=True, layout=widgets.Layout(width='30px'))\n",
        "            w_info = widgets.HTML(info_html, layout=widgets.Layout(width='200px'))\n",
        "            tpl_body = w_body_tpl.value.replace(\"\\n\", \"<br>\")\n",
        "            final_preview_html = (\"Hi \" + item['reviewer'] + \",<br><br>The Information Security team is sending you a reminder to complete the entitlement reviews for the following applications:<br><br>\" + item['merged_html'] + \"<br><br>Please complete these reviews as soon as possible. Your prompt assistance to this matter is appreciated.<br><br>Sincerely,<br>Apple Bank's Information Security Team\") if item['is_merged'] else tpl_body.format(**item['ctx'])\n",
        "            \n",
        "            w_preview = widgets.HTML(value=f\"<div style='font-family:sans-serif; font-size:12px; padding:5px; color:#333'>{final_preview_html}</div>\", layout=widgets.Layout(width='100%', height='140px', border='1px solid #eee', overflow_y='auto'))\n",
        "            w_email = widgets.Text(value=item['email'], placeholder=\"Email\", layout=widgets.Layout(width='98%'))\n",
        "            w_btn = widgets.Button(description=\"üöÄ Send\", button_style='warning', layout=widgets.Layout(width='80px'))\n",
        "\n",
        "            def create_sender(k, preview_html, subj_tpl, btn_obj):\n",
        "                def on_send(b):\n",
        "                    if not row_logic_store[k]['w_email'].value: \n",
        "                        btn_obj.description = \"No Email\"; return\n",
        "                    btn_obj.disabled = True; btn_obj.description = \"...\"\n",
        "                    try:\n",
        "                        final_subj = subj_tpl if item['is_merged'] else subj_tpl.format(**item['ctx'])\n",
        "                        url = f\"https://graph.microsoft.com/v1.0/users/{SENDER_EMAIL}/sendMail\"\n",
        "                        to_list = [{\"emailAddress\": {\"address\": row_logic_store[k]['w_email'].value}}]\n",
        "                        cc_list = [{\"emailAddress\": {\"address\": e}} for e in parse_email_list(w_cc_global.value)]\n",
        "                        reply_to_list = [{\"emailAddress\": {\"address\": e}} for e in parse_email_list(w_reply_to.value)]\n",
        "                        message_payload = {\n",
        "                            \"subject\": final_subj,\n",
        "                            \"body\": {\"contentType\": \"HTML\", \"content\": preview_html},\n",
        "                            \"toRecipients\": to_list\n",
        "                        }\n",
        "                        if cc_list:\n",
        "                            message_payload[\"ccRecipients\"] = cc_list\n",
        "                        if reply_to_list:\n",
        "                            message_payload[\"replyTo\"] = reply_to_list\n",
        "                        payload = {\"message\": message_payload}\n",
        "                        r = requests.post(url, headers={**headers, \"Content-Type\": \"application/json\"}, json=payload)\n",
        "                        if r.status_code == 202: \n",
        "                            btn_obj.button_style = 'success'; btn_obj.description = \"Sent\"\n",
        "                            row_logic_store[k]['w_chk'].value = False\n",
        "                        else: \n",
        "                            btn_obj.button_style = 'danger'; btn_obj.description = \"Fail\"\n",
        "                            print(r.text)\n",
        "                    except Exception as e: print(e); btn_obj.button_style = 'danger'\n",
        "                    finally: \n",
        "                        if btn_obj.description != \"Sent\": btn_obj.disabled = False\n",
        "                return on_send\n",
        "            \n",
        "            sender_func = create_sender(key, final_preview_html, w_subject_tpl.value, w_btn)\n",
        "            w_btn.on_click(sender_func)\n",
        "            \n",
        "            row_logic_store[key] = {'w_chk': w_chk, 'w_email': w_email, 'w_btn': w_btn, 'trigger_send': sender_func}\n",
        "            \n",
        "            ui_items.append(widgets.HBox([w_chk, w_info, widgets.VBox([widgets.Label(\"Preview:\"), w_preview], layout=widgets.Layout(flex='1', padding='0 10px')), widgets.VBox([widgets.Label(\"Action:\"), w_email, w_btn], layout=widgets.Layout(width='150px'))], layout=widgets.Layout(border='1px solid #ccc', margin='5px 0', padding='5px', align_items='center')))\n",
        "        container_rows.children = tuple(ui_items)\n",
        "\n",
        "    def trigger_batch_send(b):\n",
        "        b.disabled = True; b.description = \"Sending...\"\n",
        "        count = 0\n",
        "        for k, logic in row_logic_store.items():\n",
        "            if logic['w_chk'].value and logic['w_btn'].description != \"Sent\":\n",
        "                logic['trigger_send'](logic['w_btn'])\n",
        "                count += 1\n",
        "        b.disabled = False; b.description = f\"üî• Send All (Batch) - Done {count}\"\n",
        "\n",
        "    w_merge.observe(render_rows, names='value')\n",
        "    btn_refresh.on_click(render_rows)\n",
        "    btn_send_all.on_click(trigger_batch_send)\n",
        "    \n",
        "    render_rows()\n",
        "    display(widgets.VBox([\n",
        "        widgets.HTML(\"<h3>üìß Email Notification Center</h3>\"), \n",
        "        widgets.HBox([w_merge, btn_refresh, btn_send_all]),\n",
        "        widgets.HTML(\"<hr>\"), \n",
        "        w_subject_tpl, w_cc_global, w_reply_to,\n",
        "        widgets.Label(\"Body Template (Single App Only):\"), w_body_tpl\n",
        "    ], layout=widgets.Layout(background_color='#f0f4f8', padding='10px', border='1px solid #ccc', margin='0 0 10px 0')), container_rows)\n"
      ]
    }
  ],
  "metadata": {
    "kernelspec": {
      "display_name": "Python 3",
      "language": "python",
      "name": "python3"
    },
    "language_info": {
      "codemirror_mode": {
        "name": "ipython",
        "version": 3
      },
      "file_extension": ".py",
      "mimetype": "text/x-python",
      "name": "python",
      "nbformat_minor": 4,
      "pygments_lexer": "ipython3",
      "version": "3.8.5"
    }
  },
  "nbformat": 4,
  "nbformat_minor": 4
}
