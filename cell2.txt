# === Cell 2: è¨­å®šèˆ‡èªè­‰ (å®Œæ•´ä¿®å¾©ç‰ˆ) ===
import ipywidgets as widgets
from IPython.display import display, clear_output
import requests

# --- 1. SharePoint API Functions (æ ¸å¿ƒå‡½æ•¸å®šç¾©) ---
def get_site_id(site_name: str) -> str:
    url = f"https://graph.microsoft.com/v1.0/sites/{SHAREPOINT_HOST}:/sites/{site_name}"
    resp = requests.get(url, headers=headers)
    resp.raise_for_status()
    return resp.json()["id"]

def list_folders(site_id: str, path: str) -> list[dict]:
    if not path or path.strip() == "":
        url = f"https://graph.microsoft.com/v1.0/sites/{site_id}/drive/root/children"
    else:
        clean_path = path.strip("/")
        url = f"https://graph.microsoft.com/v1.0/sites/{site_id}/drive/root:/{clean_path}:/children"
    resp = requests.get(url, headers=headers)
    return [
        {"name": item["name"], "webUrl": item.get("webUrl", "")}
        for item in resp.json().get("value", []) if item.get("folder")
    ]

def list_excel_files(site_id: str, folder_path: str) -> list[dict]:
    clean_path = folder_path.strip("/")
    url = f"https://graph.microsoft.com/v1.0/sites/{site_id}/drive/root:/{clean_path}:/children"
    resp = requests.get(url, headers=headers)
    files = []
    for item in resp.json().get("value", []):
        if item["name"].endswith(".xlsx"):
            files.append({
                "id": item["id"], "name": item["name"],
                "lastModifiedDateTime": item.get("lastModifiedDateTime"),
                "createdDateTime": item.get("createdDateTime"), # æŠ“å–æª”æ¡ˆå»ºç«‹æ™‚é–“
                "webUrl": item.get("webUrl")
            })
    return sorted(files, key=lambda f: f.get("lastModifiedDateTime", ""), reverse=True)

def download_file(site_id: str, file_path: str) -> bytes:
    clean_path = file_path.strip("/")
    url = f"https://graph.microsoft.com/v1.0/sites/{site_id}/drive/root:/{clean_path}:/content"
    resp = requests.get(url, headers=headers)
    resp.raise_for_status()
    return resp.content

def get_file_audit_info(site_id: str, file_id: str) -> dict:
    url = f"https://graph.microsoft.com/v1.0/sites/{site_id}/drive/items/{file_id}/versions"
    resp = requests.get(url, headers=headers)
    default_res = {"log": "N/A", "creator": "Unknown", "modifier": "Unknown", "created_ts": None}
    
    if resp.status_code != 200: return default_res
    
    versions = resp.json().get("value", [])
    if not versions: return default_res

    # 1. è§£æ Log
    logs = []
    for v in versions:
        mod_time = v.get("lastModifiedDateTime", "")[:19].replace("T", " ")
        actor = v.get("lastModifiedBy", {}).get("user", {}).get("displayName") or "System"
        logs.append(f"{mod_time} - {actor}")
    
    # 2. æŠ“å–é¦–å°¾ç‰ˆæœ¬è³‡è¨Š
    last_v = versions[0]
    first_v = versions[-1] # æœ€æ—©çš„ç‰ˆæœ¬

    return {
        "log": "\n".join(logs),
        "creator": first_v.get("lastModifiedBy", {}).get("user", {}).get("displayName") or "System",
        "modifier": last_v.get("lastModifiedBy", {}).get("user", {}).get("displayName") or "System",
        "created_ts": first_v.get("lastModifiedDateTime")
    }

# --- 2. Initialize Connection ---
try:
    site_id = get_site_id(SITE_NAME)
    logger.info(f"âœ… SharePoint é€£ç·šæˆåŠŸ (Site ID: {site_id[:10]}...)")
except Exception as e:
    logger.error(f"âŒ é€£ç·šå¤±æ•—: {e}")
    # ä¸è¦åœ¨é€™è£¡ raiseï¼Œä»¥å…é˜»æ–·å¾ŒçºŒä¿®æ­£ï¼Œä½†é€šå¸¸é€™è£¡å¤±æ•—å¾Œé¢ä¹Ÿè·‘ä¸å‹•

# --- 3. Tree Selector UI (å« Cache é–‹é—œ) ---
TARGET_APPS = [] 
USE_CACHE = True # Default Global Variable

def create_app_selector():
    print(f"ğŸ“‚ æ­£åœ¨è®€å–æ ¹ç›®éŒ„: {BASE_PATH} ...")
    try:
        categories = list_folders(site_id, BASE_PATH)
    except Exception as e:
        print(f"âŒ è®€å–å¤±æ•—: {e}")
        return

    ui_container = widgets.VBox()
    app_checkboxes = []
    
    # Cache Toggle
    chk_cache = widgets.Checkbox(value=True, description="âš¡ ä½¿ç”¨å¿«å– (Use Cache)", indent=False)
    ui_container.children += (widgets.HTML("<h3>ğŸ“‚ App é¸æ“‡å™¨</h3>"), chk_cache, widgets.HTML("<hr>"))

    for cat in categories:
        if cat['name'] in ["Forms", "_private"] or "audit" in cat['name'].lower(): continue
            
        cat_label = widgets.HTML(f"<b>ğŸ“ {cat['name']}</b>", layout=widgets.Layout(width='100px'))
        btn_expand = widgets.Button(description="â• å±•é–‹", button_style='info', layout=widgets.Layout(width='80px'))
        app_list_box = widgets.VBox(layout=widgets.Layout(margin='0 0 0 30px', display='none'))
        
        def on_expand(b, cat_name=cat['name'], container=app_list_box, btn=btn_expand):
            if btn.description == "â• å±•é–‹":
                btn.description = "â³"
                sub_path = f"{BASE_PATH}/{cat_name}"
                try:
                    apps = list_folders(site_id, sub_path)
                    checks = []
                    if not apps: checks.append(widgets.Label("(ç„¡è³‡æ–™å¤¾)"))
                    
                    for app in apps:
                        if app['name'] in ["Forms", "_private"]: continue
                        cb = widgets.Checkbox(value=False, description=app['name'], indent=False)
                        cb.app_data = (cat_name, app['name'], f"{sub_path}/{app['name']}")
                        checks.append(cb)
                        app_checkboxes.append(cb)
                    
                    container.children = tuple(checks)
                    container.layout.display = 'block'
                    btn.description = "â– æ”¶èµ·"
                except Exception as e:
                    container.children = (widgets.Label(f"Error: {e}"),)
                    btn.description = "âŒ"
            else:
                if container.layout.display == 'none':
                    container.layout.display = 'block'; btn.description = "â– æ”¶èµ·"
                else:
                    container.layout.display = 'none'; btn.description = "â• å±•é–‹"

        btn_expand.on_click(on_expand)
        ui_container.children += (widgets.HBox([btn_expand, cat_label]), app_list_box)

    btn_confirm = widgets.Button(description="âœ… ç¢ºèªé¸æ“‡", button_style='success', layout=widgets.Layout(margin='20px 0'))
    output_area = widgets.Output()

    def on_confirm(b):
        global TARGET_APPS, USE_CACHE
        TARGET_APPS = [cb.app_data for cb in app_checkboxes if cb.value]
        USE_CACHE = chk_cache.value
        
        with output_area:
            clear_output()
            if not TARGET_APPS: print("âš ï¸ æœªé¸æ“‡ä»»ä½• Appï¼")
            else:
                cache_status = "é–‹å•Ÿ" if USE_CACHE else "é—œé–‰ (å¼·åˆ¶é‡æ–°è®€å–)"
                print(f"ğŸ¯ å·²é¸æ“‡ {len(TARGET_APPS)} å€‹ Apps | å¿«å–: {cache_status}")
                print("â³ è«‹åŸ·è¡Œ Cell 4 é–‹å§‹è™•ç†ã€‚")

    btn_confirm.on_click(on_confirm)
    display(ui_container, btn_confirm, output_area)

create_app_selector()