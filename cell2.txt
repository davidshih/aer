# === Cell 2: SharePoint API, App Selector (with Counts) ===
import ipywidgets as widgets
from IPython.display import display, clear_output
import requests

# --- 1. SharePoint API Functions ---
def get_site_id(site_name: str) -> str:
    url = f"https://graph.microsoft.com/v1.0/sites/{SHAREPOINT_HOST}:/sites/{site_name}"
    resp = requests.get(url, headers=headers)
    resp.raise_for_status()
    return resp.json()["id"]

def list_folders_with_count(site_id: str, path: str) -> list[dict]:
    """
    Returns list of folders with 'childCount' (how many subfolders/files inside)
    """
    if not path or path.strip() == "":
        url = f"https://graph.microsoft.com/v1.0/sites/{site_id}/drive/root/children"
    else:
        clean_path = path.strip("/")
        url = f"https://graph.microsoft.com/v1.0/sites/{site_id}/drive/root:/{clean_path}:/children"
    
    resp = requests.get(url, headers=headers)
    results = []
    for item in resp.json().get("value", []):
        if item.get("folder"):
            # Graph API returns 'childCount' inside the folder property
            count = item.get("folder", {}).get("childCount", 0)
            results.append({
                "name": item["name"], 
                "webUrl": item.get("webUrl", ""),
                "count": count
            })
    return results

# --- 2. Initialize Connection ---
try:
    site_id = get_site_id(SITE_NAME)
    logger.info(f"‚úÖ SharePoint Connected (Site ID: {site_id[:10]}...)\")
except Exception as e:
    logger.error(f"‚ùå Connection Failed: {e}")

# --- 3. Tree Selector UI (with Counts) ---
TARGET_APPS = [] 
USE_CACHE = True 

def create_app_selector():
    print(f"üìÇ Reading Root: {BASE_PATH} ...")
    try:
        categories = list_folders_with_count(site_id, BASE_PATH)
    except Exception as e:
        print(f"‚ùå Read Failed: {e}")
        return

    ui_container = widgets.VBox()
    app_checkboxes = []
    
    chk_cache = widgets.Checkbox(value=True, description="‚ö° Use Cache (Faster)", indent=False)
    ui_container.children += (widgets.HTML("<h3>üìÇ App Selector (v3.6)</h3>"), chk_cache, widgets.HTML("<hr>"))

    for cat in categories:
        if cat['name'] in ["Forms", "_private"] or "audit" in cat['name'].lower(): continue
            
        # Show Category Label
        cat_label = widgets.HTML(f"<b>üìÅ {cat['name']}</b>", layout=widgets.Layout(width='150px'))
        btn_expand = widgets.Button(description="‚ûï Expand", button_style='info', layout=widgets.Layout(width='80px'))
        app_list_box = widgets.VBox(layout=widgets.Layout(margin='0 0 0 30px', display='none'))
        
        def on_expand(b, cat_name=cat['name'], container=app_list_box, btn=btn_expand):
            if btn.description == "‚ûï Expand":
                btn.description = "‚è≥"
                sub_path = f"{BASE_PATH}/{cat_name}"
                try:
                    apps = list_folders_with_count(site_id, sub_path)
                    checks = []
                    if not apps: checks.append(widgets.Label("(Empty)"))
                    
                    for app in apps:
                        if app['name'] in ["Forms", "_private"]: continue
                        # Display count of sub-items (users)
                        count_display = f" <span style='color:#888; font-size:11px'>({app['count']} users)</span>"
                        cb = widgets.Checkbox(value=False, description=app['name'], indent=False, layout=widgets.Layout(width='400px'))
                        # Hack to render HTML in checkbox description is hard, so we use HBox
                        lbl_count = widgets.HTML(count_display)
                        
                        cb.app_data = (cat_name, app['name'], f"{sub_path}/{app['name']}")
                        app_checkboxes.append(cb)
                        checks.append(widgets.HBox([cb, lbl_count]))
                    
                    container.children = tuple(checks)
                    container.layout.display = 'block'
                    btn.description = "‚ûñ Collapse"
                except Exception as e:
                    container.children = (widgets.Label(f"Error: {e}"),)
                    btn.description = "‚ùå"
            else:
                if container.layout.display == 'none':
                    container.layout.display = 'block'; btn.description = "‚ûñ Collapse"
                else:
                    container.layout.display = 'none'; btn.description = "‚ûï Expand"

        btn_expand.on_click(on_expand)
        ui_container.children += (widgets.HBox([btn_expand, cat_label]), app_list_box)

    btn_confirm = widgets.Button(description="‚úÖ Confirm Selection", button_style='success', layout=widgets.Layout(margin='20px 0'))
    output_area = widgets.Output()

    def on_confirm(b):
        global TARGET_APPS, USE_CACHE
        TARGET_APPS = [cb.app_data for cb in app_checkboxes if cb.value]
        USE_CACHE = chk_cache.value
        
        with output_area:
            clear_output()
            if not TARGET_APPS: print("‚ö†Ô∏è No apps selected!")
            else:
                print(f"üéØ Selected {len(TARGET_APPS)} Apps | Cache: {USE_CACHE}")
                print("‚è≥ Proceed to Cell 4 (Enrichment) or Cell 5 (Scan).")

    btn_confirm.on_click(on_confirm)
    display(ui_container, btn_confirm, output_area)

create_app_selector()