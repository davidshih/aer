{
 "cells": [
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "#### üõ°Ô∏è AER - Smart Access Review Generator (v6.5 Robust Edition)\n",
    "\n",
    "**Refactoring Log:**\n",
    "1. **Robust AD Fetching**: Switched to `as_completed` pattern with `try-except` and `max_workers=25` for high reliability and speed.\n",
    "2. **UI Stability**: Fixed `clear_output` NameError and ensured clean UI rendering.\n",
    "3. **Audit Logic**: Email-first mapping. Invalid reviewers are flagged as 'Dept head: manual assign'.\n",
    "4. **UI Sorting**: Active (Top) > No AD Record (Middle) > Inactive (Bottom).\n",
    "5. **Progress Bar**: Real-time `n/N (P%)` counter that won't freeze on errors."
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "metadata": {},
   "outputs": [],
   "source": [
    "# === Cell 1: Environment & Authentication ===\n",
    "import os, sys, logging, glob, io, re, requests\n",
    "import pandas as pd\n",
    "import ipywidgets as widgets\n",
    "from datetime import datetime\n",
    "from dotenv import load_dotenv\n",
    "from msal import PublicClientApplication\n",
    "from collections import Counter\n",
    "from IPython.display import display, HTML, clear_output\n",
    "from concurrent.futures import ThreadPoolExecutor, as_completed\n",
    "from openpyxl import load_workbook\n",
    "from openpyxl.worksheet.datavalidation import DataValidation\n",
    "from openpyxl.utils import get_column_letter\n",
    "\n",
    "# 1. Setup Logging\n",
    "today = datetime.now().strftime('%Y-%m-%d')\n",
    "BASE_DIR = os.path.join(\"output\", today, \"create\")\n",
    "LOG_DIR = os.path.join(BASE_DIR, \"logs\")\n",
    "MAPPING_DIR = os.path.join(\"input\", \"mapping\")\n",
    "os.makedirs(LOG_DIR, exist_ok=True)\n",
    "\n",
    "log_file = os.path.join(LOG_DIR, f\"aer_create_{today}.log\")\n",
    "logger = logging.getLogger(\"aer\")\n",
    "logger.handlers.clear()\n",
    "logger.setLevel(logging.INFO)\n",
    "fh = logging.FileHandler(log_file, encoding=\"utf-8\")\n",
    "fh.setFormatter(logging.Formatter('%(asctime)s | %(levelname)s | %(message)s'))\n",
    "logger.addHandler(fh)\n",
    "logger.addHandler(logging.StreamHandler(sys.stdout))\n",
    "\n",
    "# 2. Azure AD Engine (Safe Auth)\n",
    "load_dotenv()\n",
    "headers = {}\n",
    "print(\"Checking Azure AD Authentication...\")\n",
    "try:\n",
    "    tid, cid = os.getenv(\"AZURE_TENANT_ID\"), os.getenv(\"AZURE_CLIENT_ID\")\n",
    "    if tid and cid:\n",
    "        app = PublicClientApplication(cid, authority=f\"https://login.microsoftonline.com/{tid}\")\n",
    "        res = app.acquire_token_interactive(scopes=[\"User.Read.All\"], prompt=\"select_account\")\n",
    "        if \"access_token\" in res:\n",
    "            headers = {\"Authorization\": f\"Bearer {res['access_token']}\"}\n",
    "            logger.info(\"Azure AD Auth Successful\")\n",
    "        else:\n",
    "            logger.warning(\"Auth failed or cancelled. AD lookup will be skipped.\")\n",
    "    else:\n",
    "        logger.warning(\"Azure Credentials missing in .env\")\n",
    "except Exception as e:\n",
    "    logger.error(f\"Auth Error: {str(e)}\")\n",
    "\n",
    "ad_cache = {}\n",
    "session = requests.Session()\n",
    "\n",
    "def fetch_ad_profile(email):\n",
    "    email = str(email).strip().lower()\n",
    "    if not re.match(r'^[a-z0-9.%+-]+@[a-z0-9.-]+\\.[a-z]{2,}$', email):\n",
    "        return {\"email\": email, \"status\": \"Invalid\", \"name\": \"N/A\", \"dept\": \"N/A\", \"active\": \"N/A\", \"last_seen\": \"invalid email\"}\n",
    "    if email in ad_cache: return ad_cache[email]\n",
    "    if not headers: return {\"email\": email, \"status\": \"No Auth\", \"name\": \"N/A\", \"dept\": \"N/A\", \"active\": \"N/A\", \"last_seen\": \"no token\"}\n",
    "    try:\n",
    "        url = f\"https://graph.microsoft.com/v1.0/users/{email}?$select=displayName,department,accountEnabled,signInActivity\"\n",
    "        r = session.get(url, headers=headers, timeout=5)\n",
    "        if r.status_code == 200:\n",
    "            d = r.json()\n",
    "            active = d.get(\"accountEnabled\", \"N/A\")\n",
    "            last_seen = \"\"\n",
    "            if d.get(\"signInActivity\"):\n",
    "                raw_date = d[\"signInActivity\"].get(\"lastSignInDateTime\", \"\")\n",
    "                if raw_date: last_seen = raw_date[:10]\n",
    "            res = {\"email\": email, \"status\": \"Found\", \"name\": d.get(\"displayName\", \"N/A\"), \n",
    "                   \"dept\": d.get(\"department\") or \"N/A\", \"active\": active, \"last_seen\": last_seen}\n",
    "        else:\n",
    "            res = {\"email\": email, \"status\": \"Not Found\", \"name\": \"N/A\", \"dept\": \"N/A\", \"active\": \"N/A\", \"last_seen\": \"no AD record\"}\n",
    "    except Exception as e:\n",
    "        res = {\"email\": email, \"status\": \"Error\", \"name\": \"N/A\", \"dept\": \"N/A\", \"active\": \"N/A\", \"last_seen\": \"error\"}\n",
    "    ad_cache[email] = res\n",
    "    return res"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "metadata": {},
   "outputs": [],
   "source": [
    "# === Cell 2: UI Components & Logic ===\n",
    "up_list = widgets.FileUpload(accept='.xlsx, .csv', description=\"1. User List\", button_style='info')\n",
    "txt_list = widgets.HTML(value=\"<i>No file selected</i>\", layout=widgets.Layout(margin='0 10px'))\n",
    "up_map = widgets.FileUpload(accept='.csv', description=\"2. Reviewer Map\", button_style='info')\n",
    "\n",
    "def get_latest_map():\n",
    "    files = glob.glob(os.path.join(MAPPING_DIR, \"*.csv\"))\n",
    "    return max(files, key=os.path.getmtime) if files else None\n",
    "\n",
    "def on_list_file_change(c):\n",
    "    if not up_list.value: return\n",
    "    fname = up_list.value[0]['name']\n",
    "    txt_list.value = f\"<b style='color:green;'>‚úÖ Selected: {fname}</b>\" if \"User Listing\" in fname else \"<b style='color:red;'>‚ùå Filename must contain 'User Listing'</b>\"\n",
    "\n",
    "up_list.observe(on_list_file_change, 'value')\n",
    "map_path = get_latest_map()\n",
    "txt_map = widgets.HTML(value=f\"<b style='color:green;'>‚úÖ Default: {os.path.basename(map_path)}</b>\" if map_path else \"<i>No map found</i>\", layout=widgets.Layout(margin='0 10px'))\n",
    "\n",
    "btn_process = widgets.Button(description=\"üöÄ Step 1: Analyze\", button_style='warning', layout=widgets.Layout(width='180px'))\n",
    "btn_save = widgets.Button(description=\"üíæ Step 2: Save\", button_style='success', layout=widgets.Layout(width='180px'), disabled=True)\n",
    "out_area = widgets.Output()\n",
    "\n",
    "pbar = widgets.IntProgress(value=0, min=0, max=100, description='AD Sync:', bar_style='info', layout=widgets.Layout(width='300px'))\n",
    "pbar_text = widgets.Label(value=\"0/0 (0%)\")\n",
    "pbar_box = widgets.HBox([pbar, pbar_text], layout=widgets.Layout(display='none'))\n",
    "\n",
    "review_registry = []\n",
    "processed_df = None\n",
    "current_fname = \"\"\n",
    "mapping_data = {\"emails\": {}, \"depts\": {}}\n",
    "\n",
    "def is_valid_name(val):\n",
    "    s = str(val).strip().lower()\n",
    "    return s not in [\"nan\", \"none\", \"\", \"()\", \"undefined\", \"n/a\"]\n",
    "\n",
    "def do_process(b):\n",
    "    global processed_df, current_fname, review_registry, mapping_data\n",
    "    out_area.clear_output()\n",
    "    review_registry = []\n",
    "    \n",
    "    if not up_list.value or \"User Listing\" not in up_list.value[0]['name']:\n",
    "        with out_area: display(HTML(\"<b style='color:red;'>Error: Valid 'User Listing' file required.</b>\"))\n",
    "        return\n",
    "    \n",
    "    b.disabled = True\n",
    "    pbar_box.layout.display = 'flex'\n",
    "    \n",
    "    try:\n",
    "        # 1. Load Map\n",
    "        logger.info(\"Loading Mapping File...\")\n",
    "        m_src = io.BytesIO(up_map.value[0]['content']) if up_map.value else map_path\n",
    "        df_m = pd.read_csv(m_src)\n",
    "        df_m.columns = [str(c).strip().lower() for c in df_m.columns]\n",
    "        \n",
    "        mapping_data['emails'] = {str(row['email address']).strip().lower(): row['reviewer'] for _, row in df_m.iterrows() if 'email address' in df_m.columns and pd.notnull(row['email address'])}\n",
    "        mapping_data['depts'] = {str(row['department']).strip().lower(): row['reviewer'] for _, row in df_m.iterrows() if 'department' in df_m.columns and pd.notnull(row['department'])}\n",
    "        \n",
    "        all_options = sorted([(str(d), str(d).lower().strip()) for d in df_m['department'].unique() if pd.notnull(d)])\n",
    "        branch_opts = [o for o in all_options if \"branch\" in o[0].lower()]\n",
    "        dept_opts = [o for o in all_options if \"branch\" not in o[0].lower()]\n",
    "\n",
    "        # 2. Load User List\n",
    "        f_item = up_list.value[0]\n",
    "        current_fname = f_item['name']\n",
    "        df_u = pd.read_csv(io.BytesIO(f_item['content'])) if current_fname.endswith('.csv') else pd.read_excel(io.BytesIO(f_item['content']))\n",
    "        col_email = next((c for c in df_u.columns if \"@\" in str(df_u[c].iloc[0])), df_u.columns[0])\n",
    "\n",
    "        # 3. AD Sync (Robust Pattern with as_completed)\n",
    "        emails = df_u[col_email].dropna().unique().tolist()\n",
    "        total = len(emails)\n",
    "        pbar.max = total; pbar.value = 0\n",
    "        pbar_text.value = f\"0/{total} (0%)\"\n",
    "        \n",
    "        ad_results = {}\n",
    "        with ThreadPoolExecutor(max_workers=25) as ex:\n",
    "            futures = {ex.submit(fetch_ad_profile, e): e for e in emails}\n",
    "            for i, f in enumerate(as_completed(futures), 1):\n",
    "                try:\n",
    "                    res = f.result()\n",
    "                    ad_results[res['email']] = res\n",
    "                except Exception as exc:\n",
    "                    email_err = futures[f]\n",
    "                    logger.error(f\"AD fetch failed for {email_err}: {exc}\")\n",
    "                    ad_results[email_err] = {\"email\": email_err, \"status\": \"Error\", \"name\": \"N/A\", \"dept\": \"N/A\", \"active\": \"N/A\", \"last_seen\": \"error\"}\n",
    "                \n",
    "                pbar.value = i\n",
    "                pbar_text.value = f\"{i}/{total} ({int(i/total*100)}%)\"\n",
    "\n",
    "        # 4. Processing & Sorting\n",
    "        final_rows = []\n",
    "        groups = {0: [], 1: [], 2: []} # 0:Active, 1:NoRecord, 2:Inactive\n",
    "\n",
    "        for idx, row in df_u.iterrows():\n",
    "            raw_email = str(row[col_email]).strip().lower()\n",
    "            ad = ad_results.get(raw_email, {\"dept\": \"N/A\", \"active\": \"N/A\", \"last_seen\": \"no record\"})\n",
    "            clean_dept = str(ad['dept']).split(\" - \")[-1].strip().lower()\n",
    "            \n",
    "            # Logic: Email -> Validity -> Dept\n",
    "            reviewer = mapping_data['emails'].get(raw_email)\n",
    "            is_manual = False\n",
    "            if reviewer:\n",
    "                if not is_valid_name(reviewer):\n",
    "                    reviewer = \"Dept head: manual assign\"\n",
    "                    is_manual = True\n",
    "            else:\n",
    "                reviewer = mapping_data['depts'].get(clean_dept)\n",
    "            \n",
    "            if not reviewer or not is_valid_name(reviewer) or is_manual:\n",
    "                reviewer = reviewer if is_manual else \"(please manual review)\"\n",
    "                priority = 0 if ad['active'] == True else (1 if ad['last_seen'] == \"no AD record\" else 2)\n",
    "                \n",
    "                chk_rem = widgets.Checkbox(value=priority > 0, layout=widgets.Layout(width='50px'))\n",
    "                mode_btn = widgets.ToggleButtons(options=['Dept', 'Branch'], value='Branch' if \"branch\" in clean_dept else 'Dept', \n",
    "                                                layout=widgets.Layout(width='140px'))\n",
    "                drp = widgets.Dropdown(options=branch_opts if mode_btn.value == 'Branch' else dept_opts, layout=widgets.Layout(width='180px'))\n",
    "                lbl_rev = widgets.Label(value=str(reviewer), layout=widgets.Layout(width='150px'))\n",
    "                \n",
    "                mode_btn.observe(lambda c, d=drp: setattr(d, 'options', branch_opts if c['new'] == 'Branch' else dept_opts), 'value')\n",
    "                drp.observe(lambda c, l=lbl_rev: setattr(l, 'value', str(mapping_data['depts'].get(c['new'], \"Manual\"))), 'value')\n",
    "                \n",
    "                review_registry.append({'index': idx, 'chk': chk_rem, 'drp': drp, 'lbl': lbl_rev})\n",
    "                groups[priority].append(widgets.HBox([chk_rem, widgets.Label(raw_email, layout=widgets.Layout(width='200px')), \n",
    "                                                     widgets.HTML(f\"<b>{ad['last_seen']}</b>\", layout=widgets.Layout(width='150px')), \n",
    "                                                     mode_btn, drp, lbl_rev]))\n",
    "\n",
    "            new_row = {**row.to_dict(), \"Reviewer\": reviewer, \"Reviewer's Response\": \"\", \"Details of Access Changes\": \"\"}\n",
    "            final_rows.append(new_row)\n",
    "\n",
    "        processed_df = pd.DataFrame(final_rows)\n",
    "        btn_save.disabled = False\n",
    "        with out_area:\n",
    "            display(HTML(f\"<h4>Analysis Complete: {len(processed_df)} records</h4>\"))\n",
    "            if review_registry:\n",
    "                header = widgets.HBox([widgets.Label(\"DEL\", layout=widgets.Layout(width='50px')), widgets.Label(\"EMAIL\", layout=widgets.Layout(width='200px')), \n",
    "                                      widgets.Label(\"AD STATUS\", layout=widgets.Layout(width='150px')), widgets.Label(\"MODE\", layout=widgets.Layout(width='140px')), \n",
    "                                      widgets.Label(\"MAPPING\", layout=widgets.Layout(width='180px')), widgets.Label(\"REVIEWER\", layout=widgets.Layout(width='150px'))])\n",
    "                display(widgets.VBox([header] + groups[0] + groups[1] + groups[2]))\n",
    "    except Exception as e:\n",
    "        with out_area: print(f\"Error: {str(e)}\")\n",
    "    finally:\n",
    "        b.disabled = False\n",
    "        pbar_box.layout.display = 'none'\n",
    "\n",
    "def do_save(b):\n",
    "    global processed_df\n",
    "    b.disabled = True\n",
    "    try:\n",
    "        df_final = processed_df.copy()\n",
    "        to_drop = [item['index'] for item in review_registry if item['chk'].value]\n",
    "        for item in review_registry:\n",
    "            if not item['chk'].value and item['drp'].value: df_final.at[item['index'], 'Reviewer'] = item['lbl'].value\n",
    "        \n",
    "        df_final = df_final.drop(to_drop)\n",
    "        fpath = os.path.join(BASE_DIR, current_fname.split('.')[0] + \"_AER.xlsx\")\n",
    "        df_final.to_excel(fpath, index=False)\n",
    "        \n",
    "        wb = load_workbook(fpath); ws = wb.active\n",
    "        col_resp = next((i for i, c in enumerate(ws[1], 1) if c.value == \"Reviewer's Response\"), None)\n",
    "        if col_resp:\n",
    "            dv = DataValidation(type=\"list\", formula1='\"Approved,Denied,Changes Required\"', allow_blank=True)\n",
    "            dv.add(f\"{get_column_letter(col_resp)}2:{get_column_letter(col_resp)}{len(df_final)+1}\")\n",
    "            ws.add_data_validation(dv)\n",
    "        wb.save(fpath)\n",
    "        with out_area: display(HTML(f\"<b style='color:blue;'>Saved: {fpath}</b>\"))\n",
    "    except Exception as e:\n",
    "        with out_area: print(f\"Save Error: {e}\")\n",
    "    finally: b.disabled = False\n",
    "\n",
    "btn_process.on_click(do_process); btn_save.on_click(do_save)\n",
    "\n",
    "# Final UI Assembly with clear_output fix\n",
    "ui = widgets.VBox([\n",
    "    widgets.HTML(\"<h3>üõ°Ô∏è AER Generator v6.5</h3>\"), \n",
    "    widgets.HBox([up_list, txt_list]), \n",
    "    widgets.HBox([up_map, txt_map]), \n",
    "    pbar_box, \n",
    "    widgets.HBox([btn_process, btn_save], layout=widgets.Layout(margin='10px 0')), \n",
    "    out_area\n",
    "])\n",
    "clear_output()\n",
    "display(ui)"
   ]
  }
 ],
 "metadata": {
  "kernelspec": { "display_name": "Python 3", "language": "python", "name": "python3" },
  "language_info": { "name": "python", "version": "3.10.1" }
 },
 "nbformat": 4,
 "nbformat_minor": 4
}