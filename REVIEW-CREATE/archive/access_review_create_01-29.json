{
 "cells": [
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "# \ud83d\udee1\ufe0f AER - Smart Access Review Generator (v6.4 Enhanced)\n",
    "\n",
    "**Features:**\n",
    "1. **Enhanced Reviewer Mapping**: Email-first matching with validation, falls back to department\n",
    "2. **Smart Column Detection**: Automatically detects if Name/Email columns are swapped\n",
    "3. **Branch Support**: Detects \"Branch\" columns in mapping file to split the dropdown list\n",
    "4. **Editable Reviewer**: Auto-fills the reviewer but allows manual overwrite\n",
    "5. **Smart UI Grouping**: Manual review sorted by Active \u2192 No Account \u2192 Inactive\n",
    "6. **Visual Enhancements**: Toggle buttons with color feedback, group headers, progress bars\n",
    "7. **Status Logic**: \n",
    "   - **Active**: Green (Keep)\n",
    "   - **Inactive**: Yellow (Keep/Review)\n",
    "   - **Not Found**: Red (Auto-Remove)\n",
    "8. **Excel Validation**: Adds dropdowns with Input prompts and Error alerts\n",
    "9. **Enhanced Logging**: Detailed statistics at each step\n"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "metadata": {},
   "outputs": [],
   "source": [
    "# === Cell 1: Setup & Engine (v5.7 Strict Logic) ===\n",
    "import os, sys, logging, glob, io, re, requests, json\n",
    "import pandas as pd\n",
    "import ipywidgets as widgets\n",
    "from datetime import datetime\n",
    "from dotenv import load_dotenv\n",
    "from msal import PublicClientApplication\n",
    "from concurrent.futures import ThreadPoolExecutor\n",
    "from openpyxl import load_workbook\n",
    "from openpyxl.worksheet.datavalidation import DataValidation\n",
    "from openpyxl.utils import get_column_letter\n",
    "from IPython.display import display, HTML, clear_output\n",
    "\n",
    "# 1. Paths & Logging\n",
    "today_str = datetime.now().strftime('%Y-%m-%d')\n",
    "BASE_DIR = os.path.join(\"output\", today_str, \"create\")\n",
    "LOG_DIR = os.path.join(BASE_DIR, \"logs\")\n",
    "MAPPING_DIR = os.path.join(\"input\", \"mapping\")\n",
    "os.makedirs(LOG_DIR, exist_ok=True)\n",
    "\n",
    "log_file = os.path.join(LOG_DIR, f\"aer_create_{today_str}_{datetime.now().strftime('%H%M')}.log\")\n",
    "logger = logging.getLogger(\"aer\")\n",
    "logger.handlers.clear()\n",
    "logger.setLevel(logging.INFO)\n",
    "formatter = logging.Formatter('%(asctime)s | %(levelname)s | %(message)s')\n",
    "fh = logging.FileHandler(log_file, encoding=\"utf-8\")\n",
    "fh.setFormatter(formatter)\n",
    "logger.addHandler(fh)\n",
    "logger.addHandler(logging.StreamHandler(sys.stdout))\n",
    "\n",
    "# 2. Auth & Cache\n",
    "load_dotenv()\n",
    "headers = {}\n",
    "try:\n",
    "    tid, cid = os.getenv(\"AZURE_TENANT_ID\"), os.getenv(\"AZURE_CLIENT_ID\")\n",
    "    if tid and cid:\n",
    "        app = PublicClientApplication(cid, authority=f\"https://login.microsoftonline.com/{tid}\")\n",
    "        # STRICT v5.7 Scope: Only User.Read.All (No AuditLog)\n",
    "        res = app.acquire_token_interactive(scopes=[\"User.Read.All\"], prompt=\"select_account\")\n",
    "        if \"access_token\" in res:\n",
    "            headers = {\"Authorization\": f\"Bearer {res['access_token']}\"}\n",
    "            logger.info(\"Authentication Successful\")\n",
    "except Exception as e:\n",
    "    logger.error(f\"Auth Critical Error: {str(e)}\")\n",
    "\n",
    "ad_cache = {}\n",
    "session = requests.Session()\n",
    "# Boost connection pool for speed\n",
    "adapter = requests.adapters.HTTPAdapter(pool_connections=50, pool_maxsize=50)\n",
    "session.mount('https://', adapter)\n",
    "\n",
    "def fetch_ad(email):\n",
    "    \"\"\" \n",
    "    Exact v5.7 Logic:\n",
    "    - No ID check\n",
    "    - No Last Login check (prevents 403 Forbidden)\n",
    "    - Just Name, Dept, Status\n",
    "    \"\"\"\n",
    "    email = str(email).strip().lower()\n",
    "    \n",
    "    # 1. Validation\n",
    "    if not re.match(r'^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\\.[a-zA-Z]{2,}$', email):\n",
    "        return {\"email\": email, \"status\": \"Invalid\", \"name\": \"N/A\", \"dept\": \"N/A\", \"active\": \"N/A\"}\n",
    "    \n",
    "    # 2. Cache\n",
    "    if email in ad_cache: return ad_cache[email]\n",
    "    \n",
    "    # 3. Mock Mode (No Auth)\n",
    "    if not headers: \n",
    "        return {\"email\": email, \"status\": \"Mock\", \"name\": \"User\", \"dept\": \"Mock Dept\", \"active\": True}\n",
    "    \n",
    "    try:\n",
    "        # STRICT v5.7 URL: No 'signInActivity', No 'id'\n",
    "        url = f\"https://graph.microsoft.com/v1.0/users/{email}?$select=displayName,department,accountEnabled\"\n",
    "        r = session.get(url, headers=headers, timeout=5)\n",
    "        \n",
    "        if r.status_code == 200:\n",
    "            d = r.json()\n",
    "            res = {\n",
    "                \"email\": email, \n",
    "                \"status\": \"Found\", \n",
    "                \"name\": d.get(\"displayName\", \"N/A\"), \n",
    "                \"dept\": d.get(\"department\") or \"N/A\", \n",
    "                \"active\": d.get(\"accountEnabled\", \"N/A\") # This returns Boolean True/False\n",
    "            }\n",
    "        else:\n",
    "            res = {\"email\": email, \"status\": \"Not Found\", \"name\": \"N/A\", \"dept\": \"N/A\", \"active\": \"N/A\"}\n",
    "    except:\n",
    "        res = {\"email\": email, \"status\": \"Error\", \"name\": \"N/A\", \"dept\": \"N/A\", \"active\": \"N/A\"}\n",
    "\n",
    "def is_valid_reviewer_name(reviewer):\n",
    "    \"\"\"Check if reviewer is a valid name (v6.4 Enhancement)\"\"\"\n",
    "    if not reviewer or pd.isna(reviewer):\n",
    "        return False\n",
    "    reviewer_str = str(reviewer).strip().lower()\n",
    "    # Invalid patterns\n",
    "    invalid = [\"nan\", \"none\", \"\", \"null\", \"()\", \"n/a\", \"na\", \"tbd\", \"pending\"]\n",
    "    if reviewer_str in invalid:\n",
    "        return False\n",
    "    # Check if it looks like a name (has letters, reasonable length)\n",
    "    if len(reviewer_str) < 2 or not any(c.isalpha() for c in reviewer_str):\n",
    "        return False\n",
    "    return True\n",
    "\n",
    "        \n",
    "    ad_cache[email] = res\n",
    "    return res"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "metadata": {},
   "outputs": [],
   "source": [
    "# === Cell 2: Enhanced Hybrid Logic (v6.4 with All Improvements + Error Handling) ===\n",
    "\n",
    "# --- 1. UI Styling ---\n",
    "style_html = \"\"\"\n",
    "<style>\n",
    "    .aer-row { border-bottom: 1px solid #e0e0e0; padding: 5px 0; align-items: center; }\n",
    "    .aer-header { font-weight: bold; background-color: #f0f0f0; padding: 8px 0; border-bottom: 2px solid #ccc; }\n",
    "    .aer-cell { overflow: hidden; white-space: nowrap; text-overflow: ellipsis; }\n",
    "    .widget-label { font-size: 11px; font-weight: 600; }\n",
    "    .widget-dropdown select, .widget-text input { font-size: 11px; }\n",
    "</style>\n",
    "\"\"\"\n",
    "display(HTML(style_html))\n",
    "\n",
    "# --- 2. Widgets ---\n",
    "up_list = widgets.FileUpload(accept='.xlsx, .csv', description=\"1. User List\", button_style='info')\n",
    "txt_list = widgets.HTML(value=\"<i>No file selected</i>\", layout=widgets.Layout(margin='0 10px'))\n",
    "up_map = widgets.FileUpload(accept='.csv', description=\"2. Reviewer Map\", button_style='info')\n",
    "\n",
    "btn_process = widgets.Button(description=\"\ud83d\ude80 Step 1: Analyze\", button_style='warning', layout=widgets.Layout(width='180px'))\n",
    "btn_save = widgets.Button(description=\"\ud83d\udcbe Step 2: Save\", button_style='success', layout=widgets.Layout(width='180px'), disabled=True)\n",
    "out_area = widgets.Output()\n",
    "\n",
    "# Global State\n",
    "review_registry = []\n",
    "processed_df = None\n",
    "current_fname = \"\"\n",
    "mapping_data = {\"emails\": {}, \"depts\": {}, \"all_depts\": [], \"all_branches\": []}\n",
    "match_stats = {\"email_match\": 0, \"dept_match\": 0, \"no_match\": 0, \"email_invalid\": 0}\n",
    "\n",
    "# --- 3. Helper Functions ---\n",
    "def get_latest_map():\n",
    "    try:\n",
    "        files = glob.glob(os.path.join(MAPPING_DIR, \"*.csv\"))\n",
    "        return max(files, key=os.path.getmtime) if files else None\n",
    "    except:\n",
    "        return None\n",
    "\n",
    "def on_list_file_change(c):\n",
    "    try:\n",
    "        if up_list.value and len(up_list.value) > 0:\n",
    "            fname = up_list.value[0]['name']\n",
    "            txt_list.value = f\"<b style='color:green;'>\u2705 Selected: {fname}</b>\"\n",
    "    except:\n",
    "        pass\n",
    "\n",
    "up_list.observe(on_list_file_change, 'value')\n",
    "\n",
    "map_path = get_latest_map()\n",
    "txt_map = widgets.HTML(value=f\"<b style='color:green;'>\u2705 Default: {os.path.basename(map_path)}</b>\" if map_path else \"<i>No map found</i>\", layout=widgets.Layout(margin='0 10px'))\n",
    "\n",
    "def identify_columns_smart(df):\n",
    "    \"\"\" Detects Email/Name order by content \"\"\"\n",
    "    if len(df.columns) < 2: return df.columns[0], df.columns[0]\n",
    "    c0, c1 = df.columns[0], df.columns[1]\n",
    "    sample = df.head(20).fillna('').astype(str)\n",
    "    score_0 = sum(1 for x in sample[c0] if '@' in x and '.' in x)\n",
    "    score_1 = sum(1 for x in sample[c1] if '@' in x and '.' in x)\n",
    "    return (c0, c1) if score_0 >= score_1 else (c1, c0)\n",
    "\n",
    "def detect_map_column(df, candidates):\n",
    "    cols = [str(c).lower().strip() for c in df.columns]\n",
    "    for cand in candidates:\n",
    "        for i, c in enumerate(cols):\n",
    "            if cand in c: return df.columns[i]\n",
    "    return None\n",
    "\n",
    "# --- 4. Logic: Analysis with Enhanced Features ---\n",
    "def do_process(b):\n",
    "    global processed_df, current_fname, review_registry, mapping_data, match_stats\n",
    "    out_area.clear_output()\n",
    "    review_registry = []\n",
    "    match_stats = {\"email_match\": 0, \"dept_match\": 0, \"no_match\": 0, \"email_invalid\": 0}\n",
    "    \n",
    "    # Enhanced validation\n",
    "    if not up_list.value or len(up_list.value) == 0:\n",
    "        with out_area: print(\"\u274c Error: Please upload a user list.\")\n",
    "        return\n",
    "    \n",
    "    b.disabled = True\n",
    "    try:\n",
    "        logger.info(\"--- Starting Analysis (v6.4 Enhanced) ---\")\n",
    "        \n",
    "        # A. Load Map with better error handling\n",
    "        m_src = None\n",
    "        if up_map.value and len(up_map.value) > 0:\n",
    "            m_src = io.BytesIO(up_map.value[0]['content'])\n",
    "        elif map_path:\n",
    "            m_src = map_path\n",
    "        \n",
    "        if not m_src:\n",
    "            with out_area: print(\"\u274c Error: No Mapping CSV found! Please upload a mapping file or add one to input/mapping/\")\n",
    "            b.disabled = False\n",
    "            return\n",
    "            \n",
    "        df_m = pd.read_csv(m_src)\n",
    "        \n",
    "        # Enhanced Logging (v6.4)\n",
    "        logger.info(f\"\u2705 Loaded mapping file: {len(df_m)} rows, Columns: {list(df_m.columns)}\")\n",
    "        \n",
    "        # 1. Detect Columns\n",
    "        col_m_email = detect_map_column(df_m, [\"email\", \"mail\"])\n",
    "        col_m_dept = detect_map_column(df_m, [\"department\", \"dept\"])\n",
    "        col_m_rev = detect_map_column(df_m, [\"reviewer\", \"owner\", \"manager\"])\n",
    "        col_m_br = detect_map_column(df_m, [\"branch\", \"category\", \"type\"])\n",
    "        \n",
    "        if not col_m_rev or not col_m_dept:\n",
    "            with out_area: print(f\"\u274c Error: Map needs 'Department' and 'Reviewer'. Found: {list(df_m.columns)}\")\n",
    "            b.disabled = False\n",
    "            return\n",
    "\n",
    "        # 2. Build Mapping\n",
    "        mapping_data['emails'] = {}\n",
    "        if col_m_email:\n",
    "            mapping_data['emails'] = dict(zip(df_m[col_m_email].astype(str).str.lower().str.strip(), df_m[col_m_rev]))\n",
    "        mapping_data['depts'] = dict(zip(df_m[col_m_dept].astype(str).str.lower().str.strip(), df_m[col_m_rev]))\n",
    "        \n",
    "        # Enhanced Logging (v6.4)\n",
    "        logger.info(f\"\ud83d\udcca Email mappings: {len(mapping_data['emails'])}, Dept mappings: {len(mapping_data['depts'])}\")\n",
    "        \n",
    "        # 3. Split Branch vs Dept\n",
    "        if col_m_br:\n",
    "            unique_locs = df_m[[col_m_dept, col_m_br]].drop_duplicates()\n",
    "            is_branch = unique_locs[col_m_br].astype(str).str.lower().str.contains(\"branch\", na=False)\n",
    "            list_branches = sorted(unique_locs[is_branch][col_m_dept].unique())\n",
    "            list_depts = sorted(unique_locs[~is_branch][col_m_dept].unique())\n",
    "            logger.info(f\"\ud83d\udcca Branches detected: {len(list_branches)}\")\n",
    "        else:\n",
    "            list_branches = []\n",
    "            list_depts = sorted(df_m[col_m_dept].astype(str).unique())\n",
    "\n",
    "        mapping_data['all_branches'] = [(\"Select Branch...\", \"\")] + [(d, d.lower()) for d in list_branches]\n",
    "        mapping_data['all_depts'] = [(\"Select Dept...\", \"\")] + [(d, d.lower()) for d in list_depts]\n",
    "        \n",
    "        logger.info(f\"\ud83d\udcca Departments: {len(list_depts)}, Branches: {len(list_branches)}\")\n",
    "        \n",
    "        # B. Load User List\n",
    "        f_item = up_list.value[0]\n",
    "        current_fname = f_item['name']\n",
    "        df_u = pd.read_csv(io.BytesIO(f_item['content'])) if current_fname.endswith('.csv') else pd.read_excel(io.BytesIO(f_item['content']))\n",
    "        col_email, col_name = identify_columns_smart(df_u)\n",
    "        \n",
    "        logger.info(f\"\u2705 Loaded user list: {current_fname}, {len(df_u)} rows\")\n",
    "        logger.info(f\"\ud83d\udccb Detected columns: Email='{col_email}', Name='{col_name}'\")\n",
    "        \n",
    "        # C. AD Fetch with Progress Bar (v6.4 Enhancement)\n",
    "        emails = df_u[col_email].dropna().unique().tolist()\n",
    "        \n",
    "        with out_area: \n",
    "            print(f\"\ud83d\udd04 Syncing {len(emails)} emails with AD...\")\n",
    "            \n",
    "            # Create progress bar\n",
    "            progress = widgets.IntProgress(\n",
    "                value=0, min=0, max=len(emails),\n",
    "                description='AD Sync:',\n",
    "                bar_style='info',\n",
    "                orientation='horizontal',\n",
    "                layout=widgets.Layout(width='80%')\n",
    "            )\n",
    "            progress_label = widgets.HTML(value=f\"0 / {len(emails)}\")\n",
    "            progress_box = widgets.HBox([progress, progress_label])\n",
    "            display(progress_box)\n",
    "        \n",
    "        # Fetch with progress tracking\n",
    "        completed = [0]\n",
    "        ad_results = {}\n",
    "        \n",
    "        def fetch_with_progress(email):\n",
    "            result = fetch_ad(email)\n",
    "            completed[0] += 1\n",
    "            progress.value = completed[0]\n",
    "            progress_label.value = f\"{completed[0]} / {len(emails)}\"\n",
    "            return result\n",
    "        \n",
    "        with ThreadPoolExecutor(max_workers=25) as ex:\n",
    "            results = list(ex.map(fetch_with_progress, emails))\n",
    "            ad_results = {r['email']: r for r in results}\n",
    "        \n",
    "        logger.info(f\"\u2705 AD sync completed: {len(ad_results)} accounts processed\")\n",
    "        \n",
    "        # Calculate AD statistics (v6.4 Enhancement)\n",
    "        ad_stats = {\"found\": 0, \"not_found\": 0, \"active\": 0, \"inactive\": 0, \"error\": 0}\n",
    "        for email, result in ad_results.items():\n",
    "            if result['status'] == 'Found':\n",
    "                ad_stats['found'] += 1\n",
    "                if result['active'] is True:\n",
    "                    ad_stats['active'] += 1\n",
    "                else:\n",
    "                    ad_stats['inactive'] += 1\n",
    "            elif result['status'] == 'Not Found':\n",
    "                ad_stats['not_found'] += 1\n",
    "            else:\n",
    "                ad_stats['error'] += 1\n",
    "        \n",
    "        logger.info(f\"\ud83d\udcca AD Query Stats: Found={ad_stats['found']}, Not Found={ad_stats['not_found']}, \"\n",
    "                   f\"Active={ad_stats['active']}, Inactive={ad_stats['inactive']}, Error={ad_stats['error']}\")\n",
    "\n",
    "        # D. Processing Loop with Enhanced Matching (v6.4)\n",
    "        final_rows = []\n",
    "        widget_rows = []\n",
    "        \n",
    "        header_box = widgets.HBox([\n",
    "            widgets.Label(\"Remove\", layout=widgets.Layout(width='60px', font_weight='bold', font_size='12px')),\n",
    "            widgets.Label(\"User Name\", layout=widgets.Layout(flex='2', font_weight='bold', font_size='12px')),\n",
    "            widgets.Label(\"User Email\", layout=widgets.Layout(flex='2', font_weight='bold', font_size='12px')),\n",
    "            widgets.Label(\"AD Status\", layout=widgets.Layout(flex='2', font_weight='bold', font_size='12px')),\n",
    "            widgets.Label(\"Mode\", layout=widgets.Layout(width='40px', font_weight='bold', font_size='12px')),\n",
    "            widgets.Label(\"Mapping\", layout=widgets.Layout(flex='2', font_weight='bold', font_size='12px')),\n",
    "            widgets.Label(\"Reviewer\", layout=widgets.Layout(flex='1', font_weight='bold', font_size='12px')),\n",
    "        ], layout=widgets.Layout(\n",
    "            border_bottom='3px solid #1976d2',\n",
    "            padding='10px 5px',\n",
    "            background='linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%)',\n",
    "            border_radius='4px 4px 0 0'\n",
    "        ))\n",
    "\n",
    "        for idx, row in df_u.iterrows():\n",
    "            raw_email = str(row[col_email]).strip().lower()\n",
    "            raw_name = str(row[col_name]).strip()\n",
    "            \n",
    "            # AD Lookup\n",
    "            ad = ad_results.get(raw_email, {\"status\": \"Not Found\", \"dept\": \"N/A\", \"active\": \"N/A\"})\n",
    "            \n",
    "            # Enhanced Match Logic (v6.4)\n",
    "            reviewer = None\n",
    "            match_method = \"\"\n",
    "            \n",
    "            # Step 1: Try email-based mapping first\n",
    "            if raw_email in mapping_data['emails']:\n",
    "                reviewer = mapping_data['emails'][raw_email]\n",
    "                match_method = \"email\"\n",
    "                \n",
    "                # Validate if reviewer is a valid name\n",
    "                if not is_valid_reviewer_name(reviewer):\n",
    "                    reviewer = None\n",
    "                    match_method = \"email_invalid\"\n",
    "                    match_stats['email_invalid'] += 1\n",
    "                    logger.warning(f\"Invalid reviewer for email {raw_email}\")\n",
    "                else:\n",
    "                    match_stats['email_match'] += 1\n",
    "            \n",
    "            # Step 2: If no email match, try department mapping\n",
    "            if not reviewer:\n",
    "                clean_dept = str(ad['dept']).split(\" - \")[-1].strip().lower()\n",
    "                dept_reviewer = mapping_data['depts'].get(clean_dept)\n",
    "                if dept_reviewer and match_method != \"email_invalid\":\n",
    "                    reviewer = dept_reviewer\n",
    "                    match_method = \"department\"\n",
    "                    match_stats['dept_match'] += 1\n",
    "            \n",
    "            is_problem = not reviewer or str(reviewer).strip().lower() in [\"nan\", \"none\", \"\", \"null\", \"()\"]\n",
    "            \n",
    "            if is_problem:\n",
    "                reviewer = \"(please manual review)\"\n",
    "                if match_method != \"email_invalid\":\n",
    "                    match_stats['no_match'] += 1\n",
    "                \n",
    "                # Logic: Status / Remove\n",
    "                is_active = ad['active'] is True\n",
    "                found = \"Found\" in ad['status']\n",
    "                remove_default = not found\n",
    "                \n",
    "                # Status Color\n",
    "                if is_active:\n",
    "                    stat_html = f'<span style=\"color:green;font-weight:bold;\">\u2713 {ad.get(\"name\",\"N/A\")}</span> | {ad[\"dept\"]}'\n",
    "                elif not found:\n",
    "                    stat_html = '<span style=\"color:red;font-weight:bold;\">\u2717 Not Found</span>'\n",
    "                else:\n",
    "                    stat_html = f'<span style=\"color:orange;font-weight:bold;\">\u26a0 {ad.get(\"name\",\"N/A\")}</span> | {ad[\"dept\"]}'\n",
    "                \n",
    "                # Widgets\n",
    "                chk = widgets.Checkbox(\n",
    "                    value=remove_default, \n",
    "                    indent=False, \n",
    "                    layout=widgets.Layout(width='40px'),\n",
    "                    tooltip='Check to REMOVE this user'\n",
    "                )\n",
    "                name_lbl = widgets.Label(raw_name, layout=widgets.Layout(flex='2'))\n",
    "                email_lbl = widgets.Label(raw_email, layout=widgets.Layout(flex='2'))\n",
    "                stat_lbl = widgets.HTML(stat_html, layout=widgets.Layout(flex='2'))\n",
    "                \n",
    "                # Enhanced Toggle Button (v6.4)\n",
    "                tgl = widgets.ToggleButton(\n",
    "                    value=False, \n",
    "                    description='B', \n",
    "                    tooltip='Dept Mode (Click for Branch)', \n",
    "                    layout=widgets.Layout(width='35px', height='28px'),\n",
    "                    button_style='',\n",
    "                    icon=''\n",
    "                )\n",
    "                \n",
    "                drp = widgets.Dropdown(\n",
    "                    options=mapping_data['all_depts'], \n",
    "                    value=\"\", \n",
    "                    layout=widgets.Layout(flex='2', height='28px')\n",
    "                )\n",
    "                res_txt = widgets.Text(\n",
    "                    value=reviewer, \n",
    "                    layout=widgets.Layout(flex='1'),\n",
    "                    continuous_update=False\n",
    "                )\n",
    "                \n",
    "                # Enhanced toggle with color change (v6.4)\n",
    "                def on_tgl(change, d=drp, btn=tgl):\n",
    "                    if change['new']:  # Branch mode ON\n",
    "                        d.options = mapping_data['all_branches']\n",
    "                        btn.button_style = 'success'  # Green\n",
    "                        btn.description = '\ud83c\udf33'\n",
    "                        btn.tooltip = 'Branch Mode (Click for Dept)'\n",
    "                    else:  # Department mode\n",
    "                        d.options = mapping_data['all_depts']\n",
    "                        btn.button_style = ''  # Default\n",
    "                        btn.description = 'B'\n",
    "                        btn.tooltip = 'Dept Mode (Click for Branch)'\n",
    "                    d.value = \"\"\n",
    "                \n",
    "                def on_drp(change, txt=res_txt, email=raw_email):\n",
    "                    val = str(change['new']).strip()\n",
    "                    if val:\n",
    "                        matched = mapping_data['depts'].get(val.lower())\n",
    "                        if not matched:\n",
    "                            matched = mapping_data['emails'].get(email)\n",
    "                        if matched:\n",
    "                            txt.value = matched\n",
    "                \n",
    "                tgl.observe(on_tgl, names='value')\n",
    "                drp.observe(on_drp, names='value')\n",
    "                \n",
    "                # Create row with enhanced styling (v6.4)\n",
    "                row_box = widgets.HBox([\n",
    "                    chk, \n",
    "                    widgets.Box([name_lbl], layout=widgets.Layout(flex='2')),\n",
    "                    widgets.Box([email_lbl], layout=widgets.Layout(flex='2')),\n",
    "                    widgets.Box([stat_lbl], layout=widgets.Layout(flex='2')),\n",
    "                    tgl,\n",
    "                    widgets.Box([drp], layout=widgets.Layout(flex='2')),\n",
    "                    widgets.Box([res_txt], layout=widgets.Layout(flex='1'))\n",
    "                ], layout=widgets.Layout(\n",
    "                    border='1px solid #e0e0e0',\n",
    "                    padding='8px 4px',\n",
    "                    margin='2px 0',\n",
    "                    border_radius='4px',\n",
    "                    background='#fafafa'\n",
    "                ))\n",
    "                \n",
    "                # Visual feedback for checkbox (v6.4)\n",
    "                def on_check_change(change, box=row_box):\n",
    "                    if change['new']:  # Remove\n",
    "                        box.layout.background = '#ffebee'\n",
    "                        box.layout.border = '1px solid #ef5350'\n",
    "                    else:  # Keep\n",
    "                        box.layout.background = '#fafafa'\n",
    "                        box.layout.border = '1px solid #e0e0e0'\n",
    "                \n",
    "                chk.observe(on_check_change, names='value')\n",
    "                \n",
    "                widget_rows.append(row_box)\n",
    "                review_registry.append({\n",
    "                    'email': raw_email,\n",
    "                    'name': raw_name,\n",
    "                    'ad_name': ad.get('name', 'N/A'),\n",
    "                    'ad_dept': ad['dept'],\n",
    "                    'ad_status': ad['status'],\n",
    "                    'is_active': is_active,\n",
    "                    'reviewer': reviewer,\n",
    "                    'chk': chk,\n",
    "                    'res': res_txt\n",
    "                })\n",
    "            else:\n",
    "                # Auto-matched - add to final\n",
    "                final_rows.append({\n",
    "                    'User Name': raw_name,\n",
    "                    'User Email': raw_email,\n",
    "                    'AD Name': ad.get('name', 'N/A'),\n",
    "                    'Department': ad['dept'],\n",
    "                    'Reviewer': reviewer,\n",
    "                    'AD Status': ad['status']\n",
    "                })\n",
    "        \n",
    "        # Log matching statistics (v6.4)\n",
    "        logger.info(f\"\ud83d\udcca Matching Stats: Email={match_stats['email_match']}, Dept={match_stats['dept_match']}, \"\n",
    "                   f\"Invalid={match_stats['email_invalid']}, No Match={match_stats['no_match']}\")\n",
    "        \n",
    "        # E. Sort and Display with Grouping (v6.4 Enhancement)\n",
    "        processed_df = pd.DataFrame(final_rows)\n",
    "        \n",
    "        if widget_rows:\n",
    "            # Sort by priority\n",
    "            def get_sort_priority(item):\n",
    "                is_active = item['is_active']\n",
    "                found = \"Found\" in item['ad_status']\n",
    "                \n",
    "                if is_active:\n",
    "                    return 1  # Active - First\n",
    "                elif not found:\n",
    "                    return 2  # Not Found - Second\n",
    "                else:\n",
    "                    return 3  # Inactive - Third\n",
    "            \n",
    "            sorted_pairs = sorted(zip(review_registry, widget_rows), key=lambda x: get_sort_priority(x[0]))\n",
    "            review_registry = [p[0] for p in sorted_pairs]\n",
    "            widget_rows = [p[1] for p in sorted_pairs]\n",
    "            \n",
    "            # Count categories\n",
    "            active_count = sum(1 for r in review_registry if r['is_active'])\n",
    "            no_account_count = sum(1 for r in review_registry if \"Not Found\" in r['ad_status'])\n",
    "            inactive_count = len(review_registry) - active_count - no_account_count\n",
    "            \n",
    "            # Summary panel (v6.4)\n",
    "            summary_html = f\"\"\"\n",
    "            <div style='\n",
    "                background: linear-gradient(135deg, #e8eaf6 0%, #c5cae9 100%);\n",
    "                padding: 15px;\n",
    "                margin: 10px 0 20px 0;\n",
    "                border-radius: 8px;\n",
    "                border-left: 5px solid #3f51b5;\n",
    "                box-shadow: 0 2px 8px rgba(0,0,0,0.1);\n",
    "            '>\n",
    "                <h4 style='margin: 0 0 10px 0; color: #3f51b5;'>\ud83d\udcca Manual Review Summary</h4>\n",
    "                <div style='display: flex; justify-content: space-around;'>\n",
    "                    <div style='text-align: center;'>\n",
    "                        <div style='font-size: 24px; font-weight: bold; color: #4caf50;'>{active_count}</div>\n",
    "                        <div style='font-size: 11px; color: #666;'>Active</div>\n",
    "                    </div>\n",
    "                    <div style='text-align: center;'>\n",
    "                        <div style='font-size: 24px; font-weight: bold; color: #f44336;'>{no_account_count}</div>\n",
    "                        <div style='font-size: 11px; color: #666;'>No Account</div>\n",
    "                    </div>\n",
    "                    <div style='text-align: center;'>\n",
    "                        <div style='font-size: 24px; font-weight: bold; color: #ffc107;'>{inactive_count}</div>\n",
    "                        <div style='font-size: 11px; color: #666;'>Inactive</div>\n",
    "                    </div>\n",
    "                    <div style='text-align: center;'>\n",
    "                        <div style='font-size: 24px; font-weight: bold; color: #2196f3;'>{len(widget_rows)}</div>\n",
    "                        <div style='font-size: 11px; color: #666;'>Total</div>\n",
    "                    </div>\n",
    "                </div>\n",
    "            </div>\n",
    "            \"\"\"\n",
    "            \n",
    "            # Add group headers (v6.4)\n",
    "            final_widget_rows = [widgets.HTML(summary_html)]\n",
    "            last_priority = 0\n",
    "            \n",
    "            for reg_item, widget in zip(review_registry, widget_rows):\n",
    "                priority = get_sort_priority(reg_item)\n",
    "                if priority != last_priority:\n",
    "                    if priority == 1:\n",
    "                        header = widgets.HTML(\n",
    "                            \"<div style='\"\n",
    "                            \"background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%);\"\n",
    "                            \"padding: 10px 15px; margin: 15px 0 5px 0; font-weight: bold; font-size: 13px;\"\n",
    "                            \"border-left: 4px solid #4caf50; border-radius: 4px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);\"\n",
    "                            f\"'>\u2705 Active Accounts <span style='color:#666;font-weight:normal;margin-left:10px;'>({active_count} records)</span></div>\"\n",
    "                        )\n",
    "                    elif priority == 2:\n",
    "                        header = widgets.HTML(\n",
    "                            \"<div style='\"\n",
    "                            \"background: linear-gradient(135deg, #ffebee 0%, #ffcdd2 100%);\"\n",
    "                            \"padding: 10px 15px; margin: 15px 0 5px 0; font-weight: bold; font-size: 13px;\"\n",
    "                            \"border-left: 4px solid #f44336; border-radius: 4px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);\"\n",
    "                            f\"'>\u274c No Account Found <span style='color:#666;font-weight:normal;margin-left:10px;'>({no_account_count} records)</span></div>\"\n",
    "                        )\n",
    "                    else:\n",
    "                        header = widgets.HTML(\n",
    "                            \"<div style='\"\n",
    "                            \"background: linear-gradient(135deg, #fff9c4 0%, #fff59d 100%);\"\n",
    "                            \"padding: 10px 15px; margin: 15px 0 5px 0; font-weight: bold; font-size: 13px;\"\n",
    "                            \"border-left: 4px solid #ffc107; border-radius: 4px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);\"\n",
    "                            f\"'>\u26a0\ufe0f Inactive Accounts <span style='color:#666;font-weight:normal;margin-left:10px;'>({inactive_count} records)</span></div>\"\n",
    "                        )\n",
    "                    final_widget_rows.append(header)\n",
    "                    last_priority = priority\n",
    "                final_widget_rows.append(widget)\n",
    "            \n",
    "            with out_area:\n",
    "                print(f\"\\n\ud83d\udd0d Manual Review Required: {len(review_registry)} users\")\n",
    "                display(header_box)\n",
    "                for w in final_widget_rows:\n",
    "                    display(w)\n",
    "        else:\n",
    "            with out_area: print(f\"\u2705 All {len(final_rows)} users matched!\")\n",
    "        \n",
    "        btn_save.disabled = False\n",
    "    except Exception as e:\n",
    "        with out_area: print(f\"\u274c Error: {str(e)}\")\n",
    "        logger.error(f\"Process error: {str(e)}\", exc_info=True)\n",
    "    finally: b.disabled = False\n",
    "\n",
    "# --- 5. Logic: Save ---\n",
    "def do_save(b):\n",
    "    if not review_registry and processed_df is None:\n",
    "        with out_area: print(\"\u274c Error: No data to save.\")\n",
    "        return\n",
    "    b.disabled = True\n",
    "    try:\n",
    "        # Merge auto + manual\n",
    "        manual = []\n",
    "        for r in review_registry:\n",
    "            if not r['chk'].value:  # Not removed\n",
    "                manual.append({\n",
    "                    'User Name': r['name'],\n",
    "                    'User Email': r['email'],\n",
    "                    'AD Name': r['ad_name'],\n",
    "                    'Department': r['ad_dept'],\n",
    "                    'Reviewer': r['res'].value,\n",
    "                    'AD Status': r['ad_status']\n",
    "                })\n",
    "        \n",
    "        df_manual = pd.DataFrame(manual)\n",
    "        df_final = pd.concat([processed_df, df_manual], ignore_index=True) if processed_df is not None else df_manual\n",
    "        \n",
    "        # Save\n",
    "        fname_base = current_fname.replace('.csv', '').replace('.xlsx', '')\n",
    "        fname = f\"{fname_base}_review_{datetime.now().strftime('%Y%m%d_%H%M')}.xlsx\"\n",
    "        fpath = os.path.join(BASE_DIR, fname)\n",
    "        \n",
    "        df_final.to_excel(fpath, index=False, sheet_name='Review')\n",
    "        \n",
    "        # Excel Validation\n",
    "        wb = load_workbook(fpath)\n",
    "        ws = wb.active\n",
    "        \n",
    "        col = None\n",
    "        for i, c in enumerate(df_final.columns, 1):\n",
    "            if 'action' in str(c).lower() or 'decision' in str(c).lower():\n",
    "                col = i\n",
    "                break\n",
    "        \n",
    "        if col:\n",
    "            dv = DataValidation(type=\"list\", formula1='\"Approved,Denied,Changes Required\"', allow_blank=True)\n",
    "            dv.promptTitle = \"Select Action\"\n",
    "            dv.prompt = \"Please select: Approved, Denied, or Changes Required\"\n",
    "            dv.showInputMessage = True\n",
    "            dv.errorTitle = \"Invalid Selection\"\n",
    "            dv.error = \"Please select a valid option from the drop-down menu.\"\n",
    "            dv.showErrorMessage = True\n",
    "            ws.add_data_validation(dv)\n",
    "            letter = get_column_letter(col)\n",
    "            dv.add(f\"{letter}2:{letter}{len(df_final)+1}\")\n",
    "            \n",
    "        wb.save(fpath)\n",
    "        with out_area: display(HTML(f\"<b style='color:blue;'>\u2714 Saved: {fpath}</b>\"))\n",
    "        logger.info(f\"\u2705 Saved: {fname}, {len(df_final)} records\")\n",
    "    except Exception as e:\n",
    "        with out_area: print(f\"\u274c Save Error: {str(e)}\")\n",
    "        logger.error(f\"Save error: {str(e)}\", exc_info=True)\n",
    "    finally: b.disabled = False\n",
    "\n",
    "# --- 6. Final UI ---\n",
    "btn_process.on_click(do_process); btn_save.on_click(do_save)\n",
    "ui = widgets.VBox([widgets.HTML(\"<h4>\ud83d\udee1\ufe0f AER Generator (v6.4 Enhanced)</h4>\"), widgets.HBox([up_list, txt_list]), widgets.HBox([up_map, txt_map]), widgets.HBox([btn_process, btn_save]), out_area])\n",
    "clear_output(); display(ui)\n",
    ""
   ]
  }
 ],
 "metadata": {
  "kernelspec": {
   "display_name": "Python 3",
   "language": "python",
   "name": "python3"
  },
  "language_info": {
   "name": "python",
   "version": "3.8.5"
  }
 },
 "nbformat": 4,
 "nbformat_minor": 4
}