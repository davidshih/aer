{
 "cells": [
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "# üõ°Ô∏è AER - Smart Access Review Generator (v6.3 Final)\n",
    "\n",
    "**Features:**\n",
    "1. **Strict v5.7 Logic**: Uses Email as the single source of truth. Matches Departments using strict suffix logic.\n",
    "2. **Smart Column Detection**: Automatically detects if Name/Email columns are swapped.\n",
    "3. **Branch Support**: Detects \"Branch\" columns in mapping file to split the dropdown list.\n",
    "4. **Editable Reviewer**: Auto-fills the reviewer but allows manual overwrite.\n",
    "5. **Status Logic**: \n",
    "   - **Active**: Green (Keep).\n",
    "   - **Inactive**: Yellow (Keep/Review).\n",
    "   - **Not Found**: Red (Auto-Remove).\n",
    "6. **Excel Validation**: Adds dropdowns with Input prompts and Error alerts."
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "metadata": {},
   "outputs": [],
   "source": [
    "# === Cell 1: Setup & Engine (v5.7 Strict Logic) ===\n",
    "import os, sys, logging, glob, io, re, requests, json\n",
    "import pandas as pd\n",
    "import ipywidgets as widgets\n",
    "from datetime import datetime\n",
    "from dotenv import load_dotenv\n",
    "from msal import PublicClientApplication\n",
    "from concurrent.futures import ThreadPoolExecutor\n",
    "from openpyxl import load_workbook\n",
    "from openpyxl.worksheet.datavalidation import DataValidation\n",
    "from openpyxl.utils import get_column_letter\n",
    "from IPython.display import display, HTML, clear_output\n",
    "\n",
    "# 1. Paths & Logging\n",
    "today_str = datetime.now().strftime('%Y-%m-%d')\n",
    "BASE_DIR = os.path.join(\"output\", today_str, \"create\")\n",
    "LOG_DIR = os.path.join(BASE_DIR, \"logs\")\n",
    "MAPPING_DIR = os.path.join(\"input\", \"mapping\")\n",
    "os.makedirs(LOG_DIR, exist_ok=True)\n",
    "\n",
    "log_file = os.path.join(LOG_DIR, f\"aer_create_{today_str}_{datetime.now().strftime('%H%M')}.log\")\n",
    "logger = logging.getLogger(\"aer\")\n",
    "logger.handlers.clear()\n",
    "logger.setLevel(logging.INFO)\n",
    "formatter = logging.Formatter('%(asctime)s | %(levelname)s | %(message)s')\n",
    "fh = logging.FileHandler(log_file, encoding=\"utf-8\")\n",
    "fh.setFormatter(formatter)\n",
    "logger.addHandler(fh)\n",
    "logger.addHandler(logging.StreamHandler(sys.stdout))\n",
    "\n",
    "# 2. Auth & Cache\n",
    "load_dotenv()\n",
    "headers = {}\n",
    "try:\n",
    "    tid, cid = os.getenv(\"AZURE_TENANT_ID\"), os.getenv(\"AZURE_CLIENT_ID\")\n",
    "    if tid and cid:\n",
    "        app = PublicClientApplication(cid, authority=f\"https://login.microsoftonline.com/{tid}\")\n",
    "        # STRICT v5.7 Scope: Only User.Read.All (No AuditLog)\n",
    "        res = app.acquire_token_interactive(scopes=[\"User.Read.All\"], prompt=\"select_account\")\n",
    "        if \"access_token\" in res:\n",
    "            headers = {\"Authorization\": f\"Bearer {res['access_token']}\"}\n",
    "            logger.info(\"Authentication Successful\")\n",
    "except Exception as e:\n",
    "    logger.error(f\"Auth Critical Error: {str(e)}\")\n",
    "\n",
    "ad_cache = {}\n",
    "session = requests.Session()\n",
    "# Boost connection pool for speed\n",
    "adapter = requests.adapters.HTTPAdapter(pool_connections=50, pool_maxsize=50)\n",
    "session.mount('https://', adapter)\n",
    "\n",
    "def fetch_ad(email):\n",
    "    \"\"\" \n",
    "    Exact v5.7 Logic:\n",
    "    - No ID check\n",
    "    - No Last Login check (prevents 403 Forbidden)\n",
    "    - Just Name, Dept, Status\n",
    "    \"\"\"\n",
    "    email = str(email).strip().lower()\n",
    "    \n",
    "    # 1. Validation\n",
    "    if not re.match(r'^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\\.[a-zA-Z]{2,}$', email):\n",
    "        return {\"email\": email, \"status\": \"Invalid\", \"name\": \"N/A\", \"dept\": \"N/A\", \"active\": \"N/A\"}\n",
    "    \n",
    "    # 2. Cache\n",
    "    if email in ad_cache: return ad_cache[email]\n",
    "    \n",
    "    # 3. Mock Mode (No Auth)\n",
    "    if not headers: \n",
    "        return {\"email\": email, \"status\": \"Mock\", \"name\": \"User\", \"dept\": \"Mock Dept\", \"active\": True}\n",
    "    \n",
    "    try:\n",
    "        # STRICT v5.7 URL: No 'signInActivity', No 'id'\n",
    "        url = f\"https://graph.microsoft.com/v1.0/users/{email}?$select=displayName,department,accountEnabled\"\n",
    "        r = session.get(url, headers=headers, timeout=5)\n",
    "        \n",
    "        if r.status_code == 200:\n",
    "            d = r.json()\n",
    "            res = {\n",
    "                \"email\": email, \n",
    "                \"status\": \"Found\", \n",
    "                \"name\": d.get(\"displayName\", \"N/A\"), \n",
    "                \"dept\": d.get(\"department\") or \"N/A\", \n",
    "                \"active\": d.get(\"accountEnabled\", \"N/A\") # This returns Boolean True/False\n",
    "            }\n",
    "        else:\n",
    "            res = {\"email\": email, \"status\": \"Not Found\", \"name\": \"N/A\", \"dept\": \"N/A\", \"active\": \"N/A\"}\n",
    "    except:\n",
    "        res = {\"email\": email, \"status\": \"Error\", \"name\": \"N/A\", \"dept\": \"N/A\", \"active\": \"N/A\"}\n",
    "        \n",
    "    ad_cache[email] = res\n",
    "    return res"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "metadata": {},
   "outputs": [],
   "source": [
    "# === Cell 2: Hybrid Logic (v5.7 Logic + Editable UI + Excel Validation Fix) ===\n",
    "\n",
    "# --- 1. UI Styling ---\n",
    "style_html = \"\"\"\n",
    "<style>\n",
    "    .aer-row { border-bottom: 1px solid #e0e0e0; padding: 5px 0; align-items: center; }\n",
    "    .aer-header { font-weight: bold; background-color: #f0f0f0; padding: 8px 0; border-bottom: 2px solid #ccc; }\n",
    "    .aer-cell { overflow: hidden; white-space: nowrap; text-overflow: ellipsis; }\n",
    "</style>\n",
    "\"\"\"\n",
    "display(HTML(style_html))\n",
    "\n",
    "# --- 2. Widgets ---\n",
    "up_list = widgets.FileUpload(accept='.xlsx, .csv', description=\"1. User List\", button_style='info')\n",
    "txt_list = widgets.HTML(value=\"<i>No file selected</i>\", layout=widgets.Layout(margin='0 10px'))\n",
    "up_map = widgets.FileUpload(accept='.csv', description=\"2. Reviewer Map\", button_style='info')\n",
    "\n",
    "btn_process = widgets.Button(description=\"üöÄ Step 1: Analyze\", button_style='warning', layout=widgets.Layout(width='180px'))\n",
    "btn_save = widgets.Button(description=\"üíæ Step 2: Save\", button_style='success', layout=widgets.Layout(width='180px'), disabled=True)\n",
    "out_area = widgets.Output()\n",
    "\n",
    "# Global State\n",
    "review_registry = []\n",
    "processed_df = None\n",
    "current_fname = \"\"\n",
    "mapping_data = {\"emails\": {}, \"depts\": {}, \"all_depts\": [], \"all_branches\": []}\n",
    "\n",
    "# --- 3. Helper Functions ---\n",
    "def get_latest_map():\n",
    "    files = glob.glob(os.path.join(MAPPING_DIR, \"*.csv\"))\n",
    "    return max(files, key=os.path.getmtime) if files else None\n",
    "\n",
    "def on_list_file_change(c):\n",
    "    fname = up_list.value[0]['name']\n",
    "    txt_list.value = f\"<b style='color:green;'>‚úÖ Selected: {fname}</b>\"\n",
    "up_list.observe(on_list_file_change, 'value')\n",
    "\n",
    "map_path = get_latest_map()\n",
    "txt_map = widgets.HTML(value=f\"<b style='color:green;'>‚úÖ Default: {os.path.basename(map_path)}</b>\" if map_path else \"<i>No map found</i>\", layout=widgets.Layout(margin='0 10px'))\n",
    "\n",
    "def identify_columns_smart(df):\n",
    "    \"\"\" Detects Email/Name order by content \"\"\"\n",
    "    if len(df.columns) < 2: return df.columns[0], df.columns[0]\n",
    "    c0, c1 = df.columns[0], df.columns[1]\n",
    "    sample = df.head(20).fillna('').astype(str)\n",
    "    score_0 = sum(1 for x in sample[c0] if '@' in x and '.' in x)\n",
    "    score_1 = sum(1 for x in sample[c1] if '@' in x and '.' in x)\n",
    "    return (c0, c1) if score_0 >= score_1 else (c1, c0)\n",
    "\n",
    "def detect_map_column(df, candidates):\n",
    "    cols = [str(c).lower().strip() for c in df.columns]\n",
    "    for cand in candidates:\n",
    "        for i, c in enumerate(cols):\n",
    "            if cand in c: return df.columns[i]\n",
    "    return None\n",
    "\n",
    "# --- 4. Logic: Analysis ---\n",
    "def do_process(b):\n",
    "    global processed_df, current_fname, review_registry, mapping_data\n",
    "    out_area.clear_output()\n",
    "    review_registry = []\n",
    "    \n",
    "    if not up_list.value:\n",
    "        with out_area: print(\"Error: Please upload a user list.\")\n",
    "        return\n",
    "    \n",
    "    b.disabled = True\n",
    "    try:\n",
    "        logger.info(\"--- Starting Analysis ---\")\n",
    "        \n",
    "        # A. Load Map\n",
    "        m_src = io.BytesIO(up_map.value[0]['content']) if up_map.value else map_path\n",
    "        if not m_src: raise Exception(\"No Mapping CSV found!\")\n",
    "        df_m = pd.read_csv(m_src)\n",
    "        \n",
    "        # 1. Detect Columns\n",
    "        col_m_email = detect_map_column(df_m, [\"email\", \"mail\"])\n",
    "        col_m_dept = detect_map_column(df_m, [\"department\", \"dept\"])\n",
    "        col_m_rev = detect_map_column(df_m, [\"reviewer\", \"owner\", \"manager\"])\n",
    "        col_m_br = detect_map_column(df_m, [\"branch\", \"category\", \"type\"])\n",
    "        \n",
    "        if not col_m_rev or not col_m_dept:\n",
    "            with out_area: print(f\"Error: Map needs 'Department' and 'Reviewer'. Found: {list(df_m.columns)}\")\n",
    "            return\n",
    "\n",
    "        # 2. Build Mapping\n",
    "        mapping_data['emails'] = {}\n",
    "        if col_m_email:\n",
    "            mapping_data['emails'] = dict(zip(df_m[col_m_email].astype(str).str.lower().str.strip(), df_m[col_m_rev]))\n",
    "        mapping_data['depts'] = dict(zip(df_m[col_m_dept].astype(str).str.lower().str.strip(), df_m[col_m_rev]))\n",
    "        \n",
    "        # 3. Split Branch vs Dept\n",
    "        if col_m_br:\n",
    "            unique_locs = df_m[[col_m_dept, col_m_br]].drop_duplicates()\n",
    "            is_branch = unique_locs[col_m_br].astype(str).str.lower().str.contains(\"branch\", na=False)\n",
    "            list_branches = sorted(unique_locs[is_branch][col_m_dept].unique())\n",
    "            list_depts = sorted(unique_locs[~is_branch][col_m_dept].unique())\n",
    "        else:\n",
    "            list_branches = []\n",
    "            list_depts = sorted(df_m[col_m_dept].astype(str).unique())\n",
    "\n",
    "        mapping_data['all_branches'] = [(\"Select Branch...\", \"\")] + [(d, d.lower()) for d in list_branches]\n",
    "        mapping_data['all_depts'] = [(\"Select Dept...\", \"\")] + [(d, d.lower()) for d in list_depts]\n",
    "        \n",
    "        # B. Load User List\n",
    "        f_item = up_list.value[0]\n",
    "        current_fname = f_item['name']\n",
    "        df_u = pd.read_csv(io.BytesIO(f_item['content'])) if current_fname.endswith('.csv') else pd.read_excel(io.BytesIO(f_item['content']))\n",
    "        col_email, col_name = identify_columns_smart(df_u)\n",
    "        \n",
    "        # C. AD Fetch\n",
    "        emails = df_u[col_email].dropna().unique().tolist()\n",
    "        with out_area: print(f\"Syncing {len(emails)} emails with AD...\")\n",
    "        with ThreadPoolExecutor(max_workers=25) as ex:\n",
    "            ad_results = {r['email']: r for r in list(ex.map(fetch_ad, emails))}\n",
    "\n",
    "        # D. Processing Loop\n",
    "        final_rows = []\n",
    "        widget_rows = []\n",
    "        \n",
    "        header_box = widgets.HBox([\n",
    "            widgets.Label(\"Remove\", layout=widgets.Layout(width='60px', font_weight='bold')),\n",
    "            widgets.Label(\"User Name\", layout=widgets.Layout(flex='2', font_weight='bold')),\n",
    "            widgets.Label(\"User Email\", layout=widgets.Layout(flex='2', font_weight='bold')),\n",
    "            widgets.Label(\"AD Status\", layout=widgets.Layout(flex='2', font_weight='bold')),\n",
    "            widgets.Label(\"Br?\", layout=widgets.Layout(width='40px', font_weight='bold')),\n",
    "            widgets.Label(\"Mapping\", layout=widgets.Layout(flex='2', font_weight='bold')),\n",
    "            widgets.Label(\"Reviewer\", layout=widgets.Layout(flex='1', font_weight='bold')),\n",
    "        ], layout=widgets.Layout(border='0px 0px 2px 0px solid gray', padding='5px'))\n",
    "\n",
    "        for idx, row in df_u.iterrows():\n",
    "            raw_email = str(row[col_email]).strip().lower()\n",
    "            raw_name = str(row[col_name]).strip()\n",
    "            \n",
    "            # AD Lookup (v5.7)\n",
    "            ad = ad_results.get(raw_email, {\"status\": \"Not Found\", \"dept\": \"N/A\", \"active\": \"N/A\"})\n",
    "            \n",
    "            # Match Logic (v5.7)\n",
    "            clean_dept = str(ad['dept']).split(\" - \")[-1].strip().lower()\n",
    "            reviewer = mapping_data['emails'].get(raw_email) or mapping_data['depts'].get(clean_dept)\n",
    "            \n",
    "            is_problem = not reviewer or str(reviewer).strip().lower() in [\"nan\", \"none\", \"\", \"null\", \"()\"]\n",
    "            \n",
    "            if is_problem:\n",
    "                reviewer = \"(please manual review)\"\n",
    "                \n",
    "                # Logic: Status / Remove\n",
    "                is_active = ad['active'] is True\n",
    "                found = \"Found\" in ad['status']\n",
    "                remove_default = False\n",
    "                status_txt = \"\"\n",
    "\n",
    "                if is_active:\n",
    "                    status_txt = f\"<b style='color:green;'>Active</b><br><span style='font-size:10px; color:gray'>{ad['dept']}</span>\"\n",
    "                    remove_default = False\n",
    "                elif found and not is_active:\n",
    "                    status_txt = f\"<span style='color:#b8860b;'>Inactive (Disabled)</span>\"\n",
    "                    remove_default = False \n",
    "                else:\n",
    "                    status_txt = f\"<b style='color:red;'>Not Found (No AD)</b>\"\n",
    "                    remove_default = True\n",
    "\n",
    "                # Widgets\n",
    "                chk = widgets.Checkbox(value=remove_default, indent=False, layout=widgets.Layout(width='40px'))\n",
    "                name_lbl = widgets.HTML(f\"<div style='font-size:11px; font-weight:bold'>{raw_name}</div>\")\n",
    "                email_lbl = widgets.HTML(f\"<div style='font-size:11px'>{raw_email}</div>\")\n",
    "                stat_lbl = widgets.HTML(f\"<div style='font-size:11px; line-height:1.1'>{status_txt}</div>\")\n",
    "                \n",
    "                tgl = widgets.ToggleButton(value=False, description='B', tooltip='Toggle Branch', layout=widgets.Layout(width='30px', height='25px'))\n",
    "                drp = widgets.Dropdown(options=mapping_data['all_depts'], layout=widgets.Layout(width='95%'))\n",
    "                res_txt = widgets.Text(value=\"\", placeholder=\"Type or Select...\", layout=widgets.Layout(width='95%'))\n",
    "\n",
    "                def on_tgl(change, d=drp): \n",
    "                    d.options = mapping_data['all_branches'] if change['new'] else mapping_data['all_depts']\n",
    "                    d.value = \"\"\n",
    "                \n",
    "                def on_drp(change, t=res_txt): \n",
    "                    t.value = str(mapping_data['depts'].get(change['new'], \"\"))\n",
    "\n",
    "                tgl.observe(on_tgl, names='value')\n",
    "                drp.observe(on_drp, names='value')\n",
    "\n",
    "                review_registry.append({'index': idx, 'chk': chk, 'drp': drp, 'txt': res_txt, 'email': raw_email})\n",
    "                \n",
    "                widget_rows.append(widgets.HBox([\n",
    "                    chk, \n",
    "                    widgets.Box([name_lbl], layout=widgets.Layout(flex='2')),\n",
    "                    widgets.Box([email_lbl], layout=widgets.Layout(flex='2')),\n",
    "                    widgets.Box([stat_lbl], layout=widgets.Layout(flex='2')),\n",
    "                    tgl,\n",
    "                    widgets.Box([drp], layout=widgets.Layout(flex='2')),\n",
    "                    widgets.Box([res_txt], layout=widgets.Layout(flex='1'))\n",
    "                ], layout=widgets.Layout(border='0px 0px 1px 0px solid #eee', padding='4px 0')))\n",
    "\n",
    "            new_row = row.to_dict()\n",
    "            if is_problem: reviewer = \"\" \n",
    "            new_row.update({\"Reviewer\": reviewer, \"Reviewer's Response\": \"\", \"Details of Access Changes\": \"\"})\n",
    "            final_rows.append(new_row)\n",
    "\n",
    "        processed_df = pd.DataFrame(final_rows)\n",
    "        btn_save.disabled = False\n",
    "        \n",
    "        with out_area:\n",
    "            print(f\"Analysis Complete. Total: {len(processed_df)} | Manual Review: {len(widget_rows)}\")\n",
    "            if widget_rows: display(widgets.VBox([header_box] + widget_rows))\n",
    "            else: display(HTML(\"<h4 style='color:green'>All records matched automatically!</h4>\"))\n",
    "                \n",
    "    except Exception as e:\n",
    "        with out_area: print(f\"Error: {str(e)}\")\n",
    "        logger.error(\"Process Error\", exc_info=True)\n",
    "    finally: b.disabled = False\n",
    "\n",
    "# --- 5. Logic: Save ---\n",
    "def do_save(b):\n",
    "    global processed_df\n",
    "    b.disabled = True\n",
    "    try:\n",
    "        df_final = processed_df.copy()\n",
    "        to_drop = []\n",
    "        for item in review_registry:\n",
    "            if item['chk'].value: \n",
    "                to_drop.append(item['index'])\n",
    "            else:\n",
    "                final_val = item['txt'].value.strip()\n",
    "                if final_val: \n",
    "                    df_final.at[item['index'], 'Reviewer'] = final_val\n",
    "        \n",
    "        df_final = df_final.drop(to_drop)\n",
    "        fpath = os.path.join(BASE_DIR, current_fname.split('.')[0] + \"_Reviewed.xlsx\")\n",
    "        df_final.to_excel(fpath, index=False)\n",
    "        \n",
    "        # === DATA VALIDATION FIX ===\n",
    "        wb = load_workbook(fpath)\n",
    "        ws = wb.active\n",
    "        col = next((i for i, c in enumerate(ws[1], 1) if c.value == \"Reviewer's Response\"), None)\n",
    "        \n",
    "        if col:\n",
    "            # 1. Create Validator\n",
    "            dv = DataValidation(type=\"list\", formula1='\"Approved,Denied,Changes Required\"', allow_blank=True)\n",
    "            \n",
    "            # 2. Configure Input Message (The tooltip)\n",
    "            dv.promptTitle = \"Select Action\"\n",
    "            dv.prompt = \"Please select: Approved, Denied, or Changes Required\"\n",
    "            dv.showInputMessage = True\n",
    "            \n",
    "            # 3. Configure Error Message (The popup)\n",
    "            dv.errorTitle = \"Invalid Selection\"\n",
    "            dv.error = \"Please select a valid option from the drop-down menu.\"\n",
    "            dv.showErrorMessage = True\n",
    "            \n",
    "            # 4. Apply\n",
    "            ws.add_data_validation(dv)\n",
    "            letter = get_column_letter(col)\n",
    "            dv.add(f\"{letter}2:{letter}{len(df_final)+1}\")\n",
    "            \n",
    "        wb.save(fpath)\n",
    "        with out_area: display(HTML(f\"<b style='color:blue;'>‚úî Saved: {fpath}</b>\"))\n",
    "    except Exception as e:\n",
    "        with out_area: print(f\"Save Error: {str(e)}\")\n",
    "    finally: b.disabled = False\n",
    "\n",
    "# --- 6. Final UI ---\n",
    "btn_process.on_click(do_process); btn_save.on_click(do_save)\n",
    "ui = widgets.VBox([widgets.HTML(\"<h4>üõ°Ô∏è AER Generator (v6.3 - Final)</h4>\"), widgets.HBox([up_list, txt_list]), widgets.HBox([up_map, txt_map]), widgets.HBox([btn_process, btn_save]), out_area])\n",
    "clear_output(); display(ui)"
   ]
  }
 ],
 "metadata": {
  "kernelspec": {
   "display_name": "Python 3",
   "language": "python",
   "name": "python3"
  },
  "language_info": {
   "name": "python",
   "version": "3.8.5"
  }
 },
 "nbformat": 4,
 "nbformat_minor": 4
}
