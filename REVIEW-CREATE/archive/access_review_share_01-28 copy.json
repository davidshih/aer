{
 "cells": [
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "# AER - Advanced Splitter & Distributor (v5.0)\n",
    "\n",
    "### Workflow Overview:\n",
    "1. **Auth**: Login to Microsoft 365.\n",
    "2. **Selection**: Pick Master Excel and Attachments (Local or SharePoint).\n",
    "3. **Process**: Create the split files and folders on your local machine.\n",
    "4. **Sync**: Upload the finalized folders to SharePoint.\n",
    "5. **Notify**: Share folders and email the Reviewers."
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "metadata": {},
   "outputs": [],
   "source": [
    "# === Step 1: Environment & Authentication ===\n",
    "import os, sys, shutil, time, requests, pythoncom, win32com.client, pandas as pd, ipywidgets as widgets\n",
    "from pathlib import Path\n",
    "from urllib.parse import quote\n",
    "from msal import PublicClientApplication\n",
    "from IPython.display import display, HTML, clear_output\n",
    "from datetime import datetime\n",
    "\n",
    "# Config\n",
    "TENANT_ID = \"YOUR_TENANT_ID\"\n",
    "CLIENT_ID = \"YOUR_CLIENT_ID\"\n",
    "SHAREPOINT_HOST = \"davidshih.sharepoint.com\"\n",
    "SITE_NAME = \"aer\"\n",
    "SCOPES = [\"Files.ReadWrite.All\", \"Sites.ReadWrite.All\", \"User.Read.All\", \"Mail.Send\"]\n",
    "\n",
    "app = PublicClientApplication(CLIENT_ID, authority=f\"https://login.microsoftonline.com/{TENANT_ID}\")\n",
    "auth_res = app.acquire_token_interactive(scopes=SCOPES)\n",
    "headers = {\"Authorization\": f\"Bearer {auth_res['access_token']}\"}\n",
    "\n",
    "def get_site_id(name):\n",
    "    url = f\"https://graph.microsoft.com/v1.0/sites/{SHAREPOINT_HOST}:/sites/{name}\"\n",
    "    return requests.get(url, headers=headers).json()[\"id\"]\n",
    "\n",
    "def get_email(name):\n",
    "    try:\n",
    "        url = f\"https://graph.microsoft.com/v1.0/users?$filter=startswith(displayName,'{quote(str(name).split('(')[0].strip())}')\"\n",
    "        res = requests.get(url, headers=headers).json().get('value')\n",
    "        return res[0].get('mail') or res[0].get('userPrincipalName') if res else \"\"\n",
    "    except: return \"\"\n",
    "\n",
    "SITE_ID = get_site_id(SITE_NAME)\n",
    "print(\"‚úÖ Step 1: MSAL Authenticated\")"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "metadata": {},
   "outputs": [],
   "source": [
    "# === Step 2: Configuration & File Selection ===\n",
    "\n",
    "source_mode = widgets.Dropdown(options=['SharePoint', 'Local'], value='SharePoint', description='Source Mode:')\n",
    "path_input = widgets.Text(value=\"2025 Entitlement Review/App_Name\", description=\"Folder Path:\", layout={'width':'500px'})\n",
    "btn_load = widgets.Button(description=\"Fetch Files\", button_style='info')\n",
    "master_excel = widgets.Dropdown(description=\"Master Excel:\")\n",
    "attachments = widgets.SelectMultiple(description=\"Attachments:\", layout={'height':'150px', 'width':'500px'})\n",
    "rev_col = widgets.Text(value=\"Reviewer\", description=\"Reviewer Col:\")\n",
    "\n",
    "ui_step2 = widgets.VBox([source_mode, path_input, btn_load, master_excel, attachments, rev_col])\n",
    "display(HTML(\"<h3>üìÇ Step 2: Select Source Files</h3>\"), ui_step2)\n",
    "\n",
    "def fetch_files(b):\n",
    "    if source_mode.value == 'SharePoint':\n",
    "        url = f\"https://graph.microsoft.com/v1.0/sites/{SITE_ID}/drive/root:/{quote(path_input.value)}:/children\"\n",
    "        items = requests.get(url, headers=headers).json().get('value', [])\n",
    "        opts = [(i['name'], i['id']) for i in items if 'folder' not in i]\n",
    "    else:\n",
    "        p = Path(path_input.value)\n",
    "        opts = [(f.name, str(f)) for f in p.iterdir() if f.is_file()]\n",
    "    \n",
    "    master_excel.options = [o for o in opts if o[0].endswith('.xlsx')]\n",
    "    attachments.options = opts\n",
    "    print(f\"‚úÖ Loaded {len(opts)} items.\")\n",
    "\n",
    "btn_load.on_click(fetch_files)"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "metadata": {},
   "outputs": [],
   "source": [
    "# === Step 3: Local Engine (Create Folders & Files) ===\n",
    "\n",
    "btn_process = widgets.Button(description=\"3. Run Local Processing\", button_style='success', layout={'width':'300px'})\n",
    "local_log = widgets.Output()\n",
    "display(btn_process, local_log)\n",
    "\n",
    "def run_processing(b):\n",
    "    with local_log:\n",
    "        clear_output()\n",
    "        workspace = Path(\"aer_local_workspace\")\n",
    "        if workspace.exists(): shutil.rmtree(workspace)\n",
    "        workspace.mkdir(); (workspace / \"download\").mkdir(); (workspace / \"output\").mkdir()\n",
    "        \n",
    "        # 1. Download/Copy to workspace\n",
    "        print(\"‚è≥ Preparing Workspace...\")\n",
    "        m_path = workspace / \"download\" / \"master.xlsx\"\n",
    "        if source_mode.value == 'SharePoint':\n",
    "            url_dl = f\"https://graph.microsoft.com/v1.0/sites/{SITE_ID}/drive/items/{master_excel.value}/content\"\n",
    "            with open(m_path, 'wb') as f: f.write(requests.get(url_dl, headers=headers).content)\n",
    "            for att_id in attachments.value:\n",
    "                name = [n for n, i in attachments.options if i == att_id][0]\n",
    "                url_att = f\"https://graph.microsoft.com/v1.0/sites/{SITE_ID}/drive/items/{att_id}/content\"\n",
    "                with open(workspace / \"download\" / name, 'wb') as f: f.write(requests.get(url_att, headers=headers).content)\n",
    "        else:\n",
    "            shutil.copy2(master_excel.value, m_path)\n",
    "            for att_path in attachments.value: shutil.copy2(att_path, workspace / \"download\")\n",
    "\n",
    "        # 2. Logic Implementation\n",
    "        df = pd.read_excel(m_path)\n",
    "        reviewers = df[rev_col.value].dropna().unique().tolist()\n",
    "        pythoncom.CoInitialize()\n",
    "        xl = win32com.client.Dispatch(\"Excel.Application\")\n",
    "        xl.Visible = False; xl.DisplayAlerts = False\n",
    "        \n",
    "        try:\n",
    "            for r_name in reviewers:\n",
    "                print(f\"‚öôÔ∏è Splitting Excel: {r_name}\")\n",
    "                r_folder = workspace / \"output\" / \"\".join([c if c.isalnum() else '_' for c in str(r_name)])\n",
    "                r_folder.mkdir(parents=True, exist_ok=True)\n",
    "                \n",
    "                wb = xl.Workbooks.Open(os.path.abspath(m_path))\n",
    "                ws = wb.Worksheets(1)\n",
    "                c_idx = 0\n",
    "                for c in range(1, ws.UsedRange.Columns.Count+1):\n",
    "                    if ws.Cells(1, c).Value == rev_col.value: c_idx = c; break\n",
    "                \n",
    "                if c_idx > 0:\n",
    "                    for r_idx in range(ws.UsedRange.Rows.Count, 1, -1):\n",
    "                        if str(ws.Cells(r_idx, c_idx).Value).strip() != str(r_name).strip(): ws.Rows(r_idx).Delete()\n",
    "                \n",
    "                wb.SaveAs(os.path.abspath(r_folder / f\"Review - {r_name}.xlsx\"))\n",
    "                wb.Close()\n",
    "                \n",
    "                # Copy attachments\n",
    "                for f in (workspace / \"download\").iterdir():\n",
    "                    if f.name != \"master.xlsx\": shutil.copy2(f, r_folder)\n",
    "            print(\"‚úÖ Step 3: Local Processing Complete\")\n",
    "        finally: xl.Quit()\n",
    "\n",
    "btn_process.on_click(run_processing)"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "metadata": {},
   "outputs": [],
   "source": [
    "# === Step 4: SharePoint Synchronization (The Push) ===\n",
    "\n",
    "push_path = widgets.Text(value=\"2025 Entitlement Review/Output_Folder\", description=\"Target Path:\")\n",
    "btn_push = widgets.Button(description=\"4. Push to SharePoint\", button_style='primary', layout={'width':'300px'})\n",
    "push_log = widgets.Output()\n",
    "display(push_path, btn_push, push_log)\n",
    "\n",
    "def run_push(b):\n",
    "    with push_log:\n",
    "        clear_output()\n",
    "        local_out = Path(\"aer_local_workspace/output\")\n",
    "        if not local_out.exists(): print(\"‚ùå No local data found. Run Step 3.\"); return\n",
    "        \n",
    "        for folder in local_out.iterdir():\n",
    "            if folder.is_dir():\n",
    "                print(f\"üì§ Uploading Folder: {folder.name}\")\n",
    "                sp_dest = f\"{push_path.value}/{folder.name}\"\n",
    "                # Ensure folder\n",
    "                requests.post(f\"https://graph.microsoft.com/v1.0/sites/{SITE_ID}/drive/root:/{quote(push_path.value)}:/children\", \n",
    "                              headers=headers, json={\"name\": folder.name, \"folder\": {}, \"@microsoft.graph.conflictBehavior\": \"replace\"})\n",
    "                \n",
    "                for f in folder.iterdir():\n",
    "                    url_up = f\"https://graph.microsoft.com/v1.0/sites/{SITE_ID}/drive/root:/{quote(sp_dest)}/{quote(f.name)}:/content\"\n",
    "                    with open(f, 'rb') as f_data: requests.put(url_up, headers=headers, data=f_data.read())\n",
    "        print(\"‚úÖ Step 4: All Folders Uploaded\")\n",
    "\n",
    "btn_push.on_click(run_push)"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "metadata": {},
   "outputs": [],
   "source": [
    "# === Step 5: Distribution Dashboard ===\n",
    "\n",
    "btn_dashboard = widgets.Button(description=\"5. Load Distribution List\", button_style='warning')\n",
    "dash_out = widgets.VBox()\n",
    "display(btn_dashboard, dash_out)\n",
    "\n",
    "def build_dash(b):\n",
    "    clear_output(); rows = []\n",
    "    local_out = Path(\"aer_local_workspace/output\")\n",
    "    for folder in local_out.iterdir():\n",
    "        email = get_email(folder.name)\n",
    "        email_box = widgets.Text(value=email, layout={'width':'250px'})\n",
    "        btn_s = widgets.Button(description=\"Share\", layout={'width':'80px'})\n",
    "        btn_e = widgets.Button(description=\"Email\", disabled=True, layout={'width':'80px'})\n",
    "        lbl_s = widgets.HTML(\"Ready\")\n",
    "        \n",
    "        def do_share(b, f=folder, st=lbl_s, eb=btn_e, em=email_box, bs=btn_s):\n",
    "            bs.disabled = True\n",
    "            sp_f_path = f\"{push_path.value}/{f.name}\"\n",
    "            it_id = requests.get(f\"https://graph.microsoft.com/v1.0/sites/{SITE_ID}/drive/root:/{quote(sp_f_path)}\", headers=headers).json().get('id')\n",
    "            requests.post(f\"https://graph.microsoft.com/v1.0/sites/{SITE_ID}/drive/items/{it_id}/invite\", headers=headers, \n",
    "                          json={\"recipients\":[{\"email\":em.value}], \"roles\":[\"read\"], \"requireSignIn\":True, \"sendInvitation\":False})\n",
    "            f.sp_url = requests.get(f\"https://graph.microsoft.com/v1.0/sites/{SITE_ID}/drive/items/{it_id}\", headers=headers).json().get('webUrl')\n",
    "            st.value = \"‚úÖ Shared\"; eb.disabled = False; bs.button_style='success'\n",
    "\n",
    "        def do_email(b, f=folder, em=email_box, be=btn_e):\n",
    "            body = f\"Hi, please find your review folder here: <a href='{f.sp_url}'>Link</a>\"\n",
    "            payload = {\"message\": {\"subject\": \"Entitlement Review\", \"body\": {\"contentType\":\"HTML\", \"content\":body}, \"toRecipients\":[{\"emailAddress\":{\"address\":em.value}}]}}\n",
    "            requests.post(f\"https://graph.microsoft.com/v1.0/users/me/sendMail\", headers=headers, json=payload)\n",
    "            be.button_style='success'; be.description='Sent'\n",
    "\n",
    "        btn_s.on_click(do_share); btn_e.on_click(do_email)\n",
    "        rows.append(widgets.HBox([widgets.Label(folder.name, layout={'width':'150px'}), email_box, btn_s, btn_e, lbl_s]))\n",
    "    dash_out.children = rows\n",
    "\n",
    "btn_dashboard.on_click(build_dash)"
   ]
  }
 ],
 "metadata": {
  "kernelspec": {
   "display_name": "Python 3",
   "language": "python",
   "name": "python3"
  },
  "language_info": {
   "codemirror_mode": {
    "name": "ipython",
    "version": 3
   },
   "file_extension": ".py",
   "mimetype": "text/x-python",
   "name": "python",
   "nbconvert_exporter": "python",
   "pygments_lexer": "ipython3",
   "version": "3.8.5"
  }
 },
 "nbformat": 4,
 "nbformat_minor": 4
}