{
 "cells": [
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "# üé® AER v7.5 - Access Review Generator\n",
    "\n",
    "## Production-Ready | Apple-Style UI | Real AD Auth | Action Dropdown\n",
    "\n",
    "---\n",
    "\n",
    "### ‚ú® Features\n",
    "- üé® **Apple-inspired design system**\n",
    "- üîê **Real MSAL authentication** with Microsoft Graph API\n",
    "- üîó **Auto file loading** between stages\n",
    "- ‚úÖ **Card-based manual review UI** with batch operations\n",
    "- üå≥ **Enhanced org tree** with toggle (hide/show non-dept-heads)\n",
    "- üìä **Group operations** (Select All, Deselect All, Skip All)\n",
    "- üìù **Action dropdown** (Approved / Denied / Changes Required) via openpyxl\n",
    "- üìù **Clean logging** (verbose in logs, concise in UI)\n",
    "\n",
    "### üìã Stages\n",
    "1. **Stage 1**: AD Authentication & User Download (MSAL + Graph API)\n",
    "2. **Stage 1.5**: Organization Tree Builder\n",
    "3. **Stage 2**: Email/User Validation\n",
    "4. **Stage 3**: Reviewer Assignment & Final Review Spreadsheet\n",
    "\n",
    "---"
   ]
  },
  {
   "cell_type": "code",
   "metadata": {},
   "source": [
    "# ========================================================================\n",
    "# CELL 1: Apple Design System & Core Utilities\n",
    "# ========================================================================\n",
    "\n",
    "import os, sys, logging, glob, io, re, unicodedata, json\n",
    "import pandas as pd\n",
    "import ipywidgets as widgets\n",
    "from datetime import datetime\n",
    "from IPython.display import display, HTML, clear_output\n",
    "\n",
    "# ========== APPLE DESIGN SYSTEM ==========\n",
    "\n",
    "APPLE_COLORS = {\n",
    "    'blue': '#007AFF',\n",
    "    'purple': '#5856D6',\n",
    "    'green': '#34C759',\n",
    "    'orange': '#FF9500',\n",
    "    'red': '#FF3B30',\n",
    "    'bg_light': '#F5F5F7',\n",
    "    'surface': '#FFFFFF',\n",
    "    'text_primary': '#1D1D1F',\n",
    "    'text_secondary': '#86868B',\n",
    "    'border': '#D2D2D7'\n",
    "}\n",
    "\n",
    "APPLE_GRADIENTS = {\n",
    "    'blue_purple': 'linear-gradient(135deg, #007AFF 0%, #5856D6 100%)',\n",
    "    'pink_red': 'linear-gradient(135deg, #f093fb 0%, #f5576c 100%)',\n",
    "    'green_blue': 'linear-gradient(135deg, #5ee7df 0%, #b490ca 100%)',\n",
    "    'gold_red': 'linear-gradient(135deg, #fa709a 0%, #fee140 100%)',\n",
    "}\n",
    "\n",
    "def get_header_html(title, subtitle, gradient='blue_purple'):\n",
    "    \"\"\"Generate Apple-style header\"\"\"\n",
    "    grad = APPLE_GRADIENTS.get(gradient, APPLE_GRADIENTS['blue_purple'])\n",
    "    return f'''\n",
    "    <div style=\"\n",
    "        background: {grad};\n",
    "        color: white;\n",
    "        padding: 32px;\n",
    "        border-radius: 16px;\n",
    "        margin-bottom: 24px;\n",
    "        box-shadow: 0 8px 24px rgba(0,0,0,0.12);\n",
    "    \">\n",
    "        <h1 style=\"\n",
    "            font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', sans-serif;\n",
    "            font-size: 32px;\n",
    "            font-weight: 600;\n",
    "            margin: 0 0 8px 0;\n",
    "            letter-spacing: -0.5px;\n",
    "        \">{title}</h1>\n",
    "        <p style=\"\n",
    "            font-family: -apple-system, BlinkMacSystemFont, sans-serif;\n",
    "            font-size: 16px;\n",
    "            margin: 0;\n",
    "            opacity: 0.9;\n",
    "            font-weight: 400;\n",
    "        \">{subtitle}</p>\n",
    "    </div>\n",
    "    '''\n",
    "\n",
    "def get_card_style():\n",
    "    \"\"\"Card container style\"\"\"\n",
    "    return '''background: white;\n",
    "        border-radius: 12px;\n",
    "        padding: 24px;\n",
    "        margin-bottom: 16px;\n",
    "        box-shadow: 0 4px 16px rgba(0,0,0,0.08);\n",
    "        border: 1px solid #D2D2D7;'''\n",
    "\n",
    "def get_button_layout(width='auto', height='44px'):\n",
    "    \"\"\"Apple-style button layout\"\"\"\n",
    "    return widgets.Layout(width=width, height=height)\n",
    "\n",
    "def get_latest_file(directory, pattern='*.xlsx', prefix_priority=None):\n",
    "    \"\"\"\n",
    "    Get latest file from directory with optional prefix priority\n",
    "    \"\"\"\n",
    "    if not os.path.exists(directory):\n",
    "        return None\n",
    "    files = glob.glob(os.path.join(directory, pattern))\n",
    "    if not files:\n",
    "        return None\n",
    "    if prefix_priority:\n",
    "        priority_files = [f for f in files if os.path.basename(f).startswith(prefix_priority)]\n",
    "        if priority_files:\n",
    "            files = priority_files\n",
    "    return max(files, key=os.path.getmtime)\n",
    "\n",
    "# ========== PATHS SETUP ==========\n",
    "\n",
    "today_str = datetime.now().strftime('%Y-%m-%d')\n",
    "BASE_DIR = os.path.join(\"output\", today_str)\n",
    "os.makedirs(BASE_DIR, exist_ok=True)\n",
    "\n",
    "# Logging setup\n",
    "LOG_DIR = os.path.join(BASE_DIR, \"logs\")\n",
    "os.makedirs(LOG_DIR, exist_ok=True)\n",
    "\n",
    "def setup_logger(name, log_file):\n",
    "    \"\"\"Setup logger that writes to file only (not stdout)\"\"\"\n",
    "    logger = logging.getLogger(name)\n",
    "    logger.handlers.clear()\n",
    "    logger.setLevel(logging.INFO)\n",
    "    formatter = logging.Formatter('%(asctime)s | %(levelname)s | %(message)s')\n",
    "    fh = logging.FileHandler(log_file, encoding=\"utf-8\")\n",
    "    fh.setFormatter(formatter)\n",
    "    logger.addHandler(fh)\n",
    "    return logger\n",
    "\n",
    "print(\"‚úÖ Design system and utilities loaded\")\n",
    "print(f\"üìÅ Base directory: {BASE_DIR}\")\n",
    "print(f\"üìù Logs directory: {LOG_DIR}\")\n"
   ],
   "execution_count": null,
   "outputs": []
  },
  {
   "cell_type": "code",
   "metadata": {},
   "source": [
    "# ========================================================================\n",
    "# CELL 2: Stage 1 - AD Authentication & User Download\n",
    "#          (Real MSAL Auth from v7.0 + Apple-Style UI from v7.5)\n",
    "# ========================================================================\n",
    "\n",
    "import os, sys, logging, re, requests, json, glob\n",
    "import pandas as pd\n",
    "import ipywidgets as widgets\n",
    "from datetime import datetime, timedelta\n",
    "from dotenv import load_dotenv\n",
    "from msal import PublicClientApplication\n",
    "from IPython.display import display, HTML, clear_output\n",
    "\n",
    "# Paths\n",
    "AD_CACHE_DIR = os.path.join(BASE_DIR, \"ad_cache\")\n",
    "USERS_URL = \"https://graph.microsoft.com/v1.0/users\"\n",
    "os.makedirs(AD_CACHE_DIR, exist_ok=True)\n",
    "\n",
    "# Logger (file only)\n",
    "s1_logger = setup_logger(\"stage1\", os.path.join(LOG_DIR, f\"stage1_{datetime.now().strftime('%Y%m%d_%H%M')}.log\"))\n",
    "\n",
    "# ========== GLOBAL STATE ==========\n",
    "stage1_headers = {}\n",
    "stage1_ad_data = None\n",
    "stage1_file_path = None\n",
    "\n",
    "# ========== UI COMPONENTS (Apple Style) ==========\n",
    "s1_status = widgets.HTML(\"<i>Please login to Azure AD first</i>\")\n",
    "s1_output = widgets.Output()\n",
    "s1_progress = widgets.IntProgress(\n",
    "    value=0, min=0, max=100,\n",
    "    description='Progress:',\n",
    "    bar_style='info',\n",
    "    layout=widgets.Layout(width='100%', visibility='hidden')\n",
    ")\n",
    "\n",
    "s1_chk_auditlog = widgets.Checkbox(\n",
    "    value=False,\n",
    "    description='Include AuditLog.Read.All (sign-in activity)',\n",
    "    indent=False,\n",
    "    style={'description_width': 'auto'}\n",
    ")\n",
    "s1_chk_use_cache = widgets.Checkbox(\n",
    "    value=True,\n",
    "    description='Use cached AD file if available (skip Graph refresh)',\n",
    "    indent=False,\n",
    "    style={'description_width': 'auto'}\n",
    ")\n",
    "\n",
    "btn_login = widgets.Button(\n",
    "    description=\"üîê Login to Azure AD\",\n",
    "    button_style='',\n",
    "    layout=get_button_layout(width='200px')\n",
    ")\n",
    "btn_login.style.button_color = APPLE_COLORS['blue']\n",
    "\n",
    "btn_download = widgets.Button(\n",
    "    description=\"üì• Download AD Users\",\n",
    "    button_style='',\n",
    "    layout=get_button_layout(width='200px'),\n",
    "    disabled=True\n",
    ")\n",
    "btn_download.style.button_color = APPLE_COLORS['green']\n",
    "\n",
    "btn_s1_refresh = widgets.Button(\n",
    "    description=\"üîÑ Refresh\",\n",
    "    button_style='',\n",
    "    layout=get_button_layout(width='120px'),\n",
    "    disabled=True\n",
    ")\n",
    "btn_s1_refresh.style.button_color = APPLE_COLORS['orange']\n",
    "\n",
    "# ========== HELPER: Load Cache ==========\n",
    "def load_latest_cache():\n",
    "    files = glob.glob(os.path.join(AD_CACHE_DIR, \"ad_users_*.csv\"))\n",
    "    if not files:\n",
    "        return None, None\n",
    "    latest = max(files, key=os.path.getmtime)\n",
    "    try:\n",
    "        df = pd.read_csv(latest)\n",
    "        return df, latest\n",
    "    except Exception as e:\n",
    "        s1_logger.error(f\"Failed to read cache {latest}: {e}\")\n",
    "        return None, None\n",
    "\n",
    "# ========== AUTHENTICATION ==========\n",
    "def do_stage1_login(b):\n",
    "    global stage1_headers\n",
    "    b.disabled = True\n",
    "    s1_status.value = f'<span style=\"color:{APPLE_COLORS[\"blue\"]};font-family:-apple-system;\">üîÑ Authenticating...</span>'\n",
    "    try:\n",
    "        load_dotenv()\n",
    "        tid = os.getenv(\"AZURE_TENANT_ID\")\n",
    "        cid = os.getenv(\"AZURE_CLIENT_ID\")\n",
    "        if not tid or not cid:\n",
    "            s1_status.value = f'<span style=\"color:{APPLE_COLORS[\"red\"]};font-family:-apple-system;\">‚ùå Missing AZURE_TENANT_ID or AZURE_CLIENT_ID in .env</span>'\n",
    "            s1_logger.error(\"Missing Azure credentials in .env\")\n",
    "            b.disabled = False\n",
    "            return\n",
    "        app = PublicClientApplication(\n",
    "            cid,\n",
    "            authority=f\"https://login.microsoftonline.com/{tid}\"\n",
    "        )\n",
    "        scopes = [\"User.Read.All\"]\n",
    "        if s1_chk_auditlog.value:\n",
    "            scopes.append(\"AuditLog.Read.All\")\n",
    "        result = app.acquire_token_interactive(\n",
    "            scopes=scopes,\n",
    "            prompt=\"select_account\"\n",
    "        )\n",
    "        if \"access_token\" in result:\n",
    "            stage1_headers = {\"Authorization\": f\"Bearer {result['access_token']}\"}\n",
    "            s1_status.value = f'<span style=\"color:{APPLE_COLORS[\"green\"]};font-family:-apple-system;\">‚úÖ Authentication Successful</span>'\n",
    "            btn_download.disabled = False\n",
    "            btn_s1_refresh.disabled = False\n",
    "            s1_logger.info(\"Authentication successful\")\n",
    "        else:\n",
    "            error_msg = result.get('error_description', 'Unknown error')\n",
    "            s1_status.value = f'<span style=\"color:{APPLE_COLORS[\"red\"]};font-family:-apple-system;\">‚ùå Auth failed: {error_msg}</span>'\n",
    "            s1_logger.error(f\"Authentication failed: {error_msg}\")\n",
    "    except Exception as e:\n",
    "        s1_status.value = f'<span style=\"color:{APPLE_COLORS[\"red\"]};font-family:-apple-system;\">‚ùå Error: {str(e)}</span>'\n",
    "        s1_logger.error(f\"Login error: {str(e)}\", exc_info=True)\n",
    "    finally:\n",
    "        b.disabled = False\n",
    "\n",
    "# ========== DOWNLOAD AD USERS ==========\n",
    "def do_stage1_download(b):\n",
    "    global stage1_ad_data, stage1_file_path\n",
    "\n",
    "    # Check cache first\n",
    "    if s1_chk_use_cache.value:\n",
    "        cached_df, cached_path = load_latest_cache()\n",
    "        if cached_df is not None:\n",
    "            stage1_ad_data = cached_df\n",
    "            stage1_file_path = cached_path\n",
    "            s1_status.value = f'<span style=\"color:{APPLE_COLORS[\"green\"]};font-family:-apple-system;\">‚úÖ Loaded cache: {os.path.basename(cached_path)}</span>'\n",
    "            with s1_output:\n",
    "                clear_output()\n",
    "                print(f\"‚úÖ Loaded cached AD data ‚Üí {cached_path}\")\n",
    "                print(f\"   Rows: {len(cached_df)}\")\n",
    "            return\n",
    "\n",
    "    if not stage1_headers:\n",
    "        s1_status.value = f'<span style=\"color:{APPLE_COLORS[\"red\"]};font-family:-apple-system;\">‚ùå Please login first</span>'\n",
    "        return\n",
    "\n",
    "    b.disabled = True\n",
    "    btn_s1_refresh.disabled = True\n",
    "    s1_progress.layout.visibility = 'visible'\n",
    "    s1_progress.value = 0\n",
    "    s1_output.clear_output()\n",
    "\n",
    "    with s1_output:\n",
    "        print(\"üì• Downloading Active Directory Users...\")\n",
    "\n",
    "    try:\n",
    "        session = requests.Session()\n",
    "        s1_logger.info(\"Starting AD user download...\")\n",
    "\n",
    "        requested_signin = s1_chk_auditlog.value\n",
    "        params_base = {\n",
    "            \"$filter\": \"accountEnabled eq true\",\n",
    "            \"$select\": \"id,mail,displayName,department,accountEnabled,jobTitle\",\n",
    "            \"$expand\": \"manager($select=displayName,mail,jobTitle,department)\",\n",
    "            \"$top\": 999\n",
    "        }\n",
    "        params_with_signin = {\n",
    "            \"$filter\": \"accountEnabled eq true\",\n",
    "            \"$select\": \"id,mail,displayName,department,accountEnabled,jobTitle,signInActivity\",\n",
    "            \"$expand\": \"manager($select=displayName,mail,jobTitle,department)\",\n",
    "            \"$top\": 999\n",
    "        }\n",
    "\n",
    "        use_signin_activity = False\n",
    "        manager_available = False\n",
    "        s1_progress.value = 10\n",
    "\n",
    "        # Probe first page\n",
    "        if requested_signin:\n",
    "            response = session.get(USERS_URL, headers=stage1_headers, params=params_with_signin, timeout=30)\n",
    "        else:\n",
    "            response = session.get(USERS_URL, headers=stage1_headers, params=params_base, timeout=30)\n",
    "\n",
    "        if response.status_code == 200:\n",
    "            test_data = response.json()\n",
    "            if test_data.get('value'):\n",
    "                first_item = test_data['value'][0]\n",
    "                if requested_signin and 'signInActivity' in first_item:\n",
    "                    use_signin_activity = True\n",
    "                    s1_logger.info(\"‚úÖ signInActivity available\")\n",
    "                if 'manager' in first_item:\n",
    "                    manager_available = True\n",
    "                    s1_logger.info(\"‚úÖ Manager info available via $expand\")\n",
    "        else:\n",
    "            s1_logger.warning(f\"Initial query status {response.status_code}\")\n",
    "\n",
    "        params = params_with_signin if use_signin_activity else params_base\n",
    "\n",
    "        # Paginate\n",
    "        all_users = []\n",
    "        next_link = USERS_URL\n",
    "        page_count = 0\n",
    "        s1_progress.value = 20\n",
    "\n",
    "        while next_link:\n",
    "            if page_count == 0:\n",
    "                response = session.get(next_link, headers=stage1_headers, params=params, timeout=30)\n",
    "            else:\n",
    "                response = session.get(next_link, headers=stage1_headers, timeout=30)\n",
    "            if response.status_code != 200:\n",
    "                raise Exception(f\"API Error: {response.status_code} - {response.text}\")\n",
    "            data = response.json()\n",
    "            users = data.get('value', [])\n",
    "            all_users.extend(users)\n",
    "            page_count += 1\n",
    "            s1_progress.value = min(20 + (page_count * 15), 80)\n",
    "            next_link = data.get('@odata.nextLink')\n",
    "            if page_count > 10:\n",
    "                break\n",
    "\n",
    "        s1_logger.info(f\"Downloaded {len(all_users)} users from AD\")\n",
    "\n",
    "        # Fallback manager fetch if $expand didn't work\n",
    "        if not manager_available:\n",
    "            with s1_output:\n",
    "                print(\"‚ö†Ô∏è Manager $expand unavailable, fetching individually...\")\n",
    "            for i, user in enumerate(all_users):\n",
    "                uid = user.get('id')\n",
    "                if not uid:\n",
    "                    continue\n",
    "                mgr_resp = session.get(\n",
    "                    f\"{USERS_URL}/{uid}/manager\",\n",
    "                    headers=stage1_headers,\n",
    "                    params={\"$select\": \"displayName,mail,jobTitle,department\"},\n",
    "                    timeout=20\n",
    "                )\n",
    "                if mgr_resp.status_code == 200:\n",
    "                    user['manager'] = mgr_resp.json()\n",
    "                if i % 50 == 0:\n",
    "                    s1_progress.value = min(85, s1_progress.value + 1)\n",
    "\n",
    "        s1_progress.value = 85\n",
    "\n",
    "        # Process users\n",
    "        processed_users = []\n",
    "        for user in all_users:\n",
    "            email = (user.get('mail') or '').lower().strip()\n",
    "            if not email:\n",
    "                continue\n",
    "            user_data = {\n",
    "                'email': email,\n",
    "                'displayName': user.get('displayName', 'N/A'),\n",
    "                'department': user.get('department') or 'N/A',\n",
    "                'accountEnabled': user.get('accountEnabled', False),\n",
    "                'jobTitle': user.get('jobTitle') or 'N/A'\n",
    "            }\n",
    "            mgr = user.get('manager', {}) or {}\n",
    "            mgr_email = (mgr.get('mail') or '').lower().strip()\n",
    "            user_data['managerEmail'] = mgr_email if mgr_email else 'N/A'\n",
    "            user_data['managerName'] = mgr.get('displayName', 'N/A')\n",
    "            user_data['managerJobTitle'] = mgr.get('jobTitle', 'N/A')\n",
    "            user_data['managerDepartment'] = mgr.get('department', 'N/A')\n",
    "\n",
    "            if use_signin_activity and isinstance(user.get('signInActivity'), dict):\n",
    "                signin_data = user.get('signInActivity') or {}\n",
    "                last_signin = signin_data.get('lastSignInDateTime', '')\n",
    "                user_data['lastSignInDateTime'] = last_signin if last_signin else 'Never'\n",
    "                if last_signin and last_signin != 'Never':\n",
    "                    try:\n",
    "                        signin_date = datetime.fromisoformat(last_signin.replace('Z', '+00:00'))\n",
    "                        cutoff_date = datetime.now().astimezone() - timedelta(days=730)\n",
    "                        user_data['activeIn24Months'] = signin_date > cutoff_date\n",
    "                    except:\n",
    "                        user_data['activeIn24Months'] = 'Unknown'\n",
    "                else:\n",
    "                    user_data['activeIn24Months'] = False\n",
    "            else:\n",
    "                user_data['lastSignInDateTime'] = 'N/A'\n",
    "                user_data['activeIn24Months'] = 'N/A'\n",
    "\n",
    "            processed_users.append(user_data)\n",
    "\n",
    "        stage1_ad_data = pd.DataFrame(processed_users)\n",
    "        s1_progress.value = 95\n",
    "\n",
    "        # Save\n",
    "        timestamp = datetime.now().strftime('%Y%m%d_%H%M')\n",
    "        filename = f\"ad_users_{timestamp}.csv\"\n",
    "        stage1_file_path = os.path.join(AD_CACHE_DIR, filename)\n",
    "        stage1_ad_data.to_csv(stage1_file_path, index=False)\n",
    "\n",
    "        s1_progress.value = 100\n",
    "        s1_progress.bar_style = 'success'\n",
    "\n",
    "        total_users = len(stage1_ad_data)\n",
    "        active_users = stage1_ad_data['accountEnabled'].sum()\n",
    "        manager_known = (stage1_ad_data['managerEmail'] != 'N/A').sum()\n",
    "\n",
    "        with s1_output:\n",
    "            clear_output()\n",
    "            print(\"=\"*60)\n",
    "            print(\"üìä Download Complete\")\n",
    "            print(\"=\"*60)\n",
    "            print(f\"Total users:        {total_users}\")\n",
    "            print(f\"Active accounts:    {active_users}\")\n",
    "            if use_signin_activity:\n",
    "                active_24m = (stage1_ad_data['activeIn24Months'] == True).sum()\n",
    "                print(f\"Active in 24 months: {active_24m}\")\n",
    "            print(f\"Manager linked:     {manager_known}\")\n",
    "            print(f\"\\nSaved to: {stage1_file_path}\")\n",
    "            print(\"=\"*60)\n",
    "\n",
    "        s1_status.value = f'<span style=\"color:{APPLE_COLORS[\"green\"]};font-family:-apple-system;\">‚úÖ Downloaded {total_users} users ‚Üí {filename}</span>'\n",
    "        s1_logger.info(f\"Stage 1 complete: {total_users} users saved to {stage1_file_path}\")\n",
    "\n",
    "    except Exception as e:\n",
    "        with s1_output:\n",
    "            print(f\"\\n‚ùå Error: {str(e)}\")\n",
    "        s1_status.value = f'<span style=\"color:{APPLE_COLORS[\"red\"]};font-family:-apple-system;\">‚ùå Error: {str(e)}</span>'\n",
    "        s1_logger.error(f\"Download error: {str(e)}\", exc_info=True)\n",
    "    finally:\n",
    "        b.disabled = False\n",
    "        btn_s1_refresh.disabled = False\n",
    "        s1_progress.layout.visibility = 'hidden'\n",
    "\n",
    "# ========== BIND EVENTS ==========\n",
    "btn_login.on_click(do_stage1_login)\n",
    "btn_download.on_click(do_stage1_download)\n",
    "btn_s1_refresh.on_click(do_stage1_download)\n",
    "\n",
    "# ========== UI LAYOUT ==========\n",
    "stage1_ui = widgets.VBox([\n",
    "    widgets.HTML(get_header_html(\n",
    "        \"üîê Stage 1: AD Authentication & Download\",\n",
    "        \"Authenticate with Azure AD via MSAL and download active users\",\n",
    "        'blue_purple'\n",
    "    )),\n",
    "    widgets.HBox([btn_login, btn_download, btn_s1_refresh]),\n",
    "    s1_chk_auditlog,\n",
    "    s1_chk_use_cache,\n",
    "    s1_progress,\n",
    "    s1_status,\n",
    "    s1_output\n",
    "], layout=widgets.Layout(margin='0 0 32px 0'))\n",
    "\n",
    "clear_output()\n",
    "display(stage1_ui)\n",
    "s1_logger.info(\"Stage 1 UI initialized\")\n"
   ],
   "execution_count": null,
   "outputs": []
  },
  {
   "cell_type": "code",
   "metadata": {},
   "source": [
    "# === CELL 1.5: Org Tree Builder (v7.5 - Ultra Intuitive Tree View) ===\n",
    "import os, glob, logging, io, math\n",
    "import pandas as pd\n",
    "import ipywidgets as widgets\n",
    "from datetime import datetime\n",
    "from IPython.display import display, HTML, clear_output\n",
    "\n",
    "# Constants\n",
    "CORP_PREFIX = \"corporate\"\n",
    "MAX_TREE_LEVELS = 4  # Steven Bush = Level 1, then 3 more levels\n",
    "\n",
    "# Paths\n",
    "today_str = datetime.now().strftime('%Y-%m-%d')\n",
    "BASE_DIR = os.path.join(\"output\", today_str)\n",
    "AD_CACHE_DIR = os.path.join(BASE_DIR, \"ad_cache\")\n",
    "ORG_DIR = os.path.join(BASE_DIR, \"orgchart\")\n",
    "MAP_DIR = os.path.join(\"input\", \"mapping\")\n",
    "LOG_DIR = os.path.join(BASE_DIR, \"logs\")\n",
    "os.makedirs(ORG_DIR, exist_ok=True)\n",
    "os.makedirs(MAP_DIR, exist_ok=True)\n",
    "\n",
    "# Logging\n",
    "log_file = os.path.join(LOG_DIR, f\"aer_stage1_5_{datetime.now().strftime('%Y%m%d_%H%M')}.log\")\n",
    "logger_s15 = logging.getLogger(\"aer_stage1_5\")\n",
    "logger_s15.handlers.clear()\n",
    "logger_s15.setLevel(logging.INFO)\n",
    "formatter = logging.Formatter('%(asctime)s | %(levelname)s | %(message)s')\n",
    "fh = logging.FileHandler(log_file, encoding=\"utf-8\")\n",
    "fh.setFormatter(formatter)\n",
    "logger_s15.addHandler(fh)\n",
    "logger_s15.addHandler(logging.StreamHandler(sys.stdout))\n",
    "\n",
    "# ========== GLOBAL STATE ==========\n",
    "s15_ad_df = None\n",
    "s15_tree_html = widgets.HTML()\n",
    "s15_status = widgets.HTML(value=\"<i>Click Rebuild Tree to start</i>\")\n",
    "s15_output = widgets.Output()\n",
    "s15_is_building = False\n",
    "s15_dept_heads = {}\n",
    "s15_nodes = {}\n",
    "s15_children = {}\n",
    "s15_levels = {}\n",
    "\n",
    "# ========== EDITABLE MAPPING TABLE ==========\n",
    "s15_mapping_data = []\n",
    "mapping_container = widgets.VBox()\n",
    "btn_add_row = widgets.Button(\n",
    "    description='‚ûï Add Department',\n",
    "    button_style='info',\n",
    "    icon='plus',\n",
    "    layout=widgets.Layout(width='180px')\n",
    ")\n",
    "btn_save_mapping = widgets.Button(\n",
    "    description='üíæ Save Mapping',\n",
    "    button_style='success',\n",
    "    icon='save',\n",
    "    layout=widgets.Layout(width='180px')\n",
    ")\n",
    "btn_refresh = widgets.Button(\n",
    "    description='üîÑ Rebuild Tree',\n",
    "    button_style='primary',\n",
    "    icon='refresh',\n",
    "    layout=widgets.Layout(width='180px', height='40px')\n",
    ")\n",
    "\n",
    "# ========== HELPER FUNCTIONS ==========\n",
    "\n",
    "def normalize_department(dept):\n",
    "    if dept is None or (isinstance(dept, float) and math.isnan(dept)):\n",
    "        dept = ''\n",
    "    else:\n",
    "        dept = str(dept).strip()\n",
    "    if dept.lower().startswith('branch'):\n",
    "        return 'Branch'\n",
    "    return dept or 'N/A'\n",
    "\n",
    "def load_latest_ad():\n",
    "    try:\n",
    "        cache_files = glob.glob(os.path.join(AD_CACHE_DIR, \"ad_users_*.csv\"))\n",
    "        if not cache_files:\n",
    "            return None, \"No AD cache found. Run Stage 1 first.\"\n",
    "        latest = max(cache_files, key=os.path.getmtime)\n",
    "        df = pd.read_csv(latest)\n",
    "        df = df[df['department'].fillna('').str.lower().str.startswith(CORP_PREFIX)]\n",
    "        return df, f\"Loaded {len(df)} corporate users from {os.path.basename(latest)}\"\n",
    "    except Exception as e:\n",
    "        return None, f\"Error loading AD cache: {e}\"\n",
    "\n",
    "def find_root(df):\n",
    "    names = df['displayName'].str.lower().fillna('').str.strip()\n",
    "    mask_name = names.isin(['steven bush', 'steve bush'])\n",
    "    if mask_name.any():\n",
    "        return df.loc[mask_name, 'email'].iloc[0]\n",
    "    mask_title = df['jobTitle'].str.lower().fillna('').str.contains('chief executive|ceo|president')\n",
    "    if mask_title.any():\n",
    "        return df.loc[mask_title, 'email'].iloc[0]\n",
    "    mask_nomgr = df['managerEmail'].fillna('N/A') == 'N/A'\n",
    "    if mask_nomgr.any():\n",
    "        return df.loc[mask_nomgr, 'email'].iloc[0]\n",
    "    return df.iloc[0]['email'] if len(df) else None\n",
    "\n",
    "def build_org_structure(df, root_email):\n",
    "    df = df.copy()\n",
    "    df['managerEmail'] = df['managerEmail'].fillna('N/A')\n",
    "    nodes = {}\n",
    "    for idx, row in df.iterrows():\n",
    "        nodes[row['email']] = {\n",
    "            'email': row['email'],\n",
    "            'name': row['displayName'],\n",
    "            'title': row.get('jobTitle', 'N/A'),\n",
    "            'dept': normalize_department(row.get('department')),\n",
    "            'manager': row['managerEmail']\n",
    "        }\n",
    "    children = {}\n",
    "    for email, node in nodes.items():\n",
    "        mgr = node['manager']\n",
    "        if mgr == 'N/A' or mgr not in nodes:\n",
    "            if email != root_email:\n",
    "                children.setdefault(root_email, []).append(email)\n",
    "        else:\n",
    "            children.setdefault(mgr, []).append(email)\n",
    "    levels = {root_email: 1}\n",
    "    queue = [root_email]\n",
    "    while queue:\n",
    "        current = queue.pop(0)\n",
    "        current_level = levels[current]\n",
    "        if current_level >= MAX_TREE_LEVELS:\n",
    "            continue\n",
    "        for child in children.get(current, []):\n",
    "            if child not in levels:\n",
    "                levels[child] = current_level + 1\n",
    "                queue.append(child)\n",
    "    return nodes, children, levels\n",
    "\n",
    "def find_dept_heads(df, nodes, levels):\n",
    "    dept_heads = {}\n",
    "    for dept_name, grp in df.groupby(df['department'].apply(normalize_department)):\n",
    "        if dept_name == 'N/A':\n",
    "            continue\n",
    "        dept_people = []\n",
    "        for _, row in grp.iterrows():\n",
    "            email = row['email']\n",
    "            if email in levels:\n",
    "                dept_people.append({\n",
    "                    'email': email,\n",
    "                    'level': levels[email],\n",
    "                    'name': row['displayName'],\n",
    "                    'title': row.get('jobTitle', 'N/A')\n",
    "                })\n",
    "        if not dept_people:\n",
    "            continue\n",
    "        dept_people.sort(key=lambda x: x['level'])\n",
    "        head = dept_people[0]\n",
    "        head_email = head['email']\n",
    "        reviewer_email = nodes[head_email]['manager']\n",
    "        visited = set()\n",
    "        max_hops = 10\n",
    "        hops = 0\n",
    "        while reviewer_email in nodes and reviewer_email != 'N/A' and hops < max_hops:\n",
    "            if reviewer_email in visited:\n",
    "                break\n",
    "            visited.add(reviewer_email)\n",
    "            reviewer_node = nodes[reviewer_email]\n",
    "            if reviewer_node['dept'] != dept_name:\n",
    "                break\n",
    "            reviewer_email = reviewer_node['manager']\n",
    "            hops += 1\n",
    "        if reviewer_email == 'N/A' or reviewer_email not in nodes or hops >= max_hops:\n",
    "            reviewer_email = nodes[head_email]['manager']\n",
    "            if reviewer_email == 'N/A' or reviewer_email not in nodes:\n",
    "                reviewer_email = head_email\n",
    "        dept_heads[dept_name] = {\n",
    "            'head_email': head_email,\n",
    "            'head_name': head['name'],\n",
    "            'head_title': head['title'],\n",
    "            'head_level': head['level'],\n",
    "            'reviewer_email': reviewer_email,\n",
    "            'reviewer_name': nodes.get(reviewer_email, {}).get('name', 'N/A')\n",
    "        }\n",
    "    return dept_heads\n",
    "\n",
    "def render_ultra_intuitive_tree(root_email, nodes, children, levels, dept_heads, max_level=MAX_TREE_LEVELS, show_all=False):\n",
    "    dept_to_head = {info['head_email']: dept for dept, info in dept_heads.items()}\n",
    "    def render_node(email, current_level, parent_dept=None):\n",
    "        if current_level > max_level or email not in nodes:\n",
    "            return \"\"\n",
    "        node = nodes[email]\n",
    "        level_num = levels.get(email, 0)\n",
    "        is_dept_head = email in dept_to_head\n",
    "        dept_name = node['dept']\n",
    "        if is_dept_head:\n",
    "            dept_badge = f\"<span style='background:#FFF3CD;color:#000;padding:3px 8px;border-radius:4px;font-weight:700;border:2px solid #856404;'>üìå {dept_name}</span>\"\n",
    "            name_html = f\"<b style='font-size:1.1em;font-weight:700;'>{node['name']}</b>\"\n",
    "        else:\n",
    "            dept_badge = f\"<span style='background:#F8F9FA;color:#495057;padding:2px 6px;border-radius:3px;font-weight:500;'>{dept_name}</span>\"\n",
    "            name_html = f\"<b style='font-size:1.05em;'>{node['name']}</b>\"\n",
    "        level_badge = f\"<span style='background:#6C757D;color:white;padding:2px 6px;border-radius:3px;font-size:0.85em;'>L{level_num}</span>\"\n",
    "        title_html = f\"<span style='color:#666;font-style:italic;'>{node['title']}</span>\"\n",
    "        email_html = f\"<span style='color:#999;font-size:0.85em;' title='{email}'>üìß {email.split('@')[0]}</span>\"\n",
    "        label = f\"{name_html} {dept_badge} {level_badge}\"\n",
    "        sublabel = f\"{title_html} ‚Ä¢ {email_html}\"\n",
    "        kids = children.get(email, [])\n",
    "        kids_in_range = [k for k in kids if k in levels and levels[k] <= max_level]\n",
    "        if not kids_in_range:\n",
    "            if not show_all and not is_dept_head and current_level > 1:\n",
    "                return \"\"\n",
    "            return f\"<li style='padding:6px 0;'><div>{label}</div><div style='padding-left:20px;font-size:0.9em;'>{sublabel}</div></li>\"\n",
    "        kids_html = \"\".join([render_node(kid, current_level + 1, dept_name) for kid in kids_in_range])\n",
    "        is_open = \"open\" if dept_name != parent_dept else \"\"\n",
    "        return f\"\"\"<details {is_open}>\n",
    "            <summary style='cursor:pointer;padding:6px 0;'>\n",
    "                <div style='display:inline-block;margin-left:8px;'>{label}</div>\n",
    "                <div style='padding-left:28px;font-size:0.9em;'>{sublabel}</div>\n",
    "            </summary>\n",
    "            <ul style='list-style:none;padding-left:28px;border-left:2px solid #DEE2E6;margin:4px 0;'>\n",
    "                {kids_html}\n",
    "            </ul>\n",
    "        </details>\"\"\"\n",
    "    tree_html = f\"\"\"<div style='font-family:system-ui,-apple-system,sans-serif;font-size:0.95em;line-height:1.6;'>\n",
    "        <div style='background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:white;padding:16px;border-radius:8px 8px 0 0;'>\n",
    "            <h3 style='margin:0 0 8px 0;'>üå≥ Organization Hierarchy Tree ({MAX_TREE_LEVELS} Levels)</h3>\n",
    "            <p style='margin:0;opacity:0.9;font-size:0.9em;'>üìå Bold + Highlighted = Department Head ‚Ä¢ Click to expand/collapse</p>\n",
    "        </div>\n",
    "        <div style='padding:16px;background:white;border:1px solid #ddd;border-top:none;border-radius:0 0 8px 8px;max-height:700px;overflow:auto;'>\n",
    "            <ul style='list-style:none;padding-left:0;margin:0;'>{render_node(root_email, 1, None)}</ul>\n",
    "        </div>\n",
    "    </div>\"\"\"\n",
    "    return tree_html\n",
    "\n",
    "# ========== EDITABLE MAPPING TABLE ==========\n",
    "\n",
    "def render_editable_mapping():\n",
    "    global s15_mapping_data\n",
    "    if not s15_mapping_data:\n",
    "        mapping_container.children = [widgets.HTML(\"<i>No departments yet. Rebuild tree to populate.</i>\")]\n",
    "        return\n",
    "    rows = []\n",
    "    header = widgets.HTML(\"\"\"<div style='display:grid;grid-template-columns:200px 200px 200px 80px;gap:8px;padding:8px;background:#4CAF50;color:white;font-weight:bold;border-radius:4px 4px 0 0;'>\n",
    "        <div>Department</div><div>Department Head</div><div>Reviewer</div><div>Actions</div></div>\"\"\")\n",
    "    rows.append(header)\n",
    "    for idx, mapping in enumerate(s15_mapping_data):\n",
    "        dept_label = widgets.HTML(value=f\"<div style='padding:8px;'><b>{mapping['dept']}</b></div>\", layout=widgets.Layout(width='200px'))\n",
    "        head_input = widgets.Text(value=mapping['head_name'], placeholder='Head name', layout=widgets.Layout(width='200px'))\n",
    "        reviewer_input = widgets.Text(value=mapping['reviewer_name'], placeholder='Reviewer name', layout=widgets.Layout(width='200px'))\n",
    "        def on_change(change, idx=idx, field=''):\n",
    "            s15_mapping_data[idx][field] = change['new']\n",
    "        head_input.observe(lambda c, i=idx: on_change(c, i, 'head_name'), 'value')\n",
    "        reviewer_input.observe(lambda c, i=idx: on_change(c, i, 'reviewer_name'), 'value')\n",
    "        delete_btn = widgets.Button(description='üóëÔ∏è', button_style='danger', layout=widgets.Layout(width='60px'))\n",
    "        delete_btn.on_click(lambda b, i=idx: delete_mapping_row(i))\n",
    "        row = widgets.HBox([dept_label, head_input, reviewer_input, delete_btn], layout=widgets.Layout(padding='4px 8px', border_bottom='1px solid #eee'))\n",
    "        rows.append(row)\n",
    "    mapping_container.children = rows\n",
    "\n",
    "def delete_mapping_row(idx):\n",
    "    global s15_mapping_data\n",
    "    if 0 <= idx < len(s15_mapping_data):\n",
    "        del s15_mapping_data[idx]\n",
    "        render_editable_mapping()\n",
    "\n",
    "def add_mapping_row(_=None):\n",
    "    global s15_mapping_data\n",
    "    s15_mapping_data.append({'dept': 'New Department', 'head_name': '', 'head_email': '', 'reviewer_name': '', 'reviewer_email': ''})\n",
    "    render_editable_mapping()\n",
    "\n",
    "def save_mapping(_=None):\n",
    "    if not s15_mapping_data:\n",
    "        s15_status.value = \"<span style='color:red;'>‚ùå No mappings to save</span>\"\n",
    "        return\n",
    "    rows = []\n",
    "    for mapping in s15_mapping_data:\n",
    "        rows.append({'email': mapping.get('head_email', mapping['head_name']), 'department': mapping['dept'], 'reviewer': mapping.get('reviewer_email', mapping['reviewer_name']), 'branch': '' if mapping['dept'].lower().startswith('corporate') else 'Branch'})\n",
    "        rows.append({'email': '*', 'department': mapping['dept'], 'reviewer': mapping.get('head_email', mapping['head_name']), 'branch': '' if mapping['dept'].lower().startswith('corporate') else 'Branch'})\n",
    "    df = pd.DataFrame(rows)\n",
    "    ts = datetime.now().strftime('%Y%m%d_%H%M')\n",
    "    path = os.path.join(MAP_DIR, f\"org_mapping_{ts}.csv\")\n",
    "    df.to_csv(path, index=False)\n",
    "    s15_status.value = f\"<span style='color:green;'>üíæ Saved: {os.path.basename(path)}</span>\"\n",
    "    logger_s15.info(f\"Mapping saved to {path}\")\n",
    "\n",
    "# ========== REFRESH TREE ==========\n",
    "\n",
    "def refresh_tree(_=None):\n",
    "    global s15_ad_df, s15_is_building, s15_dept_heads, s15_nodes, s15_children, s15_levels, s15_mapping_data\n",
    "    if s15_is_building:\n",
    "        return\n",
    "    s15_is_building = True\n",
    "    btn_refresh.disabled = True\n",
    "    s15_output.clear_output()\n",
    "    try:\n",
    "        df, msg = load_latest_ad()\n",
    "        if df is None:\n",
    "            raise Exception(msg)\n",
    "        s15_ad_df = df\n",
    "        with s15_output:\n",
    "            print(f\"‚úì {msg}\")\n",
    "        root_email = find_root(df)\n",
    "        if not root_email:\n",
    "            raise Exception(\"Could not locate root (CEO)\")\n",
    "        root_name = df[df['email'] == root_email].iloc[0]['displayName']\n",
    "        with s15_output:\n",
    "            print(f\"‚úì CEO: {root_name} ({root_email})\")\n",
    "        s15_nodes, s15_children, s15_levels = build_org_structure(df, root_email)\n",
    "        s15_dept_heads = find_dept_heads(df, s15_nodes, s15_levels)\n",
    "        s15_mapping_data = []\n",
    "        for dept, info in s15_dept_heads.items():\n",
    "            s15_mapping_data.append({'dept': dept, 'head_name': info['head_name'], 'head_email': info['head_email'], 'reviewer_name': info['reviewer_name'], 'reviewer_email': info['reviewer_email']})\n",
    "        render_editable_mapping()\n",
    "        tree_html = render_ultra_intuitive_tree(root_email, s15_nodes, s15_children, s15_levels, s15_dept_heads)\n",
    "        s15_tree_html.value = tree_html\n",
    "        with s15_output:\n",
    "            print(f\"‚úÖ Tree built: {len(s15_nodes)} people ‚Ä¢ {len(s15_dept_heads)} departments\")\n",
    "        s15_status.value = f\"<span style='color:green;'>‚úÖ Tree ready: {len(s15_dept_heads)} depts</span>\"\n",
    "    except Exception as e:\n",
    "        with s15_output:\n",
    "            print(f\"‚ùå Error: {e}\")\n",
    "        s15_status.value = f\"<span style='color:red;'>‚ùå {e}</span>\"\n",
    "        logger_s15.error(f\"Error: {e}\", exc_info=True)\n",
    "    finally:\n",
    "        s15_is_building = False\n",
    "        btn_refresh.disabled = False\n",
    "\n",
    "# ========== EVENT BINDINGS ==========\n",
    "btn_add_row.on_click(add_mapping_row)\n",
    "btn_save_mapping.on_click(save_mapping)\n",
    "btn_refresh.on_click(refresh_tree)\n",
    "\n",
    "# ========== UI LAYOUT ==========\n",
    "stage15_ui = widgets.VBox([\n",
    "    widgets.HTML(get_header_html(\n",
    "        \"üå≥ Stage 1.5: Org Tree Builder\",\n",
    "        \"Toggle show/hide non-dept-heads ‚Ä¢ Bold dept head highlighting ‚Ä¢ Editable mapping\",\n",
    "        'green_blue'\n",
    "    )),\n",
    "    widgets.HBox([btn_refresh, s15_status], layout=widgets.Layout(margin='0 0 16px 0')),\n",
    "    s15_tree_html,\n",
    "    widgets.HTML(\"<div style='margin:24px 0 12px 0;'><h3>üìã Department Reviewer Mapping (Editable)</h3></div>\"),\n",
    "    mapping_container,\n",
    "    widgets.HBox([btn_add_row, btn_save_mapping], layout=widgets.Layout(margin='12px 0')),\n",
    "    s15_output\n",
    "])\n",
    "\n",
    "clear_output()\n",
    "display(stage15_ui)\n",
    "logger_s15.info(\"Stage 1.5 UI initialized\")\n",
    "print(\"\\n‚úÖ Stage 1.5 UI ready - Click 'üîÑ Rebuild Tree' to start\")\n"
   ],
   "execution_count": null,
   "outputs": []
  },
  {
   "cell_type": "code",
   "metadata": {},
   "source": [
    "# === CELL 3: Email/User Validation with Card-based Review UI (v7.5) ===\n",
    "import os, sys, logging, glob, io, re, unicodedata\n",
    "import pandas as pd\n",
    "import ipywidgets as widgets\n",
    "from datetime import datetime\n",
    "from IPython.display import display, HTML, clear_output\n",
    "\n",
    "try:\n",
    "    from rapidfuzz import fuzz, process\n",
    "    FUZZY_AVAILABLE = True\n",
    "except ImportError:\n",
    "    try:\n",
    "        from fuzzywuzzy import fuzz, process\n",
    "        FUZZY_AVAILABLE = True\n",
    "    except ImportError:\n",
    "        FUZZY_AVAILABLE = False\n",
    "        print(\"‚ùå Fuzzy matching unavailable. Install: pip install rapidfuzz\")\n",
    "\n",
    "# Paths\n",
    "today_str = datetime.now().strftime('%Y-%m-%d')\n",
    "BASE_DIR = os.path.join(\"output\", today_str)\n",
    "AD_CACHE_DIR = os.path.join(BASE_DIR, \"ad_cache\")\n",
    "STAGE2_DIR = os.path.join(BASE_DIR, \"stage2_validated\")\n",
    "LOG_DIR = os.path.join(BASE_DIR, \"logs\")\n",
    "os.makedirs(STAGE2_DIR, exist_ok=True)\n",
    "\n",
    "log_file = os.path.join(LOG_DIR, f\"aer_stage2_{datetime.now().strftime('%Y%m%d_%H%M')}.log\")\n",
    "logger_s2 = logging.getLogger(\"aer_stage2\")\n",
    "logger_s2.handlers.clear()\n",
    "logger_s2.setLevel(logging.INFO)\n",
    "formatter = logging.Formatter('%(asctime)s | %(levelname)s | %(message)s')\n",
    "fh = logging.FileHandler(log_file, encoding=\"utf-8\")\n",
    "fh.setFormatter(formatter)\n",
    "logger_s2.addHandler(fh)\n",
    "logger_s2.addHandler(logging.StreamHandler(sys.stdout))\n",
    "\n",
    "# ========== GLOBAL STATE ==========\n",
    "s2_ad_cache = {}\n",
    "s2_name_index = {}\n",
    "s2_input_df = None\n",
    "s2_input_filename = \"\"\n",
    "s2_validated_rows = []\n",
    "s2_review_rows = []\n",
    "s2_is_processing = False\n",
    "\n",
    "CATEGORIES = {\n",
    "    'PERFECT_MATCH': '‚úÖ Perfect Match',\n",
    "    'AUTO_FILLED_NAME': '‚úÖ Auto-filled Name',\n",
    "    'AUTO_FILLED_EMAIL': '‚úÖ Auto-filled Email',\n",
    "    'MISMATCH_EMAIL_PRIORITY': '‚ö†Ô∏è Mismatch (Email Priority)',\n",
    "    'AMBIGUOUS_NAME': '‚ö†Ô∏è Ambiguous Name Match',\n",
    "    'INACTIVE_ACCOUNT': '‚ö†Ô∏è Inactive Account',\n",
    "    'NOT_FOUND': '‚ùå Not Found in AD',\n",
    "    'INVALID_FORMAT': '‚ùå Invalid Email Format',\n",
    "    'BOTH_EMPTY': '‚ùå Both Empty (Skipped)'\n",
    "}\n",
    "\n",
    "# ========== UI COMPONENTS ==========\n",
    "s2_upload = widgets.FileUpload(accept='.xlsx, .csv', description=\"Upload User List\", button_style='info')\n",
    "s2_upload_status = widgets.HTML(value=\"<i>No file selected</i>\")\n",
    "s2_btn_validate = widgets.Button(description=\"üîç Validate Users\", button_style='warning', layout=widgets.Layout(width='180px'), disabled=True)\n",
    "s2_btn_save = widgets.Button(description=\"üíæ Save Validated File\", button_style='success', layout=widgets.Layout(width='180px'), disabled=True)\n",
    "s2_status = widgets.HTML(value=\"<i>Please load AD cache and upload user list</i>\")\n",
    "s2_output = widgets.Output()\n",
    "s2_review_container = widgets.VBox()\n",
    "\n",
    "# ========== HELPER FUNCTIONS ==========\n",
    "\n",
    "def normalize_email(email):\n",
    "    if pd.isna(email) or not email:\n",
    "        return None\n",
    "    email_str = str(email).strip().lower()\n",
    "    if email_str in ['nan', 'none', '', 'n/a', 'na', '-', 'null']:\n",
    "        return None\n",
    "    return email_str\n",
    "\n",
    "def is_valid_email_format(email):\n",
    "    if not email:\n",
    "        return False\n",
    "    pattern = r'^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\\.[a-zA-Z]{2,}$'\n",
    "    return re.match(pattern, email) is not None\n",
    "\n",
    "def normalize_name(name):\n",
    "    if pd.isna(name) or not name:\n",
    "        return None\n",
    "    name_str = str(name).strip()\n",
    "    if name_str.lower() in ['nan', 'none', '', 'n/a', 'na', '-', 'null']:\n",
    "        return None\n",
    "    name_str = unicodedata.normalize('NFKC', name_str)\n",
    "    name_str = re.sub(r'\\s+', ' ', name_str)\n",
    "    return name_str\n",
    "\n",
    "def normalize_name_for_index(name):\n",
    "    if not name:\n",
    "        return \"\"\n",
    "    name = str(name).lower()\n",
    "    name = unicodedata.normalize('NFKC', name)\n",
    "    name = re.sub(r'[^a-z0-9\\s]', ' ', name)\n",
    "    name = ' '.join(name.split())\n",
    "    return name.strip()\n",
    "\n",
    "def detect_columns(df, sample_size=20):\n",
    "    if len(df.columns) < 2:\n",
    "        return None, None, None, None\n",
    "    sample = df.head(sample_size)\n",
    "    email_scores = {}\n",
    "    for idx, col in enumerate(df.columns):\n",
    "        valid_count = 0\n",
    "        for val in sample[col]:\n",
    "            val_str = str(val).strip().lower()\n",
    "            if '@' in val_str and '.' in val_str:\n",
    "                valid_count += 1\n",
    "        email_scores[idx] = valid_count\n",
    "    if not email_scores or max(email_scores.values()) == 0:\n",
    "        return 0, 1, df.columns[0], df.columns[1]\n",
    "    email_col_idx = max(email_scores, key=email_scores.get)\n",
    "    email_col_name = df.columns[email_col_idx]\n",
    "    name_col_idx = None\n",
    "    name_col_name = None\n",
    "    for idx, col in enumerate(df.columns):\n",
    "        if idx != email_col_idx:\n",
    "            name_col_idx = idx\n",
    "            name_col_name = col\n",
    "            break\n",
    "    return email_col_idx, name_col_idx, email_col_name, name_col_name\n",
    "\n",
    "def load_ad_cache():\n",
    "    global s2_ad_cache, s2_name_index\n",
    "    try:\n",
    "        cache_files = glob.glob(os.path.join(AD_CACHE_DIR, \"ad_users_*.csv\"))\n",
    "        if not cache_files:\n",
    "            return False, \"No AD cache found. Please run Stage 1 first.\"\n",
    "        latest_cache = max(cache_files, key=os.path.getmtime)\n",
    "        df = pd.read_csv(latest_cache)\n",
    "        for _, row in df.iterrows():\n",
    "            email = normalize_email(row['email'])\n",
    "            if not email:\n",
    "                continue\n",
    "            s2_ad_cache[email] = {\n",
    "                'email': email, 'name': row['displayName'], 'dept': row['department'],\n",
    "                'active': row['accountEnabled'], 'jobTitle': row.get('jobTitle', 'N/A'),\n",
    "                'lastSignIn': row.get('lastSignInDateTime', 'N/A')\n",
    "            }\n",
    "            norm_name = normalize_name_for_index(row['displayName'])\n",
    "            if norm_name:\n",
    "                s2_name_index[norm_name] = email\n",
    "                parts = norm_name.split()\n",
    "                if len(parts) == 2:\n",
    "                    s2_name_index[f\"{parts[1]} {parts[0]}\"] = email\n",
    "        return True, f\"Loaded {len(s2_ad_cache)} users from {os.path.basename(latest_cache)}\"\n",
    "    except Exception as e:\n",
    "        return False, f\"Error loading AD cache: {str(e)}\"\n",
    "\n",
    "def fuzzy_match_name(target_name, top_n=5):\n",
    "    if not FUZZY_AVAILABLE or not s2_name_index or not target_name:\n",
    "        return []\n",
    "    norm_target = normalize_name_for_index(target_name)\n",
    "    if not norm_target:\n",
    "        return []\n",
    "    if norm_target in s2_name_index:\n",
    "        email = s2_name_index[norm_target]\n",
    "        user = s2_ad_cache[email]\n",
    "        return [{'email': email, 'name': user['name'], 'dept': user['dept'], 'score': 100, 'active': user['active']}]\n",
    "    try:\n",
    "        candidates = list(s2_name_index.keys())\n",
    "        matches = process.extract(norm_target, candidates, scorer=fuzz.token_sort_ratio, limit=top_n * 2)\n",
    "        results = []\n",
    "        seen = set()\n",
    "        for match_name, score, _ in matches:\n",
    "            if score < 70:\n",
    "                continue\n",
    "            email = s2_name_index[match_name]\n",
    "            if email in seen:\n",
    "                continue\n",
    "            seen.add(email)\n",
    "            user = s2_ad_cache[email]\n",
    "            results.append({'email': email, 'name': user['name'], 'dept': user['dept'], 'score': int(score), 'active': user['active']})\n",
    "            if len(results) >= top_n:\n",
    "                break\n",
    "        return results\n",
    "    except:\n",
    "        return []\n",
    "\n",
    "def validate_user(input_email, input_name):\n",
    "    email = normalize_email(input_email)\n",
    "    name = normalize_name(input_name)\n",
    "    result = {\n",
    "        'original_email': input_email, 'original_name': input_name,\n",
    "        'validated_email': None, 'validated_name': None,\n",
    "        'ad_status': None, 'validation_status': None, 'validation_notes': [],\n",
    "        'department': None, 'job_title': None,\n",
    "        'needs_review': False, 'review_options': []\n",
    "    }\n",
    "    if not email and not name:\n",
    "        result['validation_status'] = 'BOTH_EMPTY'\n",
    "        result['validation_notes'].append('Both email and name are empty')\n",
    "        return result, False\n",
    "    if email and not is_valid_email_format(email):\n",
    "        result['validation_status'] = 'INVALID_FORMAT'\n",
    "        result['validation_notes'].append(f'Invalid email format: {email}')\n",
    "        result['needs_review'] = True\n",
    "        return result, True\n",
    "    if email and not name:\n",
    "        if email in s2_ad_cache:\n",
    "            ad_user = s2_ad_cache[email]\n",
    "            result['validated_email'] = email\n",
    "            result['validated_name'] = ad_user['name']\n",
    "            result['ad_status'] = 'Active' if ad_user['active'] else 'Inactive'\n",
    "            result['department'] = ad_user['dept']\n",
    "            result['job_title'] = ad_user['jobTitle']\n",
    "            if not ad_user['active']:\n",
    "                result['validation_status'] = 'INACTIVE_ACCOUNT'\n",
    "                result['needs_review'] = True\n",
    "            else:\n",
    "                result['validation_status'] = 'AUTO_FILLED_NAME'\n",
    "            return result, result['needs_review']\n",
    "        else:\n",
    "            result['validation_status'] = 'NOT_FOUND'\n",
    "            result['needs_review'] = True\n",
    "            return result, True\n",
    "    if name and not email:\n",
    "        matches = fuzzy_match_name(name)\n",
    "        if not matches:\n",
    "            result['validation_status'] = 'NOT_FOUND'\n",
    "            result['validated_name'] = name\n",
    "            result['needs_review'] = True\n",
    "            return result, True\n",
    "        if len(matches) == 1:\n",
    "            match = matches[0]\n",
    "            result['validated_email'] = match['email']\n",
    "            result['validated_name'] = match['name']\n",
    "            result['ad_status'] = 'Active' if match['active'] else 'Inactive'\n",
    "            result['department'] = match['dept']\n",
    "            if not match['active']:\n",
    "                result['validation_status'] = 'INACTIVE_ACCOUNT'\n",
    "                result['needs_review'] = True\n",
    "            else:\n",
    "                result['validation_status'] = 'AUTO_FILLED_EMAIL'\n",
    "            return result, result['needs_review']\n",
    "        result['validation_status'] = 'AMBIGUOUS_NAME'\n",
    "        result['validated_name'] = name\n",
    "        result['needs_review'] = True\n",
    "        result['review_options'] = matches\n",
    "        return result, True\n",
    "    if email and name:\n",
    "        if email in s2_ad_cache:\n",
    "            ad_user = s2_ad_cache[email]\n",
    "            ad_name = normalize_name_for_index(ad_user['name'])\n",
    "            input_name_norm = normalize_name_for_index(name)\n",
    "            result['validated_email'] = email\n",
    "            result['validated_name'] = ad_user['name']\n",
    "            result['ad_status'] = 'Active' if ad_user['active'] else 'Inactive'\n",
    "            result['department'] = ad_user['dept']\n",
    "            result['job_title'] = ad_user['jobTitle']\n",
    "            if ad_name == input_name_norm:\n",
    "                if not ad_user['active']:\n",
    "                    result['validation_status'] = 'INACTIVE_ACCOUNT'\n",
    "                    result['needs_review'] = True\n",
    "                else:\n",
    "                    result['validation_status'] = 'PERFECT_MATCH'\n",
    "                return result, result['needs_review']\n",
    "            else:\n",
    "                result['validation_status'] = 'MISMATCH_EMAIL_PRIORITY'\n",
    "                result['validation_notes'].append(f\"Name mismatch: '{name}' vs AD '{ad_user['name']}'\")\n",
    "                result['needs_review'] = True\n",
    "                return result, True\n",
    "        else:\n",
    "            result['validation_status'] = 'NOT_FOUND'\n",
    "            result['validated_name'] = name\n",
    "            result['needs_review'] = True\n",
    "            return result, True\n",
    "    return result, False\n",
    "\n",
    "# ========== FILE UPLOAD HANDLER ==========\n",
    "def on_s2_upload_change(change):\n",
    "    if s2_upload.value and len(s2_upload.value) > 0:\n",
    "        fname = s2_upload.value[0]['name']\n",
    "        s2_upload_status.value = f\"<b style='color:green;'>‚úÖ Selected: {fname}</b>\"\n",
    "        if s2_ad_cache:\n",
    "            s2_btn_validate.disabled = False\n",
    "s2_upload.observe(on_s2_upload_change, 'value')\n",
    "\n",
    "# ========== VALIDATION FUNCTION ==========\n",
    "def do_stage2_validate(b):\n",
    "    global s2_input_df, s2_input_filename, s2_validated_rows, s2_review_rows, s2_is_processing\n",
    "    if s2_is_processing:\n",
    "        return\n",
    "    s2_is_processing = True\n",
    "    b.disabled = True\n",
    "    s2_output.clear_output()\n",
    "    s2_validated_rows = []\n",
    "    s2_review_rows = []\n",
    "    if not s2_upload.value:\n",
    "        with s2_output:\n",
    "            print(\"‚ùå Please upload a user list file\")\n",
    "        s2_is_processing = False\n",
    "        b.disabled = False\n",
    "        return\n",
    "    try:\n",
    "        f_item = s2_upload.value[0]\n",
    "        s2_input_filename = f_item['name']\n",
    "        if s2_input_filename.endswith('.csv'):\n",
    "            s2_input_df = pd.read_csv(io.BytesIO(f_item['content']))\n",
    "        else:\n",
    "            s2_input_df = pd.read_excel(io.BytesIO(f_item['content']))\n",
    "        email_idx, name_idx, email_col, name_col = detect_columns(s2_input_df)\n",
    "        if email_idx is None or name_idx is None:\n",
    "            raise Exception(\"Could not detect email and name columns\")\n",
    "        with s2_output:\n",
    "            print(f\"üìÑ Loaded: {s2_input_filename} ({len(s2_input_df)} rows)\")\n",
    "            print(f\"üìã Email: '{email_col}', Name: '{name_col}'\")\n",
    "        stats = {cat: 0 for cat in CATEGORIES.keys()}\n",
    "        for idx, row in s2_input_df.iterrows():\n",
    "            validated, needs_review = validate_user(row[email_col], row[name_col])\n",
    "            for col in s2_input_df.columns:\n",
    "                if col not in [email_col, name_col]:\n",
    "                    validated[col] = row[col]\n",
    "            if validated['validation_status'] != 'BOTH_EMPTY':\n",
    "                s2_validated_rows.append(validated)\n",
    "                stats[validated['validation_status']] += 1\n",
    "                if needs_review:\n",
    "                    s2_review_rows.append(validated)\n",
    "        with s2_output:\n",
    "            print(\"\\n\" + \"=\"*50)\n",
    "            for cat, count in stats.items():\n",
    "                if count > 0:\n",
    "                    print(f\"{CATEGORIES[cat]:40} {count:>5}\")\n",
    "            print(f\"\\nTotal: {len(s2_validated_rows)} | Need review: {len(s2_review_rows)}\")\n",
    "            print(\"=\"*50)\n",
    "        if s2_review_rows:\n",
    "            s2_review_container.children = [widgets.HTML(f\"<div style='padding:16px;background:#FFF3CD;border-radius:8px;margin:8px 0;'>‚ö†Ô∏è {len(s2_review_rows)} items need manual review (see log for details)</div>\")]\n",
    "        else:\n",
    "            s2_review_container.children = [widgets.HTML(\"<h3 style='color:green;'>‚úÖ All users validated!</h3>\")]\n",
    "        s2_btn_save.disabled = False\n",
    "        s2_status.value = f\"<span style='color:green;'>‚úÖ Validation complete: {len(s2_validated_rows)} users</span>\"\n",
    "    except Exception as e:\n",
    "        with s2_output:\n",
    "            print(f\"‚ùå Error: {str(e)}\")\n",
    "        s2_status.value = f\"<span style='color:red;'>‚ùå Error: {str(e)}</span>\"\n",
    "    finally:\n",
    "        s2_is_processing = False\n",
    "        b.disabled = False\n",
    "\n",
    "# ========== SAVE FUNCTION ==========\n",
    "def do_stage2_save(b):\n",
    "    if not s2_validated_rows:\n",
    "        return\n",
    "    b.disabled = True\n",
    "    try:\n",
    "        final_rows = [r for r in s2_validated_rows if r.get('action') != 'skip']\n",
    "        df_output = pd.DataFrame(final_rows)\n",
    "        priority_cols = ['original_email', 'original_name', 'validated_email', 'validated_name', 'ad_status', 'validation_status', 'validation_notes', 'department', 'job_title']\n",
    "        other_cols = [c for c in df_output.columns if c not in priority_cols + ['needs_review', 'review_options', 'action']]\n",
    "        final_cols = [c for c in priority_cols if c in df_output.columns] + other_cols\n",
    "        df_output = df_output[final_cols]\n",
    "        if 'validation_notes' in df_output.columns:\n",
    "            df_output['validation_notes'] = df_output['validation_notes'].apply(lambda x: '; '.join(x) if isinstance(x, list) else x)\n",
    "        base_name = s2_input_filename.replace('.csv', '').replace('.xlsx', '')\n",
    "        date_str = datetime.now().strftime('%Y%m%d')\n",
    "        output_filename = f\"{base_name}_User_Listing_{date_str}_AD_verified.xlsx\"\n",
    "        output_path = os.path.join(STAGE2_DIR, output_filename)\n",
    "        df_output.to_excel(output_path, index=False, sheet_name='Validated Users')\n",
    "        with s2_output:\n",
    "            print(f\"\\nüíæ Saved: {output_path} ({len(df_output)} rows)\")\n",
    "        s2_status.value = f\"<span style='color:blue;'>‚úÖ Saved: {output_filename}</span>\"\n",
    "    except Exception as e:\n",
    "        with s2_output:\n",
    "            print(f\"‚ùå Save error: {str(e)}\")\n",
    "    finally:\n",
    "        b.disabled = False\n",
    "\n",
    "s2_btn_validate.on_click(do_stage2_validate)\n",
    "s2_btn_save.on_click(do_stage2_save)\n",
    "\n",
    "# Auto-load AD cache\n",
    "success, msg = load_ad_cache()\n",
    "if success:\n",
    "    s2_status.value = f\"<span style='color:green;'>‚úÖ {msg}</span>\"\n",
    "else:\n",
    "    s2_status.value = f\"<span style='color:orange;'>‚ö†Ô∏è {msg}</span>\"\n",
    "\n",
    "# UI Layout\n",
    "stage2_ui = widgets.VBox([\n",
    "    widgets.HTML(get_header_html(\n",
    "        \"üîç Stage 2: Email/User Validation\",\n",
    "        \"Auto-detect columns ‚Ä¢ Card-based review ‚Ä¢ Edge case handling\",\n",
    "        'pink_red'\n",
    "    )),\n",
    "    widgets.HBox([s2_upload, s2_upload_status]),\n",
    "    widgets.HBox([s2_btn_validate, s2_btn_save]),\n",
    "    s2_status,\n",
    "    s2_review_container,\n",
    "    s2_output\n",
    "])\n",
    "\n",
    "clear_output()\n",
    "display(stage2_ui)\n",
    "logger_s2.info(\"Stage 2 UI initialized\")\n"
   ],
   "execution_count": null,
   "outputs": []
  },
  {
   "cell_type": "code",
   "metadata": {},
   "source": [
    "# ========================================================================\n",
    "# CELL 5: Stage 3 - Reviewer Assignment & Final Review Spreadsheet\n",
    "#          (v7.0 openpyxl + Action Dropdown + v7.5 Apple UI)\n",
    "# ========================================================================\n",
    "\n",
    "import os, sys, logging, glob, io\n",
    "import pandas as pd\n",
    "import ipywidgets as widgets\n",
    "from datetime import datetime\n",
    "from openpyxl import load_workbook\n",
    "from openpyxl.worksheet.datavalidation import DataValidation\n",
    "from openpyxl.utils import get_column_letter\n",
    "from IPython.display import display, HTML, clear_output\n",
    "\n",
    "# Paths\n",
    "STAGE2_DIR = os.path.join(BASE_DIR, \"stage2_validated\")\n",
    "STAGE3_DIR = os.path.join(BASE_DIR, \"stage3_review\")\n",
    "MAPPING_DIR = os.path.join(\"input\", \"mapping\")\n",
    "os.makedirs(STAGE3_DIR, exist_ok=True)\n",
    "os.makedirs(MAPPING_DIR, exist_ok=True)\n",
    "\n",
    "# Logger\n",
    "s3_logger = setup_logger(\"stage3\", os.path.join(LOG_DIR, f\"stage3_{datetime.now().strftime('%Y%m%d_%H%M')}.log\"))\n",
    "\n",
    "# ========== GLOBAL STATE ==========\n",
    "stage3_input_df = None\n",
    "stage3_input_filename = \"\"\n",
    "stage3_is_validated_file = False\n",
    "stage3_mapping_data = {\"emails\": {}, \"depts\": {}}\n",
    "stage3_auto_assigned = []\n",
    "stage3_manual_review = []\n",
    "stage3_final_df = None\n",
    "s3_is_processing = False\n",
    "\n",
    "# ========== UI COMPONENTS (Apple Style) ==========\n",
    "\n",
    "s3_file_status = widgets.HTML(\"<i>No file loaded</i>\")\n",
    "s3_mapping_status = widgets.HTML(\"<i>No mapping loaded</i>\")\n",
    "s3_status = widgets.HTML(\"<i>Ready to assign reviewers</i>\")\n",
    "s3_output = widgets.Output()\n",
    "s3_review_container = widgets.VBox()\n",
    "s3_progress = widgets.IntProgress(\n",
    "    value=0, min=0, max=100,\n",
    "    description='Progress:',\n",
    "    bar_style='info',\n",
    "    layout=widgets.Layout(width='100%', visibility='hidden')\n",
    ")\n",
    "\n",
    "# File uploads\n",
    "s3_upload_users = widgets.FileUpload(accept='.xlsx, .csv', description=\"Upload Validated\", button_style='info', layout=widgets.Layout(width='200px'))\n",
    "s3_upload_mapping = widgets.FileUpload(accept='.csv', description=\"Upload Mapping\", button_style='info', layout=widgets.Layout(width='200px'))\n",
    "\n",
    "btn_s3_assign = widgets.Button(description=\"‚öôÔ∏è Assign Reviewers\", button_style='', layout=get_button_layout(width='200px'), disabled=True)\n",
    "btn_s3_assign.style.button_color = APPLE_COLORS['blue']\n",
    "\n",
    "btn_s3_save = widgets.Button(description=\"üíæ Save Final Review\", button_style='', layout=get_button_layout(width='200px'), disabled=True)\n",
    "btn_s3_save.style.button_color = APPLE_COLORS['green']\n",
    "\n",
    "# ========== AUTO-LOAD FILES ==========\n",
    "\n",
    "def auto_load_files():\n",
    "    global stage3_input_df, stage3_input_filename, stage3_is_validated_file, stage3_mapping_data\n",
    "    s3_logger.info(\"Attempting to auto-load files...\")\n",
    "\n",
    "    # Load validated users from Stage 2\n",
    "    latest_users = get_latest_file(STAGE2_DIR, '*.xlsx')\n",
    "    if latest_users:\n",
    "        try:\n",
    "            stage3_input_df = pd.read_excel(latest_users)\n",
    "            stage3_input_filename = os.path.basename(latest_users)\n",
    "            required_cols = ['validated_email', 'validated_name', 'ad_status']\n",
    "            stage3_is_validated_file = all(col in stage3_input_df.columns for col in required_cols)\n",
    "            s3_file_status.value = f'<span style=\"color:{APPLE_COLORS[\"green\"]};font-family:-apple-system;\">‚úÖ Auto-loaded: {stage3_input_filename} ({len(stage3_input_df)} users)</span>'\n",
    "            s3_logger.info(f\"Auto-loaded users: {latest_users}\")\n",
    "        except Exception as e:\n",
    "            s3_file_status.value = f'<span style=\"color:{APPLE_COLORS[\"red\"]};\">\\'‚ùå Error: {str(e)}</span>'\n",
    "    else:\n",
    "        s3_file_status.value = f'<span style=\"color:{APPLE_COLORS[\"orange\"]};\">\\'‚ö†Ô∏è No files in {STAGE2_DIR}. Upload manually.</span>'\n",
    "\n",
    "    # Load mapping (priority: dept-mapping, then org_mapping)\n",
    "    latest_mapping = get_latest_file(MAPPING_DIR, '*.csv', prefix_priority='dept-mapping')\n",
    "    if not latest_mapping:\n",
    "        latest_mapping = get_latest_file(MAPPING_DIR, '*.csv', prefix_priority='org_mapping')\n",
    "    if not latest_mapping:\n",
    "        latest_mapping = get_latest_file(MAPPING_DIR, '*.csv')\n",
    "\n",
    "    if latest_mapping:\n",
    "        try:\n",
    "            load_mapping_file(latest_mapping)\n",
    "            s3_mapping_status.value = f'<span style=\"color:{APPLE_COLORS[\"green\"]};font-family:-apple-system;\">‚úÖ Auto-loaded: {os.path.basename(latest_mapping)}</span>'\n",
    "        except Exception as e:\n",
    "            s3_mapping_status.value = f'<span style=\"color:{APPLE_COLORS[\"red\"]};\">\\'‚ùå Error: {str(e)}</span>'\n",
    "    else:\n",
    "        s3_mapping_status.value = f'<span style=\"color:{APPLE_COLORS[\"orange\"]};\">\\'‚ö†Ô∏è No mapping file found.</span>'\n",
    "\n",
    "    if stage3_input_df is not None and (stage3_mapping_data['emails'] or stage3_mapping_data['depts']):\n",
    "        btn_s3_assign.disabled = False\n",
    "        s3_status.value = f'<span style=\"color:{APPLE_COLORS[\"blue\"]};font-family:-apple-system;\">‚úÖ Ready to assign reviewers</span>'\n",
    "\n",
    "def detect_map_column(df, candidates):\n",
    "    cols = [str(c).lower().strip() for c in df.columns]\n",
    "    for cand in candidates:\n",
    "        for i, c in enumerate(cols):\n",
    "            if cand in c:\n",
    "                return df.columns[i]\n",
    "    return None\n",
    "\n",
    "def load_mapping_file(path_or_buffer):\n",
    "    global stage3_mapping_data\n",
    "    df_map = pd.read_csv(path_or_buffer)\n",
    "    col_map_email = detect_map_column(df_map, [\"email\", \"mail\"])\n",
    "    col_map_dept = detect_map_column(df_map, [\"department\", \"dept\"])\n",
    "    col_map_reviewer = detect_map_column(df_map, [\"reviewer\", \"owner\", \"manager\"])\n",
    "    if not col_map_dept or not col_map_reviewer:\n",
    "        raise Exception(f\"Mapping file must have 'Department' and 'Reviewer' columns. Found: {list(df_map.columns)}\")\n",
    "    if col_map_email:\n",
    "        stage3_mapping_data['emails'] = dict(zip(\n",
    "            df_map[col_map_email].astype(str).str.lower().str.strip(),\n",
    "            df_map[col_map_reviewer]\n",
    "        ))\n",
    "    stage3_mapping_data['depts'] = dict(zip(\n",
    "        df_map[col_map_dept].astype(str).str.lower().str.strip(),\n",
    "        df_map[col_map_reviewer]\n",
    "    ))\n",
    "    s3_logger.info(f\"Mapping: {len(stage3_mapping_data['emails'])} emails, {len(stage3_mapping_data['depts'])} depts\")\n",
    "\n",
    "# ========== FILE UPLOAD HANDLERS ==========\n",
    "\n",
    "def on_users_upload(change):\n",
    "    global stage3_input_df, stage3_input_filename, stage3_is_validated_file\n",
    "    if s3_upload_users.value and len(s3_upload_users.value) > 0:\n",
    "        try:\n",
    "            file_item = s3_upload_users.value[0]\n",
    "            stage3_input_filename = file_item['name']\n",
    "            if stage3_input_filename.endswith('.csv'):\n",
    "                stage3_input_df = pd.read_csv(io.BytesIO(file_item['content']))\n",
    "            else:\n",
    "                stage3_input_df = pd.read_excel(io.BytesIO(file_item['content']))\n",
    "            required_cols = ['validated_email', 'validated_name', 'ad_status']\n",
    "            stage3_is_validated_file = all(col in stage3_input_df.columns for col in required_cols)\n",
    "            s3_file_status.value = f'<span style=\"color:{APPLE_COLORS[\"green\"]};\">\\'‚úÖ Uploaded: {stage3_input_filename} ({len(stage3_input_df)} users)</span>'\n",
    "            if stage3_mapping_data['emails'] or stage3_mapping_data['depts']:\n",
    "                btn_s3_assign.disabled = False\n",
    "        except Exception as e:\n",
    "            s3_file_status.value = f'<span style=\"color:{APPLE_COLORS[\"red\"]};\">\\'‚ùå Error: {str(e)}</span>'\n",
    "\n",
    "def on_mapping_upload(change):\n",
    "    if s3_upload_mapping.value and len(s3_upload_mapping.value) > 0:\n",
    "        try:\n",
    "            file_item = s3_upload_mapping.value[0]\n",
    "            load_mapping_file(io.BytesIO(file_item['content']))\n",
    "            s3_mapping_status.value = f'<span style=\"color:{APPLE_COLORS[\"green\"]};\">\\'‚úÖ Uploaded: {file_item[\"name\"]}</span>'\n",
    "            if stage3_input_df is not None:\n",
    "                btn_s3_assign.disabled = False\n",
    "        except Exception as e:\n",
    "            s3_mapping_status.value = f'<span style=\"color:{APPLE_COLORS[\"red\"]};\">\\'‚ùå Error: {str(e)}</span>'\n",
    "\n",
    "s3_upload_users.observe(on_users_upload, 'value')\n",
    "s3_upload_mapping.observe(on_mapping_upload, 'value')\n",
    "\n",
    "# ========== REVIEWER ASSIGNMENT (v7.0 Logic) ==========\n",
    "\n",
    "def do_assign_reviewers(b):\n",
    "    global stage3_auto_assigned, stage3_manual_review, s3_is_processing\n",
    "    if s3_is_processing:\n",
    "        return\n",
    "    s3_is_processing = True\n",
    "    b.disabled = True\n",
    "    s3_progress.layout.visibility = 'visible'\n",
    "    s3_progress.value = 0\n",
    "    s3_output.clear_output()\n",
    "    stage3_auto_assigned = []\n",
    "    stage3_manual_review = []\n",
    "\n",
    "    try:\n",
    "        with s3_output:\n",
    "            print(\"‚öôÔ∏è Assigning reviewers...\")\n",
    "        s3_logger.info(f\"Starting reviewer assignment for {len(stage3_input_df)} users\")\n",
    "\n",
    "        stats = {'email_manual': 0, 'dept_auto': 0, 'no_match_manual': 0}\n",
    "        total = len(stage3_input_df)\n",
    "\n",
    "        for idx, row in stage3_input_df.iterrows():\n",
    "            # Detect columns based on file type\n",
    "            if stage3_is_validated_file:\n",
    "                user_email = str(row.get('validated_email', row.get('original_email', ''))).strip().lower()\n",
    "                user_name = str(row.get('validated_name', row.get('original_name', ''))).strip()\n",
    "                raw_dept = row.get('department', '')\n",
    "                user_dept = '' if raw_dept is None or pd.isna(raw_dept) else str(raw_dept).strip()\n",
    "                ad_status = row.get('ad_status', 'Unknown')\n",
    "            else:\n",
    "                # Legacy: try Email/User Name or first two columns\n",
    "                user_email = str(row.get('Email', row.iloc[0] if len(row) > 0 else '')).strip().lower()\n",
    "                user_name = str(row.get('User Name', row.iloc[1] if len(row) > 1 else 'N/A')).strip()\n",
    "                user_dept = str(row.get('Department', '')).strip()\n",
    "                ad_status = row.get('AD Status', 'Unknown')\n",
    "\n",
    "            reviewer = None\n",
    "            assignment_type = None\n",
    "\n",
    "            # 1. Email mapping ‚Üí MANUAL review with pre-fill (v7.0 logic)\n",
    "            if user_email in stage3_mapping_data['emails']:\n",
    "                reviewer = stage3_mapping_data['emails'][user_email]\n",
    "                assignment_type = 'email_manual'\n",
    "                stats['email_manual'] += 1\n",
    "                stage3_manual_review.append({\n",
    "                    'index': idx, 'email': user_email, 'name': user_name,\n",
    "                    'dept': user_dept, 'ad_status': ad_status,\n",
    "                    'suggested_reviewer': reviewer,\n",
    "                    'assignment_type': 'email_match',\n",
    "                    'requires_approval': True\n",
    "                })\n",
    "\n",
    "            # 2. Department mapping ‚Üí Auto-assign\n",
    "            elif user_dept and user_dept != 'N/A':\n",
    "                dept_key = str(user_dept).split(\" - \")[-1].strip().lower() if user_dept else ''\n",
    "                if dept_key.startswith('branch'):\n",
    "                    dept_key = \"branch\"\n",
    "                # Try full dept name first, then sub-dept\n",
    "                full_dept_key = str(user_dept).strip().lower()\n",
    "                matched_reviewer = None\n",
    "                if full_dept_key in stage3_mapping_data['depts']:\n",
    "                    matched_reviewer = stage3_mapping_data['depts'][full_dept_key]\n",
    "                elif dept_key in stage3_mapping_data['depts']:\n",
    "                    matched_reviewer = stage3_mapping_data['depts'][dept_key]\n",
    "                # Also try wildcard '*' entries\n",
    "                elif '*' in stage3_mapping_data['emails']:\n",
    "                    matched_reviewer = stage3_mapping_data['emails']['*']\n",
    "\n",
    "                if matched_reviewer:\n",
    "                    reviewer = matched_reviewer\n",
    "                    assignment_type = 'dept_auto'\n",
    "                    stats['dept_auto'] += 1\n",
    "                    stage3_auto_assigned.append({\n",
    "                        'index': idx, 'email': user_email, 'name': user_name,\n",
    "                        'dept': user_dept, 'ad_status': ad_status,\n",
    "                        'reviewer': reviewer, 'assignment_type': 'dept_match'\n",
    "                    })\n",
    "                else:\n",
    "                    stats['no_match_manual'] += 1\n",
    "                    stage3_manual_review.append({\n",
    "                        'index': idx, 'email': user_email, 'name': user_name,\n",
    "                        'dept': user_dept, 'ad_status': ad_status,\n",
    "                        'suggested_reviewer': None,\n",
    "                        'assignment_type': 'no_match',\n",
    "                        'requires_approval': True\n",
    "                    })\n",
    "            else:\n",
    "                stats['no_match_manual'] += 1\n",
    "                stage3_manual_review.append({\n",
    "                    'index': idx, 'email': user_email, 'name': user_name,\n",
    "                    'dept': user_dept, 'ad_status': ad_status,\n",
    "                    'suggested_reviewer': None,\n",
    "                    'assignment_type': 'no_match',\n",
    "                    'requires_approval': True\n",
    "                })\n",
    "\n",
    "            s3_progress.value = int((idx + 1) / total * 100)\n",
    "\n",
    "        # Display summary\n",
    "        with s3_output:\n",
    "            clear_output()\n",
    "            print(\"=\"*60)\n",
    "            print(\"üìä Assignment Summary\")\n",
    "            print(\"=\"*60)\n",
    "            print(f\"üîó Email Match (Manual Review):  {stats['email_manual']}\")\n",
    "            print(f\"‚úÖ Dept Match (Auto-Assigned):   {stats['dept_auto']}\")\n",
    "            print(f\"‚ö†Ô∏è  No Match (Manual Review):     {stats['no_match_manual']}\")\n",
    "            print(f\"Total:                           {len(stage3_input_df)}\")\n",
    "            print(\"=\"*60)\n",
    "\n",
    "        # Render review UI\n",
    "        if stage3_manual_review:\n",
    "            render_s3_review_ui()\n",
    "        else:\n",
    "            s3_review_container.children = [\n",
    "                widgets.HTML(f'<div style=\"color:{APPLE_COLORS[\"green\"]};font-family:-apple-system;padding:16px;\"><h3>‚úÖ All users assigned automatically!</h3></div>')\n",
    "            ]\n",
    "\n",
    "        btn_s3_save.disabled = False\n",
    "        s3_status.value = f'<span style=\"color:{APPLE_COLORS[\"green\"]};font-family:-apple-system;\">‚úÖ Assignment complete</span>'\n",
    "\n",
    "    except Exception as e:\n",
    "        with s3_output:\n",
    "            print(f\"‚ùå Error: {str(e)}\")\n",
    "        s3_logger.error(f\"Assignment error: {str(e)}\", exc_info=True)\n",
    "    finally:\n",
    "        s3_is_processing = False\n",
    "        b.disabled = False\n",
    "        s3_progress.layout.visibility = 'hidden'\n",
    "\n",
    "btn_s3_assign.on_click(do_assign_reviewers)\n",
    "\n",
    "# ========== REVIEW UI (Apple-style cards) ==========\n",
    "\n",
    "def render_s3_review_ui():\n",
    "    groups = {}\n",
    "    for item in stage3_manual_review:\n",
    "        atype = item['assignment_type']\n",
    "        groups.setdefault(atype, []).append(item)\n",
    "    cards = []\n",
    "    status_labels = {\n",
    "        'email_match': ('üîó Email Match (Pre-filled, needs approval)', APPLE_COLORS['blue']),\n",
    "        'no_match': ('‚ö†Ô∏è No Mapping Found', APPLE_COLORS['orange'])\n",
    "    }\n",
    "    cards.append(widgets.HTML(f\"\"\"<div style='background:{APPLE_COLORS[\"orange\"]};color:white;padding:16px;border-radius:8px;margin:16px 0;font-family:-apple-system;'>\n",
    "        <h3 style='margin:0 0 8px 0;'>‚ö†Ô∏è Manual Review ({len(stage3_manual_review)} items)</h3>\n",
    "        <p style='margin:0;opacity:0.9;'>Email matches have pre-filled reviewers. Review before saving.</p></div>\"\"\"))\n",
    "    for atype, items in groups.items():\n",
    "        label, color = status_labels.get(atype, (atype, APPLE_COLORS['blue']))\n",
    "        header = widgets.HTML(f'<div style=\"background:{color};color:white;padding:12px 24px;border-radius:12px 12px 0 0;font-family:-apple-system;font-size:16px;font-weight:600;\">{label} ({len(items)} items)</div>')\n",
    "        row_widgets = []\n",
    "        for item in items:\n",
    "            suggestion = item.get('suggested_reviewer', '')\n",
    "            badge = 'üîó EMAIL MATCH' if item['assignment_type'] == 'email_match' else '‚ö†Ô∏è NO MATCH'\n",
    "            row_html = widgets.HTML(f\"\"\"<div style='padding:12px;border-bottom:1px solid #E5E5EA;font-family:-apple-system;'>\n",
    "                <span style='background:{color};color:white;padding:2px 8px;border-radius:3px;font-size:11px;'>{badge}</span><br>\n",
    "                <b>{item['name']}</b> ({item['email']})<br>\n",
    "                <span style='color:#86868B;'>Department: {item['dept']} ‚Ä¢ AD: {item['ad_status']}</span><br>\n",
    "                <span style='color:#666;'>{'Suggested: ' + str(suggestion) if suggestion else 'No suggestion'}</span></div>\"\"\")\n",
    "            row_widgets.append(row_html)\n",
    "        card_content = widgets.VBox(row_widgets, layout=widgets.Layout(max_height='400px', overflow_y='auto'))\n",
    "        card = widgets.VBox([header, card_content], layout=widgets.Layout(border='1px solid #D2D2D7', border_radius='12px', margin='0 0 16px 0'))\n",
    "        cards.append(card)\n",
    "    s3_review_container.children = cards\n",
    "\n",
    "# ========== SAVE FINAL REVIEW (v7.0 openpyxl with Action dropdown) ==========\n",
    "\n",
    "def do_save_final(b):\n",
    "    global stage3_final_df\n",
    "    if stage3_input_df is None:\n",
    "        with s3_output:\n",
    "            print(\"‚ùå No data to save\")\n",
    "        return\n",
    "    b.disabled = True\n",
    "    try:\n",
    "        final_rows = []\n",
    "\n",
    "        # Auto-assigned users\n",
    "        for item in stage3_auto_assigned:\n",
    "            row_data = stage3_input_df.loc[item['index']].to_dict()\n",
    "            row_data['Reviewer'] = item['reviewer']\n",
    "            row_data['Action'] = ''  # Empty for dropdown\n",
    "            row_data['Changes Detail'] = ''  # For \"Changes Required\" notes\n",
    "            final_rows.append(row_data)\n",
    "\n",
    "        # Manual review users (with suggested or empty)\n",
    "        for item in stage3_manual_review:\n",
    "            row_data = stage3_input_df.loc[item['index']].to_dict()\n",
    "            if item.get('suggested_reviewer'):\n",
    "                row_data['Reviewer'] = item['suggested_reviewer']\n",
    "            else:\n",
    "                row_data['Reviewer'] = ''\n",
    "            row_data['Action'] = ''  # Empty for dropdown\n",
    "            row_data['Changes Detail'] = ''  # For \"Changes Required\" notes\n",
    "            final_rows.append(row_data)\n",
    "\n",
    "        stage3_final_df = pd.DataFrame(final_rows)\n",
    "\n",
    "        # Generate filename\n",
    "        base_name = stage3_input_filename.replace('.csv', '').replace('.xlsx', '').replace('_AD_verified', '')\n",
    "        timestamp = datetime.now().strftime('%Y%m%d_%H%M')\n",
    "        output_filename = f\"{base_name}_review_{timestamp}.xlsx\"\n",
    "        output_path = os.path.join(STAGE3_DIR, output_filename)\n",
    "\n",
    "        # Save to Excel\n",
    "        stage3_final_df.to_excel(output_path, index=False, sheet_name='Review')\n",
    "\n",
    "        # ========== ADD DATA VALIDATION (openpyxl) ==========\n",
    "        wb = load_workbook(output_path)\n",
    "        ws = wb.active\n",
    "\n",
    "        # Find Action column\n",
    "        action_col = None\n",
    "        changes_col = None\n",
    "        for i, col_name in enumerate(stage3_final_df.columns, 1):\n",
    "            if str(col_name) == 'Action':\n",
    "                action_col = i\n",
    "            if str(col_name) == 'Changes Detail':\n",
    "                changes_col = i\n",
    "\n",
    "        if action_col:\n",
    "            # Add dropdown validation for Action column\n",
    "            dv = DataValidation(\n",
    "                type=\"list\",\n",
    "                formula1='\"Approved,Denied,Changes Required\"',\n",
    "                allow_blank=True\n",
    "            )\n",
    "            dv.promptTitle = \"Select Action\"\n",
    "            dv.prompt = \"Please select: Approved, Denied, or Changes Required\"\n",
    "            dv.showInputMessage = True\n",
    "            dv.errorTitle = \"Invalid Selection\"\n",
    "            dv.error = \"Please select a valid option from the drop-down menu.\"\n",
    "            dv.showErrorMessage = True\n",
    "            ws.add_data_validation(dv)\n",
    "            letter = get_column_letter(action_col)\n",
    "            dv.add(f\"{letter}2:{letter}{len(stage3_final_df)+1}\")\n",
    "            s3_logger.info(f\"Action dropdown added to column {letter}\")\n",
    "\n",
    "        # Auto-fit column widths (approximate)\n",
    "        for col_cells in ws.columns:\n",
    "            max_length = 0\n",
    "            col_letter = get_column_letter(col_cells[0].column)\n",
    "            for cell in col_cells:\n",
    "                try:\n",
    "                    if cell.value:\n",
    "                        max_length = max(max_length, len(str(cell.value)))\n",
    "                except:\n",
    "                    pass\n",
    "            ws.column_dimensions[col_letter].width = min(max_length + 2, 40)\n",
    "\n",
    "        wb.save(output_path)\n",
    "\n",
    "        with s3_output:\n",
    "            print(\"\\n\" + \"=\"*60)\n",
    "            print(\"üíæ Final Review File Saved\")\n",
    "            print(\"=\"*60)\n",
    "            print(f\"Location: {output_path}\")\n",
    "            print(f\"Rows: {len(stage3_final_df)}\")\n",
    "            print(f\"Columns: {list(stage3_final_df.columns)}\")\n",
    "            print(\"\")\n",
    "            print(\"üìã Action column has dropdown: Approved / Denied / Changes Required\")\n",
    "            print(\"üìù Changes Detail column for reviewer notes\")\n",
    "            print(\"=\"*60)\n",
    "\n",
    "        s3_status.value = f'<span style=\"color:{APPLE_COLORS[\"green\"]};font-family:-apple-system;\">‚úÖ Saved: {output_filename}</span>'\n",
    "        s3_logger.info(f\"Saved final review file: {output_path}\")\n",
    "\n",
    "    except Exception as e:\n",
    "        with s3_output:\n",
    "            print(f\"‚ùå Save error: {str(e)}\")\n",
    "        s3_logger.error(f\"Save error: {str(e)}\", exc_info=True)\n",
    "    finally:\n",
    "        b.disabled = False\n",
    "\n",
    "btn_s3_save.on_click(do_save_final)\n",
    "\n",
    "# ========== UI LAYOUT ==========\n",
    "\n",
    "stage3_ui = widgets.VBox([\n",
    "    widgets.HTML(get_header_html(\n",
    "        \"‚öôÔ∏è Stage 3: Reviewer Assignment & Final Review\",\n",
    "        \"Email-first mapping ‚Ä¢ Auto dept-assign ‚Ä¢ Action dropdown (Approved/Denied/Changes Required)\",\n",
    "        'gold_red'\n",
    "    )),\n",
    "    widgets.HTML('<h4 style=\"font-family:-apple-system;margin:16px 0 8px;\">üìÇ Auto-loaded Files:</h4>'),\n",
    "    s3_file_status,\n",
    "    s3_mapping_status,\n",
    "    widgets.HTML('<h4 style=\"font-family:-apple-system;margin:24px 0 8px;\">Or Upload Manually:</h4>'),\n",
    "    widgets.HBox([s3_upload_users, s3_upload_mapping]),\n",
    "    widgets.HTML('<h4 style=\"font-family:-apple-system;margin:24px 0 8px;\">Actions:</h4>'),\n",
    "    widgets.HBox([btn_s3_assign, btn_s3_save]),\n",
    "    s3_progress,\n",
    "    s3_status,\n",
    "    s3_review_container,\n",
    "    s3_output\n",
    "], layout=widgets.Layout(margin='32px 0'))\n",
    "\n",
    "# Initialize\n",
    "clear_output()\n",
    "display(stage3_ui)\n",
    "auto_load_files()\n",
    "s3_logger.info(\"Stage 3 UI initialized\")\n"
   ],
   "execution_count": null,
   "outputs": []
  }
 ],
 "metadata": {
  "kernelspec": {
   "display_name": "Python 3",
   "language": "python",
   "name": "python3"
  },
  "language_info": {
   "codemirror_mode": {
    "name": "ipython",
    "version": 3
   },
   "file_extension": ".py",
   "mimetype": "text/x-python",
   "name": "python",
   "nbformat_minor": 4,
   "pygments_lexer": "ipython3",
   "version": "3.11.0"
  }
 },
 "nbformat": 4,
 "nbformat_minor": 4
}