{
 "cells": [
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "# üõ°Ô∏è AER - Smart Access Review Generator (v7.0 Three-Stage)\n",
    "\n",
    "**Major Refactoring in v7.0:**\n",
    "- ‚úÖ **Stage 1 (Cell 1)**: AD Authentication & User Download\n",
    "- ‚úÖ **Stage 2 (Cell 2)**: Email/User Validation & AD Status Check\n",
    "- ‚úÖ **Stage 3 (Cell 3)**: Reviewer Assignment & Manual Override\n",
    "- ‚úÖ **Stage 1.5 (Cell 2)**: Org Tree Builder for Dept Heads\n",
    "\n",
    "**New Features:**\n",
    "1. ‚úÖ **Separated Workflow**: Each stage is independent and saves checkpoint files\n",
    "2. ‚úÖ **24-Month Activity**: Attempts to fetch sign-in activity (falls back gracefully)\n",
    "3. ‚úÖ **Manager Info**: Captures manager for every user to build org tree\n",
    "4. ‚úÖ **Org Tree UI**: Select dept heads & generate mapping file\n",
    "3. ‚úÖ **AD Status Column**: Clear visibility of Active/Inactive/Not Found\n",
    "4. ‚úÖ **Email-First Logic**: Email matches require manual approval with pre-fill\n",
    "5. ‚úÖ **Backward Compatible**: Works with legacy files if Cell 1-2 are skipped\n",
    "\n",
    "**Previous Features (v6.5):**\n",
    "- Enhanced Reviewer Mapping\n",
    "- Missing Email Handler with Fuzzy Matching\n",
    "- Smart Column Detection\n",
    "- Branch Support\n",
    "- Visual Enhancements\n"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "metadata": {},
   "outputs": [],
   "source": [
    "# === CELL 1: AD Authentication & User Download (v7.1 Stage 1) ===\n",
    "import os, sys, logging, re, requests, json, glob\n",
    "import pandas as pd\n",
    "import ipywidgets as widgets\n",
    "from datetime import datetime, timedelta\n",
    "from dotenv import load_dotenv\n",
    "from msal import PublicClientApplication\n",
    "from IPython.display import display, HTML, clear_output\n",
    "\n",
    "# 1. Setup Paths\n",
    "today_str = datetime.now().strftime('%Y-%m-%d')\n",
    "BASE_DIR = os.path.join(\"output\", today_str)\n",
    "AD_CACHE_DIR = os.path.join(BASE_DIR, \"ad_cache\")\n",
    "LOG_DIR = os.path.join(BASE_DIR, \"logs\")\n",
    "USERS_URL = \"https://graph.microsoft.com/v1.0/users\"\n",
    "os.makedirs(AD_CACHE_DIR, exist_ok=True)\n",
    "os.makedirs(LOG_DIR, exist_ok=True)\n",
    "\n",
    "# 2. Logging\n",
    "log_file = os.path.join(LOG_DIR, f\"aer_stage1_{datetime.now().strftime('%Y%m%d_%H%M')}.log\")\n",
    "logger_s1 = logging.getLogger(\"aer_stage1\")\n",
    "logger_s1.handlers.clear()\n",
    "logger_s1.setLevel(logging.INFO)\n",
    "formatter = logging.Formatter('%(asctime)s | %(levelname)s | %(message)s')\n",
    "fh = logging.FileHandler(log_file, encoding=\"utf-8\")\n",
    "fh.setFormatter(formatter)\n",
    "logger_s1.addHandler(fh)\n",
    "logger_s1.addHandler(logging.StreamHandler(sys.stdout))\n",
    "\n",
    "# 3. Global State\n",
    "stage1_headers = {}\n",
    "stage1_ad_data = None\n",
    "stage1_file_path = None\n",
    "\n",
    "# 4. UI Components\n",
    "s1_btn_login = widgets.Button(\n",
    "    description=\"üîê Login to Azure AD\",\n",
    "    button_style='primary',\n",
    "    layout=widgets.Layout(width='200px', height='40px')\n",
    ")\n",
    "s1_btn_download = widgets.Button(\n",
    "    description=\"üì• Download AD Users\",\n",
    "    button_style='success',\n",
    "    layout=widgets.Layout(width='200px', height='40px'),\n",
    "    disabled=True\n",
    ")\n",
    "s1_btn_refresh = widgets.Button(\n",
    "    description=\"üîÑ Refresh\",\n",
    "    button_style='warning',\n",
    "    layout=widgets.Layout(width='120px', height='40px'),\n",
    "    disabled=True\n",
    ")\n",
    "s1_chk_auditlog = widgets.Checkbox(\n",
    "    value=False,\n",
    "    description='Include AuditLog.Read.All (sign-in activity)',\n",
    "    indent=False\n",
    ")\n",
    "s1_chk_use_cache = widgets.Checkbox(\n",
    "    value=True,\n",
    "    description='Use cached AD file if available (skip Graph refresh)',\n",
    "    indent=False\n",
    ")\n",
    "s1_status = widgets.HTML(value=\"<i>Please login to Azure AD first</i>\")\n",
    "s1_output = widgets.Output()\n",
    "\n",
    "# Helpers\n",
    "def load_latest_cache():\n",
    "    files = glob.glob(os.path.join(AD_CACHE_DIR, \"ad_users_*.csv\"))\n",
    "    if not files:\n",
    "        return None, None\n",
    "    latest = max(files, key=os.path.getmtime)\n",
    "    try:\n",
    "        df = pd.read_csv(latest)\n",
    "        return df, latest\n",
    "    except Exception as e:\n",
    "        logger_s1.error(f\"Failed to read cache {latest}: {e}\")\n",
    "        return None, None\n",
    "\n",
    "# 5. Authentication Function\n",
    "def do_stage1_login(b):\n",
    "    global stage1_headers\n",
    "    \n",
    "    b.disabled = True\n",
    "    s1_status.value = \"<span style='color:blue;'>üîÑ Authenticating...</span>\"\n",
    "    \n",
    "    try:\n",
    "        load_dotenv()\n",
    "        tid = os.getenv(\"AZURE_TENANT_ID\")\n",
    "        cid = os.getenv(\"AZURE_CLIENT_ID\")\n",
    "        \n",
    "        if not tid or not cid:\n",
    "            s1_status.value = \"<span style='color:red;'>‚ùå Missing AZURE_TENANT_ID or AZURE_CLIENT_ID in .env</span>\"\n",
    "            logger_s1.error(\"Missing Azure credentials in .env\")\n",
    "            b.disabled = False\n",
    "            return\n",
    "        \n",
    "        app = PublicClientApplication(\n",
    "            cid,\n",
    "            authority=f\"https://login.microsoftonline.com/{tid}\"\n",
    "        )\n",
    "        \n",
    "        scopes = [\"User.Read.All\"]\n",
    "        if s1_chk_auditlog.value:\n",
    "            scopes.append(\"AuditLog.Read.All\")\n",
    "        \n",
    "        result = app.acquire_token_interactive(\n",
    "            scopes=scopes,\n",
    "            prompt=\"select_account\"\n",
    "        )\n",
    "        \n",
    "        if \"access_token\" in result:\n",
    "            stage1_headers = {\"Authorization\": f\"Bearer {result['access_token']}\"}\n",
    "            s1_status.value = \"<span style='color:green;'>‚úÖ Authentication Successful</span>\"\n",
    "            s1_btn_download.disabled = False\n",
    "            s1_btn_refresh.disabled = False\n",
    "            logger_s1.info(\"Stage 1: Authentication successful\")\n",
    "        else:\n",
    "            error_msg = result.get('error_description', 'Unknown error')\n",
    "            s1_status.value = f\"<span style='color:red;'>‚ùå Authentication failed: {error_msg}</span>\"\n",
    "            logger_s1.error(f\"Authentication failed: {error_msg}\")\n",
    "            \n",
    "    except Exception as e:\n",
    "        s1_status.value = f\"<span style='color:red;'>‚ùå Error: {str(e)}</span>\"\n",
    "        logger_s1.error(f\"Login error: {str(e)}\", exc_info=True)\n",
    "    finally:\n",
    "        b.disabled = False\n",
    "\n",
    "# 6. Download Function\n",
    "def do_stage1_download(b):\n",
    "    global stage1_ad_data, stage1_file_path\n",
    "    \n",
    "    if s1_chk_use_cache.value:\n",
    "        cached_df, cached_path = load_latest_cache()\n",
    "        if cached_df is not None:\n",
    "            stage1_ad_data = cached_df\n",
    "            stage1_file_path = cached_path\n",
    "            s1_status.value = f\"<span style='color:green;'>‚úÖ Loaded cache: {os.path.basename(cached_path)}</span>\"\n",
    "            s1_output.clear_output()\n",
    "            with s1_output:\n",
    "                print(\"Loaded cached AD data ‚Üí\", cached_path)\n",
    "                print(f\"Rows: {len(cached_df)}\")\n",
    "            return\n",
    "    \n",
    "    if not stage1_headers:\n",
    "        s1_status.value = \"<span style='color:red;'>‚ùå Please login first</span>\"\n",
    "        return\n",
    "    \n",
    "    b.disabled = True\n",
    "    s1_btn_refresh.disabled = True\n",
    "    \n",
    "    s1_output.clear_output()\n",
    "    \n",
    "    with s1_output:\n",
    "        print(\"\\n\" + \"=\"*60)\n",
    "        print(\"üì• Downloading Active Directory Users\")\n",
    "        print(\"=\"*60)\n",
    "        print(\"\\nFetching active users from Azure AD...\\n\")\n",
    "    \n",
    "    try:\n",
    "        session = requests.Session()\n",
    "        \n",
    "        progress = widgets.IntProgress(\n",
    "            value=0,\n",
    "            min=0,\n",
    "            max=100,\n",
    "            description='Progress:',\n",
    "            bar_style='info',\n",
    "            layout=widgets.Layout(width='80%')\n",
    "        )\n",
    "        status_label = widgets.HTML(value=\"Initializing...\")\n",
    "        progress_box = widgets.VBox([progress, status_label])\n",
    "        \n",
    "        with s1_output:\n",
    "            display(progress_box)\n",
    "        \n",
    "        logger_s1.info(\"Starting AD user download...\")\n",
    "        \n",
    "        requested_signin = s1_chk_auditlog.value\n",
    "        params_base = {\n",
    "            \"$filter\": \"accountEnabled eq true\",\n",
    "            \"$select\": \"id,mail,displayName,department,accountEnabled,jobTitle\",\n",
    "            \"$expand\": \"manager($select=displayName,mail,jobTitle,department)\",\n",
    "            \"$top\": 999\n",
    "        }\n",
    "        params_with_signin = {\n",
    "            \"$filter\": \"accountEnabled eq true\",\n",
    "            \"$select\": \"id,mail,displayName,department,accountEnabled,jobTitle,signInActivity\",\n",
    "            \"$expand\": \"manager($select=displayName,mail,jobTitle,department)\",\n",
    "            \"$top\": 999\n",
    "        }\n",
    "\n",
    "        use_signin_activity = False\n",
    "        manager_available = False\n",
    "\n",
    "        if requested_signin:\n",
    "            status_label.value = \"Attempting to fetch with sign-in activity...\"\n",
    "            progress.value = 10\n",
    "            response = session.get(USERS_URL, headers=stage1_headers, params=params_with_signin, timeout=30)\n",
    "        else:\n",
    "            status_label.value = \"AuditLog scope unchecked; skipping sign-in activity\"\n",
    "            progress.value = 10\n",
    "            response = session.get(USERS_URL, headers=stage1_headers, params=params_base, timeout=30)\n",
    "\n",
    "        if response.status_code == 200:\n",
    "            test_data = response.json()\n",
    "            if test_data.get('value'):\n",
    "                first_item = test_data['value'][0]\n",
    "                if requested_signin and 'signInActivity' in first_item:\n",
    "                    use_signin_activity = True\n",
    "                    logger_s1.info(\"‚úÖ signInActivity available\")\n",
    "                    with s1_output:\n",
    "                        print(\"‚úÖ Sign-in activity data available\\n\")\n",
    "                elif requested_signin:\n",
    "                    logger_s1.warning(\"‚ö†Ô∏è signInActivity not available in response\")\n",
    "                    with s1_output:\n",
    "                        print(\"‚ö†Ô∏è Sign-in activity not available (permission issue)\")\n",
    "                        print(\"Continuing without last sign-in data...\\n\")\n",
    "                if 'manager' in first_item:\n",
    "                    manager_available = True\n",
    "                    logger_s1.info(\"‚úÖ Manager info available via $expand\")\n",
    "                    with s1_output:\n",
    "                        print(\"‚úÖ Manager data available from Graph\\n\")\n",
    "        else:\n",
    "            logger_s1.warning(f\"‚ö†Ô∏è initial query failed: {response.status_code}\")\n",
    "            with s1_output:\n",
    "                print(f\"‚ö†Ô∏è Initial query failed (status {response.status_code})\")\n",
    "                print(\"Continuing with basic fields...\\n\")\n",
    "        \n",
    "        params = params_with_signin if use_signin_activity else params_base\n",
    "        \n",
    "        all_users = []\n",
    "        next_link = USERS_URL\n",
    "        page_count = 0\n",
    "        \n",
    "        status_label.value = \"Downloading user data...\"\n",
    "        progress.value = 20\n",
    "        \n",
    "        while next_link:\n",
    "            if page_count == 0:\n",
    "                response = session.get(next_link, headers=stage1_headers, params=params, timeout=30)\n",
    "            else:\n",
    "                response = session.get(next_link, headers=stage1_headers, timeout=30)\n",
    "            \n",
    "            if response.status_code != 200:\n",
    "                raise Exception(f\"API Error: {response.status_code} - {response.text}\")\n",
    "            \n",
    "            data = response.json()\n",
    "            users = data.get('value', [])\n",
    "            all_users.extend(users)\n",
    "            \n",
    "            page_count += 1\n",
    "            progress.value = min(20 + (page_count * 15), 80)\n",
    "            status_label.value = f\"Downloaded {len(all_users)} users (page {page_count})...\"\n",
    "            \n",
    "            next_link = data.get('@odata.nextLink')\n",
    "            \n",
    "            if page_count > 10:\n",
    "                break\n",
    "        \n",
    "        logger_s1.info(f\"Downloaded {len(all_users)} users from AD\")\n",
    "\n",
    "        if not manager_available:\n",
    "            status_label.value = \"Fetching managers (fallback)...\"\n",
    "            progress.value = min(progress.value + 5, 85)\n",
    "            for i, user in enumerate(all_users):\n",
    "                uid = user.get('id')\n",
    "                if not uid:\n",
    "                    continue\n",
    "                mgr_resp = session.get(\n",
    "                    f\"{USERS_URL}/{uid}/manager\",\n",
    "                    headers=stage1_headers,\n",
    "                    params={\"$select\": \"displayName,mail,jobTitle,department\"},\n",
    "                    timeout=20\n",
    "                )\n",
    "                if mgr_resp.status_code == 200:\n",
    "                    user['manager'] = mgr_resp.json()\n",
    "                if i % 50 == 0:\n",
    "                    progress.value = min(85, progress.value + 1)\n",
    "                    status_label.value = f\"Managers fetched: {i+1}/{len(all_users)}\"\n",
    "        \n",
    "        status_label.value = \"Processing user data...\"\n",
    "        progress.value = 85\n",
    "        \n",
    "        processed_users = []\n",
    "        \n",
    "        for user in all_users:\n",
    "            email = (user.get('mail') or '').lower().strip()\n",
    "            if not email:\n",
    "                continue\n",
    "            \n",
    "            user_data = {\n",
    "                'email': email,\n",
    "                'displayName': user.get('displayName', 'N/A'),\n",
    "                'department': user.get('department') or 'N/A',\n",
    "                'accountEnabled': user.get('accountEnabled', False),\n",
    "                'jobTitle': user.get('jobTitle') or 'N/A'\n",
    "            }\n",
    "\n",
    "            mgr = user.get('manager', {}) or {}\n",
    "            mgr_email = (mgr.get('mail') or '').lower().strip()\n",
    "            user_data['managerEmail'] = mgr_email if mgr_email else 'N/A'\n",
    "            user_data['managerName'] = mgr.get('displayName', 'N/A')\n",
    "            user_data['managerJobTitle'] = mgr.get('jobTitle', 'N/A')\n",
    "            user_data['managerDepartment'] = mgr.get('department', 'N/A')\n",
    "            \n",
    "            if use_signin_activity and isinstance(user.get('signInActivity'), dict):\n",
    "                signin_data = user.get('signInActivity') or {}\n",
    "                last_signin = signin_data.get('lastSignInDateTime', '')\n",
    "                user_data['lastSignInDateTime'] = last_signin if last_signin else 'Never'\n",
    "                if last_signin and last_signin != 'Never':\n",
    "                    try:\n",
    "                        signin_date = datetime.fromisoformat(last_signin.replace('Z', '+00:00'))\n",
    "                        cutoff_date = datetime.now().astimezone() - timedelta(days=730)\n",
    "                        user_data['activeIn24Months'] = signin_date > cutoff_date\n",
    "                    except:\n",
    "                        user_data['activeIn24Months'] = 'Unknown'\n",
    "                else:\n",
    "                    user_data['activeIn24Months'] = False\n",
    "            else:\n",
    "                user_data['lastSignInDateTime'] = 'N/A'\n",
    "                user_data['activeIn24Months'] = 'N/A'\n",
    "            \n",
    "            processed_users.append(user_data)\n",
    "        \n",
    "        stage1_ad_data = pd.DataFrame(processed_users)\n",
    "        \n",
    "        status_label.value = \"Saving to file...\"\n",
    "        progress.value = 95\n",
    "        \n",
    "        timestamp = datetime.now().strftime('%Y%m%d_%H%M')\n",
    "        filename = f\"ad_users_{timestamp}.csv\"\n",
    "        stage1_file_path = os.path.join(AD_CACHE_DIR, filename)\n",
    "        \n",
    "        stage1_ad_data.to_csv(stage1_file_path, index=False)\n",
    "        \n",
    "        progress.value = 100\n",
    "        progress.bar_style = 'success'\n",
    "        status_label.value = \"<span style='color:green;font-weight:bold;'>‚úÖ Complete!</span>\"\n",
    "        \n",
    "        total_users = len(stage1_ad_data)\n",
    "        active_users = stage1_ad_data['accountEnabled'].sum()\n",
    "        manager_known = (stage1_ad_data['managerEmail'] != 'N/A').sum()\n",
    "        \n",
    "        with s1_output:\n",
    "            print(\"\\n\" + \"=\"*60)\n",
    "            print(\"üìä Download Complete\")\n",
    "            print(\"=\"*60)\n",
    "            print(f\"Total users:        {total_users}\")\n",
    "            print(f\"Active accounts:    {active_users}\")\n",
    "            if use_signin_activity:\n",
    "                active_24m = (stage1_ad_data['activeIn24Months'] == True).sum()\n",
    "                print(f\"Active in 24 months: {active_24m}\")\n",
    "            print(f\"Manager linked:     {manager_known}\")\n",
    "            print(f\"\\nSaved to: {stage1_file_path}\")\n",
    "            print(\"=\"*60)\n",
    "        \n",
    "        s1_status.value = f\"<span style='color:green;'>‚úÖ Downloaded {total_users} users ‚Üí {filename}</span>\"\n",
    "        \n",
    "        logger_s1.info(f\"Stage 1 complete: {total_users} users saved to {stage1_file_path}\")\n",
    "        \n",
    "    except Exception as e:\n",
    "        with s1_output:\n",
    "            print(f\"\\n‚ùå Error: {str(e)}\")\n",
    "        s1_status.value = f\"<span style='color:red;'>‚ùå Error: {str(e)}</span>\"\n",
    "        logger_s1.error(f\"Download error: {str(e)}\", exc_info=True)\n",
    "    finally:\n",
    "        b.disabled = False\n",
    "        s1_btn_refresh.disabled = False\n",
    "\n",
    "# 7. Bind Events\n",
    "s1_btn_login.on_click(do_stage1_login)\n",
    "s1_btn_download.on_click(do_stage1_download)\n",
    "s1_btn_refresh.on_click(do_stage1_download)\n",
    "\n",
    "# 8. UI Layout\n",
    "stage1_ui = widgets.VBox([\n",
    "    widgets.HTML(\"\"\"\n",
    "        <div style='\n",
    "            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);\n",
    "            padding: 20px;\n",
    "            border-radius: 8px;\n",
    "            color: white;\n",
    "            margin-bottom: 20px;\n",
    "        '>\n",
    "            <h2 style='margin: 0 0 10px 0;'>üõ°Ô∏è Stage 1: AD User Download</h2>\n",
    "            <p style='margin: 0; opacity: 0.9;'>\n",
    "                Authenticate with Azure AD and download active users for validation\n",
    "            </p>\n",
    "        </div>\n",
    "    \"\"\"),\n",
    "    widgets.HBox([s1_btn_login, s1_btn_download, s1_btn_refresh]),\n",
    "    s1_chk_auditlog,\n",
    "    s1_chk_use_cache,\n",
    "    s1_status,\n",
    "    s1_output\n",
    "])\n",
    "\n",
    "clear_output()\n",
    "display(stage1_ui)\n",
    "\n",
    "logger_s1.info(\"Stage 1 UI initialized\")\n",
    "logger_s1.info(\"=\"*60)\n",
    "\n",
    "\n",
    "\n",
    "\n"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "metadata": {},
   "outputs": [],
   "source": [
    "# === CELL 1.5: Org Tree Builder (v7.3 Stage 1.5) ===\n",
    "import os, glob, logging, io, math\n",
    "import pandas as pd\n",
    "import ipywidgets as widgets\n",
    "from datetime import datetime\n",
    "from IPython.display import display, HTML, clear_output\n",
    "\n",
    "# Constants\n",
    "CORP_PREFIX = \"corporate\"\n",
    "MAX_TREE_DEPTH = 3  # CEO (level 1) + 3 levels down = depth 3 from root\n",
    "TITLE_PRIORITY = [\n",
    "    'chief executive', 'chief', 'ceo', 'president', 'vice president', 'vp',\n",
    "    'director', 'head', 'manager', 'lead'\n",
    "]\n",
    "\n",
    "# Paths\n",
    "today_str = datetime.now().strftime('%Y-%m-%d')\n",
    "BASE_DIR = os.path.join(\"output\", today_str)\n",
    "AD_CACHE_DIR = os.path.join(BASE_DIR, \"ad_cache\")\n",
    "ORG_DIR = os.path.join(BASE_DIR, \"orgchart\")\n",
    "MAP_DIR = os.path.join(\"input\", \"mapping\")\n",
    "LOG_DIR = os.path.join(BASE_DIR, \"logs\")\n",
    "os.makedirs(ORG_DIR, exist_ok=True)\n",
    "os.makedirs(MAP_DIR, exist_ok=True)\n",
    "\n",
    "# Logging\n",
    "log_file = os.path.join(LOG_DIR, f\"aer_stage1_5_{datetime.now().strftime('%Y%m%d_%H%M')}.log\")\n",
    "logger_s15 = logging.getLogger(\"aer_stage1_5\")\n",
    "logger_s15.handlers.clear()\n",
    "logger_s15.setLevel(logging.INFO)\n",
    "formatter = logging.Formatter('%(asctime)s | %(levelname)s | %(message)s')\n",
    "fh = logging.FileHandler(log_file, encoding=\"utf-8\")\n",
    "fh.setFormatter(formatter)\n",
    "logger_s15.addHandler(fh)\n",
    "logger_s15.addHandler(logging.StreamHandler(sys.stdout))\n",
    "\n",
    "# Globals\n",
    "s15_ad_df = None\n",
    "s15_tree_html = widgets.HTML()\n",
    "s15_status = widgets.HTML(value=\"<i>Load AD cache to build org tree</i>\")\n",
    "s15_output = widgets.Output()\n",
    "drop_head = widgets.Dropdown(description='Dept Head', options=[], layout=widgets.Layout(width='75%'))\n",
    "txt_reviewer_email = widgets.Text(description='Reviewer', placeholder='email@example.com', layout=widgets.Layout(width='50%'))\n",
    "txt_department = widgets.Text(description='Dept', layout=widgets.Layout(width='50%'))\n",
    "btn_add = widgets.Button(description='‚ûï Add/Update Mapping', button_style='warning', layout=widgets.Layout(width='220px'))\n",
    "btn_save = widgets.Button(description='üíæ Save Mapping', button_style='success', layout=widgets.Layout(width='160px'))\n",
    "btn_refresh = widgets.Button(description='üîÑ Rebuild Tree', button_style='info', layout=widgets.Layout(width='140px'))\n",
    "mapping_table = widgets.HTML()\n",
    "\n",
    "s15_mapping_rows = []\n",
    "\n",
    "# Helpers\n",
    "def normalize_department(dept):\n",
    "    if dept is None or (isinstance(dept, float) and math.isnan(dept)):\n",
    "        dept = ''\n",
    "    else:\n",
    "        dept = str(dept).strip()\n",
    "    if dept.lower().startswith('branch'):\n",
    "        return 'Branch'\n",
    "    return dept or 'N/A'\n",
    "\n",
    "def load_latest_ad():\n",
    "    try:\n",
    "        cache_files = glob.glob(os.path.join(AD_CACHE_DIR, \"ad_users_*.csv\"))\n",
    "        if not cache_files:\n",
    "            return None, \"No AD cache found. Run Stage 1 first.\"\n",
    "        latest = max(cache_files, key=os.path.getmtime)\n",
    "        df = pd.read_csv(latest)\n",
    "        df = df[df['department'].fillna('').str.lower().str.startswith(CORP_PREFIX)]\n",
    "        return df, f\"Loaded {len(df)} corporate users from {os.path.basename(latest)}\"\n",
    "    except Exception as e:\n",
    "        return None, f\"Error loading AD cache: {e}\"\n",
    "\n",
    "# Build tree based on manager hierarchy\n",
    "\n",
    "def find_root(df):\n",
    "    names = df['displayName'].str.lower().fillna('').str.strip()\n",
    "    mask_name = names.isin(['steven bush', 'steve bush'])\n",
    "    if mask_name.any():\n",
    "        return df.loc[mask_name, 'email'].iloc[0]\n",
    "    mask_title = df['jobTitle'].str.lower().fillna('').str.contains('chief executive|ceo|president')\n",
    "    if mask_title.any():\n",
    "        return df.loc[mask_title, 'email'].iloc[0]\n",
    "    mask_nomgr = df['managerEmail'].fillna('N/A') == 'N/A'\n",
    "    if mask_nomgr.any():\n",
    "        return df.loc[mask_nomgr, 'email'].iloc[0]\n",
    "    return df.iloc[0]['email'] if len(df) else None\n",
    "\n",
    "def build_org_tree(df):\n",
    "    df = df.copy()\n",
    "    if 'managerEmail' not in df.columns:\n",
    "        df['managerEmail'] = 'N/A'\n",
    "    df['managerEmail'] = df['managerEmail'].fillna('N/A')\n",
    "    root = find_root(df)\n",
    "    nodes = {row['email']: row for _, row in df.iterrows()}\n",
    "    children = {}\n",
    "    for _, row in df.iterrows():\n",
    "        mgr = row.get('managerEmail', 'N/A')\n",
    "        if mgr not in nodes or mgr == 'N/A':\n",
    "            mgr = root\n",
    "        children.setdefault(mgr, []).append(row['email'])\n",
    "    return nodes, children, root\n",
    "\n",
    "def compute_depths(children, root, max_depth=MAX_TREE_DEPTH):\n",
    "    depths = {root: 0}\n",
    "    queue = [root]\n",
    "    while queue:\n",
    "        cur = queue.pop(0)\n",
    "        d = depths[cur]\n",
    "        if d >= max_depth:\n",
    "            continue\n",
    "        for child in children.get(cur, []):\n",
    "            depths[child] = d + 1\n",
    "            queue.append(child)\n",
    "    return depths\n",
    "\n",
    "def tree_html(nodes, children, email, depth, max_depth):\n",
    "    if email not in nodes or depth > max_depth:\n",
    "        return ''\n",
    "    user = nodes[email]\n",
    "    label = f\"<b>{user.get('displayName','N/A')}</b> ‚Äî {user.get('jobTitle','N/A')} ‚Äî {user.get('department','N/A')} ‚Äî {email}\"\n",
    "    parts = [f\"<details {'open' if depth==0 else ''}><summary>{label}</summary>\"]\n",
    "    for child in sorted(children.get(email, []), key=lambda e: nodes[e].get('displayName','').lower()):\n",
    "        parts.append(tree_html(nodes, children, child, depth+1, max_depth))\n",
    "    parts.append(\"</details>\")\n",
    "    return '\\n'.join(parts)\n",
    "\n",
    "def dept_heads_by_title(df, depths):\n",
    "    heads = {}\n",
    "    for dept, grp in df.groupby(df['department'].fillna('N/A')):\n",
    "        grp = grp.copy()\n",
    "        grp['depth'] = grp['email'].map(depths).fillna(99)\n",
    "        def title_score(title):\n",
    "            t = str(title).lower()\n",
    "            for i, kw in enumerate(TITLE_PRIORITY):\n",
    "                if kw in t:\n",
    "                    return i\n",
    "            return len(TITLE_PRIORITY) + 1\n",
    "        grp['title_score'] = grp['jobTitle'].apply(title_score)\n",
    "        head = grp.sort_values(['title_score','depth','displayName']).iloc[0]\n",
    "        heads[dept] = head\n",
    "    return heads\n",
    "\n",
    "# UI render\n",
    "\n",
    "def refresh_tree(_=None):\n",
    "    global s15_ad_df, s15_mapping_rows\n",
    "    s15_output.clear_output()\n",
    "    df, msg = load_latest_ad()\n",
    "    if df is None:\n",
    "        s15_status.value = f\"<span style='color:red;'>‚ùå {msg}</span>\"\n",
    "        return\n",
    "    s15_ad_df = df\n",
    "    nodes, children, root = build_org_tree(df)\n",
    "    if not root:\n",
    "        s15_status.value = '<span style=\"color:red;\">‚ùå Could not locate root (CEO)</span>'\n",
    "        return\n",
    "\n",
    "    depths = compute_depths(children, root)\n",
    "    valid = {e for e,d in depths.items() if d <= MAX_TREE_DEPTH}\n",
    "\n",
    "    # Dropdown options\n",
    "    opts = []\n",
    "    for _, row in df[df['email'].isin(valid)].sort_values(['department','displayName']).iterrows():\n",
    "        label = f\"{row.get('department','N/A')} | {row.get('displayName','N/A')} | {row.get('jobTitle','N/A')} | {row.get('email','')}\"\n",
    "        opts.append((label, row.get('email','')))\n",
    "    drop_head.options = opts\n",
    "\n",
    "    # Determine dept heads by title (not by tree position)\n",
    "    heads = dept_heads_by_title(df[df['email'].isin(valid)], depths)\n",
    "\n",
    "    # Build mapping rows\n",
    "    s15_mapping_rows = []\n",
    "    for dept, head in heads.items():\n",
    "        head_email = head.get('email','')\n",
    "        head_mgr = head.get('managerEmail','') if head.get('managerEmail','N/A') != 'N/A' else ''\n",
    "        branch_val = '' if str(dept).lower().startswith('corporate') else 'Branch'\n",
    "        s15_mapping_rows.append({'email': head_email, 'department': dept, 'reviewer': head_mgr, 'branch': branch_val})\n",
    "        s15_mapping_rows.append({'email': '*', 'department': dept, 'reviewer': head_email, 'branch': branch_val})\n",
    "\n",
    "    render_mapping()\n",
    "\n",
    "    # Tree view: manager hierarchy, limited depth\n",
    "    tree = tree_html(nodes, children, root, 0, MAX_TREE_DEPTH)\n",
    "    s15_tree_html.value = (\n",
    "        \"<div style='max-height:520px;overflow:auto;border:1px solid #ddd;padding:10px;'>\" +\n",
    "        \"<h4>Corporate Org (manager hierarchy, CEO + 3 levels)</h4>\" + tree + \"</div>\"\n",
    "    )\n",
    "    s15_status.value = f\"<span style='color:green;'>‚úÖ {msg}</span>\"\n",
    "    logger_s15.info(msg)\n",
    "\n",
    "# Mapping table render\n",
    "\n",
    "def render_mapping():\n",
    "    if not s15_mapping_rows:\n",
    "        mapping_table.value = \"<i>No mappings added yet</i>\"\n",
    "        return\n",
    "    df = pd.DataFrame(s15_mapping_rows)\n",
    "    cols = ['email','department','reviewer','branch']\n",
    "    for c in cols:\n",
    "        if c not in df.columns:\n",
    "            df[c] = ''\n",
    "    mapping_table.value = df[cols].to_html(index=False)\n",
    "\n",
    "# Events\n",
    "\n",
    "def on_head_change(change):\n",
    "    if not change['new'] or s15_ad_df is None:\n",
    "        return\n",
    "    row = s15_ad_df.loc[s15_ad_df['email'] == change['new']].iloc[0]\n",
    "    dept = normalize_department(row.get('department'))\n",
    "    txt_department.value = dept\n",
    "    txt_reviewer_email.value = row.get('email', '')\n",
    "\n",
    "def on_add_clicked(_):\n",
    "    if not txt_department.value or not txt_reviewer_email.value:\n",
    "        s15_status.value = \"<span style='color:red;'>‚ùå Department and reviewer email required</span>\"\n",
    "        return\n",
    "    dept = normalize_department(txt_department.value)\n",
    "    reviewer = txt_reviewer_email.value.strip().lower()\n",
    "    email = drop_head.value\n",
    "    branch_val = '' if dept.lower().startswith('corporate') else 'Branch'\n",
    "    new_rows = [\n",
    "        {'email': email or reviewer, 'department': dept, 'reviewer': reviewer, 'branch': branch_val},\n",
    "        {'email': '*', 'department': dept, 'reviewer': email or reviewer, 'branch': branch_val}\n",
    "    ]\n",
    "    s15_mapping_rows[:] = [r for r in s15_mapping_rows if r.get('department','').lower() != dept.lower()]\n",
    "    s15_mapping_rows.extend(new_rows)\n",
    "    s15_status.value = f\"<span style='color:blue;'>‚úÖ Mapping updated for {dept}</span>\"\n",
    "    render_mapping()\n",
    "\n",
    "def on_save_clicked(_):\n",
    "    if not s15_mapping_rows:\n",
    "        s15_status.value = \"<span style='color:red;'>‚ùå No mappings to save</span>\"\n",
    "        return\n",
    "    df = pd.DataFrame(s15_mapping_rows)\n",
    "    ts = datetime.now().strftime('%Y%m%d_%H%M')\n",
    "    path = os.path.join(MAP_DIR, f\"org_mapping_{ts}.csv\")\n",
    "    df.to_csv(path, index=False)\n",
    "    s15_status.value = f\"<span style='color:green;'>üíæ Saved mapping to {path}</span>\"\n",
    "    logger_s15.info(f\"Mapping saved to {path}\")\n",
    "\n",
    "# Bind events\n",
    "drop_head.observe(on_head_change, names='value')\n",
    "btn_add.on_click(on_add_clicked)\n",
    "btn_save.on_click(on_save_clicked)\n",
    "btn_refresh.on_click(refresh_tree)\n",
    "\n",
    "# Layout\n",
    "stage15_ui = widgets.VBox([\n",
    "    widgets.HTML(\"\"\"\n",
    "        <div style='\n",
    "            background: linear-gradient(135deg, #5ee7df 0%, #b490ca 100%);\n",
    "            padding: 20px;\n",
    "            border-radius: 8px;\n",
    "            color: white;\n",
    "            margin-bottom: 20px;\n",
    "        '>\n",
    "            <h2 style='margin: 0 0 10px 0;'>üå≥ Stage 1.5: Org Tree Builder</h2>\n",
    "            <p style='margin: 0; opacity: 0.9;'>\n",
    "                Manager hierarchy from CEO (Steven/Steve Bush) down 3 levels; auto-mapping dept heads by title priority\n",
    "            </p>\n",
    "        </div>\n",
    "    \"\"\"),\n",
    "    widgets.HBox([btn_refresh, s15_status]),\n",
    "    s15_tree_html,\n",
    "    widgets.HTML('<h4>Current Mapping (email, department, reviewer, branch)</h4>'),\n",
    "    mapping_table,\n",
    "    widgets.HBox([drop_head]),\n",
    "    widgets.HBox([txt_department, txt_reviewer_email]),\n",
    "    widgets.HBox([btn_add, btn_save]),\n",
    "    s15_output\n",
    "])\n",
    "\n",
    "clear_output()\n",
    "display(stage15_ui)\n",
    "refresh_tree()\n",
    "logger_s15.info(\"Stage 1.5 UI initialized\")\n",
    "logger_s15.info(\"=\"*60)\n",
    "\n"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "metadata": {},
   "outputs": [],
   "source": [
    "#!/usr/bin/env python3\n",
    "\"\"\"\n",
    "Stage 2: Email/User Validation with Enhanced UI (Jupyter Cell) v8.1\n",
    "\n",
    "Changes from v8.0:\n",
    "1. Fold (collapsible accordion) 100% perfect matches instead of hiding\n",
    "2. Fuzzy matches < 80% require manual selection (no auto-populate)\n",
    "3. Output includes Department and is_AD_active columns from AD cache\n",
    "4. Delete button on each review row ‚Äî removes from UI and output\n",
    "5. All displayed records (even empty inputs) saved unless explicitly deleted\n",
    "\n",
    "Copy and paste this entire cell into Jupyter notebook and run.\n",
    "\"\"\"\n",
    "\n",
    "import os\n",
    "import sys\n",
    "import re\n",
    "import io\n",
    "import glob\n",
    "import unicodedata\n",
    "from typing import Dict, List, Tuple\n",
    "from datetime import datetime\n",
    "import pandas as pd\n",
    "import ipywidgets as widgets\n",
    "from IPython.display import display, HTML, clear_output\n",
    "\n",
    "# Try import fuzzy matching\n",
    "try:\n",
    "    from rapidfuzz import fuzz, process\n",
    "    FUZZY_AVAILABLE = True\n",
    "except ImportError:\n",
    "    try:\n",
    "        from fuzzywuzzy import fuzz, process\n",
    "        FUZZY_AVAILABLE = True\n",
    "    except ImportError:\n",
    "        FUZZY_AVAILABLE = False\n",
    "        print(\"‚ö†Ô∏è Fuzzy matching unavailable. Install: pip install rapidfuzz\")\n",
    "\n",
    "# ============================================\n",
    "# Setup Paths\n",
    "# ============================================\n",
    "\n",
    "today_str = datetime.now().strftime('%Y-%m-%d')\n",
    "BASE_DIR = os.path.join(\"output\", today_str)\n",
    "AD_CACHE_DIR = os.path.join(BASE_DIR, \"ad_cache\")\n",
    "STAGE2_DIR = os.path.join(BASE_DIR, \"stage2_validated\")\n",
    "LOG_DIR = os.path.join(BASE_DIR, \"logs\")\n",
    "os.makedirs(STAGE2_DIR, exist_ok=True)\n",
    "\n",
    "# ============================================\n",
    "# Validation Status Enum\n",
    "# ============================================\n",
    "\n",
    "class ValidationStatus:\n",
    "    \"\"\"Validation status categories\"\"\"\n",
    "    VALID_PERFECT = \"valid_perfect\"\n",
    "    WARN_NAME_MISMATCH = \"warn_name_mismatch\"\n",
    "    INFO_FUZZY_UNIQUE = \"info_fuzzy_unique\"\n",
    "    ERR_FUZZY_MULTIPLE = \"err_fuzzy_multiple\"\n",
    "    ERR_NOT_FOUND = \"err_not_found\"\n",
    "    ERR_EMAIL_INVALID = \"err_email_invalid\"\n",
    "    ERR_MISSING_DATA = \"err_missing_data\"\n",
    "\n",
    "    @staticmethod\n",
    "    def get_display_text(status: str) -> str:\n",
    "        status_map = {\n",
    "            ValidationStatus.VALID_PERFECT: \"‚úÖ Verified (Email & Name Match)\",\n",
    "            ValidationStatus.WARN_NAME_MISMATCH: \"‚ö†Ô∏è Email Valid - Name Mismatch\",\n",
    "            ValidationStatus.INFO_FUZZY_UNIQUE: \"üîµ Auto-Matched by Name (Single Match)\",\n",
    "            ValidationStatus.ERR_FUZZY_MULTIPLE: \"üü† Manual Selection Required (Multiple Matches)\",\n",
    "            ValidationStatus.ERR_NOT_FOUND: \"‚ùå User Not Found in AD\",\n",
    "            ValidationStatus.ERR_EMAIL_INVALID: \"‚ùå Email Not in AD\",\n",
    "            ValidationStatus.ERR_MISSING_DATA: \"‚ö™ Insufficient Data\"\n",
    "        }\n",
    "        return status_map.get(status, \"Unknown Status\")\n",
    "\n",
    "# ============================================\n",
    "# Global State\n",
    "# ============================================\n",
    "\n",
    "stage2_ad_cache = {}\n",
    "stage2_name_index = {}\n",
    "stage2_input_df = None\n",
    "stage2_input_filename = \"\"\n",
    "stage2_categorized = {}\n",
    "stage2_ui_rows = {}\n",
    "\n",
    "# ============================================\n",
    "# Helper Functions\n",
    "# ============================================\n",
    "\n",
    "def is_email_valid(email) -> bool:\n",
    "    \"\"\"Check if email is valid\"\"\"\n",
    "    if pd.isna(email):\n",
    "        return False\n",
    "    email_str = str(email).strip().lower()\n",
    "    if email_str in ['', 'nan', 'none', 'n/a', 'na', '#n/a']:\n",
    "        return False\n",
    "    if '@' not in email_str or '.' not in email_str:\n",
    "        return False\n",
    "    if not re.match(r'^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\\.[a-zA-Z]{2,}$', email_str):\n",
    "        return False\n",
    "    return True\n",
    "\n",
    "\n",
    "def normalize_name(name) -> str:\n",
    "    \"\"\"Normalize name for fuzzy matching\"\"\"\n",
    "    if not name or pd.isna(name):\n",
    "        return \"\"\n",
    "    name = str(name).lower()\n",
    "    name = unicodedata.normalize('NFKC', name)\n",
    "    name = re.sub(r'[^a-z0-9\\s]', ' ', name)\n",
    "    name = ' '.join(name.split())\n",
    "    return name.strip()\n",
    "\n",
    "\n",
    "def fuzzy_match_name(target_name: str, name_index: Dict, ad_cache: Dict, top_n: int = 5) -> List[Dict]:\n",
    "    \"\"\"Find best email matches for a name\"\"\"\n",
    "    if not FUZZY_AVAILABLE or not name_index:\n",
    "        return []\n",
    "\n",
    "    norm_target = normalize_name(target_name)\n",
    "    if not norm_target:\n",
    "        return []\n",
    "\n",
    "    # Exact match check\n",
    "    if norm_target in name_index:\n",
    "        email = name_index[norm_target]\n",
    "        user = ad_cache[email]\n",
    "        return [{\n",
    "            'email': email,\n",
    "            'name': user['name'],\n",
    "            'dept': user['dept'],\n",
    "            'score': 100,\n",
    "            'match_type': 'exact'\n",
    "        }]\n",
    "\n",
    "    # Fuzzy search\n",
    "    try:\n",
    "        candidates = list(name_index.keys())\n",
    "        matches = process.extract(\n",
    "            norm_target,\n",
    "            candidates,\n",
    "            scorer=fuzz.token_sort_ratio,\n",
    "            limit=top_n * 2\n",
    "        )\n",
    "\n",
    "        results = []\n",
    "        seen = set()\n",
    "\n",
    "        for match_name, score, _ in matches:\n",
    "            if score < 70:\n",
    "                continue\n",
    "\n",
    "            email = name_index[match_name]\n",
    "            if email in seen:\n",
    "                continue\n",
    "\n",
    "            seen.add(email)\n",
    "            user = ad_cache[email]\n",
    "\n",
    "            results.append({\n",
    "                'email': email,\n",
    "                'name': user['name'],\n",
    "                'dept': user['dept'],\n",
    "                'score': int(score),\n",
    "                'match_type': 'high' if score >= 90 else 'medium'\n",
    "            })\n",
    "\n",
    "            if len(results) >= top_n:\n",
    "                break\n",
    "\n",
    "        return results\n",
    "    except:\n",
    "        return []\n",
    "\n",
    "\n",
    "def load_ad_cache():\n",
    "    \"\"\"Load AD cache from Stage 1\"\"\"\n",
    "    global stage2_ad_cache, stage2_name_index\n",
    "\n",
    "    try:\n",
    "        cache_files = glob.glob(os.path.join(AD_CACHE_DIR, \"ad_users_*.csv\"))\n",
    "        if not cache_files:\n",
    "            return False, \"No AD cache found. Please run Stage 1 first.\"\n",
    "\n",
    "        latest_cache = max(cache_files, key=os.path.getmtime)\n",
    "        df = pd.read_csv(latest_cache)\n",
    "\n",
    "        # Build cache\n",
    "        for _, row in df.iterrows():\n",
    "            email = str(row['email']).lower().strip()\n",
    "            if not email or email == 'nan':\n",
    "                continue\n",
    "\n",
    "            stage2_ad_cache[email] = {\n",
    "                'email': email,\n",
    "                'name': row['displayName'],\n",
    "                'dept': row['department'],\n",
    "                'active': row['accountEnabled']\n",
    "            }\n",
    "\n",
    "            # Build name index\n",
    "            norm_name = normalize_name(row['displayName'])\n",
    "            if norm_name:\n",
    "                stage2_name_index[norm_name] = email\n",
    "\n",
    "                # Add reversed name\n",
    "                parts = norm_name.split()\n",
    "                if len(parts) == 2:\n",
    "                    reversed_name = f\"{parts[1]} {parts[0]}\"\n",
    "                    stage2_name_index[reversed_name] = email\n",
    "\n",
    "        return True, f\"Loaded {len(stage2_ad_cache)} users from {os.path.basename(latest_cache)}\"\n",
    "\n",
    "    except Exception as e:\n",
    "        return False, f\"Error loading AD cache: {str(e)}\"\n",
    "\n",
    "\n",
    "def categorize_user(row: pd.Series, ad_cache: Dict, name_index: Dict) -> Tuple[str, Dict]:\n",
    "    \"\"\"Categorize a user record\"\"\"\n",
    "    user_email = row.get('Email') if 'Email' in row.index else row.iloc[0]\n",
    "    user_name = row.get('User Name') if 'User Name' in row.index else row.iloc[1] if len(row) > 1 else ''\n",
    "\n",
    "    metadata = {\n",
    "        'original_email': user_email,\n",
    "        'original_name': user_name,\n",
    "        'ad_user': None,\n",
    "        'fuzzy_matches': [],\n",
    "        'validation_message': '',\n",
    "        'final_email': '',\n",
    "        'final_name': ''\n",
    "    }\n",
    "\n",
    "    email_valid = is_email_valid(user_email)\n",
    "\n",
    "    # Case 1: Both missing\n",
    "    if not email_valid and (not user_name or pd.isna(user_name) or str(user_name).strip() == ''):\n",
    "        metadata['validation_message'] = 'Insufficient data'\n",
    "        return ValidationStatus.ERR_MISSING_DATA, metadata\n",
    "\n",
    "    # Case 2: Email valid\n",
    "    if email_valid:\n",
    "        email_clean = str(user_email).strip().lower()\n",
    "\n",
    "        if email_clean not in ad_cache:\n",
    "            metadata['validation_message'] = f'Email not in AD'\n",
    "            return ValidationStatus.ERR_EMAIL_INVALID, metadata\n",
    "\n",
    "        ad_user = ad_cache[email_clean]\n",
    "        metadata['ad_user'] = ad_user\n",
    "        metadata['final_email'] = email_clean\n",
    "        metadata['final_name'] = ad_user['name']\n",
    "\n",
    "        # Check name match\n",
    "        ad_name_norm = normalize_name(ad_user['name'])\n",
    "        input_name_norm = normalize_name(user_name)\n",
    "\n",
    "        if input_name_norm and ad_name_norm == input_name_norm:\n",
    "            metadata['validation_message'] = 'Perfect match'\n",
    "            return ValidationStatus.VALID_PERFECT, metadata\n",
    "        else:\n",
    "            metadata['validation_message'] = f\"Name differs\"\n",
    "            return ValidationStatus.WARN_NAME_MISMATCH, metadata\n",
    "\n",
    "    # Case 3: Email missing, try fuzzy match\n",
    "    if not user_name or pd.isna(user_name) or str(user_name).strip() == '':\n",
    "        metadata['validation_message'] = 'No name provided'\n",
    "        return ValidationStatus.ERR_MISSING_DATA, metadata\n",
    "\n",
    "    fuzzy_matches = fuzzy_match_name(user_name, name_index, ad_cache, top_n=5)\n",
    "\n",
    "    if not fuzzy_matches:\n",
    "        metadata['validation_message'] = 'No match found'\n",
    "        return ValidationStatus.ERR_NOT_FOUND, metadata\n",
    "\n",
    "    metadata['fuzzy_matches'] = fuzzy_matches\n",
    "\n",
    "    if len(fuzzy_matches) == 1:\n",
    "        match = fuzzy_matches[0]\n",
    "        if match['score'] >= 80:\n",
    "            # High confidence ‚Äî auto-populate\n",
    "            metadata['final_email'] = match['email']\n",
    "            metadata['final_name'] = match['name']\n",
    "            metadata['validation_message'] = f'Single match: {match[\"score\"]}%'\n",
    "            return ValidationStatus.INFO_FUZZY_UNIQUE, metadata\n",
    "        else:\n",
    "            # Low confidence ‚Äî require manual selection\n",
    "            metadata['validation_message'] = f'Low confidence: {match[\"score\"]}%'\n",
    "            return ValidationStatus.ERR_FUZZY_MULTIPLE, metadata\n",
    "    else:\n",
    "        metadata['validation_message'] = f'{len(fuzzy_matches)} matches found'\n",
    "        return ValidationStatus.ERR_FUZZY_MULTIPLE, metadata\n",
    "\n",
    "\n",
    "# ============================================\n",
    "# UI Components\n",
    "# ============================================\n",
    "\n",
    "def create_fuzzy_unique_row(idx: int, row: pd.Series, metadata: Dict):\n",
    "    \"\"\"Green row for single fuzzy match, with delete button\"\"\"\n",
    "    original_name = str(metadata['original_name'])\n",
    "    match = metadata['fuzzy_matches'][0]\n",
    "\n",
    "    name_html = f\"\"\"\n",
    "    <div style='width:220px; padding:5px;'>\n",
    "        <b style='color:#34c759;'>‚úì {original_name}</b>\n",
    "        <br><small style='color:#34c759;'>Match: {match['score']}%</small>\n",
    "    </div>\n",
    "    \"\"\"\n",
    "\n",
    "    info_html = f\"\"\"\n",
    "    <div style='padding:5px; border:1px solid #34c759; background:#e8f5e9; border-radius:4px; width:500px;'>\n",
    "        <b style='color:#34c759;'>‚úÖ Single Match</b><br>\n",
    "        <b>{match['name']}</b> ({match['email']})<br>\n",
    "        Dept: {match['dept']} | Confidence: {match['score']}%\n",
    "    </div>\n",
    "    \"\"\"\n",
    "\n",
    "    btn_delete = widgets.Button(\n",
    "        description='‚úï',\n",
    "        button_style='danger',\n",
    "        layout=widgets.Layout(width='36px', height='30px'),\n",
    "        tooltip='Remove this record'\n",
    "    )\n",
    "\n",
    "    container = widgets.HBox([\n",
    "        widgets.HTML(value=name_html),\n",
    "        widgets.HTML(value=info_html),\n",
    "        btn_delete\n",
    "    ])\n",
    "\n",
    "    result = {\n",
    "        'index': idx,\n",
    "        'row': container,\n",
    "        'selected_email': match['email'],\n",
    "        'selected_name': match['name'],\n",
    "        'deleted': False\n",
    "    }\n",
    "\n",
    "    def on_delete(b):\n",
    "        result['deleted'] = True\n",
    "        container.layout.display = 'none'\n",
    "\n",
    "    btn_delete.on_click(on_delete)\n",
    "    return result\n",
    "\n",
    "\n",
    "def create_fuzzy_multiple_row(idx: int, row: pd.Series, metadata: Dict):\n",
    "    \"\"\"Orange row for multiple fuzzy matches or low-confidence single match\"\"\"\n",
    "    original_name = str(metadata['original_name'])\n",
    "    fuzzy_matches = metadata['fuzzy_matches']\n",
    "    is_low_confidence = len(fuzzy_matches) == 1\n",
    "\n",
    "    if is_low_confidence:\n",
    "        badge_text = f\"Low confidence: {fuzzy_matches[0]['score']}%\"\n",
    "    else:\n",
    "        badge_text = f\"{len(fuzzy_matches)} matches\"\n",
    "\n",
    "    name_html = f\"\"\"\n",
    "    <div style='width:220px; padding:5px;'>\n",
    "        <b style='color:#ff9500;'>‚ö†Ô∏è {original_name}</b>\n",
    "        <br><small style='color:#ff9500;'>{badge_text}</small>\n",
    "    </div>\n",
    "    \"\"\"\n",
    "\n",
    "    options = [('-- Select --', '')]\n",
    "    for match in fuzzy_matches:\n",
    "        label = f\"{match['name']} ({match['email']}) - {match['dept']} [{match['score']}%]\"\n",
    "        options.append((label, match['email']))\n",
    "    options.append(('-- Manual Entry --', 'MANUAL'))\n",
    "\n",
    "    # Low-confidence single match: don't pre-select, force manual choice\n",
    "    default_value = '' if is_low_confidence else fuzzy_matches[0]['email']\n",
    "\n",
    "    dropdown = widgets.Dropdown(\n",
    "        options=options,\n",
    "        value=default_value,\n",
    "        description='',\n",
    "        layout=widgets.Layout(width='550px')\n",
    "    )\n",
    "\n",
    "    txt_manual = widgets.Text(\n",
    "        placeholder='Enter email manually',\n",
    "        layout=widgets.Layout(width='300px'),\n",
    "        disabled=True\n",
    "    )\n",
    "\n",
    "    def on_dropdown_change(change):\n",
    "        if change['new'] == 'MANUAL':\n",
    "            txt_manual.disabled = False\n",
    "        else:\n",
    "            txt_manual.disabled = True\n",
    "            txt_manual.value = ''\n",
    "\n",
    "    dropdown.observe(on_dropdown_change, names='value')\n",
    "\n",
    "    btn_delete = widgets.Button(\n",
    "        description='‚úï',\n",
    "        button_style='danger',\n",
    "        layout=widgets.Layout(width='36px', height='30px'),\n",
    "        tooltip='Remove this record'\n",
    "    )\n",
    "\n",
    "    container = widgets.HBox([\n",
    "        widgets.HTML(value=name_html),\n",
    "        dropdown,\n",
    "        txt_manual,\n",
    "        btn_delete\n",
    "    ])\n",
    "\n",
    "    result = {\n",
    "        'index': idx,\n",
    "        'dropdown': dropdown,\n",
    "        'manual_input': txt_manual,\n",
    "        'metadata': metadata,\n",
    "        'row': container,\n",
    "        'deleted': False\n",
    "    }\n",
    "\n",
    "    def on_delete(b):\n",
    "        result['deleted'] = True\n",
    "        container.layout.display = 'none'\n",
    "\n",
    "    btn_delete.on_click(on_delete)\n",
    "    return result\n",
    "\n",
    "\n",
    "def create_mismatch_row(idx: int, row: pd.Series, metadata: Dict):\n",
    "    \"\"\"Yellow row for name mismatch\"\"\"\n",
    "    original_email = metadata['original_email']\n",
    "    original_name = metadata['original_name']\n",
    "    ad_user = metadata['ad_user']\n",
    "\n",
    "    chk_accept = widgets.Checkbox(\n",
    "        value=True,\n",
    "        description='Accept AD Name',\n",
    "        indent=False\n",
    "    )\n",
    "\n",
    "    info_html = f\"\"\"\n",
    "    <div style='padding:5px; border:1px solid #ff9800; background:#fff3e0; border-radius:4px;'>\n",
    "        <b style='color:#ff9800;'>‚ö†Ô∏è Name Mismatch</b><br>\n",
    "        Input: {original_name}<br>\n",
    "        AD: {ad_user['name']}<br>\n",
    "        Email: {original_email} ‚úÖ\n",
    "    </div>\n",
    "    \"\"\"\n",
    "\n",
    "    btn_delete = widgets.Button(\n",
    "        description='‚úï',\n",
    "        button_style='danger',\n",
    "        layout=widgets.Layout(width='36px', height='30px'),\n",
    "        tooltip='Remove this record'\n",
    "    )\n",
    "\n",
    "    container = widgets.HBox([\n",
    "        chk_accept,\n",
    "        widgets.HTML(value=info_html),\n",
    "        btn_delete\n",
    "    ])\n",
    "\n",
    "    result = {\n",
    "        'index': idx,\n",
    "        'accept_checkbox': chk_accept,\n",
    "        'metadata': metadata,\n",
    "        'row': container,\n",
    "        'deleted': False\n",
    "    }\n",
    "\n",
    "    def on_delete(b):\n",
    "        result['deleted'] = True\n",
    "        container.layout.display = 'none'\n",
    "\n",
    "    btn_delete.on_click(on_delete)\n",
    "    return result\n",
    "\n",
    "\n",
    "# ============================================\n",
    "# Main Validation Function\n",
    "# ============================================\n",
    "\n",
    "def do_validation(b):\n",
    "    \"\"\"Validate uploaded file\"\"\"\n",
    "    global stage2_input_df, stage2_input_filename, stage2_categorized, stage2_ui_rows\n",
    "\n",
    "    s2_output.clear_output()\n",
    "\n",
    "    if not s2_upload.value:\n",
    "        with s2_output:\n",
    "            print(\"‚ùå Please upload a file\")\n",
    "        return\n",
    "\n",
    "    b.disabled = True\n",
    "\n",
    "    try:\n",
    "        with s2_output:\n",
    "            print(\"\\n\" + \"=\"*60)\n",
    "            print(\"üîç Stage 2: Email/User Validation\")\n",
    "            print(\"=\"*60 + \"\\n\")\n",
    "\n",
    "        # Load file\n",
    "        f_item = s2_upload.value[0]\n",
    "        stage2_input_filename = f_item['name']\n",
    "\n",
    "        if stage2_input_filename.endswith('.csv'):\n",
    "            stage2_input_df = pd.read_csv(io.BytesIO(f_item['content']))\n",
    "        else:\n",
    "            stage2_input_df = pd.read_excel(io.BytesIO(f_item['content']))\n",
    "\n",
    "        with s2_output:\n",
    "            print(f\"üìÑ Loaded: {stage2_input_filename}\")\n",
    "            print(f\"   Rows: {len(stage2_input_df)}\")\n",
    "            print(f\"   Columns: {list(stage2_input_df.columns)}\\n\")\n",
    "\n",
    "        # Categorize users\n",
    "        print(\"üîç Categorizing users...\")\n",
    "        stage2_categorized = {}\n",
    "\n",
    "        for idx, row in stage2_input_df.iterrows():\n",
    "            status, metadata = categorize_user(row, stage2_ad_cache, stage2_name_index)\n",
    "\n",
    "            if status not in stage2_categorized:\n",
    "                stage2_categorized[status] = []\n",
    "\n",
    "            stage2_categorized[status].append({\n",
    "                'index': idx,\n",
    "                'row': row,\n",
    "                'metadata': metadata,\n",
    "                'status': status\n",
    "            })\n",
    "\n",
    "        # Statistics\n",
    "        stats = {status: len(stage2_categorized.get(status, [])) for status in [\n",
    "            ValidationStatus.VALID_PERFECT,\n",
    "            ValidationStatus.WARN_NAME_MISMATCH,\n",
    "            ValidationStatus.INFO_FUZZY_UNIQUE,\n",
    "            ValidationStatus.ERR_FUZZY_MULTIPLE,\n",
    "            ValidationStatus.ERR_NOT_FOUND,\n",
    "            ValidationStatus.ERR_EMAIL_INVALID,\n",
    "            ValidationStatus.ERR_MISSING_DATA\n",
    "        ]}\n",
    "\n",
    "        with s2_output:\n",
    "            print(f\"\\nüìä Validation Statistics:\")\n",
    "            print(f\"   ‚úÖ Perfect Match (folded):      {stats[ValidationStatus.VALID_PERFECT]}\")\n",
    "            print(f\"   üîµ Single Fuzzy (>=80%):       {stats[ValidationStatus.INFO_FUZZY_UNIQUE]}\")\n",
    "            print(f\"   ‚ö†Ô∏è  Name Mismatch:              {stats[ValidationStatus.WARN_NAME_MISMATCH]}\")\n",
    "            print(f\"   üü† Manual Select (<80%/multi): {stats[ValidationStatus.ERR_FUZZY_MULTIPLE]}\")\n",
    "            print(f\"   ‚ùå Not Found:                  {stats[ValidationStatus.ERR_NOT_FOUND]}\")\n",
    "            print(f\"   ‚ùå Email Invalid:              {stats[ValidationStatus.ERR_EMAIL_INVALID]}\")\n",
    "            print(f\"   ‚ö™ Missing Data:               {stats[ValidationStatus.ERR_MISSING_DATA]}\")\n",
    "            print(f\"   üìå Total:                      {len(stage2_input_df)}\\n\")\n",
    "\n",
    "        # Build UI\n",
    "        ui_sections = []\n",
    "        stage2_ui_rows = {\n",
    "            'fuzzy_unique': [],\n",
    "            'fuzzy_multiple': [],\n",
    "            'mismatch': []\n",
    "        }\n",
    "\n",
    "        # Summary\n",
    "        summary_html = f\"\"\"\n",
    "        <div style='background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);\n",
    "                    padding: 20px; border-radius: 8px; color: white; margin-bottom: 20px;'>\n",
    "            <h2 style='margin: 0 0 10px 0;'>üîç Validation Results</h2>\n",
    "            <div style='display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px;'>\n",
    "                <div style='background: rgba(255,255,255,0.2); padding: 10px; border-radius: 5px; text-align: center;'>\n",
    "                    <div style='font-size: 24px; font-weight: bold;'>{stats[ValidationStatus.VALID_PERFECT]}</div>\n",
    "                    <div>‚úÖ Perfect (Auto)</div>\n",
    "                </div>\n",
    "                <div style='background: rgba(52,199,89,0.3); padding: 10px; border-radius: 5px; text-align: center;'>\n",
    "                    <div style='font-size: 24px; font-weight: bold;'>{stats[ValidationStatus.INFO_FUZZY_UNIQUE]}</div>\n",
    "                    <div>üîµ Single</div>\n",
    "                </div>\n",
    "                <div style='background: rgba(255,149,0,0.3); padding: 10px; border-radius: 5px; text-align: center;'>\n",
    "                    <div style='font-size: 24px; font-weight: bold;'>{stats[ValidationStatus.ERR_FUZZY_MULTIPLE]}</div>\n",
    "                    <div>üü† Multiple</div>\n",
    "                </div>\n",
    "                <div style='background: rgba(255,152,0,0.3); padding: 10px; border-radius: 5px; text-align: center;'>\n",
    "                    <div style='font-size: 24px; font-weight: bold;'>{stats[ValidationStatus.WARN_NAME_MISMATCH]}</div>\n",
    "                    <div>‚ö†Ô∏è Mismatch</div>\n",
    "                </div>\n",
    "            </div>\n",
    "        </div>\n",
    "        \"\"\"\n",
    "        ui_sections.append(widgets.HTML(value=summary_html))\n",
    "\n",
    "        # Perfect matches (foldable accordion ‚Äî collapsed by default)\n",
    "        if stats[ValidationStatus.VALID_PERFECT] > 0:\n",
    "            perfect_rows_html = []\n",
    "            for item in stage2_categorized.get(ValidationStatus.VALID_PERFECT, []):\n",
    "                m = item['metadata']\n",
    "                ad = m.get('ad_user') or {}\n",
    "                dept = ad.get('dept', 'N/A')\n",
    "                active = 'Yes' if ad.get('active') else 'No'\n",
    "                perfect_rows_html.append(\n",
    "                    f\"<tr>\"\n",
    "                    f\"<td style='padding:6px 10px; border-bottom:1px solid #eee;'>{m['final_name']}</td>\"\n",
    "                    f\"<td style='padding:6px 10px; border-bottom:1px solid #eee;'>{m['final_email']}</td>\"\n",
    "                    f\"<td style='padding:6px 10px; border-bottom:1px solid #eee;'>{dept}</td>\"\n",
    "                    f\"<td style='padding:6px 10px; border-bottom:1px solid #eee;'>{active}</td>\"\n",
    "                    f\"</tr>\"\n",
    "                )\n",
    "            table_html = (\n",
    "                \"<div style='max-height:400px; overflow:auto;'>\"\n",
    "                \"<table style='width:100%; border-collapse:collapse;'>\"\n",
    "                \"<tr style='background:#e8f5e9; position:sticky; top:0;'>\"\n",
    "                \"<th style='padding:8px 10px; text-align:left; border-bottom:2px solid #4caf50;'>Name</th>\"\n",
    "                \"<th style='padding:8px 10px; text-align:left; border-bottom:2px solid #4caf50;'>Email</th>\"\n",
    "                \"<th style='padding:8px 10px; text-align:left; border-bottom:2px solid #4caf50;'>Department</th>\"\n",
    "                \"<th style='padding:8px 10px; text-align:left; border-bottom:2px solid #4caf50;'>AD Active</th>\"\n",
    "                \"</tr>\"\n",
    "                + ''.join(perfect_rows_html) +\n",
    "                \"</table></div>\"\n",
    "            )\n",
    "            accordion_content = widgets.HTML(value=table_html)\n",
    "            accordion = widgets.Accordion(children=[accordion_content])\n",
    "            accordion.set_title(0, f\"‚úÖ Perfect Match ({stats[ValidationStatus.VALID_PERFECT]} records ‚Äî auto-validated, click to expand)\")\n",
    "            accordion.selected_index = None  # Collapsed by default\n",
    "            ui_sections.append(accordion)\n",
    "\n",
    "        # Single fuzzy matches\n",
    "        if stats[ValidationStatus.INFO_FUZZY_UNIQUE] > 0:\n",
    "            ui_sections.append(widgets.HTML(value=\"\"\"\n",
    "                <h3 style='color: #34c759; border-bottom: 2px solid #34c759; padding-bottom: 5px;'>\n",
    "                    üîµ Single Match (Auto-Selected)\n",
    "                </h3>\n",
    "            \"\"\"))\n",
    "\n",
    "            for item in stage2_categorized.get(ValidationStatus.INFO_FUZZY_UNIQUE, []):\n",
    "                row_ui = create_fuzzy_unique_row(item['index'], item['row'], item['metadata'])\n",
    "                stage2_ui_rows['fuzzy_unique'].append(row_ui)\n",
    "                ui_sections.append(row_ui['row'])\n",
    "\n",
    "        # Multiple fuzzy matches\n",
    "        if stats[ValidationStatus.ERR_FUZZY_MULTIPLE] > 0:\n",
    "            ui_sections.append(widgets.HTML(value=\"\"\"\n",
    "                <h3 style='color: #ff9500; border-bottom: 2px solid #ff9500; padding-bottom: 5px; margin-top: 30px;'>\n",
    "                    üü† Multiple Matches - Select One\n",
    "                </h3>\n",
    "            \"\"\"))\n",
    "\n",
    "            for item in stage2_categorized.get(ValidationStatus.ERR_FUZZY_MULTIPLE, []):\n",
    "                row_ui = create_fuzzy_multiple_row(item['index'], item['row'], item['metadata'])\n",
    "                stage2_ui_rows['fuzzy_multiple'].append(row_ui)\n",
    "                ui_sections.append(row_ui['row'])\n",
    "\n",
    "        # Name mismatches\n",
    "        if stats[ValidationStatus.WARN_NAME_MISMATCH] > 0:\n",
    "            ui_sections.append(widgets.HTML(value=\"\"\"\n",
    "                <h3 style='color: #ff9800; border-bottom: 2px solid #ff9800; padding-bottom: 5px; margin-top: 30px;'>\n",
    "                    ‚ö†Ô∏è Name Mismatch - Review\n",
    "                </h3>\n",
    "            \"\"\"))\n",
    "\n",
    "            for item in stage2_categorized.get(ValidationStatus.WARN_NAME_MISMATCH, []):\n",
    "                row_ui = create_mismatch_row(item['index'], item['row'], item['metadata'])\n",
    "                stage2_ui_rows['mismatch'].append(row_ui)\n",
    "                ui_sections.append(row_ui['row'])\n",
    "\n",
    "        # Save button\n",
    "        ui_sections.append(widgets.HTML(value=\"<hr style='margin: 30px 0;'>\"))\n",
    "        ui_sections.append(widgets.HBox([s2_btn_save]))\n",
    "\n",
    "        # Display UI\n",
    "        with s2_output:\n",
    "            display(widgets.VBox(ui_sections))\n",
    "\n",
    "        s2_btn_save.disabled = False\n",
    "        s2_status.value = f\"<span style='color:green;'>‚úÖ Validation complete</span>\"\n",
    "\n",
    "    except Exception as e:\n",
    "        with s2_output:\n",
    "            print(f\"\\n‚ùå Error: {str(e)}\")\n",
    "        s2_status.value = f\"<span style='color:red;'>‚ùå Error: {str(e)}</span>\"\n",
    "    finally:\n",
    "        b.disabled = False\n",
    "\n",
    "\n",
    "# ============================================\n",
    "# Save Function\n",
    "# ============================================\n",
    "\n",
    "def do_save(b):\n",
    "    \"\"\"Save validated file\"\"\"\n",
    "    if stage2_input_df is None:\n",
    "        print(\"‚ùå No data to save\")\n",
    "        return\n",
    "\n",
    "    b.disabled = True\n",
    "\n",
    "    try:\n",
    "        print(\"\\nüíæ Saving validated file...\")\n",
    "\n",
    "        validated_rows = []\n",
    "        skipped_count = 0\n",
    "        deleted_count = 0\n",
    "\n",
    "        def _ad_fields(email_key):\n",
    "            \"\"\"Look up Department and is_AD_active from AD cache\"\"\"\n",
    "            if email_key and email_key in stage2_ad_cache:\n",
    "                ad = stage2_ad_cache[email_key]\n",
    "                return ad.get('dept', ''), 'Yes' if ad.get('active') else 'No'\n",
    "            return '', ''\n",
    "\n",
    "        # 1. Perfect matches (folded)\n",
    "        for item in stage2_categorized.get(ValidationStatus.VALID_PERFECT, []):\n",
    "            row_data = item['row'].to_dict()\n",
    "            metadata = item['metadata']\n",
    "            row_data['Email'] = metadata['final_email']\n",
    "            row_data['User Name'] = metadata['final_name']\n",
    "            row_data['Department'], row_data['is_AD_active'] = _ad_fields(metadata['final_email'])\n",
    "            row_data['Validation Status'] = ValidationStatus.get_display_text(ValidationStatus.VALID_PERFECT)\n",
    "            validated_rows.append(row_data)\n",
    "\n",
    "        # 2. Single fuzzy matches (>= 80%)\n",
    "        for row_ui in stage2_ui_rows['fuzzy_unique']:\n",
    "            if row_ui.get('deleted'):\n",
    "                deleted_count += 1\n",
    "                continue\n",
    "            item = stage2_categorized[ValidationStatus.INFO_FUZZY_UNIQUE][stage2_ui_rows['fuzzy_unique'].index(row_ui)]\n",
    "            row_data = item['row'].to_dict()\n",
    "            row_data['Email'] = row_ui['selected_email']\n",
    "            row_data['User Name'] = row_ui['selected_name']\n",
    "            row_data['Department'], row_data['is_AD_active'] = _ad_fields(row_ui['selected_email'])\n",
    "            row_data['Validation Status'] = ValidationStatus.get_display_text(ValidationStatus.INFO_FUZZY_UNIQUE)\n",
    "            validated_rows.append(row_data)\n",
    "\n",
    "        # 3. Multiple fuzzy matches / low-confidence singles\n",
    "        for row_ui in stage2_ui_rows['fuzzy_multiple']:\n",
    "            if row_ui.get('deleted'):\n",
    "                deleted_count += 1\n",
    "                continue\n",
    "            item = stage2_categorized[ValidationStatus.ERR_FUZZY_MULTIPLE][stage2_ui_rows['fuzzy_multiple'].index(row_ui)]\n",
    "            row_data = item['row'].to_dict()\n",
    "\n",
    "            selected = row_ui['dropdown'].value\n",
    "            is_manual = (selected == 'MANUAL')\n",
    "\n",
    "            if is_manual:\n",
    "                selected = row_ui['manual_input'].value.strip().lower()\n",
    "\n",
    "            if selected:\n",
    "                found = False\n",
    "                for match in row_ui['metadata']['fuzzy_matches']:\n",
    "                    if match['email'] == selected:\n",
    "                        row_data['Email'] = match['email']\n",
    "                        row_data['User Name'] = match['name']\n",
    "                        found = True\n",
    "                        break\n",
    "\n",
    "                if is_manual and not found:\n",
    "                    row_data['Email'] = selected\n",
    "                    if selected in stage2_ad_cache:\n",
    "                        row_data['User Name'] = stage2_ad_cache[selected]['name']\n",
    "\n",
    "                row_data['Department'], row_data['is_AD_active'] = _ad_fields(selected)\n",
    "                row_data['Validation Status'] = \"üîß Manually Resolved\" if is_manual else ValidationStatus.get_display_text(ValidationStatus.ERR_FUZZY_MULTIPLE)\n",
    "                validated_rows.append(row_data)\n",
    "            else:\n",
    "                # User didn't select anything ‚Äî still include with warning\n",
    "                row_data['Department'] = ''\n",
    "                row_data['is_AD_active'] = ''\n",
    "                row_data['Validation Status'] = \"‚ö†Ô∏è Unresolved (No Selection Made)\"\n",
    "                validated_rows.append(row_data)\n",
    "                skipped_count += 1\n",
    "\n",
    "        # 4. Name mismatches\n",
    "        for row_ui in stage2_ui_rows['mismatch']:\n",
    "            if row_ui.get('deleted'):\n",
    "                deleted_count += 1\n",
    "                continue\n",
    "            item = stage2_categorized[ValidationStatus.WARN_NAME_MISMATCH][stage2_ui_rows['mismatch'].index(row_ui)]\n",
    "            row_data = item['row'].to_dict()\n",
    "            metadata = row_ui['metadata']\n",
    "\n",
    "            if row_ui['accept_checkbox'].value:\n",
    "                row_data['Email'] = metadata['final_email']\n",
    "                row_data['User Name'] = metadata['final_name']\n",
    "                row_data['Validation Status'] = \"‚úÖ Name Mismatch Resolved (AD Name)\"\n",
    "            else:\n",
    "                row_data['Email'] = metadata['final_email']\n",
    "                row_data['User Name'] = metadata['original_name']\n",
    "                row_data['Validation Status'] = \"‚ö†Ô∏è Name Mismatch (Kept Original)\"\n",
    "\n",
    "            row_data['Department'], row_data['is_AD_active'] = _ad_fields(metadata['final_email'])\n",
    "            validated_rows.append(row_data)\n",
    "\n",
    "        # 5. Errors (included with empty AD fields)\n",
    "        for status in [ValidationStatus.ERR_NOT_FOUND, ValidationStatus.ERR_EMAIL_INVALID, ValidationStatus.ERR_MISSING_DATA]:\n",
    "            for item in stage2_categorized.get(status, []):\n",
    "                row_data = item['row'].to_dict()\n",
    "                row_data['Department'] = ''\n",
    "                row_data['is_AD_active'] = ''\n",
    "                row_data['Validation Status'] = ValidationStatus.get_display_text(status)\n",
    "                validated_rows.append(row_data)\n",
    "\n",
    "        # Warn about unresolved/deleted rows\n",
    "        if skipped_count > 0:\n",
    "            print(f\"‚ö†Ô∏è  {skipped_count} rows had no selection ‚Äî marked as 'Unresolved'\")\n",
    "        if deleted_count > 0:\n",
    "            print(f\"üóëÔ∏è  {deleted_count} rows deleted by user ‚Äî excluded from output\")\n",
    "\n",
    "        # Create output\n",
    "        output_df = pd.DataFrame(validated_rows)\n",
    "        priority_cols = ['Validation Status', 'Email', 'User Name', 'Department', 'is_AD_active']\n",
    "        other_cols = [c for c in output_df.columns if c not in priority_cols]\n",
    "        cols = priority_cols + other_cols\n",
    "        cols = [c for c in cols if c in output_df.columns]\n",
    "        output_df = output_df[cols]\n",
    "\n",
    "        # Save\n",
    "        base_name = stage2_input_filename.replace('.csv', '').replace('.xlsx', '')\n",
    "        date_str = datetime.now().strftime('%Y%m%d')\n",
    "        output_filename = f\"{base_name}_validated_{date_str}.xlsx\"\n",
    "        output_path = os.path.join(STAGE2_DIR, output_filename)\n",
    "\n",
    "        output_df.to_excel(output_path, index=False, sheet_name='Validated')\n",
    "\n",
    "        print(f\"\\n‚úÖ Saved: {output_path}\")\n",
    "        print(f\"   Rows: {len(output_df)}\")\n",
    "        print(f\"   Columns: {list(output_df.columns)}\")\n",
    "\n",
    "        s2_status.value = f\"<span style='color:blue;'>‚úÖ Saved: {output_filename}</span>\"\n",
    "\n",
    "    except Exception as e:\n",
    "        print(f\"\\n‚ùå Save error: {str(e)}\")\n",
    "        s2_status.value = f\"<span style='color:red;'>‚ùå Error: {str(e)}</span>\"\n",
    "    finally:\n",
    "        b.disabled = False\n",
    "\n",
    "\n",
    "# ============================================\n",
    "# UI Setup\n",
    "# ============================================\n",
    "\n",
    "s2_upload = widgets.FileUpload(\n",
    "    accept='.xlsx, .csv',\n",
    "    description=\"Upload File\",\n",
    "    button_style='info'\n",
    ")\n",
    "s2_upload_status = widgets.HTML(value=\"<i>No file selected</i>\")\n",
    "s2_btn_validate = widgets.Button(\n",
    "    description=\"üîç Validate\",\n",
    "    button_style='warning',\n",
    "    layout=widgets.Layout(width='140px', height='40px'),\n",
    "    disabled=True\n",
    ")\n",
    "s2_btn_save = widgets.Button(\n",
    "    description=\"üíæ Save\",\n",
    "    button_style='success',\n",
    "    layout=widgets.Layout(width='140px', height='40px'),\n",
    "    disabled=True\n",
    ")\n",
    "s2_status = widgets.HTML(value=\"<i>Loading AD cache...</i>\")\n",
    "s2_output = widgets.Output()\n",
    "\n",
    "# Event handlers\n",
    "def on_upload_change(change):\n",
    "    if s2_upload.value:\n",
    "        fname = s2_upload.value[0]['name']\n",
    "        s2_upload_status.value = f\"<b style='color:green;'>‚úÖ {fname}</b>\"\n",
    "        s2_btn_validate.disabled = False\n",
    "\n",
    "s2_upload.observe(on_upload_change, 'value')\n",
    "s2_btn_validate.on_click(do_validation)\n",
    "s2_btn_save.on_click(do_save)\n",
    "\n",
    "# Initialize\n",
    "success, msg = load_ad_cache()\n",
    "if success:\n",
    "    s2_status.value = f\"<span style='color:green;'>‚úÖ {msg}</span>\"\n",
    "else:\n",
    "    s2_status.value = f\"<span style='color:red;'>‚ö†Ô∏è {msg}</span>\"\n",
    "\n",
    "# Main UI\n",
    "stage2_ui = widgets.VBox([\n",
    "    widgets.HTML(\"\"\"\n",
    "        <div style='background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);\n",
    "                    padding: 20px; border-radius: 8px; color: white; margin-bottom: 20px;'>\n",
    "            <h2 style='margin: 0 0 10px 0;'>üîç Stage 2: Email/User Validation</h2>\n",
    "            <p style='margin: 0;'>Upload user list, validate against AD, resolve mismatches</p>\n",
    "        </div>\n",
    "    \"\"\"),\n",
    "    widgets.HBox([s2_upload, s2_upload_status]),\n",
    "    widgets.HBox([s2_btn_validate, s2_btn_save]),\n",
    "    s2_status,\n",
    "    s2_output\n",
    "])\n",
    "\n",
    "clear_output()\n",
    "display(stage2_ui)\n",
    "\n",
    "print(\"=\"*60)\n",
    "print(\"Stage 2 UI Ready\")\n",
    "print(\"=\"*60)\n"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "metadata": {},
   "outputs": [],
   "source": [
    "#!/usr/bin/env python3\n",
    "\"\"\"\n",
    "Stage 3: Reviewer Assignment with Complete Columns (v3.0 FINAL)\n",
    "\n",
    "Complete output columns:\n",
    "1. All input columns (preserved)\n",
    "2. Reviewer (email from mapping)\n",
    "3. Manual Review (Yes if email match, empty if dept match)\n",
    "4. Reviewer's Response (dropdown: Approved/Denied/Changes Required)\n",
    "5. Details of Access Change (free text for reviewer to fill)\n",
    "\n",
    "Matching logic:\n",
    "- Email exact match ‚Üí Fill reviewer + Mark \"Manual Review\" = \"Yes\"\n",
    "- Department contains match ‚Üí Fill reviewer, no manual review mark\n",
    "- Keep all input columns clean (no text pollution)\n",
    "\n",
    "Usage in Jupyter:\n",
    "    1. Run this cell\n",
    "    2. Upload validated file from Stage 2\n",
    "    3. Upload or use default mapping file\n",
    "    4. Click \"Assign Reviewers\"\n",
    "    5. Review assignments\n",
    "    6. Click \"Save Final Review\"\n",
    "\"\"\"\n",
    "\n",
    "import os, sys, logging, glob, io\n",
    "import pandas as pd\n",
    "import ipywidgets as widgets\n",
    "from datetime import datetime\n",
    "from openpyxl import load_workbook\n",
    "from openpyxl.worksheet.datavalidation import DataValidation\n",
    "from openpyxl.utils import get_column_letter\n",
    "from IPython.display import display, HTML, clear_output\n",
    "\n",
    "# ============================================\n",
    "# Setup Paths\n",
    "# ============================================\n",
    "\n",
    "today_str = datetime.now().strftime('%Y-%m-%d')\n",
    "BASE_DIR = os.path.join(\"output\", today_str)\n",
    "STAGE2_DIR = os.path.join(BASE_DIR, \"stage2_validated\")\n",
    "STAGE3_DIR = os.path.join(BASE_DIR, \"stage3_review\")\n",
    "MAPPING_DIR = os.path.join(\"input\", \"mapping\")\n",
    "LOG_DIR = os.path.join(BASE_DIR, \"logs\")\n",
    "os.makedirs(STAGE3_DIR, exist_ok=True)\n",
    "\n",
    "# ============================================\n",
    "# Logging\n",
    "# ============================================\n",
    "\n",
    "log_file = os.path.join(LOG_DIR, f\"aer_stage3_{datetime.now().strftime('%Y%m%d_%H%M')}.log\")\n",
    "logger_s3 = logging.getLogger(\"aer_stage3\")\n",
    "logger_s3.handlers.clear()\n",
    "logger_s3.setLevel(logging.INFO)\n",
    "formatter = logging.Formatter('%(asctime)s | %(levelname)s | %(message)s')\n",
    "fh = logging.FileHandler(log_file, encoding=\"utf-8\")\n",
    "fh.setFormatter(formatter)\n",
    "logger_s3.addHandler(fh)\n",
    "logger_s3.addHandler(logging.StreamHandler(sys.stdout))\n",
    "\n",
    "# ============================================\n",
    "# Global State\n",
    "# ============================================\n",
    "\n",
    "stage3_input_df = None\n",
    "stage3_mapping_df = None\n",
    "stage3_final_df = None\n",
    "stage3_input_filename = \"\"\n",
    "\n",
    "# ============================================\n",
    "# UI Components\n",
    "# ============================================\n",
    "\n",
    "s3_upload = widgets.FileUpload(\n",
    "    accept='.xlsx, .csv',\n",
    "    description=\"Upload Validated File\",\n",
    "    button_style='info',\n",
    "    layout=widgets.Layout(width='250px')\n",
    ")\n",
    "s3_upload_status = widgets.HTML(value=\"<i>No file selected</i>\")\n",
    "\n",
    "s3_upload_map = widgets.FileUpload(\n",
    "    accept='.csv',\n",
    "    description=\"Mapping File\",\n",
    "    button_style='info',\n",
    "    layout=widgets.Layout(width='250px')\n",
    ")\n",
    "s3_map_status = widgets.HTML(value=\"<i>Will use default mapping if available</i>\")\n",
    "\n",
    "s3_btn_assign = widgets.Button(\n",
    "    description=\"‚öôÔ∏è Assign Reviewers\",\n",
    "    button_style='warning',\n",
    "    layout=widgets.Layout(width='180px', height='40px'),\n",
    "    disabled=True\n",
    ")\n",
    "s3_btn_save = widgets.Button(\n",
    "    description=\"üíæ Save Final Review\",\n",
    "    button_style='success',\n",
    "    layout=widgets.Layout(width='180px', height='40px'),\n",
    "    disabled=True\n",
    ")\n",
    "s3_status = widgets.HTML(value=\"<i>Please upload validated file from Stage 2</i>\")\n",
    "s3_output = widgets.Output()\n",
    "\n",
    "# ============================================\n",
    "# Helper Functions\n",
    "# ============================================\n",
    "\n",
    "def get_latest_mapping():\n",
    "    \"\"\"Get latest mapping file from default location\"\"\"\n",
    "    try:\n",
    "        files = glob.glob(os.path.join(MAPPING_DIR, \"*.csv\"))\n",
    "        if not files:\n",
    "            files = glob.glob(os.path.join(MAPPING_DIR, \"**\", \"*.csv\"), recursive=True)\n",
    "        return max(files, key=os.path.getmtime) if files else None\n",
    "    except:\n",
    "        return None\n",
    "\n",
    "\n",
    "def detect_column(df, candidates):\n",
    "    \"\"\"Detect column by name matching\"\"\"\n",
    "    cols_lower = {str(c).lower().strip(): c for c in df.columns}\n",
    "\n",
    "    for cand in candidates:\n",
    "        for col_key, col_actual in cols_lower.items():\n",
    "            if cand in col_key:\n",
    "                return col_actual\n",
    "    return None\n",
    "\n",
    "\n",
    "def assign_reviewers(input_df, mapping_df):\n",
    "    \"\"\"\n",
    "    Assign reviewers based on email/department mapping\n",
    "\n",
    "    Args:\n",
    "        input_df: Input DataFrame (must have 'Email', 'Department' columns)\n",
    "        mapping_df: Mapping DataFrame with columns:\n",
    "            - email: User email for exact matching (optional)\n",
    "            - department: Department name/substring\n",
    "            - reviewer: Reviewer email to assign\n",
    "\n",
    "    Returns:\n",
    "        DataFrame with:\n",
    "        - All input columns (preserved)\n",
    "        - Reviewer (email)\n",
    "        - Manual Review (Yes if email match, empty otherwise)\n",
    "        - Reviewer's Response (empty, for dropdown)\n",
    "        - Details of Access Change (empty, for free text)\n",
    "    \"\"\"\n",
    "\n",
    "    # Detect mapping columns\n",
    "    map_cols = {\n",
    "        'email': detect_column(mapping_df, ['email', 'mail']),\n",
    "        'department': detect_column(mapping_df, ['department', 'dept']),\n",
    "        'reviewer': detect_column(mapping_df, ['reviewer', 'owner', 'manager'])\n",
    "    }\n",
    "\n",
    "    if not map_cols['department'] or not map_cols['reviewer']:\n",
    "        raise ValueError(\n",
    "            f\"Mapping file must have 'department' and 'reviewer' columns. \"\n",
    "            f\"Found: {list(mapping_df.columns)}\"\n",
    "        )\n",
    "\n",
    "    # Build mapping dictionaries\n",
    "    email_map = {}\n",
    "    dept_map = {}\n",
    "\n",
    "    # Email mapping (if email column exists)\n",
    "    if map_cols['email']:\n",
    "        for _, row in mapping_df.iterrows():\n",
    "            email_key = str(row[map_cols['email']]).lower().strip()\n",
    "            if email_key and email_key not in ['nan', 'none', '*']:\n",
    "                email_map[email_key] = str(row[map_cols['reviewer']]).strip()\n",
    "\n",
    "    # Department mapping\n",
    "    for _, row in mapping_df.iterrows():\n",
    "        dept_key = str(row[map_cols['department']]).lower().strip()\n",
    "        if dept_key and dept_key != 'nan':\n",
    "            dept_map[dept_key] = str(row[map_cols['reviewer']]).strip()\n",
    "\n",
    "    print(f\"üìä Loaded mapping:\")\n",
    "    print(f\"   Email mappings: {len(email_map)}\")\n",
    "    print(f\"   Dept mappings: {len(dept_map)}\\n\")\n",
    "\n",
    "    # Create output DataFrame (copy all input columns)\n",
    "    output_df = input_df.copy()\n",
    "    output_df['Reviewer'] = ''\n",
    "    output_df['Manual Review'] = ''\n",
    "    output_df['Reviewer\\'s Response'] = ''\n",
    "    output_df['Details of Access Change'] = ''\n",
    "\n",
    "    # Statistics\n",
    "    stats = {'email_match': 0, 'dept_match': 0, 'no_match': 0}\n",
    "\n",
    "    # Process each user\n",
    "    for idx, row in output_df.iterrows():\n",
    "        user_email = str(row.get('Email', '')).lower().strip()\n",
    "        user_dept = str(row.get('Department', '')).strip()\n",
    "\n",
    "        reviewer_assigned = None\n",
    "        is_manual_review = False\n",
    "\n",
    "        # Priority 1: Email exact match ‚Üí Manual Review = Yes\n",
    "        if user_email and user_email != 'nan' and user_email in email_map:\n",
    "            reviewer_assigned = email_map[user_email]\n",
    "            is_manual_review = True\n",
    "            stats['email_match'] += 1\n",
    "\n",
    "        # Priority 2: Department contains match ‚Üí Auto assign\n",
    "        elif user_dept and user_dept not in ['N/A', 'nan', '']:\n",
    "            user_dept_lower = user_dept.lower()\n",
    "\n",
    "            # Try exact match first\n",
    "            if user_dept_lower in dept_map:\n",
    "                reviewer_assigned = dept_map[user_dept_lower]\n",
    "                stats['dept_match'] += 1\n",
    "            else:\n",
    "                # Try contains logic\n",
    "                # Example: input=\"corporate 123 - finance\", mapping=\"finance\" ‚Üí MATCH\n",
    "                for map_dept_key, map_reviewer in dept_map.items():\n",
    "                    if map_dept_key in user_dept_lower:\n",
    "                        reviewer_assigned = map_reviewer\n",
    "                        stats['dept_match'] += 1\n",
    "                        break\n",
    "\n",
    "        # Assign results\n",
    "        if reviewer_assigned:\n",
    "            output_df.at[idx, 'Reviewer'] = reviewer_assigned\n",
    "            output_df.at[idx, 'Manual Review'] = 'Yes' if is_manual_review else ''\n",
    "        else:\n",
    "            stats['no_match'] += 1\n",
    "\n",
    "    # Print statistics\n",
    "    print(f\"üìà Assignment Results:\")\n",
    "    print(f\"   Email Match (Manual Review): {stats['email_match']}\")\n",
    "    print(f\"   Dept Match (Auto):           {stats['dept_match']}\")\n",
    "    print(f\"   No Match:                    {stats['no_match']}\")\n",
    "    print(f\"   Total:                       {len(output_df)}\\n\")\n",
    "\n",
    "    return output_df\n",
    "\n",
    "\n",
    "def save_with_validation(df, output_path):\n",
    "    \"\"\"\n",
    "    Save DataFrame to Excel with data validation for dropdown columns\n",
    "\n",
    "    Dropdowns:\n",
    "    - Manual Review: Yes/No\n",
    "    - Reviewer's Response: Approved/Denied/Changes Required\n",
    "    \"\"\"\n",
    "\n",
    "    # Save to Excel\n",
    "    df.to_excel(output_path, index=False, sheet_name='Review')\n",
    "\n",
    "    # Add data validation\n",
    "    wb = load_workbook(output_path)\n",
    "    ws = wb.active\n",
    "\n",
    "    # Find columns\n",
    "    col_indices = {}\n",
    "    for i, col_name in enumerate(df.columns, 1):\n",
    "        col_str = str(col_name)\n",
    "        if col_str == 'Manual Review':\n",
    "            col_indices['manual_review'] = i\n",
    "        elif col_str == 'Reviewer\\'s Response':\n",
    "            col_indices['reviewer_response'] = i\n",
    "\n",
    "    # Manual Review dropdown (Yes/No)\n",
    "    if 'manual_review' in col_indices:\n",
    "        dv = DataValidation(\n",
    "            type=\"list\",\n",
    "            formula1='\"Yes,No\"',\n",
    "            allow_blank=True\n",
    "        )\n",
    "        dv.promptTitle = \"Manual Review Status\"\n",
    "        dv.prompt = \"Select Yes if this assignment requires manual review\"\n",
    "        dv.showInputMessage = True\n",
    "\n",
    "        ws.add_data_validation(dv)\n",
    "        letter = get_column_letter(col_indices['manual_review'])\n",
    "        dv.add(f\"{letter}2:{letter}{len(df)+1}\")\n",
    "\n",
    "    # Reviewer's Response dropdown (Approved/Denied/Changes Required)\n",
    "    if 'reviewer_response' in col_indices:\n",
    "        dv = DataValidation(\n",
    "            type=\"list\",\n",
    "            formula1='\"Approved,Denied,Changes Required\"',\n",
    "            allow_blank=True\n",
    "        )\n",
    "        dv.promptTitle = \"Reviewer's Response\"\n",
    "        dv.prompt = \"Select the review decision\"\n",
    "        dv.showInputMessage = True\n",
    "        dv.errorTitle = \"Invalid Selection\"\n",
    "        dv.error = \"Please select a valid option from the dropdown\"\n",
    "        dv.showErrorMessage = True\n",
    "\n",
    "        ws.add_data_validation(dv)\n",
    "        letter = get_column_letter(col_indices['reviewer_response'])\n",
    "        dv.add(f\"{letter}2:{letter}{len(df)+1}\")\n",
    "\n",
    "    wb.save(output_path)\n",
    "    print(f\"‚úÖ Added dropdown validation for:\")\n",
    "    if 'manual_review' in col_indices:\n",
    "        print(f\"   - Manual Review (Yes/No)\")\n",
    "    if 'reviewer_response' in col_indices:\n",
    "        print(f\"   - Reviewer's Response (Approved/Denied/Changes Required)\")\n",
    "    print()\n",
    "\n",
    "# ============================================\n",
    "# Event Handlers\n",
    "# ============================================\n",
    "\n",
    "def on_s3_upload_change(change):\n",
    "    \"\"\"Handle input file upload\"\"\"\n",
    "    if s3_upload.value and len(s3_upload.value) > 0:\n",
    "        fname = s3_upload.value[0]['name']\n",
    "        s3_upload_status.value = f\"<b style='color:green;'>‚úÖ Selected: {fname}</b>\"\n",
    "        s3_btn_assign.disabled = False\n",
    "\n",
    "\n",
    "def on_s3_map_change(change):\n",
    "    \"\"\"Handle mapping file upload\"\"\"\n",
    "    if s3_upload_map.value and len(s3_upload_map.value) > 0:\n",
    "        fname = s3_upload_map.value[0]['name']\n",
    "        s3_map_status.value = f\"<b style='color:green;'>‚úÖ Using: {fname}</b>\"\n",
    "\n",
    "\n",
    "def do_stage3_assign(b):\n",
    "    \"\"\"Assign reviewers based on mapping\"\"\"\n",
    "    global stage3_input_df, stage3_mapping_df, stage3_final_df, stage3_input_filename\n",
    "\n",
    "    s3_output.clear_output()\n",
    "\n",
    "    if not s3_upload.value:\n",
    "        with s3_output:\n",
    "            print(\"‚ùå Please upload a validated file from Stage 2\")\n",
    "        return\n",
    "\n",
    "    b.disabled = True\n",
    "\n",
    "    try:\n",
    "        with s3_output:\n",
    "            print(\"\\n\" + \"=\"*60)\n",
    "            print(\"‚öôÔ∏è Stage 3: Reviewer Assignment (Complete)\")\n",
    "            print(\"=\"*60 + \"\\n\")\n",
    "\n",
    "        # Load input file\n",
    "        f_item = s3_upload.value[0]\n",
    "        stage3_input_filename = f_item['name']\n",
    "\n",
    "        if stage3_input_filename.endswith('.csv'):\n",
    "            stage3_input_df = pd.read_csv(io.BytesIO(f_item['content']))\n",
    "        else:\n",
    "            stage3_input_df = pd.read_excel(io.BytesIO(f_item['content']))\n",
    "\n",
    "        logger_s3.info(f\"Loaded input: {stage3_input_filename}, {len(stage3_input_df)} rows\")\n",
    "\n",
    "        with s3_output:\n",
    "            print(f\"üìÑ Input file: {stage3_input_filename}\")\n",
    "            print(f\"   Rows: {len(stage3_input_df)}\")\n",
    "            print(f\"   Columns: {list(stage3_input_df.columns)}\\n\")\n",
    "\n",
    "        # Validate required columns\n",
    "        if 'Email' not in stage3_input_df.columns:\n",
    "            with s3_output:\n",
    "                print(f\"‚ùå Input file missing 'Email' column\")\n",
    "                print(f\"   Available: {list(stage3_input_df.columns)}\")\n",
    "            b.disabled = False\n",
    "            return\n",
    "\n",
    "        if 'Department' not in stage3_input_df.columns:\n",
    "            with s3_output:\n",
    "                print(\"‚ö†Ô∏è  Warning: 'Department' column not found. Adding placeholder.\")\n",
    "            stage3_input_df['Department'] = 'N/A'\n",
    "\n",
    "        # Load mapping file\n",
    "        map_src = None\n",
    "        map_name = \"\"\n",
    "\n",
    "        if s3_upload_map.value and len(s3_upload_map.value) > 0:\n",
    "            map_src = io.BytesIO(s3_upload_map.value[0]['content'])\n",
    "            map_name = s3_upload_map.value[0]['name']\n",
    "        else:\n",
    "            default_map = get_latest_mapping()\n",
    "            if default_map:\n",
    "                map_src = default_map\n",
    "                map_name = os.path.basename(default_map)\n",
    "\n",
    "        if not map_src:\n",
    "            with s3_output:\n",
    "                print(\"‚ùå No mapping file found\")\n",
    "                print(f\"   Upload a mapping file or place one in: {MAPPING_DIR}\")\n",
    "            s3_status.value = \"<span style='color:red;'>‚ùå Mapping file required</span>\"\n",
    "            b.disabled = False\n",
    "            return\n",
    "\n",
    "        stage3_mapping_df = pd.read_csv(map_src)\n",
    "\n",
    "        with s3_output:\n",
    "            print(f\"üìã Mapping file: {map_name}\")\n",
    "            print(f\"   Rows: {len(stage3_mapping_df)}\")\n",
    "            print(f\"   Columns: {list(stage3_mapping_df.columns)}\\n\")\n",
    "\n",
    "        logger_s3.info(f\"Loaded mapping: {map_name}, {len(stage3_mapping_df)} rows\")\n",
    "\n",
    "        # Assign reviewers\n",
    "        with s3_output:\n",
    "            print(\"=\"*60)\n",
    "            print(\"üîç Assigning Reviewers\")\n",
    "            print(\"=\"*60 + \"\\n\")\n",
    "\n",
    "        stage3_final_df = assign_reviewers(stage3_input_df, stage3_mapping_df)\n",
    "\n",
    "        # Preview results\n",
    "        with s3_output:\n",
    "            print(\"=\"*60)\n",
    "            print(\"üìä Preview (first 5 rows)\")\n",
    "            print(\"=\"*60)\n",
    "            preview_cols = ['Email', 'Department', 'Reviewer', 'Manual Review']\n",
    "            available_cols = [c for c in preview_cols if c in stage3_final_df.columns]\n",
    "            print(stage3_final_df[available_cols].head())\n",
    "            print()\n",
    "\n",
    "        s3_btn_save.disabled = False\n",
    "        s3_status.value = f\"<span style='color:green;'>‚úÖ Assignment complete: {len(stage3_final_df)} users ready</span>\"\n",
    "        logger_s3.info(f\"Assignment complete: {len(stage3_final_df)} rows\")\n",
    "\n",
    "    except Exception as e:\n",
    "        with s3_output:\n",
    "            print(f\"\\n‚ùå Error: {str(e)}\")\n",
    "        logger_s3.error(f\"Assignment error: {str(e)}\", exc_info=True)\n",
    "        s3_status.value = f\"<span style='color:red;'>‚ùå Error: {str(e)}</span>\"\n",
    "    finally:\n",
    "        b.disabled = False\n",
    "\n",
    "\n",
    "def do_stage3_save(b):\n",
    "    \"\"\"Save final review file with dropdowns\"\"\"\n",
    "    if stage3_final_df is None:\n",
    "        with s3_output:\n",
    "            print(\"‚ùå No data to save. Please assign reviewers first.\")\n",
    "        return\n",
    "\n",
    "    b.disabled = True\n",
    "\n",
    "    try:\n",
    "        with s3_output:\n",
    "            print(\"\\n\" + \"=\"*60)\n",
    "            print(\"üíæ Saving Final Review File\")\n",
    "            print(\"=\"*60 + \"\\n\")\n",
    "\n",
    "        # Generate filename\n",
    "        base_name = stage3_input_filename.replace('.csv', '').replace('.xlsx', '').replace('_AD_verified', '')\n",
    "        timestamp = datetime.now().strftime('%Y%m%d_%H%M')\n",
    "        output_filename = f\"{base_name}_review_{timestamp}.xlsx\"\n",
    "        output_path = os.path.join(STAGE3_DIR, output_filename)\n",
    "\n",
    "        # Save with validation\n",
    "        save_with_validation(stage3_final_df, output_path)\n",
    "\n",
    "        with s3_output:\n",
    "            print(f\"‚úÖ Saved to: {output_path}\")\n",
    "            print(f\"   Rows: {len(stage3_final_df)}\")\n",
    "            print(f\"   Columns: {list(stage3_final_df.columns)}\")\n",
    "            print(\"=\"*60)\n",
    "\n",
    "        s3_status.value = f\"<span style='color:blue;'>‚úÖ Saved: {output_filename}</span>\"\n",
    "        logger_s3.info(f\"Saved review file: {output_path}\")\n",
    "\n",
    "    except Exception as e:\n",
    "        with s3_output:\n",
    "            print(f\"\\n‚ùå Save error: {str(e)}\")\n",
    "        logger_s3.error(f\"Save error: {str(e)}\", exc_info=True)\n",
    "        s3_status.value = f\"<span style='color:red;'>‚ùå Save error: {str(e)}</span>\"\n",
    "    finally:\n",
    "        b.disabled = False\n",
    "\n",
    "# ============================================\n",
    "# Bind Events\n",
    "# ============================================\n",
    "\n",
    "s3_upload.observe(on_s3_upload_change, 'value')\n",
    "s3_upload_map.observe(on_s3_map_change, 'value')\n",
    "s3_btn_assign.on_click(do_stage3_assign)\n",
    "s3_btn_save.on_click(do_stage3_save)\n",
    "\n",
    "# ============================================\n",
    "# Initialize: Check for default mapping\n",
    "# ============================================\n",
    "\n",
    "default_map = get_latest_mapping()\n",
    "if default_map:\n",
    "    s3_map_status.value = f\"<b style='color:green;'>‚úÖ Default: {os.path.basename(default_map)}</b>\"\n",
    "    logger_s3.info(f\"Default mapping found: {os.path.basename(default_map)}\")\n",
    "else:\n",
    "    s3_map_status.value = f\"<i>No default mapping found in {MAPPING_DIR}</i>\"\n",
    "    logger_s3.warning(f\"No default mapping found\")\n",
    "\n",
    "# ============================================\n",
    "# UI Layout\n",
    "# ============================================\n",
    "\n",
    "stage3_ui = widgets.VBox([\n",
    "    widgets.HTML(\"\"\"\n",
    "        <div style='\n",
    "            background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);\n",
    "            padding: 20px;\n",
    "            border-radius: 8px;\n",
    "            color: white;\n",
    "            margin-bottom: 20px;\n",
    "            box-shadow: 0 4px 6px rgba(0,0,0,0.1);\n",
    "        '>\n",
    "            <h2 style='margin: 0 0 10px 0;'>‚öôÔ∏è Stage 3: Reviewer Assignment (Complete)</h2>\n",
    "            <p style='margin: 0; opacity: 0.9;'>\n",
    "                Assign reviewers + prepare complete review sheet with all required columns\n",
    "            </p>\n",
    "            <div style='margin-top: 10px; padding: 10px; background: rgba(255,255,255,0.2); border-radius: 5px;'>\n",
    "                <b>Output columns:</b> Reviewer | Manual Review | Reviewer's Response | Details of Access Change\n",
    "            </div>\n",
    "        </div>\n",
    "    \"\"\"),\n",
    "    widgets.HBox([s3_upload, s3_upload_status]),\n",
    "    widgets.HBox([s3_upload_map, s3_map_status]),\n",
    "    widgets.HBox([s3_btn_assign, s3_btn_save], layout=widgets.Layout(margin='10px 0')),\n",
    "    s3_status,\n",
    "    s3_output\n",
    "])\n",
    "\n",
    "clear_output()\n",
    "display(stage3_ui)\n",
    "\n",
    "logger_s3.info(\"Stage 3 UI initialized (Complete version)\")\n",
    "logger_s3.info(\"=\"*60)\n"
   ]
  }
 ],
 "metadata": {
  "kernelspec": {
   "display_name": "Python 3",
   "language": "python",
   "name": "python3"
  },
  "language_info": {
   "name": "python",
   "version": "3.8.5"
  }
 },
 "nbformat": 4,
 "nbformat_minor": 4
}
