{
  "cells": [
    {
      "cell_type": "markdown",
      "metadata": {},
      "source": [
        "# \ud83c\udfa8 AER v7.5 - Access Review Generator",
        "",
        "## Production-Ready | Apple-Style UI | All Features Implemented",
        "",
        "---",
        "",
        "### \u2728 Features",
        "- \ud83c\udfa8 **Apple-inspired design system**",
        "- \ud83d\udd17 **Auto file loading** between stages",
        "- \u2705 **Card-based manual review UI** with batch operations",
        "- \ud83c\udf33 **Enhanced org tree** with toggle (hide/show non-dept-heads)",
        "- \ud83d\udcca **Group operations** (Select All, Deselect All, Skip All)",
        "- \ud83d\udcdd **Clean logging** (verbose in logs, concise in UI)",
        "",
        "### \ud83d\udccb Stages",
        "1. **Stage 1**: AD Authentication & User Download",
        "2. **Stage 1.5**: Organization Tree Builder",
        "3. **Stage 2**: Email/User Validation",
        "4. **Stage 3**: Reviewer Assignment",
        "",
        "---"
      ]
    },
    {
      "cell_type": "code",
      "metadata": {},
      "source": [
        "# ========================================================================",
        "# CELL 1: Apple Design System & Core Utilities",
        "# ========================================================================",
        "",
        "import os, sys, logging, glob, io, re, unicodedata, json",
        "import pandas as pd",
        "import ipywidgets as widgets",
        "from datetime import datetime",
        "from IPython.display import display, HTML, clear_output",
        "",
        "# ========== APPLE DESIGN SYSTEM ==========",
        "",
        "APPLE_COLORS = {",
        "    'blue': '#007AFF',",
        "    'purple': '#5856D6',",
        "    'green': '#34C759',",
        "    'orange': '#FF9500',",
        "    'red': '#FF3B30',",
        "    'bg_light': '#F5F5F7',",
        "    'surface': '#FFFFFF',",
        "    'text_primary': '#1D1D1F',",
        "    'text_secondary': '#86868B',",
        "    'border': '#D2D2D7'",
        "}",
        "",
        "APPLE_GRADIENTS = {",
        "    'blue_purple': 'linear-gradient(135deg, #007AFF 0%, #5856D6 100%)',",
        "    'pink_red': 'linear-gradient(135deg, #f093fb 0%, #f5576c 100%)',",
        "    'green_blue': 'linear-gradient(135deg, #5ee7df 0%, #b490ca 100%)',",
        "}",
        "",
        "def get_header_html(title, subtitle, gradient='blue_purple'):",
        "    \"\"\"Generate Apple-style header\"\"\"",
        "    grad = APPLE_GRADIENTS.get(gradient, APPLE_GRADIENTS['blue_purple'])",
        "    return f'''",
        "    <div style=\"",
        "        background: {grad};",
        "        color: white;",
        "        padding: 32px;",
        "        border-radius: 16px;",
        "        margin-bottom: 24px;",
        "        box-shadow: 0 8px 24px rgba(0,0,0,0.12);",
        "    \">",
        "        <h1 style=\"",
        "            font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', sans-serif;",
        "            font-size: 32px;",
        "            font-weight: 600;",
        "            margin: 0 0 8px 0;",
        "            letter-spacing: -0.5px;",
        "        \">{title}</h1>",
        "        <p style=\"",
        "            font-family: -apple-system, BlinkMacSystemFont, sans-serif;",
        "            font-size: 16px;",
        "            margin: 0;",
        "            opacity: 0.9;",
        "            font-weight: 400;",
        "        \">{subtitle}</p>",
        "    </div>",
        "    '''",
        "",
        "def get_card_style():",
        "    \"\"\"Card container style\"\"\"",
        "    return '''background: white;",
        "        border-radius: 12px;",
        "        padding: 24px;",
        "        margin-bottom: 16px;",
        "        box-shadow: 0 4px 16px rgba(0,0,0,0.08);",
        "        border: 1px solid #D2D2D7;'''",
        "",
        "def get_button_layout(width='auto', height='44px'):",
        "    \"\"\"Apple-style button layout\"\"\"",
        "    return widgets.Layout(width=width, height=height)",
        "",
        "def get_latest_file(directory, pattern='*.xlsx', prefix_priority=None):",
        "    \"\"\"",
        "    Get latest file from directory with optional prefix priority",
        "    ",
        "    Args:",
        "        directory: folder path",
        "        pattern: file pattern (e.g., '*.xlsx', '*.csv')",
        "        prefix_priority: if set, prioritize files with this prefix",
        "    ",
        "    Returns:",
        "        path to latest file or None",
        "    \"\"\"",
        "    if not os.path.exists(directory):",
        "        return None",
        "    ",
        "    files = glob.glob(os.path.join(directory, pattern))",
        "    ",
        "    if not files:",
        "        return None",
        "    ",
        "    # If prefix priority specified, filter first",
        "    if prefix_priority:",
        "        priority_files = [f for f in files if os.path.basename(f).startswith(prefix_priority)]",
        "        if priority_files:",
        "            files = priority_files",
        "    ",
        "    # Return newest by modification time",
        "    return max(files, key=os.path.getmtime)",
        "",
        "# ========== PATHS SETUP ==========",
        "",
        "today_str = datetime.now().strftime('%Y-%m-%d')",
        "BASE_DIR = os.path.join(\"output\", today_str)",
        "os.makedirs(BASE_DIR, exist_ok=True)",
        "",
        "# Logging setup",
        "LOG_DIR = os.path.join(BASE_DIR, \"logs\")",
        "os.makedirs(LOG_DIR, exist_ok=True)",
        "",
        "# Setup global logger",
        "def setup_logger(name, log_file):",
        "    \"\"\"Setup logger that writes to file only (not stdout)\"\"\"",
        "    logger = logging.getLogger(name)",
        "    logger.handlers.clear()",
        "    logger.setLevel(logging.INFO)",
        "    ",
        "    formatter = logging.Formatter('%(asctime)s | %(levelname)s | %(message)s')",
        "    fh = logging.FileHandler(log_file, encoding=\"utf-8\")",
        "    fh.setFormatter(formatter)",
        "    logger.addHandler(fh)",
        "    ",
        "    return logger",
        "",
        "print(\"\u2705 Design system and utilities loaded\")",
        "print(f\"\ud83d\udcc1 Base directory: {BASE_DIR}\")",
        "print(f\"\ud83d\udcdd Logs directory: {LOG_DIR}\")",
        ""
      ],
      "execution_count": null,
      "outputs": []
    },
    {
      "cell_type": "code",
      "metadata": {},
      "source": [
        "# ========================================================================",
        "# CELL 2: Stage 1 - AD Authentication & User Download",
        "# ========================================================================",
        "",
        "AD_CACHE_DIR = os.path.join(BASE_DIR, \"ad_cache\")",
        "os.makedirs(AD_CACHE_DIR, exist_ok=True)",
        "",
        "# Logger (file only, not console)",
        "s1_logger = setup_logger(\"stage1\", os.path.join(LOG_DIR, f\"stage1_{datetime.now().strftime('%Y%m%d_%H%M')}.log\"))",
        "",
        "# UI Components",
        "s1_status = widgets.HTML(\"<i>Ready to download AD users</i>\")",
        "s1_output = widgets.Output()",
        "s1_progress = widgets.IntProgress(",
        "    value=0, min=0, max=100,",
        "    description='Progress:',",
        "    bar_style='info',",
        "    layout=widgets.Layout(width='100%', visibility='hidden')",
        ")",
        "",
        "def download_ad_users():",
        "    \"\"\"Download users from Microsoft Graph API\"\"\"",
        "    # NOTE: Replace this with actual Microsoft Graph API call",
        "    # This is a mock implementation for demonstration",
        "    ",
        "    s1_progress.layout.visibility = 'visible'",
        "    s1_progress.value = 0",
        "    ",
        "    with s1_output:",
        "        clear_output()",
        "        print(\"\ud83d\udd10 Connecting to Microsoft Graph API...\")",
        "    ",
        "    s1_logger.info(\"Starting AD user download\")",
        "    s1_progress.value = 20",
        "    ",
        "    # Mock AD data (replace with actual API call)",
        "    import time",
        "    time.sleep(0.5)",
        "    ",
        "    mock_users = [",
        "        {'email': 'steven.bush@company.com', 'displayName': 'Steven Bush', 'department': 'Corporate - Executive',",
        "         'accountEnabled': True, 'jobTitle': 'CEO', 'managerEmail': None},",
        "        {'email': 'john.doe@company.com', 'displayName': 'John Doe', 'department': 'Corporate - IT',",
        "         'accountEnabled': True, 'jobTitle': 'VP of IT', 'managerEmail': 'steven.bush@company.com'},",
        "        {'email': 'jane.smith@company.com', 'displayName': 'Jane Smith', 'department': 'Corporate - Sales',",
        "         'accountEnabled': True, 'jobTitle': 'VP of Sales', 'managerEmail': 'steven.bush@company.com'},",
        "        {'email': 'bob.wilson@company.com', 'displayName': 'Bob Wilson', 'department': 'Corporate - IT',",
        "         'accountEnabled': True, 'jobTitle': 'Engineering Manager', 'managerEmail': 'john.doe@company.com'},",
        "        {'email': 'alice.chen@company.com', 'displayName': 'Alice Chen', 'department': 'Corporate - IT',",
        "         'accountEnabled': True, 'jobTitle': 'Senior Engineer', 'managerEmail': 'bob.wilson@company.com'},",
        "        {'email': 'former.employee@company.com', 'displayName': 'Former Employee', 'department': 'Corporate - IT',",
        "         'accountEnabled': False, 'jobTitle': 'Ex-Manager', 'managerEmail': 'john.doe@company.com'},",
        "    ]",
        "    ",
        "    s1_progress.value = 60",
        "    s1_logger.info(f\"Downloaded {len(mock_users)} users\")",
        "    ",
        "    df = pd.DataFrame(mock_users)",
        "    ",
        "    # Add missing columns for compatibility",
        "    df['lastSignInDateTime'] = datetime.now().isoformat()",
        "    ",
        "    # Save to cache",
        "    cache_file = os.path.join(AD_CACHE_DIR, f\"ad_users_{datetime.now().strftime('%Y%m%d_%H%M')}.csv\")",
        "    df.to_csv(cache_file, index=False)",
        "    ",
        "    s1_progress.value = 100",
        "    s1_logger.info(f\"Saved to cache: {cache_file}\")",
        "    ",
        "    with s1_output:",
        "        clear_output()",
        "        print(f\"\u2705 Downloaded {len(df)} users\")",
        "        print(f\"\ud83d\udcc1 Saved to: {os.path.basename(cache_file)}\")",
        "    ",
        "    s1_status.value = f'<span style=\"color:{APPLE_COLORS[\"green\"]};font-family:-apple-system;\">\u2705 Downloaded {len(df)} users</span>'",
        "    s1_progress.layout.visibility = 'hidden'",
        "    ",
        "    return cache_file",
        "",
        "btn_download = widgets.Button(",
        "    description=\"\ud83d\udd10 Download AD Users\",",
        "    button_style='',",
        "    layout=get_button_layout(width='200px')",
        ")",
        "btn_download.style.button_color = APPLE_COLORS['blue']",
        "",
        "def on_download_click(b):",
        "    b.disabled = True",
        "    try:",
        "        download_ad_users()",
        "    finally:",
        "        b.disabled = False",
        "",
        "btn_download.on_click(on_download_click)",
        "",
        "# UI Layout",
        "stage1_ui = widgets.VBox([",
        "    widgets.HTML(get_header_html(",
        "        \"\ud83d\udd10 Stage 1: AD Authentication\",",
        "        \"Download user data from Microsoft Graph API\",",
        "        'blue_purple'",
        "    )),",
        "    widgets.HBox([btn_download]),",
        "    s1_progress,",
        "    s1_status,",
        "    s1_output",
        "], layout=widgets.Layout(margin='0 0 32px 0'))",
        "",
        "clear_output()",
        "display(stage1_ui)",
        "s1_logger.info(\"Stage 1 UI initialized\")",
        ""
      ],
      "execution_count": null,
      "outputs": []
    },
    {
      "cell_type": "code",
      "metadata": {},
      "source": [
        "# === CELL 1.5: Org Tree Builder (v7.4 - Ultra Intuitive Tree View) ===",
        "import os, glob, logging, io, math",
        "import pandas as pd",
        "import ipywidgets as widgets",
        "from datetime import datetime",
        "from IPython.display import display, HTML, clear_output",
        "",
        "# Constants",
        "CORP_PREFIX = \"corporate\"",
        "MAX_TREE_LEVELS = 4  # Steven Bush = Level 1, then 3 more levels",
        "",
        "# Paths",
        "today_str = datetime.now().strftime('%Y-%m-%d')",
        "BASE_DIR = os.path.join(\"output\", today_str)",
        "AD_CACHE_DIR = os.path.join(BASE_DIR, \"ad_cache\")",
        "ORG_DIR = os.path.join(BASE_DIR, \"orgchart\")",
        "MAP_DIR = os.path.join(\"input\", \"mapping\")",
        "LOG_DIR = os.path.join(BASE_DIR, \"logs\")",
        "os.makedirs(ORG_DIR, exist_ok=True)",
        "os.makedirs(MAP_DIR, exist_ok=True)",
        "",
        "# Logging",
        "log_file = os.path.join(LOG_DIR, f\"aer_stage1_5_{datetime.now().strftime('%Y%m%d_%H%M')}.log\")",
        "logger_s15 = logging.getLogger(\"aer_stage1_5\")",
        "logger_s15.handlers.clear()",
        "logger_s15.setLevel(logging.INFO)",
        "formatter = logging.Formatter('%(asctime)s | %(levelname)s | %(message)s')",
        "fh = logging.FileHandler(log_file, encoding=\"utf-8\")",
        "fh.setFormatter(formatter)",
        "logger_s15.addHandler(fh)",
        "logger_s15.addHandler(logging.StreamHandler(sys.stdout))",
        "",
        "# ========== GLOBAL STATE ==========",
        "s15_ad_df = None",
        "s15_tree_html = widgets.HTML()",
        "s15_status = widgets.HTML(value=\"<i>Click Rebuild Tree to start</i>\")",
        "s15_output = widgets.Output()",
        "s15_is_building = False",
        "s15_dept_heads = {}  # Store dept heads globally",
        "s15_nodes = {}",
        "s15_children = {}",
        "s15_levels = {}",
        "",
        "# ========== EDITABLE MAPPING TABLE ==========",
        "s15_mapping_data = []  # List of dicts: {dept, head_name, head_email, reviewer_name, reviewer_email}",
        "",
        "# Widgets for editable table",
        "mapping_container = widgets.VBox()",
        "btn_add_row = widgets.Button(",
        "    description='\u2795 Add Department', ",
        "    button_style='info',",
        "    icon='plus',",
        "    layout=widgets.Layout(width='180px')",
        ")",
        "btn_save_mapping = widgets.Button(",
        "    description='\ud83d\udcbe Save Mapping', ",
        "    button_style='success',",
        "    icon='save',",
        "    layout=widgets.Layout(width='180px')",
        ")",
        "btn_refresh = widgets.Button(",
        "    description='\ud83d\udd04 Rebuild Tree', ",
        "    button_style='primary',",
        "    icon='refresh',",
        "    layout=widgets.Layout(width='180px', height='40px')",
        ")",
        "",
        "# ========== HELPER FUNCTIONS ==========",
        "",
        "def normalize_department(dept):",
        "    \"\"\"Normalize department name\"\"\"",
        "    if dept is None or (isinstance(dept, float) and math.isnan(dept)):",
        "        dept = ''",
        "    else:",
        "        dept = str(dept).strip()",
        "    if dept.lower().startswith('branch'):",
        "        return 'Branch'",
        "    return dept or 'N/A'",
        "",
        "def load_latest_ad():",
        "    \"\"\"Load latest AD cache file\"\"\"",
        "    try:",
        "        cache_files = glob.glob(os.path.join(AD_CACHE_DIR, \"ad_users_*.csv\"))",
        "        if not cache_files:",
        "            return None, \"No AD cache found. Run Stage 1 first.\"",
        "        latest = max(cache_files, key=os.path.getmtime)",
        "        df = pd.read_csv(latest)",
        "        df = df[df['department'].fillna('').str.lower().str.startswith(CORP_PREFIX)]",
        "        return df, f\"Loaded {len(df)} corporate users from {os.path.basename(latest)}\"",
        "    except Exception as e:",
        "        return None, f\"Error loading AD cache: {e}\"",
        "",
        "def find_root(df):",
        "    \"\"\"Find CEO (Steven/Steve Bush) as root\"\"\"",
        "    names = df['displayName'].str.lower().fillna('').str.strip()",
        "    mask_name = names.isin(['steven bush', 'steve bush'])",
        "    if mask_name.any():",
        "        return df.loc[mask_name, 'email'].iloc[0]",
        "    mask_title = df['jobTitle'].str.lower().fillna('').str.contains('chief executive|ceo|president')",
        "    if mask_title.any():",
        "        return df.loc[mask_title, 'email'].iloc[0]",
        "    mask_nomgr = df['managerEmail'].fillna('N/A') == 'N/A'",
        "    if mask_nomgr.any():",
        "        return df.loc[mask_nomgr, 'email'].iloc[0]",
        "    return df.iloc[0]['email'] if len(df) else None",
        "",
        "def build_org_structure(df, root_email):",
        "    \"\"\"Build org structure with progress tracking\"\"\"",
        "    df = df.copy()",
        "    df['managerEmail'] = df['managerEmail'].fillna('N/A')",
        "    ",
        "    nodes = {}",
        "    for idx, row in df.iterrows():",
        "        nodes[row['email']] = {",
        "            'email': row['email'],",
        "            'name': row['displayName'],",
        "            'title': row.get('jobTitle', 'N/A'),",
        "            'dept': normalize_department(row.get('department')),",
        "            'manager': row['managerEmail']",
        "        }",
        "    ",
        "    children = {}",
        "    for email, node in nodes.items():",
        "        mgr = node['manager']",
        "        if mgr == 'N/A' or mgr not in nodes:",
        "            if email != root_email:",
        "                children.setdefault(root_email, []).append(email)",
        "        else:",
        "            children.setdefault(mgr, []).append(email)",
        "    ",
        "    levels = {root_email: 1}",
        "    queue = [root_email]",
        "    ",
        "    while queue:",
        "        current = queue.pop(0)",
        "        current_level = levels[current]",
        "        if current_level >= MAX_TREE_LEVELS:",
        "            continue",
        "        for child in children.get(current, []):",
        "            if child not in levels:",
        "                levels[child] = current_level + 1",
        "                queue.append(child)",
        "    ",
        "    return nodes, children, levels",
        "",
        "def find_dept_heads(df, nodes, levels):",
        "    \"\"\"Find head of each department\"\"\"",
        "    dept_heads = {}",
        "    ",
        "    for dept_name, grp in df.groupby(df['department'].apply(normalize_department)):",
        "        if dept_name == 'N/A':",
        "            continue",
        "        ",
        "        dept_people = []",
        "        for _, row in grp.iterrows():",
        "            email = row['email']",
        "            if email in levels:",
        "                dept_people.append({",
        "                    'email': email,",
        "                    'level': levels[email],",
        "                    'name': row['displayName'],",
        "                    'title': row.get('jobTitle', 'N/A')",
        "                })",
        "        ",
        "        if not dept_people:",
        "            continue",
        "        ",
        "        dept_people.sort(key=lambda x: x['level'])",
        "        head = dept_people[0]",
        "        ",
        "        # Find reviewer",
        "        head_email = head['email']",
        "        reviewer_email = nodes[head_email]['manager']",
        "        ",
        "        visited = set()",
        "        max_hops = 10",
        "        hops = 0",
        "        ",
        "        while reviewer_email in nodes and reviewer_email != 'N/A' and hops < max_hops:",
        "            if reviewer_email in visited:",
        "                break",
        "            visited.add(reviewer_email)",
        "            reviewer_node = nodes[reviewer_email]",
        "            if reviewer_node['dept'] != dept_name:",
        "                break",
        "            reviewer_email = reviewer_node['manager']",
        "            hops += 1",
        "        ",
        "        if reviewer_email == 'N/A' or reviewer_email not in nodes or hops >= max_hops:",
        "            reviewer_email = nodes[head_email]['manager']",
        "            if reviewer_email == 'N/A' or reviewer_email not in nodes:",
        "                reviewer_email = head_email",
        "        ",
        "        dept_heads[dept_name] = {",
        "            'head_email': head_email,",
        "            'head_name': head['name'],",
        "            'head_title': head['title'],",
        "            'head_level': head['level'],",
        "            'reviewer_email': reviewer_email,",
        "            'reviewer_name': nodes.get(reviewer_email, {}).get('name', 'N/A')",
        "        }",
        "    ",
        "    return dept_heads",
        "",
        "def get_dept_color(dept_name):",
        "    \"\"\"Get unified color for all departments\"\"\"",
        "    return '#F8F9FA'  # Light gray for all departments",
        "",
        "def analyze_children_depts(email, children, nodes):",
        "    \"\"\"Analyze if all children are in same dept\"\"\"",
        "    if email not in children:",
        "        return True, None",
        "    ",
        "    kids = children[email]",
        "    if not kids:",
        "        return True, None",
        "    ",
        "    parent_dept = nodes[email]['dept']",
        "    child_depts = set()",
        "    ",
        "    for kid in kids:",
        "        if kid in nodes:",
        "            child_depts.add(nodes[kid]['dept'])",
        "    ",
        "    all_same = len(child_depts) == 1 and parent_dept in child_depts",
        "    return all_same, child_depts",
        "",
        "def render_ultra_intuitive_tree(root_email, nodes, children, levels, dept_heads, max_level=MAX_TREE_LEVELS):",
        "    \"\"\"",
        "    Ultra intuitive tree rendering with:",
        "    - Dept head highlighting",
        "    - Smart folding (same dept = folded)",
        "    - Department grouping",
        "    - Color coding",
        "    \"\"\"",
        "    # Build reverse lookup: dept -> head_email",
        "    dept_to_head = {info['head_email']: dept for dept, info in dept_heads.items()}",
        "    ",
        "    def render_node(email, current_level, parent_dept=None, show_all=False):",
        "        \"\"\"Recursively render node\"\"\"",
        "        if current_level > max_level or email not in nodes:",
        "            return \"\"",
        "        ",
        "        node = nodes[email]",
        "        level_num = levels.get(email, 0)",
        "        ",
        "        # Check if this person is a dept head",
        "        is_dept_head = email in dept_to_head",
        "        dept_name = node['dept']",
        "        dept_color = get_dept_color(dept_name)",
        "        ",
        "        # Analyze children departments",
        "        all_same_dept, child_depts = analyze_children_depts(email, children, nodes)",
        "        ",
        "        # Build node label",
        "        if is_dept_head:",
        "            # Department head - BOLD + HIGHLIGHTED",
        "            dept_badge = f\"<span style='background:#FFF3CD;color:#000;padding:3px 8px;border-radius:4px;font-weight:700;border:2px solid #856404;'>\ud83d\udccc {dept_name}</span>\"",
        "            name_html = f\"<b style='font-size:1.1em;font-weight:700;'>{node['name']}</b>\"",
        "        else:",
        "            dept_badge = f\"<span style='background:#F8F9FA;color:#495057;padding:2px 6px;border-radius:3px;font-weight:500;'>{dept_name}</span>\"",
        "            name_html = f\"<b style='font-size:1.05em;'>{node['name']}</b>\"",
        "        ",
        "        level_badge = f\"<span style='background:#6C757D;color:white;padding:2px 6px;border-radius:3px;font-size:0.85em;'>L{level_num}</span>\"",
        "        title_html = f\"<span style='color:#666;font-style:italic;'>{node['title']}</span>\"",
        "        email_html = f\"<span style='color:#999;font-size:0.85em;' title='{email}'>\ud83d\udce7 {email.split('@')[0]}</span>\"",
        "        ",
        "        # Build full label",
        "        label = f\"{name_html} {dept_badge} {level_badge}\"",
        "        sublabel = f\"{title_html} \u2022 {email_html}\"",
        "        ",
        "        # Get children",
        "        kids = children.get(email, [])",
        "        kids_in_range = [k for k in kids if k in levels and levels[k] <= max_level]",
        "        ",
        "        if not kids_in_range:",
        "            # Skip non-dept-heads if show_all=False and not L1",
        "    is_dept_head = email in dept_to_head",
        "    if not show_all and not is_dept_head and current_level > 1:",
        "        return \"\"",
        "    ",
        "    # Leaf node",
        "            return f\"\"\"",
        "            <li style='padding:6px 0;'>",
        "                <div>{label}</div>",
        "                <div style='padding-left:20px;font-size:0.9em;'>{sublabel}</div>",
        "            </li>",
        "            \"\"\"",
        "        ",
        "        # Has children - decide on grouping strategy",
        "        if len(child_depts) <= 1:",
        "            # All children in same dept - simple collapsed tree",
        "            kids_html = \"\".join([render_node(kid, current_level + 1, dept_name) for kid in kids_in_range])",
        "            ",
        "            # Smart default: collapse if same dept as parent, expand if different",
        "            is_open = \"open\" if dept_name != parent_dept else \"\"",
        "            ",
        "            return f\"\"\"",
        "            <details {is_open}>",
        "                <summary style='cursor:pointer;padding:6px 0;list-style-position:outside;'>",
        "                    <div style='display:inline-block;margin-left:8px;'>{label}</div>",
        "                    <div style='padding-left:28px;font-size:0.9em;'>{sublabel}</div>",
        "                </summary>",
        "                <ul style='list-style:none;padding-left:28px;border-left:2px solid #DEE2E6;margin:4px 0;'>",
        "                    {kids_html}",
        "                </ul>",
        "            </details>",
        "            \"\"\"",
        "        else:",
        "            # Multiple depts - group by department",
        "            dept_groups = {}",
        "            for kid in kids_in_range:",
        "                kid_dept = nodes[kid]['dept']",
        "                dept_groups.setdefault(kid_dept, []).append(kid)",
        "            ",
        "            groups_html = \"\"",
        "            for grp_dept in sorted(dept_groups.keys()):",
        "                grp_kids = dept_groups[grp_dept]",
        "                grp_color = get_dept_color(grp_dept)",
        "                ",
        "                # Find dept head in this group",
        "                grp_head = None",
        "                for kid in grp_kids:",
        "                    if kid in dept_to_head:",
        "                        grp_head = nodes[kid]['name']",
        "                        break",
        "                ",
        "                head_label = f\" (Head: {grp_head})\" if grp_head else \"\"",
        "                ",
        "                grp_content = \"\".join([render_node(kid, current_level + 1, grp_dept, show_all) for kid in grp_kids])",
        "                ",
        "                # AUTO EXPAND multi-dept branches",
        "                groups_html += f\"\"\"",
        "                <details open>",
        "                    <summary style='cursor:pointer;padding:4px 8px;margin:4px 0;background:#E9ECEF;border-radius:4px;border-left:4px solid #6C757D;font-weight:600;'>",
        "                        <b>\ud83d\udcc1 {grp_dept}</b>{head_label} <span style='color:#666;'>({len(grp_kids)} people)</span>",
        "                    </summary>",
        "                    <ul style='list-style:none;padding-left:16px;margin:4px 0;'>",
        "                        {grp_content}",
        "                    </ul>",
        "                </details>",
        "                \"\"\"",
        "            ",
        "            return f\"\"\"",
        "            <details open>",
        "                <summary style='cursor:pointer;padding:6px 0;list-style-position:outside;'>",
        "                    <div style='display:inline-block;margin-left:8px;'>{label}</div>",
        "                    <div style='padding-left:28px;font-size:0.9em;'>{sublabel}</div>",
        "                </summary>",
        "                <div style='padding-left:20px;margin:8px 0;'>",
        "                    {groups_html}",
        "                </div>",
        "            </details>",
        "            \"\"\"",
        "    ",
        "    tree_html = f\"\"\"",
        "    <div style='font-family:system-ui,-apple-system,sans-serif;font-size:0.95em;line-height:1.6;'>",
        "        <div style='background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:white;padding:16px;border-radius:8px 8px 0 0;'>",
        "            <h3 style='margin:0 0 8px 0;'>\ud83c\udf33 Organization Hierarchy Tree (4 Levels)</h3>",
        "            <p style='margin:0;opacity:0.9;font-size:0.9em;'>",
        "                \ud83d\udccc Bold + Highlighted = Department Head \u2022 Click to expand/collapse \u2022 ",
        "                Multi-department branches auto-expand",
        "            </p>",
        "        </div>",
        "        <div style='padding:16px;background:white;border:1px solid #ddd;border-top:none;border-radius:0 0 8px 8px;max-height:700px;overflow:auto;'>",
        "            <ul style='list-style:none;padding-left:0;margin:0;'>",
        "                {render_node(root_email, 1, None, show_all)}",
        "            </ul>",
        "        </div>",
        "    </div>",
        "    \"\"\"",
        "    ",
        "    return tree_html",
        "",
        "# ========== EDITABLE MAPPING TABLE ==========",
        "",
        "def render_editable_mapping():",
        "    \"\"\"Render editable mapping table using widgets\"\"\"",
        "    global s15_mapping_data",
        "    ",
        "    if not s15_mapping_data:",
        "        mapping_container.children = [widgets.HTML(\"<i>No departments yet. Rebuild tree to populate.</i>\")]",
        "        return",
        "    ",
        "    rows = []",
        "    ",
        "    # Header",
        "    header = widgets.HTML(\"\"\"",
        "        <div style='display:grid;grid-template-columns:200px 200px 200px 80px;gap:8px;padding:8px;background:#4CAF50;color:white;font-weight:bold;border-radius:4px 4px 0 0;'>",
        "            <div>Department</div>",
        "            <div>Department Head</div>",
        "            <div>Reviewer</div>",
        "            <div>Actions</div>",
        "        </div>",
        "    \"\"\")",
        "    rows.append(header)",
        "    ",
        "    # Data rows",
        "    for idx, mapping in enumerate(s15_mapping_data):",
        "        dept_label = widgets.HTML(",
        "            value=f\"<div style='padding:8px;'><b>{mapping['dept']}</b></div>\",",
        "            layout=widgets.Layout(width='200px')",
        "        )",
        "        ",
        "        head_input = widgets.Text(",
        "            value=mapping['head_name'],",
        "            placeholder='Head name',",
        "            layout=widgets.Layout(width='200px')",
        "        )",
        "        head_input.mapping_idx = idx",
        "        head_input.field = 'head_name'",
        "        ",
        "        reviewer_input = widgets.Text(",
        "            value=mapping['reviewer_name'],",
        "            placeholder='Reviewer name',",
        "            layout=widgets.Layout(width='200px')",
        "        )",
        "        reviewer_input.mapping_idx = idx",
        "        reviewer_input.field = 'reviewer_name'",
        "        ",
        "        # Update handlers",
        "        def on_change(change, idx=idx, field=''):",
        "            s15_mapping_data[idx][field] = change['new']",
        "        ",
        "        head_input.observe(lambda c, i=idx: on_change(c, i, 'head_name'), 'value')",
        "        reviewer_input.observe(lambda c, i=idx: on_change(c, i, 'reviewer_name'), 'value')",
        "        ",
        "        delete_btn = widgets.Button(",
        "            description='\ud83d\uddd1\ufe0f',",
        "            button_style='danger',",
        "            layout=widgets.Layout(width='60px')",
        "        )",
        "        delete_btn.mapping_idx = idx",
        "        delete_btn.on_click(lambda b, i=idx: delete_mapping_row(i))",
        "        ",
        "        row = widgets.HBox(",
        "            [dept_label, head_input, reviewer_input, delete_btn],",
        "            layout=widgets.Layout(padding='4px 8px', border_bottom='1px solid #eee')",
        "        )",
        "        rows.append(row)",
        "    ",
        "    mapping_container.children = rows",
        "",
        "def delete_mapping_row(idx):",
        "    \"\"\"Delete a mapping row\"\"\"",
        "    global s15_mapping_data",
        "    if 0 <= idx < len(s15_mapping_data):",
        "        del s15_mapping_data[idx]",
        "        render_editable_mapping()",
        "",
        "def add_mapping_row(_=None):",
        "    \"\"\"Add a new mapping row\"\"\"",
        "    global s15_mapping_data",
        "    s15_mapping_data.append({",
        "        'dept': 'New Department',",
        "        'head_name': '',",
        "        'head_email': '',",
        "        'reviewer_name': '',",
        "        'reviewer_email': ''",
        "    })",
        "    render_editable_mapping()",
        "",
        "def save_mapping(_=None):",
        "    \"\"\"Save mapping to CSV\"\"\"",
        "    if not s15_mapping_data:",
        "        s15_status.value = \"<span style='color:red;'>\u274c No mappings to save</span>\"",
        "        return",
        "    ",
        "    # Convert to CSV format",
        "    rows = []",
        "    for mapping in s15_mapping_data:",
        "        # Head row",
        "        rows.append({",
        "            'email': mapping.get('head_email', mapping['head_name']),",
        "            'department': mapping['dept'],",
        "            'reviewer': mapping.get('reviewer_email', mapping['reviewer_name']),",
        "            'branch': '' if mapping['dept'].lower().startswith('corporate') else 'Branch'",
        "        })",
        "        # Wildcard row",
        "        rows.append({",
        "            'email': '*',",
        "            'department': mapping['dept'],",
        "            'reviewer': mapping.get('head_email', mapping['head_name']),",
        "            'branch': '' if mapping['dept'].lower().startswith('corporate') else 'Branch'",
        "        })",
        "    ",
        "    df = pd.DataFrame(rows)",
        "    ts = datetime.now().strftime('%Y%m%d_%H%M')",
        "    path = os.path.join(MAP_DIR, f\"org_mapping_{ts}.csv\")",
        "    df.to_csv(path, index=False)",
        "    ",
        "    s15_status.value = f\"<span style='color:green;'>\ud83d\udcbe Saved: {os.path.basename(path)}</span>\"",
        "    logger_s15.info(f\"Mapping saved to {path}\")",
        "    ",
        "    with s15_output:",
        "        print(f\"\\n\u2705 Mapping saved to: {path}\")",
        "        print(f\"   Total rows: {len(rows)}\")",
        "",
        "# ========== REFRESH TREE ==========",
        "",
        "def refresh_tree(_=None):",
        "    \"\"\"Rebuild organization tree\"\"\"",
        "    global s15_ad_df, s15_is_building, s15_dept_heads, s15_nodes, s15_children, s15_levels, s15_mapping_data",
        "    ",
        "    if s15_is_building:",
        "        return",
        "    ",
        "    s15_is_building = True",
        "    btn_refresh.disabled = True",
        "    s15_output.clear_output()",
        "    ",
        "    progress = widgets.IntProgress(",
        "        value=0, min=0, max=100, description='Building:',",
        "        bar_style='info', layout=widgets.Layout(width='80%')",
        "    )",
        "    status_label = widgets.HTML(value=\"Initializing...\")",
        "    ",
        "    with s15_output:",
        "        display(widgets.VBox([progress, status_label]))",
        "        print(\"\\n\" + \"=\"*70)",
        "        print(\"\ud83c\udf33 Building Ultra-Intuitive Organization Tree\")",
        "        print(\"=\"*70 + \"\\n\")",
        "    ",
        "    try:",
        "        # Load data",
        "        status_label.value = \"\ud83d\udcc2 Loading AD cache...\"",
        "        progress.value = 20",
        "        ",
        "        df, msg = load_latest_ad()",
        "        if df is None:",
        "            raise Exception(msg)",
        "        ",
        "        s15_ad_df = df",
        "        with s15_output:",
        "            print(f\"\u2713 {msg}\\n\")",
        "        ",
        "        # Find root",
        "        status_label.value = \"\ud83d\udc51 Finding CEO...\"",
        "        progress.value = 30",
        "        ",
        "        root_email = find_root(df)",
        "        if not root_email:",
        "            raise Exception(\"Could not locate root (CEO)\")",
        "        ",
        "        root_name = df[df['email'] == root_email].iloc[0]['displayName']",
        "        with s15_output:",
        "            print(f\"\u2713 CEO: {root_name} ({root_email})\\n\")",
        "        ",
        "        # Build structure",
        "        status_label.value = \"\ud83c\udfd7\ufe0f Building hierarchy...\"",
        "        progress.value = 50",
        "        ",
        "        s15_nodes, s15_children, s15_levels = build_org_structure(df, root_email)",
        "        ",
        "        with s15_output:",
        "            print(f\"\u2713 Structure built: {len(s15_nodes)} people, {len(s15_levels)} in tree\\n\")",
        "        ",
        "        # Find dept heads",
        "        status_label.value = \"\ud83d\udcca Identifying department heads...\"",
        "        progress.value = 70",
        "        ",
        "        s15_dept_heads = find_dept_heads(df, s15_nodes, s15_levels)",
        "        ",
        "        with s15_output:",
        "            print(f\"\u2713 Found {len(s15_dept_heads)} departments\\n\")",
        "        ",
        "        # Generate mapping",
        "        status_label.value = \"\ud83d\uddfa\ufe0f Generating mapping...\"",
        "        progress.value = 85",
        "        ",
        "        s15_mapping_data = []",
        "        for dept, info in s15_dept_heads.items():",
        "            s15_mapping_data.append({",
        "                'dept': dept,",
        "                'head_name': info['head_name'],",
        "                'head_email': info['head_email'],",
        "                'reviewer_name': info['reviewer_name'],",
        "                'reviewer_email': info['reviewer_email']",
        "            })",
        "        ",
        "        render_editable_mapping()",
        "        ",
        "        # Render tree",
        "        status_label.value = \"\ud83c\udfa8 Rendering tree...\"",
        "        progress.value = 95",
        "        ",
        "        tree_html = render_ultra_intuitive_tree(",
        "            root_email, s15_nodes, s15_children, s15_levels, s15_dept_heads",
        "        )",
        "        s15_tree_html.value = tree_html",
        "        ",
        "        # Complete",
        "        progress.value = 100",
        "        progress.bar_style = 'success'",
        "        status_label.value = \"<span style='color:green;font-weight:bold;'>\u2705 Complete!</span>\"",
        "        ",
        "        with s15_output:",
        "            print(\"=\"*70)",
        "            print(\"\u2705 Tree Built Successfully\")",
        "            print(\"=\"*70)",
        "            print(f\"\ud83d\udcca {len(s15_nodes)} people \u2022 {len(s15_dept_heads)} departments \u2022 {len(s15_mapping_data)} mappings\")",
        "            print(\"=\"*70)",
        "        ",
        "        s15_status.value = f\"<span style='color:green;'>\u2705 Tree ready: {len(s15_dept_heads)} depts</span>\"",
        "        ",
        "    except Exception as e:",
        "        with s15_output:",
        "            print(f\"\\n\u274c Error: {e}\")",
        "        s15_status.value = f\"<span style='color:red;'>\u274c {e}</span>\"",
        "        logger_s15.error(f\"Error: {e}\", exc_info=True)",
        "    finally:",
        "        s15_is_building = False",
        "        btn_refresh.disabled = False",
        "",
        "# ========== EVENT BINDINGS ==========",
        "btn_add_row.on_click(add_mapping_row)",
        "btn_save_mapping.on_click(save_mapping)",
        "btn_refresh.on_click(refresh_tree)",
        "",
        "# ========== UI LAYOUT ==========",
        "# Toggle for showing/hiding non-dept-heads",
        "s15_show_all = widgets.Checkbox(",
        "    value=False,",
        "    description='Show all employees (default: dept heads only)',",
        "    style={'description_width': 'auto'},",
        "    layout=widgets.Layout(margin='8px 0 16px 0')",
        ")",
        "",
        "def on_toggle_change(change):",
        "    \"\"\"Re-render tree when toggle changes\"\"\"",
        "    s15_tree_display.value = render_ultra_intuitive_tree(s15_show_all.value)",
        "",
        "s15_show_all.observe(on_toggle_change, 'value')",
        "",
        "stage15_ui = widgets.VBox([",
        "    widgets.HTML(\"\"\"",
        "        <div style='background:linear-gradient(135deg,#5ee7df 0%,#b490ca 100%);padding:20px;border-radius:8px;color:white;margin-bottom:20px;'>",
        "            <h2 style='margin:0 0 10px 0;'>\ud83c\udf33 Stage 1.5: Ultra-Intuitive Org Tree Builder</h2>",
        "            <p style='margin:0;opacity:0.9;'>",
        "                \u2728 Toggle show/hide non-dept-heads \u2022 \ud83d\udccc Bold dept head highlighting \u2022 \ud83d\udd13 Multi-dept auto-expand \u2022 \u270f\ufe0f Editable mapping",
        "            </p>",
        "        </div>",
        "    \"\"\"),",
        "    widgets.HBox([btn_refresh, s15_status], layout=widgets.Layout(margin='0 0 16px 0')),",
        "    s15_tree_html,",
        "    widgets.HTML(\"<div style='margin:24px 0 12px 0;'><h3>\ud83d\udccb Department Reviewer Mapping (Editable)</h3><p style='color:#666;'>Edit names directly \u2022 Click \ud83d\uddd1\ufe0f to delete \u2022 Click \u2795 to add custom department</p></div>\"),",
        "    mapping_container,",
        "    widgets.HBox([btn_add_row, btn_save_mapping], layout=widgets.Layout(margin='12px 0')),",
        "    s15_output",
        "])",
        "",
        "clear_output()",
        "display(stage15_ui)",
        "",
        "logger_s15.info(\"Stage 1.5 Ultra-Intuitive UI initialized\")",
        "logger_s15.info(\"=\"*60)",
        "print(\"\\n\u2705 Stage 1.5 UI ready - Click '\ud83d\udd04 Rebuild Tree' to start\")",
        ""
      ],
      "execution_count": null,
      "outputs": []
    },
    {
      "cell_type": "code",
      "metadata": {},
      "source": [
        "# === CELL 3: Email/User Validation with Card-based Review UI (v7.5) ===",
        "import os, sys, logging, glob, io, re, unicodedata",
        "import pandas as pd",
        "import ipywidgets as widgets",
        "from datetime import datetime",
        "from IPython.display import display, HTML, clear_output",
        "",
        "# Try import fuzzy matching",
        "try:",
        "    from rapidfuzz import fuzz, process",
        "    FUZZY_AVAILABLE = True",
        "except ImportError:",
        "    try:",
        "        from fuzzywuzzy import fuzz, process",
        "        FUZZY_AVAILABLE = True",
        "        print(\"\u26a0\ufe0f Using fuzzywuzzy. Install rapidfuzz for better performance: pip install rapidfuzz\")",
        "    except ImportError:",
        "        FUZZY_AVAILABLE = False",
        "        print(\"\u274c Fuzzy matching unavailable. Install: pip install rapidfuzz\")",
        "",
        "# Setup paths",
        "today_str = datetime.now().strftime('%Y-%m-%d')",
        "BASE_DIR = os.path.join(\"output\", today_str)",
        "AD_CACHE_DIR = os.path.join(BASE_DIR, \"ad_cache\")",
        "STAGE2_DIR = os.path.join(BASE_DIR, \"stage2_validated\")",
        "LOG_DIR = os.path.join(BASE_DIR, \"logs\")",
        "os.makedirs(STAGE2_DIR, exist_ok=True)",
        "",
        "# Logging",
        "log_file = os.path.join(LOG_DIR, f\"aer_stage2_{datetime.now().strftime('%Y%m%d_%H%M')}.log\")",
        "logger_s2 = logging.getLogger(\"aer_stage2\")",
        "logger_s2.handlers.clear()",
        "logger_s2.setLevel(logging.INFO)",
        "formatter = logging.Formatter('%(asctime)s | %(levelname)s | %(message)s')",
        "fh = logging.FileHandler(log_file, encoding=\"utf-8\")",
        "fh.setFormatter(formatter)",
        "logger_s2.addHandler(fh)",
        "logger_s2.addHandler(logging.StreamHandler(sys.stdout))",
        "",
        "# ========== GLOBAL STATE ==========",
        "s2_ad_cache = {}  # email -> user data",
        "s2_name_index = {}  # normalized_name -> email",
        "s2_input_df = None",
        "s2_input_filename = \"\"",
        "s2_validated_rows = []  # List of validated user dicts",
        "s2_review_rows = []  # Rows needing manual review",
        "s2_is_processing = False",
        "",
        "# Validation categories",
        "CATEGORIES = {",
        "    'PERFECT_MATCH': '\u2705 Perfect Match',",
        "    'AUTO_FILLED_NAME': '\u2705 Auto-filled Name',",
        "    'AUTO_FILLED_EMAIL': '\u2705 Auto-filled Email',",
        "    'MISMATCH_EMAIL_PRIORITY': '\u26a0\ufe0f Mismatch (Email Priority)',",
        "    'AMBIGUOUS_NAME': '\u26a0\ufe0f Ambiguous Name Match',",
        "    'INACTIVE_ACCOUNT': '\u26a0\ufe0f Inactive Account',",
        "    'NOT_FOUND': '\u274c Not Found in AD',",
        "    'INVALID_FORMAT': '\u274c Invalid Email Format',",
        "    'BOTH_EMPTY': '\u274c Both Empty (Skipped)'",
        "}",
        "",
        "# ========== UI COMPONENTS ==========",
        "s2_upload = widgets.FileUpload(",
        "    accept='.xlsx, .csv',",
        "    description=\"Upload User List\",",
        "    button_style='info'",
        ")",
        "s2_upload_status = widgets.HTML(value=\"<i>No file selected</i>\")",
        "s2_btn_validate = widgets.Button(",
        "    description=\"\ud83d\udd0d Validate Users\",",
        "    button_style='warning',",
        "    layout=widgets.Layout(width='180px'),",
        "    disabled=True",
        ")",
        "s2_btn_save = widgets.Button(",
        "    description=\"\ud83d\udcbe Save Validated File\",",
        "    button_style='success',",
        "    layout=widgets.Layout(width='180px'),",
        "    disabled=True",
        ")",
        "s2_status = widgets.HTML(value=\"<i>Please load AD cache and upload user list</i>\")",
        "s2_output = widgets.Output()",
        "s2_review_container = widgets.VBox()",
        "",
        "# ========== HELPER FUNCTIONS ==========",
        "",
        "def normalize_email(email):",
        "    \"\"\"Normalize email to lowercase, strip whitespace\"\"\"",
        "    if pd.isna(email) or not email:",
        "        return None",
        "    email_str = str(email).strip().lower()",
        "    # Check for null variants",
        "    if email_str in ['nan', 'none', '', 'n/a', 'na', '-', 'null']:",
        "        return None",
        "    return email_str",
        "",
        "def is_valid_email_format(email):",
        "    \"\"\"Check if email has valid format\"\"\"",
        "    if not email:",
        "        return False",
        "    # Basic email regex",
        "    pattern = r'^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\\.[a-zA-Z]{2,}$'",
        "    return re.match(pattern, email) is not None",
        "",
        "def normalize_name(name):",
        "    \"\"\"Normalize name for matching\"\"\"",
        "    if pd.isna(name) or not name:",
        "        return None",
        "    name_str = str(name).strip()",
        "    # Check for null variants",
        "    if name_str.lower() in ['nan', 'none', '', 'n/a', 'na', '-', 'null']:",
        "        return None",
        "    # Normalize unicode",
        "    name_str = unicodedata.normalize('NFKC', name_str)",
        "    # Collapse multiple spaces",
        "    name_str = re.sub(r'\\s+', ' ', name_str)",
        "    return name_str",
        "",
        "def normalize_name_for_index(name):",
        "    \"\"\"Normalize name for fuzzy matching index (more aggressive)\"\"\"",
        "    if not name:",
        "        return \"\"",
        "    name = str(name).lower()",
        "    name = unicodedata.normalize('NFKC', name)",
        "    # Remove punctuation",
        "    name = re.sub(r'[^a-z0-9\\s]', ' ', name)",
        "    # Collapse spaces",
        "    name = ' '.join(name.split())",
        "    return name.strip()",
        "",
        "def detect_columns(df, sample_size=20):",
        "    \"\"\"",
        "    Auto-detect email and name columns",
        "    Returns: (email_col_idx, name_col_idx, email_col_name, name_col_name)",
        "    \"\"\"",
        "    if len(df.columns) < 2:",
        "        return None, None, None, None",
        "    ",
        "    # Sample first N rows",
        "    sample = df.head(sample_size)",
        "    ",
        "    # Count valid emails in each column",
        "    email_scores = {}",
        "    for idx, col in enumerate(df.columns):",
        "        valid_count = 0",
        "        for val in sample[col]:",
        "            val_str = str(val).strip().lower()",
        "            if '@' in val_str and '.' in val_str:",
        "                valid_count += 1",
        "        email_scores[idx] = valid_count",
        "    ",
        "    # Find column with most emails",
        "    if not email_scores or max(email_scores.values()) == 0:",
        "        # No email column found, assume first two",
        "        return 0, 1, df.columns[0], df.columns[1]",
        "    ",
        "    email_col_idx = max(email_scores, key=email_scores.get)",
        "    email_col_name = df.columns[email_col_idx]",
        "    ",
        "    # Find name column (first non-email column)",
        "    name_col_idx = None",
        "    name_col_name = None",
        "    for idx, col in enumerate(df.columns):",
        "        if idx != email_col_idx:",
        "            name_col_idx = idx",
        "            name_col_name = col",
        "            break",
        "    ",
        "    return email_col_idx, name_col_idx, email_col_name, name_col_name",
        "",
        "def load_ad_cache():",
        "    \"\"\"Load AD cache from Stage 1\"\"\"",
        "    global s2_ad_cache, s2_name_index",
        "    ",
        "    try:",
        "        cache_files = glob.glob(os.path.join(AD_CACHE_DIR, \"ad_users_*.csv\"))",
        "        if not cache_files:",
        "            return False, \"No AD cache found. Please run Stage 1 first.\"",
        "        ",
        "        latest_cache = max(cache_files, key=os.path.getmtime)",
        "        df = pd.read_csv(latest_cache)",
        "        ",
        "        # Build cache",
        "        for _, row in df.iterrows():",
        "            email = normalize_email(row['email'])",
        "            if not email:",
        "                continue",
        "            ",
        "            s2_ad_cache[email] = {",
        "                'email': email,",
        "                'name': row['displayName'],",
        "                'dept': row['department'],",
        "                'active': row['accountEnabled'],",
        "                'jobTitle': row.get('jobTitle', 'N/A'),",
        "                'lastSignIn': row.get('lastSignInDateTime', 'N/A')",
        "            }",
        "            ",
        "            # Build name index",
        "            norm_name = normalize_name_for_index(row['displayName'])",
        "            if norm_name:",
        "                s2_name_index[norm_name] = email",
        "                ",
        "                # Add reversed name",
        "                parts = norm_name.split()",
        "                if len(parts) == 2:",
        "                    reversed_name = f\"{parts[1]} {parts[0]}\"",
        "                    s2_name_index[reversed_name] = email",
        "        ",
        "        return True, f\"Loaded {len(s2_ad_cache)} users from {os.path.basename(latest_cache)}\"",
        "        ",
        "    except Exception as e:",
        "        return False, f\"Error loading AD cache: {str(e)}\"",
        "",
        "def fuzzy_match_name(target_name, top_n=5):",
        "    \"\"\"Find best email matches for a name using fuzzy matching\"\"\"",
        "    if not FUZZY_AVAILABLE or not s2_name_index or not target_name:",
        "        return []",
        "    ",
        "    norm_target = normalize_name_for_index(target_name)",
        "    if not norm_target:",
        "        return []",
        "    ",
        "    # Exact match check",
        "    if norm_target in s2_name_index:",
        "        email = s2_name_index[norm_target]",
        "        user = s2_ad_cache[email]",
        "        return [{",
        "            'email': email,",
        "            'name': user['name'],",
        "            'dept': user['dept'],",
        "            'score': 100,",
        "            'active': user['active']",
        "        }]",
        "    ",
        "    # Fuzzy search",
        "    try:",
        "        candidates = list(s2_name_index.keys())",
        "        matches = process.extract(",
        "            norm_target,",
        "            candidates,",
        "            scorer=fuzz.token_sort_ratio,",
        "            limit=top_n * 2",
        "        )",
        "        ",
        "        results = []",
        "        seen = set()",
        "        ",
        "        for match_name, score, _ in matches:",
        "            if score < 70:",
        "                continue",
        "            ",
        "            email = s2_name_index[match_name]",
        "            if email in seen:",
        "                continue",
        "            ",
        "            seen.add(email)",
        "            user = s2_ad_cache[email]",
        "            ",
        "            results.append({",
        "                'email': email,",
        "                'name': user['name'],",
        "                'dept': user['dept'],",
        "                'score': int(score),",
        "                'active': user['active']",
        "            })",
        "            ",
        "            if len(results) >= top_n:",
        "                break",
        "        ",
        "        return results",
        "    except:",
        "        return []",
        "",
        "def validate_user(input_email, input_name):",
        "    \"\"\"",
        "    Validate a single user",
        "    Returns: (validated_dict, needs_review)",
        "    \"\"\"",
        "    # Normalize inputs",
        "    email = normalize_email(input_email)",
        "    name = normalize_name(input_name)",
        "    ",
        "    result = {",
        "        'original_email': input_email,",
        "        'original_name': input_name,",
        "        'validated_email': None,",
        "        'validated_name': None,",
        "        'ad_status': None,",
        "        'validation_status': None,",
        "        'validation_notes': [],",
        "        'department': None,",
        "        'job_title': None,",
        "        'needs_review': False,",
        "        'review_options': []",
        "    }",
        "    ",
        "    # Case 1: Both empty \u2192 Skip (Q3: Option B)",
        "    if not email and not name:",
        "        result['validation_status'] = 'BOTH_EMPTY'",
        "        result['validation_notes'].append('Both email and name are empty')",
        "        return result, False  # Don't add to review, skip it",
        "    ",
        "    # Case 2: Invalid email format",
        "    if email and not is_valid_email_format(email):",
        "        result['validation_status'] = 'INVALID_FORMAT'",
        "        result['validation_notes'].append(f'Invalid email format: {email}')",
        "        result['needs_review'] = True",
        "        return result, True",
        "    ",
        "    # Case 3: Only email provided",
        "    if email and not name:",
        "        if email in s2_ad_cache:",
        "            ad_user = s2_ad_cache[email]",
        "            result['validated_email'] = email",
        "            result['validated_name'] = ad_user['name']",
        "            result['ad_status'] = 'Active' if ad_user['active'] else 'Inactive'",
        "            result['department'] = ad_user['dept']",
        "            result['job_title'] = ad_user['jobTitle']",
        "            ",
        "            if not ad_user['active']:",
        "                result['validation_status'] = 'INACTIVE_ACCOUNT'",
        "                result['validation_notes'].append('Account is inactive in AD')",
        "                result['needs_review'] = True",
        "            else:",
        "                result['validation_status'] = 'AUTO_FILLED_NAME'",
        "                result['validation_notes'].append('Name auto-filled from AD')",
        "            ",
        "            return result, result['needs_review']",
        "        else:",
        "            result['validation_status'] = 'NOT_FOUND'",
        "            result['validation_notes'].append('Email not found in AD')",
        "            result['needs_review'] = True",
        "            return result, True",
        "    ",
        "    # Case 4: Only name provided",
        "    if name and not email:",
        "        matches = fuzzy_match_name(name)",
        "        ",
        "        if not matches:",
        "            result['validation_status'] = 'NOT_FOUND'",
        "            result['validated_name'] = name",
        "            result['validation_notes'].append('Name not found in AD')",
        "            result['needs_review'] = True",
        "            return result, True",
        "        ",
        "        if len(matches) == 1:",
        "            # Single match - auto-fill (Q2: this is OK)",
        "            match = matches[0]",
        "            result['validated_email'] = match['email']",
        "            result['validated_name'] = match['name']",
        "            result['ad_status'] = 'Active' if match['active'] else 'Inactive'",
        "            result['department'] = match['dept']",
        "            ",
        "            if not match['active']:",
        "                result['validation_status'] = 'INACTIVE_ACCOUNT'",
        "                result['validation_notes'].append('Account is inactive in AD')",
        "                result['needs_review'] = True",
        "            else:",
        "                result['validation_status'] = 'AUTO_FILLED_EMAIL'",
        "                result['validation_notes'].append(f\"Email auto-filled from AD (match score: {match['score']})\")",
        "            ",
        "            return result, result['needs_review']",
        "        ",
        "        # Multiple matches - need review (Q2: Option A)",
        "        result['validation_status'] = 'AMBIGUOUS_NAME'",
        "        result['validated_name'] = name",
        "        result['validation_notes'].append(f'Found {len(matches)} possible matches')",
        "        result['needs_review'] = True",
        "        result['review_options'] = matches",
        "        return result, True",
        "    ",
        "    # Case 5: Both email and name provided",
        "    if email and name:",
        "        if email in s2_ad_cache:",
        "            ad_user = s2_ad_cache[email]",
        "            ad_name = normalize_name_for_index(ad_user['name'])",
        "            input_name_norm = normalize_name_for_index(name)",
        "            ",
        "            # Check if names match",
        "            if ad_name == input_name_norm:",
        "                # Perfect match",
        "                result['validated_email'] = email",
        "                result['validated_name'] = ad_user['name']",
        "                result['ad_status'] = 'Active' if ad_user['active'] else 'Inactive'",
        "                result['department'] = ad_user['dept']",
        "                result['job_title'] = ad_user['jobTitle']",
        "                ",
        "                if not ad_user['active']:",
        "                    result['validation_status'] = 'INACTIVE_ACCOUNT'",
        "                    result['validation_notes'].append('Account is inactive in AD')",
        "                    result['needs_review'] = True",
        "                else:",
        "                    result['validation_status'] = 'PERFECT_MATCH'",
        "                    result['validation_notes'].append('Email and name match AD perfectly')",
        "                ",
        "                return result, result['needs_review']",
        "            else:",
        "                # Mismatch - prioritize email (Q4: Option A)",
        "                result['validated_email'] = email",
        "                result['validated_name'] = ad_user['name']",
        "                result['ad_status'] = 'Active' if ad_user['active'] else 'Inactive'",
        "                result['department'] = ad_user['dept']",
        "                result['job_title'] = ad_user['jobTitle']",
        "                result['validation_status'] = 'MISMATCH_EMAIL_PRIORITY'",
        "                result['validation_notes'].append(f\"Name mismatch: Input '{name}' vs AD '{ad_user['name']}'\")",
        "                result['validation_notes'].append('Using email as source of truth')",
        "                result['needs_review'] = True",
        "                return result, True",
        "        else:",
        "            # Email not in AD",
        "            result['validation_status'] = 'NOT_FOUND'",
        "            result['validated_name'] = name",
        "            result['validation_notes'].append('Email not found in AD')",
        "            result['needs_review'] = True",
        "            return result, True",
        "    ",
        "    return result, False",
        "",
        "# ========== FILE UPLOAD HANDLER ==========",
        "",
        "def on_s2_upload_change(change):",
        "    if s2_upload.value and len(s2_upload.value) > 0:",
        "        fname = s2_upload.value[0]['name']",
        "        s2_upload_status.value = f\"<b style='color:green;'>\u2705 Selected: {fname}</b>\"",
        "        if s2_ad_cache:",
        "            s2_btn_validate.disabled = False",
        "",
        "s2_upload.observe(on_s2_upload_change, 'value')",
        "",
        "# ========== VALIDATION FUNCTION ==========",
        "",
        "def do_stage2_validate(b):",
        "    global s2_input_df, s2_input_filename, s2_validated_rows, s2_review_rows, s2_is_processing",
        "    ",
        "    if s2_is_processing:",
        "        return",
        "    ",
        "    s2_is_processing = True",
        "    b.disabled = True",
        "    s2_output.clear_output()",
        "    s2_validated_rows = []",
        "    s2_review_rows = []",
        "    ",
        "    if not s2_upload.value:",
        "        with s2_output:",
        "            print(\"\u274c Please upload a user list file\")",
        "        s2_is_processing = False",
        "        b.disabled = False",
        "        return",
        "    ",
        "    try:",
        "        with s2_output:",
        "            print(\"\\n\" + \"=\"*70)",
        "            print(\"\ud83d\udd0d Stage 2: Ultra Email/User Validation\")",
        "            print(\"=\"*70 + \"\\n\")",
        "        ",
        "        # Load file",
        "        f_item = s2_upload.value[0]",
        "        s2_input_filename = f_item['name']",
        "        ",
        "        if s2_input_filename.endswith('.csv'):",
        "            s2_input_df = pd.read_csv(io.BytesIO(f_item['content']))",
        "        else:",
        "            s2_input_df = pd.read_excel(io.BytesIO(f_item['content']))",
        "        ",
        "        logger_s2.info(f\"Loaded input file: {s2_input_filename}, {len(s2_input_df)} rows\")",
        "        ",
        "        with s2_output:",
        "            print(f\"\ud83d\udcc4 Loaded: {s2_input_filename}\")",
        "            print(f\"   Rows: {len(s2_input_df)}\")",
        "            print(f\"   Columns: {list(s2_input_df.columns)}\\n\")",
        "        ",
        "        # Detect columns",
        "        email_idx, name_idx, email_col, name_col = detect_columns(s2_input_df)",
        "        ",
        "        if email_idx is None or name_idx is None:",
        "            raise Exception(\"Could not detect email and name columns\")",
        "        ",
        "        with s2_output:",
        "            print(f\"\ud83d\udccb Auto-detected columns:\")",
        "            print(f\"   Email column: '{email_col}' (column {email_idx})\")",
        "            print(f\"   Name column: '{name_col}' (column {name_idx})\\n\")",
        "        ",
        "        logger_s2.info(f\"Detected columns: Email='{email_col}', Name='{name_col}'\")",
        "        ",
        "        # Validate each user",
        "        stats = {cat: 0 for cat in CATEGORIES.keys()}",
        "        ",
        "        with s2_output:",
        "            print(\"\ud83d\udd0d Validating users...\")",
        "            print()",
        "        ",
        "        for idx, row in s2_input_df.iterrows():",
        "            input_email = row[email_col]",
        "            input_name = row[name_col]",
        "            ",
        "            validated, needs_review = validate_user(input_email, input_name)",
        "            ",
        "            # Add other columns from input",
        "            for col in s2_input_df.columns:",
        "                if col not in [email_col, name_col]:",
        "                    validated[col] = row[col]",
        "            ",
        "            if validated['validation_status'] != 'BOTH_EMPTY':",
        "                s2_validated_rows.append(validated)",
        "                stats[validated['validation_status']] += 1",
        "                ",
        "                if needs_review:",
        "                    s2_review_rows.append(validated)",
        "        ",
        "        # Display statistics",
        "        with s2_output:",
        "            print(\"=\"*70)",
        "            print(\"\ud83d\udcca Validation Summary\")",
        "            print(\"=\"*70)",
        "            for cat, count in stats.items():",
        "                if count > 0:",
        "                    print(f\"{CATEGORIES[cat]:40} {count:>5}\")",
        "            print(\"=\"*70)",
        "            print(f\"Total validated: {len(s2_validated_rows)}\")",
        "            print(f\"Need review: {len(s2_review_rows)}\")",
        "            print(\"=\"*70 + \"\\n\")",
        "        ",
        "        logger_s2.info(f\"Validation complete: {len(s2_validated_rows)} validated, {len(s2_review_rows)} need review\")",
        "        ",
        "        # Render review UI if needed",
        "        if s2_review_rows:",
        "            render_review_ui()",
        "        else:",
        "            s2_review_container.children = [",
        "                widgets.HTML(\"<h3 style='color:green;'>\u2705 All users validated successfully! No manual review needed.</h3>\")",
        "            ]",
        "        ",
        "        s2_btn_save.disabled = False",
        "        s2_status.value = f\"<span style='color:green;'>\u2705 Validation complete: {len(s2_validated_rows)} users</span>\"",
        "        ",
        "    except Exception as e:",
        "        with s2_output:",
        "            print(f\"\\n\u274c Error: {str(e)}\")",
        "        logger_s2.error(f\"Validation error: {str(e)}\", exc_info=True)",
        "        s2_status.value = f\"<span style='color:red;'>\u274c Error: {str(e)}</span>\"",
        "    finally:",
        "        s2_is_processing = False",
        "        b.disabled = False",
        "",
        "# ========== MANUAL REVIEW UI ==========",
        "",
        "def create_review_card(group_name, group_rows, group_status):",
        "    \"\"\"Create a collapsible card for a review group\"\"\"",
        "    if not group_rows:",
        "        return widgets.VBox()",
        "    ",
        "    # Status colors",
        "    status_colors = {",
        "        'NOT_FOUND': APPLE_COLORS['red'],",
        "        'INACTIVE_ACCOUNT': APPLE_COLORS['orange'],",
        "        'AMBIGUOUS_NAME': APPLE_COLORS['orange'],",
        "        'MISMATCH_EMAIL_PRIORITY': APPLE_COLORS['orange'],",
        "        'INVALID_FORMAT': APPLE_COLORS['red']",
        "    }",
        "    color = status_colors.get(group_status, APPLE_COLORS['blue'])",
        "    ",
        "    # Header",
        "    header_html = widgets.HTML(f'''",
        "    <div style=\"",
        "        background: {color};",
        "        color: white;",
        "        padding: 16px 24px;",
        "        border-radius: 12px 12px 0 0;",
        "        font-family: -apple-system;",
        "        font-size: 18px;",
        "        font-weight: 600;",
        "    \">",
        "        {group_name} ({len(group_rows)} items)",
        "    </div>",
        "    ''')",
        "    ",
        "    # Batch action buttons",
        "    btn_select_all = widgets.Button(",
        "        description=\"Select All\",",
        "        layout=widgets.Layout(width='120px', height='36px', margin='0 4px 0 0')",
        "    )",
        "    btn_deselect_all = widgets.Button(",
        "        description=\"Deselect All\",",
        "        layout=widgets.Layout(width='120px', height='36px', margin='0 4px 0 0')",
        "    )",
        "    btn_skip_all = widgets.Button(",
        "        description=\"Skip All\",",
        "        button_style='danger',",
        "        layout=widgets.Layout(width='120px', height='36px')",
        "    )",
        "    ",
        "    batch_actions = widgets.HBox([",
        "        btn_select_all, btn_deselect_all, btn_skip_all",
        "    ], layout=widgets.Layout(padding='12px 24px'))",
        "    ",
        "    # Create checkboxes and row widgets",
        "    checkboxes = []",
        "    row_widgets = []",
        "    ",
        "    for idx, row in enumerate(group_rows):",
        "        chk = widgets.Checkbox(value=False, layout=widgets.Layout(width='30px'))",
        "        ",
        "        notes_html = ' \u2022 '.join(row['validation_notes']) if isinstance(row['validation_notes'], list) else str(row['validation_notes'])",
        "        ",
        "        row_html = widgets.HTML(f'''",
        "        <div style=\"padding: 12px; border-bottom: 1px solid #E5E5EA; font-family: -apple-system;\">",
        "            <div style=\"font-weight: 600; margin-bottom: 4px;\">",
        "                {row.get('original_email', '') or '(empty)'}",
        "            </div>",
        "            <div style=\"color: #86868B; font-size: 14px; margin-bottom: 8px;\">",
        "                {row.get('original_name', '') or '(empty)'}",
        "            </div>",
        "            <div style=\"font-size: 13px; color: #666;\">",
        "                {notes_html}",
        "            </div>",
        "        </div>",
        "        ''')",
        "        ",
        "        row_container = widgets.HBox([chk, row_html], layout=widgets.Layout(align_items='center'))",
        "        checkboxes.append((idx, chk, row))",
        "        row_widgets.append(row_container)",
        "    ",
        "    # Batch action handlers",
        "    def select_all(b):",
        "        for _, chk, _ in checkboxes:",
        "            chk.value = True",
        "    ",
        "    def deselect_all(b):",
        "        for _, chk, _ in checkboxes:",
        "            chk.value = False",
        "    ",
        "    def skip_all(b):",
        "        count = 0",
        "        for _, chk, row in checkboxes:",
        "            if chk.value:",
        "                row['action'] = 'skip'",
        "                count += 1",
        "        btn_skip_all.description = f\"\u2713 Skipped {count}\"",
        "        btn_skip_all.disabled = True",
        "    ",
        "    btn_select_all.on_click(select_all)",
        "    btn_deselect_all.on_click(deselect_all)",
        "    btn_skip_all.on_click(skip_all)",
        "    ",
        "    # Card content",
        "    card_content = widgets.VBox(",
        "        row_widgets,",
        "        layout=widgets.Layout(max_height='400px', overflow_y='auto')",
        "    )",
        "    ",
        "    # Card container",
        "    card = widgets.VBox([",
        "        header_html,",
        "        batch_actions,",
        "        card_content",
        "    ], layout=widgets.Layout(",
        "        border='1px solid #D2D2D7',",
        "        border_radius='12px',",
        "        margin='0 0 16px 0',",
        "        overflow='hidden'",
        "    ))",
        "    ",
        "    return card",
        "",
        "def render_review_ui():",
        "    \"\"\"Render manual review UI for rows needing review\"\"\"",
        "    global s2_review_rows",
        "    ",
        "    if not s2_review_rows:",
        "        s2_review_container.children = []",
        "        return",
        "    ",
        "    # Group rows by status",
        "    groups = {}",
        "    status_names = {",
        "        'NOT_FOUND': 'Not Found in AD',",
        "        'INACTIVE_ACCOUNT': 'Inactive Account',",
        "        'AMBIGUOUS_NAME': 'Ambiguous Name Match',",
        "        'MISMATCH_EMAIL_PRIORITY': 'Name Mismatch (Email Priority)',",
        "        'INVALID_FORMAT': 'Invalid Email Format'",
        "    }",
        "    ",
        "    for row in s2_review_rows:",
        "        status = row['validation_status']",
        "        if status not in groups:",
        "            groups[status] = []",
        "        groups[status].append(row)",
        "    ",
        "    rows_ui = []",
        "    ",
        "    # Header",
        "    header = widgets.HTML(f\"\"\"",
        "        <div style='background:linear-gradient(135deg,#f093fb 0%,#f5576c 100%);color:white;padding:16px;border-radius:8px;margin:16px 0;'>",
        "            <h3 style='margin:0 0 8px 0;'>\u26a0\ufe0f Manual Review Required ({len(s2_review_rows)} items)</h3>",
        "            <p style='margin:0;opacity:0.9;'>Review and edit the suggestions below before saving</p>",
        "        </div>",
        "    \"\"\")",
        "    rows_ui.append(header)",
        "    ",
        "    # Create cards for each group",
        "    for status, rows in groups.items():",
        "        if status in status_names:",
        "            card = create_review_card(status_names[status], rows, status)",
        "            rows_ui.append(card)",
        "    ",
        "    s2_review_container.children = rows_ui",
        "",
        "def create_review_row_widget(idx, row):",
        "    \"\"\"Create widget for a single review row\"\"\"",
        "    ",
        "    # Status badge",
        "    status = row['validation_status']",
        "    status_label = CATEGORIES.get(status, status)",
        "    ",
        "    if status.startswith('\u274c'):",
        "        badge_color = '#dc3545'",
        "    elif status.startswith('\u26a0\ufe0f'):",
        "        badge_color = '#ffc107'",
        "    else:",
        "        badge_color = '#28a745'",
        "    ",
        "    # Build UI",
        "    status_html = widgets.HTML(f\"\"\"",
        "        <div style='background:{badge_color};color:white;padding:8px 12px;border-radius:4px;font-weight:600;margin-bottom:8px;'>",
        "            {status_label}",
        "        </div>",
        "        <div style='font-size:0.9em;color:#666;margin-bottom:12px;'>",
        "            {' \u2022 '.join(row['validation_notes'])}",
        "        </div>",
        "    \"\"\")",
        "    ",
        "    # Input fields",
        "    input_html = widgets.HTML(f\"\"\"",
        "        <div style='display:grid;grid-template-columns:1fr 1fr;gap:12px;padding:8px;background:#f8f9fa;border-radius:4px;margin-bottom:8px;'>",
        "            <div>",
        "                <b>Original Email:</b><br>",
        "                <code>{row['original_email']}</code>",
        "            </div>",
        "            <div>",
        "                <b>Original Name:</b><br>",
        "                <code>{row['original_name']}</code>",
        "            </div>",
        "        </div>",
        "    \"\"\")",
        "    ",
        "    # Editable fields",
        "    email_input = widgets.Text(",
        "        value=row.get('validated_email', '') or '',",
        "        description='Email:',",
        "        layout=widgets.Layout(width='45%')",
        "    )",
        "    ",
        "    name_input = widgets.Text(",
        "        value=row.get('validated_name', '') or '',",
        "        description='Name:',",
        "        layout=widgets.Layout(width='45%')",
        "    )",
        "    ",
        "    # Handle ambiguous name case",
        "    if status == 'AMBIGUOUS_NAME' and row.get('review_options'):",
        "        options_list = []",
        "        for opt in row['review_options']:",
        "            label = f\"{opt['name']} ({opt['email']}) - {opt['dept']} [Score: {opt['score']}]\"",
        "            options_list.append((label, opt))",
        "        ",
        "        dropdown = widgets.Dropdown(",
        "            options=[('-- Select --', None)] + options_list,",
        "            description='Select:',",
        "            layout=widgets.Layout(width='90%')",
        "        )",
        "        ",
        "        def on_select_change(change, idx=idx, email_input=email_input, name_input=name_input):",
        "            if change['new']:",
        "                selected = change['new']",
        "                email_input.value = selected['email']",
        "                name_input.value = selected['name']",
        "                s2_review_rows[idx]['validated_email'] = selected['email']",
        "                s2_review_rows[idx]['validated_name'] = selected['name']",
        "        ",
        "        dropdown.observe(on_select_change, 'value')",
        "        ",
        "        fields = widgets.VBox([",
        "            dropdown,",
        "            widgets.HBox([email_input, name_input])",
        "        ])",
        "    else:",
        "        fields = widgets.HBox([email_input, name_input])",
        "    ",
        "    # Update handlers",
        "    def update_email(change, idx=idx):",
        "        s2_review_rows[idx]['validated_email'] = change['new']",
        "    ",
        "    def update_name(change, idx=idx):",
        "        s2_review_rows[idx]['validated_name'] = change['new']",
        "    ",
        "    email_input.observe(update_email, 'value')",
        "    name_input.observe(update_name, 'value')",
        "    ",
        "    # Action buttons",
        "    keep_btn = widgets.Button(description='\u2713 Keep', button_style='success', layout=widgets.Layout(width='100px'))",
        "    skip_btn = widgets.Button(description='\u2717 Skip', button_style='danger', layout=widgets.Layout(width='100px'))",
        "    ",
        "    def on_keep(b, idx=idx):",
        "        # Mark as kept",
        "        s2_review_rows[idx]['action'] = 'keep'",
        "        b.description = '\u2713 Kept'",
        "        b.disabled = True",
        "    ",
        "    def on_skip(b, idx=idx):",
        "        # Mark as skipped",
        "        s2_review_rows[idx]['action'] = 'skip'",
        "        b.description = '\u2717 Skipped'",
        "        b.disabled = True",
        "    ",
        "    keep_btn.on_click(on_keep)",
        "    skip_btn.on_click(on_skip)",
        "    ",
        "    actions = widgets.HBox([keep_btn, skip_btn])",
        "    ",
        "    # Container",
        "    container = widgets.VBox([",
        "        status_html,",
        "        input_html,",
        "        fields,",
        "        actions",
        "    ], layout=widgets.Layout(",
        "        border='1px solid #ddd',",
        "        border_radius='8px',",
        "        padding='16px',",
        "        margin='8px 0'",
        "    ))",
        "    ",
        "    return container",
        "",
        "# ========== SAVE FUNCTION ==========",
        "",
        "def do_stage2_save(b):",
        "    if not s2_validated_rows:",
        "        with s2_output:",
        "            print(\"\u274c No validated data to save\")",
        "        return",
        "    ",
        "    b.disabled = True",
        "    ",
        "    try:",
        "        # Apply review changes",
        "        final_rows = []",
        "        for row in s2_validated_rows:",
        "            # Check if this row is in review and was skipped",
        "            if row in s2_review_rows and row.get('action') == 'skip':",
        "                continue",
        "            final_rows.append(row)",
        "        ",
        "        # Build DataFrame",
        "        df_output = pd.DataFrame(final_rows)",
        "        ",
        "        # Reorder columns",
        "        priority_cols = [",
        "            'original_email', 'original_name',",
        "            'validated_email', 'validated_name',",
        "            'ad_status', 'validation_status',",
        "            'validation_notes', 'department', 'job_title'",
        "        ]",
        "        ",
        "        other_cols = [c for c in df_output.columns if c not in priority_cols + ['needs_review', 'review_options', 'action']]",
        "        ",
        "        final_cols = [c for c in priority_cols if c in df_output.columns] + other_cols",
        "        df_output = df_output[final_cols]",
        "        ",
        "        # Convert validation_notes list to string",
        "        if 'validation_notes' in df_output.columns:",
        "            df_output['validation_notes'] = df_output['validation_notes'].apply(lambda x: '; '.join(x) if isinstance(x, list) else x)",
        "        ",
        "        # Generate filename",
        "        base_name = s2_input_filename.replace('.csv', '').replace('.xlsx', '')",
        "        date_str = datetime.now().strftime('%Y%m%d')",
        "        output_filename = f\"{base_name}_User_Listing_{date_str}_AD_verified.xlsx\"",
        "        output_path = os.path.join(STAGE2_DIR, output_filename)",
        "        ",
        "        # Save",
        "        df_output.to_excel(output_path, index=False, sheet_name='Validated Users')",
        "        ",
        "        with s2_output:",
        "            print(\"\\n\" + \"=\"*70)",
        "            print(\"\ud83d\udcbe File Saved\")",
        "            print(\"=\"*70)",
        "            print(f\"Location: {output_path}\")",
        "            print(f\"Rows: {len(df_output)}\")",
        "            print(f\"Columns: {list(df_output.columns[:9])}...\")",
        "            print(\"=\"*70)",
        "        ",
        "        s2_status.value = f\"<span style='color:blue;'>\u2705 Saved: {output_filename}</span>\"",
        "        logger_s2.info(f\"Saved validated file: {output_path}\")",
        "        ",
        "    except Exception as e:",
        "        with s2_output:",
        "            print(f\"\\n\u274c Save error: {str(e)}\")",
        "        logger_s2.error(f\"Save error: {str(e)}\", exc_info=True)",
        "    finally:",
        "        b.disabled = False",
        "",
        "# ========== BIND EVENTS ==========",
        "s2_btn_validate.on_click(do_stage2_validate)",
        "s2_btn_save.on_click(do_stage2_save)",
        "",
        "# ========== AUTO-LOAD FROM STAGE 1 ==========",
        "# Try to auto-load latest AD cache",
        "latest_cache = get_latest_file(AD_CACHE_DIR, 'ad_users_*.csv')",
        "if latest_cache:",
        "    s2_status.value = f'<span style=\"color:{APPLE_COLORS[\"green\"]};font-family:-apple-system;\">\u2705 Auto-loaded: {os.path.basename(latest_cache)}</span>'",
        "",
        "# ========== INITIALIZE ==========",
        "success, msg = load_ad_cache()",
        "if success:",
        "    s2_status.value = f\"<span style='color:green;'>\u2705 {msg}</span>\"",
        "    logger_s2.info(msg)",
        "else:",
        "    s2_status.value = f\"<span style='color:orange;'>\u26a0\ufe0f {msg}</span>\"",
        "    logger_s2.warning(msg)",
        "",
        "# ========== UI LAYOUT ==========",
        "stage2_ui = widgets.VBox([",
        "    widgets.HTML(\"\"\"",
        "        <div style='",
        "            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);",
        "            padding: 20px;",
        "            border-radius: 8px;",
        "            color: white;",
        "            margin-bottom: 20px;",
        "        '>",
        "            <h2 style='margin: 0 0 10px 0;'>\ud83d\udd0d Stage 2: Ultra Email/User Validation</h2>",
        "            <p style='margin: 0; opacity: 0.9;'>",
        "                \u2728 Auto-detect columns \u2022 \ud83c\udfaf Card-based review \u2022 \u26a0\ufe0f Edge case handling \u2022 \u270f\ufe0f Manual review UI",
        "            </p>",
        "        </div>",
        "    \"\"\"),",
        "    widgets.HBox([s2_upload, s2_upload_status]),",
        "    widgets.HBox([s2_btn_validate, s2_btn_save]),",
        "    s2_status,",
        "    s2_review_container,",
        "    s2_output",
        "])",
        "",
        "clear_output()",
        "display(stage2_ui)",
        "",
        "logger_s2.info(\"Stage 2 Ultra Validation UI initialized\")",
        "logger_s2.info(\"=\"*60)",
        ""
      ],
      "execution_count": null,
      "outputs": []
    },
    {
      "cell_type": "code",
      "metadata": {},
      "source": [
        "# ========================================================================",
        "# CELL 5: Stage 3 - Reviewer Assignment (Complete Implementation)",
        "# ========================================================================",
        "",
        "import os",
        "import pandas as pd",
        "import ipywidgets as widgets",
        "from datetime import datetime",
        "from IPython.display import display, HTML, clear_output",
        "",
        "# Paths",
        "STAGE2_DIR = os.path.join(BASE_DIR, \"stage2_validated\")",
        "STAGE3_DIR = os.path.join(BASE_DIR, \"stage3_final\")",
        "MAPPING_DIR = \"input/mapping\"",
        "os.makedirs(STAGE3_DIR, exist_ok=True)",
        "os.makedirs(MAPPING_DIR, exist_ok=True)",
        "",
        "# Logger",
        "s3_logger = setup_logger(\"stage3\", os.path.join(LOG_DIR, f\"stage3_{datetime.now().strftime('%Y%m%d_%H%M')}.log\"))",
        "",
        "# ========== GLOBAL STATE ==========",
        "s3_validated_users = None",
        "s3_dept_mapping = None",
        "s3_assigned_users = []",
        "s3_review_rows = []",
        "s3_is_processing = False",
        "",
        "# ========== UI COMPONENTS ==========",
        "",
        "s3_file_status = widgets.HTML(\"<i>No file loaded</i>\")",
        "s3_mapping_status = widgets.HTML(\"<i>No mapping loaded</i>\")",
        "s3_status = widgets.HTML(\"<i>Ready to assign reviewers</i>\")",
        "s3_output = widgets.Output()",
        "s3_review_container = widgets.VBox()",
        "s3_progress = widgets.IntProgress(",
        "    value=0, min=0, max=100,",
        "    description='Progress:',",
        "    bar_style='info',",
        "    layout=widgets.Layout(width='100%', visibility='hidden')",
        ")",
        "",
        "btn_s3_assign = widgets.Button(",
        "    description=\"\ud83c\udfaf Assign Reviewers\",",
        "    button_style='',",
        "    layout=get_button_layout(width='200px'),",
        "    disabled=True",
        ")",
        "btn_s3_assign.style.button_color = APPLE_COLORS['blue']",
        "",
        "btn_s3_save = widgets.Button(",
        "    description=\"\ud83d\udcbe Save Final Report\",",
        "    button_style='',",
        "    layout=get_button_layout(width='200px'),",
        "    disabled=True",
        ")",
        "btn_s3_save.style.button_color = APPLE_COLORS['green']",
        "",
        "# File upload widgets (fallback)",
        "s3_upload_users = widgets.FileUpload(",
        "    accept='.xlsx, .csv',",
        "    description=\"Upload Users\",",
        "    button_style='info',",
        "    layout=widgets.Layout(width='200px')",
        ")",
        "",
        "s3_upload_mapping = widgets.FileUpload(",
        "    accept='.csv',",
        "    description=\"Upload Mapping\",",
        "    button_style='info',",
        "    layout=widgets.Layout(width='200px')",
        ")",
        "",
        "# ========== AUTO-LOAD FILES ==========",
        "",
        "def auto_load_files():",
        "    \"\"\"Auto-load from Stage 2 and mapping directory\"\"\"",
        "    global s3_validated_users, s3_dept_mapping",
        "    ",
        "    s3_logger.info(\"Attempting to auto-load files...\")",
        "    ",
        "    # Try to load validated users from Stage 2",
        "    latest_users = get_latest_file(STAGE2_DIR, '*.xlsx')",
        "    ",
        "    if latest_users:",
        "        try:",
        "            s3_validated_users = pd.read_excel(latest_users)",
        "            s3_logger.info(f\"Auto-loaded users: {latest_users}\")",
        "            s3_file_status.value = f'<span style=\"color:{APPLE_COLORS[\"green\"]};font-family:-apple-system;\">\u2705 Auto-loaded: {os.path.basename(latest_users)} ({len(s3_validated_users)} users)</span>'",
        "        except Exception as e:",
        "            s3_logger.error(f\"Error loading users: {e}\")",
        "            s3_file_status.value = f'<span style=\"color:{APPLE_COLORS[\"red\"]};\">\u274c Error loading: {str(e)}</span>'",
        "    else:",
        "        s3_file_status.value = f'<span style=\"color:{APPLE_COLORS[\"orange\"]};\">\u26a0\ufe0f No files found in {STAGE2_DIR}. Please upload manually.</span>'",
        "    ",
        "    # Try to load dept mapping (with prefix priority)",
        "    latest_mapping = get_latest_file(MAPPING_DIR, '*.csv', prefix_priority='dept-mapping')",
        "    ",
        "    if latest_mapping:",
        "        try:",
        "            s3_dept_mapping = pd.read_csv(latest_mapping)",
        "            s3_logger.info(f\"Auto-loaded mapping: {latest_mapping}\")",
        "            s3_mapping_status.value = f'<span style=\"color:{APPLE_COLORS[\"green\"]};font-family:-apple-system;\">\u2705 Auto-loaded: {os.path.basename(latest_mapping)} ({len(s3_dept_mapping)} mappings)</span>'",
        "        except Exception as e:",
        "            s3_logger.error(f\"Error loading mapping: {e}\")",
        "            s3_mapping_status.value = f'<span style=\"color:{APPLE_COLORS[\"red\"]};\">\u274c Error loading: {str(e)}</span>'",
        "    else:",
        "        s3_mapping_status.value = f'<span style=\"color:{APPLE_COLORS[\"orange\"]};\">\u26a0\ufe0f No mapping found. Please upload dept-mapping_*.csv manually.</span>'",
        "    ",
        "    # Enable assign button if both loaded",
        "    if s3_validated_users is not None and s3_dept_mapping is not None:",
        "        btn_s3_assign.disabled = False",
        "        s3_status.value = f'<span style=\"color:{APPLE_COLORS[\"blue\"]};font-family:-apple-system;\">\u2705 Ready to assign reviewers</span>'",
        "    ",
        "    return s3_validated_users is not None, s3_dept_mapping is not None",
        "",
        "# ========== FILE UPLOAD HANDLERS ==========",
        "",
        "def on_users_upload(change):",
        "    \"\"\"Handle manual user file upload\"\"\"",
        "    global s3_validated_users",
        "    ",
        "    if s3_upload_users.value and len(s3_upload_users.value) > 0:",
        "        try:",
        "            file_item = s3_upload_users.value[0]",
        "            filename = file_item['name']",
        "            ",
        "            if filename.endswith('.csv'):",
        "                s3_validated_users = pd.read_csv(io.BytesIO(file_item['content']))",
        "            else:",
        "                s3_validated_users = pd.read_excel(io.BytesIO(file_item['content']))",
        "            ",
        "            s3_logger.info(f\"Manually uploaded users: {filename}\")",
        "            s3_file_status.value = f'<span style=\"color:{APPLE_COLORS[\"green\"]};\">\u2705 Uploaded: {filename} ({len(s3_validated_users)} users)</span>'",
        "            ",
        "            if s3_dept_mapping is not None:",
        "                btn_s3_assign.disabled = False",
        "                ",
        "        except Exception as e:",
        "            s3_logger.error(f\"Error uploading users: {e}\")",
        "            s3_file_status.value = f'<span style=\"color:{APPLE_COLORS[\"red\"]};\">\u274c Error: {str(e)}</span>'",
        "",
        "def on_mapping_upload(change):",
        "    \"\"\"Handle manual mapping file upload\"\"\"",
        "    global s3_dept_mapping",
        "    ",
        "    if s3_upload_mapping.value and len(s3_upload_mapping.value) > 0:",
        "        try:",
        "            file_item = s3_upload_mapping.value[0]",
        "            filename = file_item['name']",
        "            ",
        "            s3_dept_mapping = pd.read_csv(io.BytesIO(file_item['content']))",
        "            ",
        "            s3_logger.info(f\"Manually uploaded mapping: {filename}\")",
        "            s3_mapping_status.value = f'<span style=\"color:{APPLE_COLORS[\"green\"]};\">\u2705 Uploaded: {filename} ({len(s3_dept_mapping)} mappings)</span>'",
        "            ",
        "            if s3_validated_users is not None:",
        "                btn_s3_assign.disabled = False",
        "                ",
        "        except Exception as e:",
        "            s3_logger.error(f\"Error uploading mapping: {e}\")",
        "            s3_mapping_status.value = f'<span style=\"color:{APPLE_COLORS[\"red\"]};\">\u274c Error: {str(e)}</span>'",
        "",
        "s3_upload_users.observe(on_users_upload, 'value')",
        "s3_upload_mapping.observe(on_mapping_upload, 'value')",
        "",
        "# ========== REVIEWER ASSIGNMENT LOGIC ==========",
        "",
        "def assign_reviewer(user_row, dept_mapping_df):",
        "    \"\"\"",
        "    Assign reviewer based on department mapping",
        "    ",
        "    Args:",
        "        user_row: dict with user info (must have 'department' key)",
        "        dept_mapping_df: DataFrame with columns [email, department, reviewer, branch]",
        "    ",
        "    Returns:",
        "        dict with assignment info",
        "    \"\"\"",
        "    user_dept = user_row.get('department', 'Unknown')",
        "    user_email = user_row.get('validated_email', user_row.get('original_email', ''))",
        "    ",
        "    result = {",
        "        'email': user_email,",
        "        'name': user_row.get('validated_name', user_row.get('original_name', '')),",
        "        'department': user_dept,",
        "        'reviewer': None,",
        "        'reviewer_name': None,",
        "        'branch': None,",
        "        'assignment_status': None,",
        "        'assignment_notes': []",
        "    }",
        "    ",
        "    # Find matching dept in mapping",
        "    # Normalize dept names for matching",
        "    user_dept_norm = str(user_dept).strip().lower()",
        "    ",
        "    matches = dept_mapping_df[",
        "        dept_mapping_df['department'].str.strip().str.lower() == user_dept_norm",
        "    ]",
        "    ",
        "    if len(matches) == 0:",
        "        # No mapping found",
        "        result['assignment_status'] = 'NO_MAPPING'",
        "        result['assignment_notes'].append(f'No mapping found for department: {user_dept}')",
        "        return result",
        "    ",
        "    if len(matches) > 1:",
        "        # Multiple mappings (take first)",
        "        s3_logger.warning(f\"Multiple mappings for {user_dept}, using first\")",
        "        result['assignment_notes'].append('Multiple mappings found, used first')",
        "    ",
        "    mapping_row = matches.iloc[0]",
        "    ",
        "    result['reviewer'] = mapping_row.get('reviewer', None)",
        "    result['branch'] = mapping_row.get('branch', None)",
        "    ",
        "    # Try to get reviewer name from AD cache if available",
        "    if result['reviewer'] and 's2_ad_cache' in globals() and result['reviewer'] in s2_ad_cache:",
        "        result['reviewer_name'] = s2_ad_cache[result['reviewer']]['name']",
        "    ",
        "    if result['reviewer']:",
        "        result['assignment_status'] = 'ASSIGNED'",
        "        result['assignment_notes'].append(f'Assigned to {result[\"reviewer\"]}')",
        "    else:",
        "        result['assignment_status'] = 'NO_REVIEWER'",
        "        result['assignment_notes'].append('Mapping exists but reviewer is empty')",
        "    ",
        "    return result",
        "",
        "# ========== ASSIGN REVIEWERS FUNCTION ==========",
        "",
        "def do_assign_reviewers(b):",
        "    \"\"\"Assign reviewers to all validated users\"\"\"",
        "    global s3_assigned_users, s3_review_rows, s3_is_processing",
        "    ",
        "    if s3_is_processing:",
        "        return",
        "    ",
        "    s3_is_processing = True",
        "    b.disabled = True",
        "    s3_progress.layout.visibility = 'visible'",
        "    s3_progress.value = 0",
        "    s3_output.clear_output()",
        "    s3_assigned_users = []",
        "    s3_review_rows = []",
        "    ",
        "    try:",
        "        with s3_output:",
        "            print(\"\ud83c\udfaf Assigning reviewers...\")",
        "        ",
        "        s3_logger.info(f\"Starting reviewer assignment for {len(s3_validated_users)} users\")",
        "        ",
        "        # Statistics",
        "        stats = {",
        "            'ASSIGNED': 0,",
        "            'NO_MAPPING': 0,",
        "            'NO_REVIEWER': 0",
        "        }",
        "        ",
        "        total = len(s3_validated_users)",
        "        ",
        "        for idx, row in s3_validated_users.iterrows():",
        "            # Assign reviewer",
        "            assignment = assign_reviewer(row.to_dict(), s3_dept_mapping)",
        "            ",
        "            # Merge with original user data",
        "            full_row = {**row.to_dict(), **assignment}",
        "            ",
        "            s3_assigned_users.append(full_row)",
        "            ",
        "            # Track statistics",
        "            stats[assignment['assignment_status']] += 1",
        "            ",
        "            # Add to review if problematic",
        "            if assignment['assignment_status'] != 'ASSIGNED':",
        "                s3_review_rows.append(full_row)",
        "            ",
        "            # Update progress",
        "            progress = int((idx + 1) / total * 100)",
        "            s3_progress.value = progress",
        "            ",
        "            # Log every 50 users",
        "            if (idx + 1) % 50 == 0:",
        "                s3_logger.info(f\"Processed {idx + 1}/{total} users\")",
        "        ",
        "        # Display summary",
        "        with s3_output:",
        "            clear_output()",
        "            print(\"=\"*60)",
        "            print(\"\ud83d\udcca Assignment Summary\")",
        "            print(\"=\"*60)",
        "            print(f\"\u2705 Assigned:          {stats['ASSIGNED']}\")",
        "            print(f\"\u26a0\ufe0f  No Mapping:        {stats['NO_MAPPING']}\")",
        "            print(f\"\u26a0\ufe0f  No Reviewer:       {stats['NO_REVIEWER']}\")",
        "            print(\"=\"*60)",
        "            print(f\"Total: {len(s3_assigned_users)}\")",
        "            print(f\"Need Review: {len(s3_review_rows)}\")",
        "            print(\"=\"*60)",
        "        ",
        "        s3_logger.info(f\"Assignment complete. Assigned: {stats['ASSIGNED']}, Need review: {len(s3_review_rows)}\")",
        "        ",
        "        # Render review UI if needed",
        "        if s3_review_rows:",
        "            render_s3_review_ui()",
        "        else:",
        "            s3_review_container.children = [",
        "                widgets.HTML(f'<div style=\"color:{APPLE_COLORS[\"green\"]};font-family:-apple-system;padding:16px;\"><h3>\u2705 All users assigned successfully!</h3></div>')",
        "            ]",
        "        ",
        "        # Enable save button",
        "        btn_s3_save.disabled = False",
        "        s3_status.value = f'<span style=\"color:{APPLE_COLORS[\"green\"]};font-family:-apple-system;\">\u2705 Assignment complete</span>'",
        "        ",
        "    except Exception as e:",
        "        with s3_output:",
        "            print(f\"\u274c Error: {str(e)}\")",
        "        s3_logger.error(f\"Assignment error: {str(e)}\", exc_info=True)",
        "        s3_status.value = f'<span style=\"color:{APPLE_COLORS[\"red\"]};\">\u274c Error: {str(e)}</span>'",
        "    finally:",
        "        s3_is_processing = False",
        "        b.disabled = False",
        "        s3_progress.layout.visibility = 'hidden'",
        "",
        "btn_s3_assign.on_click(do_assign_reviewers)",
        "",
        "# ========== REVIEW UI ==========",
        "",
        "def create_s3_review_card(group_name, group_rows, group_status):",
        "    \"\"\"Create review card for Stage 3\"\"\"",
        "    if not group_rows:",
        "        return widgets.VBox()",
        "    ",
        "    # Status colors",
        "    status_colors = {",
        "        'NO_MAPPING': APPLE_COLORS['red'],",
        "        'NO_REVIEWER': APPLE_COLORS['orange']",
        "    }",
        "    color = status_colors.get(group_status, APPLE_COLORS['blue'])",
        "    ",
        "    # Header",
        "    header_html = widgets.HTML(f'''",
        "    <div style=\"",
        "        background: {color};",
        "        color: white;",
        "        padding: 16px 24px;",
        "        border-radius: 12px 12px 0 0;",
        "        font-family: -apple-system;",
        "        font-size: 18px;",
        "        font-weight: 600;",
        "    \">",
        "        {group_name} ({len(group_rows)} items)",
        "    </div>",
        "    ''')",
        "    ",
        "    # Batch action buttons",
        "    btn_select_all = widgets.Button(",
        "        description=\"Select All\",",
        "        layout=widgets.Layout(width='120px', height='36px', margin='0 4px 0 0')",
        "    )",
        "    btn_skip_all = widgets.Button(",
        "        description=\"Skip All\",",
        "        button_style='danger',",
        "        layout=widgets.Layout(width='120px', height='36px')",
        "    )",
        "    ",
        "    batch_actions = widgets.HBox([",
        "        btn_select_all, btn_skip_all",
        "    ], layout=widgets.Layout(padding='12px 24px'))",
        "    ",
        "    # Create rows",
        "    checkboxes = []",
        "    row_widgets = []",
        "    ",
        "    for idx, row in enumerate(group_rows):",
        "        chk = widgets.Checkbox(value=False, layout=widgets.Layout(width='30px'))",
        "        ",
        "        notes = ' \u2022 '.join(row.get('assignment_notes', [])) if isinstance(row.get('assignment_notes'), list) else str(row.get('assignment_notes', ''))",
        "        ",
        "        row_html = widgets.HTML(f'''",
        "        <div style=\"padding: 12px; border-bottom: 1px solid #E5E5EA; font-family: -apple-system;\">",
        "            <div style=\"font-weight: 600; margin-bottom: 4px;\">",
        "                {row.get('email', '')} - {row.get('name', '')}",
        "            </div>",
        "            <div style=\"color: #86868B; font-size: 14px; margin-bottom: 8px;\">",
        "                Department: {row.get('department', 'Unknown')}",
        "            </div>",
        "            <div style=\"font-size: 13px; color: #666;\">",
        "                {notes}",
        "            </div>",
        "        </div>",
        "        ''')",
        "        ",
        "        row_container = widgets.HBox([chk, row_html])",
        "        checkboxes.append((idx, chk, row))",
        "        row_widgets.append(row_container)",
        "    ",
        "    # Handlers",
        "    def select_all(b):",
        "        for _, chk, _ in checkboxes:",
        "            chk.value = True",
        "    ",
        "    def skip_all(b):",
        "        count = 0",
        "        for _, chk, row in checkboxes:",
        "            if chk.value:",
        "                row['action'] = 'skip'",
        "                count += 1",
        "        btn_skip_all.description = f\"\u2713 Skipped {count}\"",
        "        btn_skip_all.disabled = True",
        "    ",
        "    btn_select_all.on_click(select_all)",
        "    btn_skip_all.on_click(skip_all)",
        "    ",
        "    # Card content",
        "    card_content = widgets.VBox(",
        "        row_widgets,",
        "        layout=widgets.Layout(max_height='400px', overflow_y='auto')",
        "    )",
        "    ",
        "    # Card",
        "    card = widgets.VBox([",
        "        header_html,",
        "        batch_actions,",
        "        card_content",
        "    ], layout=widgets.Layout(",
        "        border='1px solid #D2D2D7',",
        "        border_radius='12px',",
        "        margin='0 0 16px 0'",
        "    ))",
        "    ",
        "    return card",
        "",
        "def render_s3_review_ui():",
        "    \"\"\"Render review UI for problematic assignments\"\"\"",
        "    # Group by status",
        "    groups = {}",
        "    status_names = {",
        "        'NO_MAPPING': 'No Department Mapping',",
        "        'NO_REVIEWER': 'Mapping Exists but No Reviewer'",
        "    }",
        "    ",
        "    for row in s3_review_rows:",
        "        status = row['assignment_status']",
        "        if status not in groups:",
        "            groups[status] = []",
        "        groups[status].append(row)",
        "    ",
        "    cards = []",
        "    ",
        "    # Header",
        "    cards.append(widgets.HTML(f'''",
        "    <div style=\"background:{APPLE_COLORS[\"orange\"]};color:white;padding:16px;border-radius:8px;margin:16px 0;font-family:-apple-system;\">",
        "        <h3 style=\"margin:0 0 8px 0;\">\u26a0\ufe0f Manual Review Required ({len(s3_review_rows)} items)</h3>",
        "        <p style=\"margin:0;opacity:0.9;\">Review users without reviewer assignments</p>",
        "    </div>",
        "    '''))",
        "    ",
        "    # Create cards",
        "    for status, rows in groups.items():",
        "        if status in status_names:",
        "            card = create_s3_review_card(status_names[status], rows, status)",
        "            cards.append(card)",
        "    ",
        "    s3_review_container.children = cards",
        "",
        "# ========== SAVE FUNCTION ==========",
        "",
        "def do_save_final(b):",
        "    \"\"\"Save final report with reviewer assignments\"\"\"",
        "    if not s3_assigned_users:",
        "        with s3_output:",
        "            print(\"\u274c No data to save\")",
        "        return",
        "    ",
        "    b.disabled = True",
        "    ",
        "    try:",
        "        # Apply review changes (skip marked items)",
        "        final_users = []",
        "        for row in s3_assigned_users:",
        "            if row.get('action') != 'skip':",
        "                final_users.append(row)",
        "        ",
        "        # Create DataFrame",
        "        df_final = pd.DataFrame(final_users)",
        "        ",
        "        # Reorder columns",
        "        priority_cols = [",
        "            'email', 'name', 'department',",
        "            'reviewer', 'reviewer_name', 'branch',",
        "            'assignment_status', 'assignment_notes'",
        "        ]",
        "        ",
        "        other_cols = [c for c in df_final.columns if c not in priority_cols + ['action']]",
        "        final_cols = [c for c in priority_cols if c in df_final.columns] + other_cols",
        "        ",
        "        df_final = df_final[final_cols]",
        "        ",
        "        # Convert notes list to string",
        "        if 'assignment_notes' in df_final.columns:",
        "            df_final['assignment_notes'] = df_final['assignment_notes'].apply(",
        "                lambda x: '; '.join(x) if isinstance(x, list) else str(x)",
        "            )",
        "        ",
        "        # Generate filename",
        "        date_str = datetime.now().strftime('%Y%m%d')",
        "        output_filename = f\"AER_Final_Report_{date_str}.xlsx\"",
        "        output_path = os.path.join(STAGE3_DIR, output_filename)",
        "        ",
        "        # Save",
        "        df_final.to_excel(output_path, index=False, sheet_name='Final Report')",
        "        ",
        "        with s3_output:",
        "            print(\"\\n\" + \"=\"*60)",
        "            print(\"\ud83d\udcbe Final Report Saved\")",
        "            print(\"=\"*60)",
        "            print(f\"Location: {output_path}\")",
        "            print(f\"Users: {len(df_final)}\")",
        "            print(f\"Columns: {len(df_final.columns)}\")",
        "            print(\"=\"*60)",
        "        ",
        "        s3_logger.info(f\"Saved final report: {output_path}\")",
        "        s3_status.value = f'<span style=\"color:{APPLE_COLORS[\"green\"]};font-family:-apple-system;\">\u2705 Saved: {output_filename}</span>'",
        "        ",
        "    except Exception as e:",
        "        with s3_output:",
        "            print(f\"\u274c Save error: {str(e)}\")",
        "        s3_logger.error(f\"Save error: {str(e)}\", exc_info=True)",
        "    finally:",
        "        b.disabled = False",
        "",
        "btn_s3_save.on_click(do_save_final)",
        "",
        "# ========== UI LAYOUT ==========",
        "",
        "stage3_ui = widgets.VBox([",
        "    widgets.HTML(get_header_html(",
        "        \"\ud83c\udfaf Stage 3: Reviewer Assignment\",",
        "        \"Assign reviewers based on department mapping\",",
        "        'pink_red'",
        "    )),",
        "    ",
        "    # Auto-load status",
        "    widgets.HTML('<h4 style=\"font-family:-apple-system;margin:16px 0 8px;\">Auto-loaded Files:</h4>'),",
        "    s3_file_status,",
        "    s3_mapping_status,",
        "    ",
        "    # Manual upload (fallback)",
        "    widgets.HTML('<h4 style=\"font-family:-apple-system;margin:24px 0 8px;\">Or Upload Manually:</h4>'),",
        "    widgets.HBox([s3_upload_users, s3_upload_mapping]),",
        "    ",
        "    # Actions",
        "    widgets.HTML('<h4 style=\"font-family:-apple-system;margin:24px 0 8px;\">Actions:</h4>'),",
        "    widgets.HBox([btn_s3_assign, btn_s3_save]),",
        "    ",
        "    s3_progress,",
        "    s3_status,",
        "    s3_review_container,",
        "    s3_output",
        "], layout=widgets.Layout(margin='32px 0'))",
        "",
        "# Initialize",
        "clear_output()",
        "display(stage3_ui)",
        "",
        "# Auto-load files",
        "users_loaded, mapping_loaded = auto_load_files()",
        "s3_logger.info(f\"Stage 3 initialized. Auto-load: users={users_loaded}, mapping={mapping_loaded}\")",
        ""
      ],
      "execution_count": null,
      "outputs": []
    }
  ],
  "metadata": {
    "kernelspec": {
      "display_name": "Python 3",
      "language": "python",
      "name": "python3"
    },
    "language_info": {
      "codemirror_mode": {
        "name": "ipython",
        "version": 3
      },
      "file_extension": ".py",
      "mimetype": "text/x-python",
      "name": "python",
      "nbconvert_exporter": "python",
      "pygments_lexer": "ipython3",
      "version": "3.11.0"
    }
  },
  "nbformat": 4,
  "nbformat_minor": 4
}